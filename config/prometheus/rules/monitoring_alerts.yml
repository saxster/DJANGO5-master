groups:
  - name: monitoring_alerts
    interval: 30s
    rules:
      # GraphQL Security Alerts
      - alert: GraphQLComplexityAttack
        expr: rate(graphql_query_validation_rejected_total[5m]) > 10
        for: 2m
        labels:
          severity: critical
          component: graphql
          category: security
        annotations:
          summary: "High rate of GraphQL complexity rejections"
          description: "{{ $value }} complex queries rejected per second (threshold: 10). Possible DoS attack."
          runbook_url: "https://docs.example.com/runbooks/graphql-dos-attack"

      - alert: GraphQLDepthAttack
        expr: rate(graphql_query_depth_exceeded_total[5m]) > 5
        for: 2m
        labels:
          severity: warning
          component: graphql
          category: security
        annotations:
          summary: "High rate of GraphQL depth violations"
          description: "{{ $value }} deep queries rejected per second. Potential nesting attack."

      - alert: GraphQLHighComplexity
        expr: graphql_query_complexity_p95 > 800
        for: 5m
        labels:
          severity: warning
          component: graphql
          category: performance
        annotations:
          summary: "GraphQL query complexity elevated"
          description: "P95 query complexity at {{ $value }} (threshold: 800). Review query patterns."

      # WebSocket Security Alerts
      - alert: WebSocketConnectionFlood
        expr: rate(websocket_connection_rejected_total[1m]) > 20
        for: 2m
        labels:
          severity: critical
          component: websocket
          category: security
        annotations:
          summary: "WebSocket connection flood detected"
          description: "{{ $value }} connection attempts rejected per minute. Possible DoS attack."
          runbook_url: "https://docs.example.com/runbooks/websocket-flood-attack"

      - alert: WebSocketHighConnectionRate
        expr: rate(websocket_connection_accepted_total[5m]) > 50
        for: 5m
        labels:
          severity: warning
          component: websocket
          category: capacity
        annotations:
          summary: "High WebSocket connection rate"
          description: "{{ $value }} connections per second. Review capacity planning."

      - alert: WebSocketConnectionLimit
        expr: websocket_active_connections > 1000
        for: 5m
        labels:
          severity: warning
          component: websocket
          category: capacity
        annotations:
          summary: "WebSocket active connections high"
          description: "{{ $value }} active connections. Approaching limits."

      # Performance Alerts
      - alert: PerformanceRegression
        expr: (request_duration_p95 - request_duration_baseline_p95) / request_duration_baseline_p95 > 0.20
        for: 10m
        labels:
          severity: warning
          component: performance
          category: regression
        annotations:
          summary: "Performance regression detected"
          description: "P95 latency {{ $value | humanizePercentage }} above baseline. Investigate recent changes."

      - alert: DatabaseQuerySlow
        expr: database_query_time_p95 > 1000
        for: 5m
        labels:
          severity: warning
          component: database
          category: performance
        annotations:
          summary: "Database queries slow"
          description: "P95 query time {{ $value }}ms (threshold: 1000ms). Optimize slow queries."

      - alert: CacheHitRateLow
        expr: cache_hit_rate < 0.70
        for: 10m
        labels:
          severity: warning
          component: cache
          category: performance
        annotations:
          summary: "Cache hit rate low"
          description: "Cache hit rate at {{ $value | humanizePercentage }} (threshold: 70%). Review caching strategy."

      # Anomaly Detection Alerts
      - alert: MetricAnomalyDetected
        expr: anomaly_detected_total > 10
        for: 5m
        labels:
          severity: warning
          component: monitoring
          category: anomaly
        annotations:
          summary: "Multiple anomalies detected"
          description: "{{ $value }} anomalies detected in the last 5 minutes. Review monitoring dashboard."

      - alert: HighSeverityAnomaly
        expr: anomaly_severity_critical_total > 0
        for: 1m
        labels:
          severity: critical
          component: monitoring
          category: anomaly
        annotations:
          summary: "Critical anomaly detected"
          description: "Critical anomaly in system metrics. Immediate investigation required."

      # Security Intelligence Alerts
      - alert: IPThreatScoreHigh
        expr: ip_threat_score > 100
        for: 2m
        labels:
          severity: critical
          component: security
          category: threat
        annotations:
          summary: "High threat score detected"
          description: "IP address threat score {{ $value }} (threshold: 100). Auto-blocking enabled."
          runbook_url: "https://docs.example.com/runbooks/ip-blocking"

      - alert: MultipleSecurityEvents
        expr: rate(security_event_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          component: security
          category: threat
        annotations:
          summary: "High rate of security events"
          description: "{{ $value }} security events per second. Review security dashboard."

      # System Health Alerts
      - alert: MonitoringServiceDown
        expr: up{job="django_monitoring"} == 0
        for: 2m
        labels:
          severity: critical
          component: monitoring
          category: availability
        annotations:
          summary: "Monitoring service unavailable"
          description: "Monitoring service has been down for 2 minutes. Check service status."

      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          component: application
          category: availability
        annotations:
          summary: "High HTTP error rate"
          description: "{{ $value | humanizePercentage }} of requests returning 5xx errors (threshold: 5%)."

      # Celery Task Monitoring
      - alert: MonitoringTasksFailing
        expr: rate(celery_task_failed_total{queue="maintenance"}[15m]) > 0.1
        for: 15m
        labels:
          severity: warning
          component: celery
          category: reliability
        annotations:
          summary: "Monitoring background tasks failing"
          description: "{{ $value }} monitoring tasks failing per second. Check Celery worker logs."

      - alert: AnomalyDetectionTaskStalled
        expr: time() - celery_task_last_success_timestamp{task="monitoring.detect_anomalies"} > 3600
        for: 5m
        labels:
          severity: warning
          component: monitoring
          category: reliability
        annotations:
          summary: "Anomaly detection task not running"
          description: "Anomaly detection hasn't run successfully in {{ $value | humanizeDuration }}."

  - name: monitoring_recording_rules
    interval: 30s
    rules:
      # GraphQL Recording Rules
      - record: graphql_query_validation_rejected_total
        expr: sum(rate(graphql_query_validation{status="rejected"}[5m])) by (rejection_reason)

      - record: graphql_query_depth_exceeded_total
        expr: sum(rate(graphql_query_validation{rejection_reason="depth_exceeded"}[5m]))

      - record: graphql_query_complexity_p95
        expr: histogram_quantile(0.95, sum(rate(graphql_query_complexity_bucket[5m])) by (le))

      # WebSocket Recording Rules
      - record: websocket_connection_rejected_total
        expr: sum(rate(websocket_connection_attempt{accepted="false"}[1m]))

      - record: websocket_connection_accepted_total
        expr: sum(rate(websocket_connection_attempt{accepted="true"}[5m]))

      - record: websocket_active_connections
        expr: sum(websocket_connections_active) by (user_type)

      # Performance Recording Rules
      - record: request_duration_p95
        expr: histogram_quantile(0.95, sum(rate(request_duration_bucket[5m])) by (le))

      - record: request_duration_baseline_p95
        expr: avg_over_time(request_duration_p95[7d])

      - record: database_query_time_p95
        expr: histogram_quantile(0.95, sum(rate(database_query_time_bucket[5m])) by (le))

      - record: cache_hit_rate
        expr: sum(rate(cache_hits_total[5m])) / (sum(rate(cache_hits_total[5m])) + sum(rate(cache_misses_total[5m])))

      # Anomaly Recording Rules
      - record: anomaly_detected_total
        expr: sum(rate(anomaly_detection_event{severity=~"high|critical"}[5m]))

      - record: anomaly_severity_critical_total
        expr: sum(rate(anomaly_detection_event{severity="critical"}[1m]))

      # Security Recording Rules
      - record: ip_threat_score
        expr: max(ip_reputation_threat_score) by (ip_address)

      - record: security_event_total
        expr: sum(rate(security_event[5m])) by (threat_type)
