# Redis Master Configuration for Sentinel High Availability
# This Redis instance will be monitored by Sentinel for automatic failover

################################## BASIC CONFIGURATION ##################################

# Port for Redis master
port ${REDIS_MASTER_PORT}

# Bind to specific interfaces
bind 127.0.0.1 ${REDIS_MASTER_IP}

# Protected mode
protected-mode yes

# TCP listen backlog
tcp-backlog 511

# Connection timeout
timeout 300

# TCP keepalive
tcp-keepalive 300

# Maximum clients
maxclients 10000

################################## AUTHENTICATION ##################################

# Authentication password
requirepass ${REDIS_PASSWORD}

# Master authentication (for replication)
masterauth ${REDIS_PASSWORD}

################################## MEMORY MANAGEMENT ##################################

# Maximum memory usage
maxmemory 2gb

# Memory eviction policy
maxmemory-policy allkeys-lru

# Memory sampling for LRU
maxmemory-samples 5

# Memory optimization settings
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 1
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

################################## PERSISTENCE ##################################

# RDB Snapshots
save 900 1      # Save after 900 sec if at least 1 key changed
save 300 10     # Save after 300 sec if at least 10 keys changed
save 60 10000   # Save after 60 sec if at least 10000 keys changed

# RDB file compression
rdbcompression yes

# RDB checksum
rdbchecksum yes

# RDB filename
dbfilename dump-master.rdb

# Working directory for persistence files
dir /var/lib/redis/master/

# AOF (Append Only File) for maximum durability
appendonly yes
appendfilename "appendonly-master.aof"

# AOF fsync policy
appendfsync everysec

# AOF rewrite optimization
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF load truncated
aof-load-truncated yes

# AOF compression
aof-use-rdb-preamble yes

################################## REPLICATION ##################################

# Replica settings (master configuration)
replica-serve-stale-data yes
replica-read-only yes
repl-diskless-sync no
repl-diskless-sync-delay 5
repl-ping-replica-period 10
repl-timeout 60
repl-disable-tcp-nodelay no
repl-backlog-size 1mb
repl-backlog-ttl 3600

# Min replicas to write configuration
# Uncomment for production to ensure data safety
# min-replicas-to-write 1
# min-replicas-max-lag 10

################################## LOGGING ##################################

# Log level
loglevel notice

# Log file
logfile /var/log/redis/redis-master.log

################################## SECURITY ##################################

# Dangerous command renaming (security)
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command CONFIG "CONFIG_${RANDOM_STRING_1}"
rename-command SHUTDOWN "SHUTDOWN_${RANDOM_STRING_1}"

################################## SENTINEL INTEGRATION ##################################

# Replica announce IP (important for Sentinel discovery)
replica-announce-ip ${REDIS_MASTER_IP}
replica-announce-port ${REDIS_MASTER_PORT}

# Sentinel can promote this instance to master
# (this is the default master, so already configured as master)

################################## PERFORMANCE OPTIMIZATION ##################################

# Database count
databases 16

# Lazy freeing for better performance
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Threading for I/O operations
io-threads 4
io-threads-do-reads yes

# Memory defragmentation
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 5
active-defrag-cycle-max 75

################################## CLIENT OUTPUT BUFFER ##################################

client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

################################## SLOW LOG ##################################

# Slow log threshold (microseconds)
slowlog-log-slower-than 10000

# Slow log maximum length
slowlog-max-len 128

################################## LATENCY MONITORING ##################################

# Latency monitoring threshold
latency-monitor-threshold 100

################################## CLUSTER MODE ##################################

# Cluster mode disabled for Sentinel setup
# (Sentinel provides HA, not horizontal scaling)
cluster-enabled no

################################## PRODUCTION NOTES ##################################

# 1. This Redis instance should be monitored by all 3 Sentinels
# 2. Ensure firewall allows access from Sentinels and replicas
# 3. Configure backup strategy for data persistence
# 4. Monitor replication lag with replicas
# 5. Test failover scenarios regularly
# 6. Ensure adequate memory and disk space
# 7. Consider read-only replicas for read scaling

################################## ENVIRONMENT VARIABLES ##################################

# The following environment variables should be set:
# - REDIS_MASTER_IP: IP address of this master instance
# - REDIS_MASTER_PORT: Port for this master (usually 6379)
# - REDIS_PASSWORD: Authentication password
# - RANDOM_STRING_1: Random string for command renaming