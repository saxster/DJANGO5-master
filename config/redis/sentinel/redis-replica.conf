# Redis Replica Configuration for Sentinel High Availability
# This Redis instance will replicate from master and can be promoted by Sentinel

################################## BASIC CONFIGURATION ##################################

# Port for Redis replica
port ${REDIS_REPLICA_PORT}

# Bind to specific interfaces
bind 127.0.0.1 ${REDIS_REPLICA_IP}

# Protected mode
protected-mode yes

# TCP listen backlog
tcp-backlog 511

# Connection timeout
timeout 300

# TCP keepalive
tcp-keepalive 300

# Maximum clients
maxclients 10000

################################## AUTHENTICATION ##################################

# Authentication password
requirepass ${REDIS_PASSWORD}

# Master authentication (for replication)
masterauth ${REDIS_PASSWORD}

################################## REPLICATION ##################################

# Connect to master for replication
replicaof ${REDIS_MASTER_IP} ${REDIS_MASTER_PORT}

# Replica settings
replica-serve-stale-data yes
replica-read-only yes
repl-diskless-sync no
repl-diskless-sync-delay 5
repl-ping-replica-period 10
repl-timeout 60
repl-disable-tcp-nodelay no
repl-backlog-size 1mb
repl-backlog-ttl 3600

# Priority for promotion (lower = higher priority)
# 0 = never promote to master
# 100 = default priority
replica-priority 100

################################## MEMORY MANAGEMENT ##################################

# Maximum memory usage (slightly less than master for safety)
maxmemory 1800mb

# Memory eviction policy
maxmemory-policy allkeys-lru

# Memory sampling for LRU
maxmemory-samples 5

# Memory optimization settings
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 1
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

################################## PERSISTENCE ##################################

# RDB Snapshots (reduced frequency for replica)
save 1800 1     # Save after 30 min if at least 1 key changed
save 300 100    # Save after 5 min if at least 100 keys changed
save 60 10000   # Save after 60 sec if at least 10000 keys changed

# RDB file compression
rdbcompression yes

# RDB checksum
rdbchecksum yes

# RDB filename
dbfilename dump-replica.rdb

# Working directory for persistence files
dir /var/lib/redis/replica/

# AOF (Append Only File) for maximum durability
appendonly yes
appendfilename "appendonly-replica.aof"

# AOF fsync policy
appendfsync everysec

# AOF rewrite optimization
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF load truncated
aof-load-truncated yes

# AOF compression
aof-use-rdb-preamble yes

################################## LOGGING ##################################

# Log level
loglevel notice

# Log file
logfile /var/log/redis/redis-replica.log

################################## SECURITY ##################################

# Dangerous command renaming (security)
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command CONFIG "CONFIG_${RANDOM_STRING_2}"
rename-command SHUTDOWN "SHUTDOWN_${RANDOM_STRING_2}"

################################## SENTINEL INTEGRATION ##################################

# Replica announce IP (important for Sentinel discovery)
replica-announce-ip ${REDIS_REPLICA_IP}
replica-announce-port ${REDIS_REPLICA_PORT}

# This replica can be promoted to master by Sentinel
# Priority determines promotion order (lower = higher priority)

################################## PERFORMANCE OPTIMIZATION ##################################

# Database count
databases 16

# Lazy freeing for better performance
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Threading for I/O operations
io-threads 2
io-threads-do-reads yes

# Memory defragmentation (less aggressive than master)
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25

################################## CLIENT OUTPUT BUFFER ##################################

client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

################################## SLOW LOG ##################################

# Slow log threshold (microseconds)
slowlog-log-slower-than 10000

# Slow log maximum length
slowlog-max-len 128

################################## LATENCY MONITORING ##################################

# Latency monitoring threshold
latency-monitor-threshold 100

################################## READ-ONLY OPTIMIZATIONS ##################################

# Since replica is read-only, optimize for read performance
# These settings help with read-heavy workloads

# Connection pooling optimization
tcp-keepalive 60

# Memory efficiency for read operations
list-max-ziplist-size -2
hash-max-ziplist-entries 512

################################## CLUSTER MODE ##################################

# Cluster mode disabled for Sentinel setup
cluster-enabled no

################################## FAILOVER PREPARATION ##################################

# Configuration for when this replica gets promoted to master

# Ensure it can handle writes when promoted
# (These settings are applied when Sentinel promotes this replica)

# Will become master settings upon promotion:
# - replica-read-only will be set to no
# - replicaof directive will be removed
# - New replicas will connect to this instance

################################## PRODUCTION NOTES ##################################

# 1. This replica should be monitored by all 3 Sentinels
# 2. Ensure firewall allows access from Sentinels and master
# 3. Monitor replication lag with master
# 4. Test promotion scenarios regularly
# 5. Ensure adequate memory and disk space
# 6. Consider multiple replicas for read scaling
# 7. Monitor replica promotion priority settings

################################## ENVIRONMENT VARIABLES ##################################

# The following environment variables should be set:
# - REDIS_REPLICA_IP: IP address of this replica instance
# - REDIS_REPLICA_PORT: Port for this replica (usually 6380)
# - REDIS_MASTER_IP: IP address of the master instance
# - REDIS_MASTER_PORT: Port of the master instance
# - REDIS_PASSWORD: Authentication password
# - RANDOM_STRING_2: Random string for command renaming

################################## MONITORING AND ALERTS ##################################

# Key metrics to monitor:
# - Replication lag: master_repl_offset - replica_repl_offset
# - Connection status with master
# - Memory usage vs master
# - Disk usage for persistence files
# - Network connectivity with Sentinels