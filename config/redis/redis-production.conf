# Redis Production Configuration - Security Hardened
# Created for IntelliWiz Django 5.2.1 Enterprise Platform
# Addresses critical security and performance gaps identified in analysis

################################## SECURITY ##################################

# Authentication - CRITICAL: Replace with strong password
requirepass ${REDIS_PASSWORD}

# Network Security - Bind to specific interfaces only
bind 127.0.0.1 ${REDIS_PRIVATE_IP}

# Disable dangerous commands that could be used for attacks
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command EVAL ""
rename-command DEBUG ""
rename-command CONFIG "CONFIG_${RANDOM_STRING}"
rename-command SHUTDOWN "SHUTDOWN_${RANDOM_STRING}"

# Protected mode - reject connections from unauthorized IPs
protected-mode yes

# Connection timeout to prevent resource exhaustion
timeout 300

# Maximum clients to prevent DoS
maxclients 10000

# TCP keepalive to detect dead connections
tcp-keepalive 300

################################## NETWORK ##################################

# Port configuration - consider changing default port for security
port 6379

# TCP listen backlog
tcp-backlog 511

# Disable dangerous commands over network
# rename-command KEYS ""  # Commented - needed for monitoring

# Client output buffer limits to prevent memory attacks
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

################################## MEMORY MANAGEMENT ##################################

# Maximum memory usage - CRITICAL for preventing OOM
maxmemory 2gb

# Memory eviction policy - optimized for cache usage patterns
maxmemory-policy allkeys-lru

# Memory sampling for LRU eviction
maxmemory-samples 5

# Memory optimization settings
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 1
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

################################## PERSISTENCE ##################################

# RDB Snapshots for data durability
save 900 1      # Save after 900 sec if at least 1 key changed
save 300 10     # Save after 300 sec if at least 10 keys changed
save 60 10000   # Save after 60 sec if at least 10000 keys changed

# RDB file compression
rdbcompression yes

# RDB checksum for integrity
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# Working directory for persistence files
dir /var/lib/redis/

# AOF (Append Only File) for maximum durability
appendonly yes
appendfilename "appendonly.aof"

# AOF fsync policy - balance between performance and durability
appendfsync everysec

# AOF rewrite optimization
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF load truncated - handle corrupted AOF files gracefully
aof-load-truncated yes

# AOF compression
aof-use-rdb-preamble yes

################################## PERFORMANCE ##################################

# Database count - optimized for multi-service usage
databases 16

# Disable slow operations in production
# slowlog-log-slower-than 10000  # 10ms threshold
# slowlog-max-len 128

# Lazy freeing for better performance
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Threading for I/O operations
io-threads 4
io-threads-do-reads yes

################################## LOGGING ##################################

# Log level for production
loglevel notice

# Log file location
logfile /var/log/redis/redis-server.log

# Syslog integration
# syslog-enabled yes
# syslog-ident redis
# syslog-facility local0

################################## REPLICATION ##################################

# Replication settings for high availability
replica-serve-stale-data yes
replica-read-only yes
repl-diskless-sync no
repl-diskless-sync-delay 5
repl-ping-replica-period 10
repl-timeout 60
repl-disable-tcp-nodelay no
repl-backlog-size 1mb
repl-backlog-ttl 3600

# Password for replica authentication
masterauth ${REDIS_PASSWORD}

################################## SENTINEL INTEGRATION ##################################

# Sentinel mode configuration (when running Sentinel)
# sentinel announce-ip ${REDIS_IP}
# sentinel announce-port 6379

################################## LUA SCRIPTING ##################################

# Lua scripting timeout
lua-time-limit 5000

################################## MONITORING ##################################

# Latency monitoring
latency-monitor-threshold 100

################################## MEMORY DEFRAGMENTATION ##################################

# Active defragmentation for memory efficiency
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 5
active-defrag-cycle-max 75

################################## CLUSTER MODE ##################################

# Cluster mode disabled for single-instance setup
# Enable for horizontal scaling
# cluster-enabled yes
# cluster-config-file nodes.conf
# cluster-node-timeout 15000
# cluster-require-full-coverage yes

################################## MODULES ##################################

# Load Redis modules for extended functionality
# loadmodule /path/to/redis-modules/rejson.so
# loadmodule /path/to/redis-modules/redisearch.so

################################## PRODUCTION OPTIMIZATIONS ##################################

# Huge pages for better memory performance
# echo madvise > /sys/kernel/mm/transparent_hugepage/enabled

# OS-level optimizations
# vm.overcommit_memory = 1
# net.core.somaxconn = 65535

################################## DOCKER INTEGRATION ##################################

# Configuration for Docker deployments
# daemonize no  # Let Docker handle daemonization
# supervised auto  # Auto-detect supervision system

################################## SSL/TLS CONFIGURATION ##################################

# TLS configuration for encrypted connections
# port 0  # Disable non-TLS port
# tls-port 6380
# tls-cert-file /etc/redis/tls/redis.crt
# tls-key-file /etc/redis/tls/redis.key
# tls-ca-cert-file /etc/redis/tls/ca.crt
# tls-dh-params-file /etc/redis/tls/redis.dh
# tls-protocols "TLSv1.2 TLSv1.3"
# tls-prefer-server-ciphers yes