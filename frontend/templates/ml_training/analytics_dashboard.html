{% extends "ml_training/base/ml_training_base.html" %}
{% load static %}

{% block title %}ML Training - Performance Analytics{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
{% endblock %}

{% block content %}
<div class="ml-container">
    <!-- Header Section -->
    <div class="ml-header">
        <div class="ml-header-content">
            <h1 class="ml-page-title">
                <i class="material-icons">analytics</i>
                Performance Analytics
            </h1>
            <p class="ml-page-subtitle">Monitor training progress and model performance metrics</p>
        </div>
        <div class="ml-header-actions">
            <div class="ml-time-range-selector">
                <select id="time-range" class="ml-select">
                    <option value="7d">Last 7 days</option>
                    <option value="30d" selected>Last 30 days</option>
                    <option value="90d">Last 90 days</option>
                    <option value="1y">Last year</option>
                </select>
            </div>
            <button class="ml-btn ml-btn-primary" id="export-report">
                <i class="material-icons">download</i>
                Export Report
            </button>
        </div>
    </div>

    <!-- Key Performance Indicators -->
    <div class="ml-kpi-grid">
        <div class="ml-kpi-card ml-kpi-primary">
            <div class="ml-kpi-header">
                <div class="ml-kpi-icon">
                    <i class="material-icons">speed</i>
                </div>
                <div class="ml-kpi-trend ml-trend-up">
                    <i class="material-icons">trending_up</i>
                    <span>+15.3%</span>
                </div>
            </div>
            <div class="ml-kpi-content">
                <h3 class="ml-kpi-value" data-target="94.2">0</h3>
                <p class="ml-kpi-label">Average Accuracy</p>
                <div class="ml-kpi-sublabel">Across all models</div>
            </div>
            <div class="ml-kpi-chart">
                <canvas id="accuracy-sparkline" width="100" height="30"></canvas>
            </div>
        </div>

        <div class="ml-kpi-card ml-kpi-success">
            <div class="ml-kpi-header">
                <div class="ml-kpi-icon">
                    <i class="material-icons">label</i>
                </div>
                <div class="ml-kpi-trend ml-trend-up">
                    <i class="material-icons">trending_up</i>
                    <span>+28.1%</span>
                </div>
            </div>
            <div class="ml-kpi-content">
                <h3 class="ml-kpi-value" data-target="12847">0</h3>
                <p class="ml-kpi-label">Labels This Month</p>
                <div class="ml-kpi-sublabel">2,340 this week</div>
            </div>
            <div class="ml-kpi-chart">
                <canvas id="labels-sparkline" width="100" height="30"></canvas>
            </div>
        </div>

        <div class="ml-kpi-card ml-kpi-info">
            <div class="ml-kpi-header">
                <div class="ml-kpi-icon">
                    <i class="material-icons">schedule</i>
                </div>
                <div class="ml-kpi-trend ml-trend-down">
                    <i class="material-icons">trending_down</i>
                    <span>-12.4%</span>
                </div>
            </div>
            <div class="ml-kpi-content">
                <h3 class="ml-kpi-value" data-target="23.8">0</h3>
                <p class="ml-kpi-label">Avg Label Time</p>
                <div class="ml-kpi-sublabel">seconds per label</div>
            </div>
            <div class="ml-kpi-chart">
                <canvas id="time-sparkline" width="100" height="30"></canvas>
            </div>
        </div>

        <div class="ml-kpi-card ml-kpi-warning">
            <div class="ml-kpi-header">
                <div class="ml-kpi-icon">
                    <i class="material-icons">model_training</i>
                </div>
                <div class="ml-kpi-trend ml-trend-neutral">
                    <i class="material-icons">remove</i>
                    <span>Stable</span>
                </div>
            </div>
            <div class="ml-kpi-content">
                <h3 class="ml-kpi-value" data-target="7">0</h3>
                <p class="ml-kpi-label">Active Training Jobs</p>
                <div class="ml-kpi-sublabel">3 queued</div>
            </div>
            <div class="ml-kpi-chart">
                <canvas id="training-sparkline" width="100" height="30"></canvas>
            </div>
        </div>
    </div>

    <!-- Analytics Grid -->
    <div class="ml-analytics-grid">
        <!-- Model Performance Chart -->
        <div class="ml-chart-card ml-chart-large">
            <div class="ml-chart-header">
                <h3 class="ml-chart-title">Model Performance Over Time</h3>
                <div class="ml-chart-controls">
                    <div class="ml-metric-selector">
                        <button class="ml-metric-btn active" data-metric="accuracy">Accuracy</button>
                        <button class="ml-metric-btn" data-metric="precision">Precision</button>
                        <button class="ml-metric-btn" data-metric="recall">Recall</button>
                        <button class="ml-metric-btn" data-metric="f1">F1 Score</button>
                    </div>
                </div>
            </div>
            <div class="ml-chart-container">
                <canvas id="performance-chart"></canvas>
            </div>
        </div>

        <!-- Dataset Distribution -->
        <div class="ml-chart-card">
            <div class="ml-chart-header">
                <h3 class="ml-chart-title">Dataset Distribution</h3>
                <div class="ml-chart-info">
                    <i class="material-icons" title="Distribution of training examples across dataset types">
                        info_outline
                    </i>
                </div>
            </div>
            <div class="ml-chart-container">
                <canvas id="dataset-distribution-chart"></canvas>
            </div>
            <div class="ml-chart-legend">
                <div class="ml-legend-item">
                    <span class="ml-legend-color" style="background: #4c84ff;"></span>
                    <span>OCR Meters (67%)</span>
                </div>
                <div class="ml-legend-item">
                    <span class="ml-legend-color" style="background: #00d084;"></span>
                    <span>License Plates (28%)</span>
                </div>
                <div class="ml-legend-item">
                    <span class="ml-legend-color" style="background: #ff6b6b;"></span>
                    <span>Face Recognition (5%)</span>
                </div>
            </div>
        </div>

        <!-- Labeling Productivity -->
        <div class="ml-chart-card">
            <div class="ml-chart-header">
                <h3 class="ml-chart-title">Labeling Productivity</h3>
                <div class="ml-chart-controls">
                    <select class="ml-select ml-select-small" id="productivity-period">
                        <option value="daily">Daily</option>
                        <option value="weekly" selected>Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
            </div>
            <div class="ml-chart-container">
                <canvas id="productivity-chart"></canvas>
            </div>
        </div>

        <!-- Quality Metrics -->
        <div class="ml-chart-card">
            <div class="ml-chart-header">
                <h3 class="ml-chart-title">Quality Metrics</h3>
                <div class="ml-quality-score">
                    <span class="ml-score-value">87.6%</span>
                    <span class="ml-score-label">Overall Quality</span>
                </div>
            </div>
            <div class="ml-quality-breakdown">
                <div class="ml-quality-item">
                    <div class="ml-quality-header">
                        <span class="ml-quality-name">Inter-Annotator Agreement</span>
                        <span class="ml-quality-value">92.4%</span>
                    </div>
                    <div class="ml-quality-bar">
                        <div class="ml-quality-fill" style="width: 92.4%;"></div>
                    </div>
                </div>
                <div class="ml-quality-item">
                    <div class="ml-quality-header">
                        <span class="ml-quality-name">Label Consistency</span>
                        <span class="ml-quality-value">88.7%</span>
                    </div>
                    <div class="ml-quality-bar">
                        <div class="ml-quality-fill" style="width: 88.7%;"></div>
                    </div>
                </div>
                <div class="ml-quality-item">
                    <div class="ml-quality-header">
                        <span class="ml-quality-name">Validation Accuracy</span>
                        <span class="ml-quality-value">91.2%</span>
                    </div>
                    <div class="ml-quality-bar">
                        <div class="ml-quality-fill" style="width: 91.2%;"></div>
                    </div>
                </div>
                <div class="ml-quality-item">
                    <div class="ml-quality-header">
                        <span class="ml-quality-name">Edge Case Coverage</span>
                        <span class="ml-quality-value">76.3%</span>
                    </div>
                    <div class="ml-quality-bar">
                        <div class="ml-quality-fill" style="width: 76.3%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Progress -->
        <div class="ml-chart-card ml-chart-large">
            <div class="ml-chart-header">
                <h3 class="ml-chart-title">Training Progress</h3>
                <div class="ml-chart-controls">
                    <div class="ml-model-selector">
                        <select class="ml-select" id="model-selector">
                            <option value="all">All Models</option>
                            <option value="meter-reading-v2">Meter Reading v2.1</option>
                            <option value="license-plate-v1">License Plate v1.3</option>
                            <option value="face-recognition-v3">Face Recognition v3.0</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="ml-chart-container">
                <canvas id="training-progress-chart"></canvas>
            </div>
        </div>

        <!-- Active Learning Insights -->
        <div class="ml-chart-card">
            <div class="ml-chart-header">
                <h3 class="ml-chart-title">Active Learning Insights</h3>
                <div class="ml-chart-subtitle">Uncertainty-based sample selection</div>
            </div>
            <div class="ml-chart-container">
                <canvas id="active-learning-chart"></canvas>
            </div>
            <div class="ml-insights-summary">
                <div class="ml-insight-item">
                    <span class="ml-insight-value">1,247</span>
                    <span class="ml-insight-label">High Uncertainty Samples</span>
                </div>
                <div class="ml-insight-item">
                    <span class="ml-insight-value">89.3%</span>
                    <span class="ml-insight-label">Selection Efficiency</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity Feed -->
    <div class="ml-activity-section">
        <div class="ml-section-header">
            <h2 class="ml-section-title">Recent Activity</h2>
            <a href="#" class="ml-view-all-link">View All Activity</a>
        </div>
        <div class="ml-activity-feed">
            <div class="ml-activity-item">
                <div class="ml-activity-icon ml-activity-success">
                    <i class="material-icons">check_circle</i>
                </div>
                <div class="ml-activity-content">
                    <div class="ml-activity-title">Training completed: Meter Reading v2.1</div>
                    <div class="ml-activity-details">Achieved 94.2% accuracy on validation set</div>
                    <div class="ml-activity-time">2 hours ago</div>
                </div>
                <div class="ml-activity-badge ml-badge-success">Completed</div>
            </div>

            <div class="ml-activity-item">
                <div class="ml-activity-icon ml-activity-info">
                    <i class="material-icons">upload</i>
                </div>
                <div class="ml-activity-content">
                    <div class="ml-activity-title">New batch uploaded: License Plate Training Set #3</div>
                    <div class="ml-activity-details">1,580 images added to dataset</div>
                    <div class="ml-activity-time">4 hours ago</div>
                </div>
                <div class="ml-activity-badge ml-badge-info">Upload</div>
            </div>

            <div class="ml-activity-item">
                <div class="ml-activity-icon ml-activity-warning">
                    <i class="material-icons">warning</i>
                </div>
                <div class="ml-activity-content">
                    <div class="ml-activity-title">Quality alert: Low inter-annotator agreement</div>
                    <div class="ml-activity-details">Face Recognition dataset showing 73% agreement</div>
                    <div class="ml-activity-time">6 hours ago</div>
                </div>
                <div class="ml-activity-badge ml-badge-warning">Alert</div>
            </div>

            <div class="ml-activity-item">
                <div class="ml-activity-icon ml-activity-primary">
                    <i class="material-icons">label</i>
                </div>
                <div class="ml-activity-content">
                    <div class="ml-activity-title">Labeling milestone reached</div>
                    <div class="ml-activity-details">10,000 labels completed this month</div>
                    <div class="ml-activity-time">1 day ago</div>
                </div>
                <div class="ml-activity-badge ml-badge-primary">Milestone</div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div id="export-modal" class="ml-modal">
    <div class="ml-modal-content">
        <div class="ml-modal-header">
            <h3>Export Analytics Report</h3>
            <button class="ml-modal-close" id="close-export-modal">
                <i class="material-icons">close</i>
            </button>
        </div>
        <div class="ml-modal-body">
            <div class="ml-export-options">
                <div class="ml-option-group">
                    <label class="ml-form-label">Report Type:</label>
                    <div class="ml-radio-group">
                        <label class="ml-radio-label">
                            <input type="radio" name="report_type" value="summary" checked>
                            <span class="ml-radio-button"></span>
                            Executive Summary
                        </label>
                        <label class="ml-radio-label">
                            <input type="radio" name="report_type" value="detailed">
                            <span class="ml-radio-button"></span>
                            Detailed Analytics
                        </label>
                        <label class="ml-radio-label">
                            <input type="radio" name="report_type" value="custom">
                            <span class="ml-radio-button"></span>
                            Custom Report
                        </label>
                    </div>
                </div>

                <div class="ml-option-group">
                    <label class="ml-form-label">Format:</label>
                    <select class="ml-select" id="export-format">
                        <option value="pdf">PDF Report</option>
                        <option value="xlsx">Excel Spreadsheet</option>
                        <option value="csv">CSV Data</option>
                        <option value="json">JSON Data</option>
                    </select>
                </div>

                <div class="ml-option-group">
                    <label class="ml-form-label">Time Range:</label>
                    <select class="ml-select" id="export-timerange">
                        <option value="7d">Last 7 days</option>
                        <option value="30d">Last 30 days</option>
                        <option value="90d">Last 90 days</option>
                        <option value="1y">Last year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="ml-modal-footer">
            <button class="ml-btn ml-btn-secondary" id="cancel-export">Cancel</button>
            <button class="ml-btn ml-btn-primary" id="generate-export">
                <i class="material-icons">download</i>
                Generate Report
            </button>
        </div>
    </div>
</div>

<script>
class AnalyticsDashboard {
    constructor() {
        this.charts = {};
        this.currentTimeRange = '30d';
        this.currentMetric = 'accuracy';

        this.initializeDashboard();
        this.setupEventListeners();
        this.loadAnalyticsData();
    }

    initializeDashboard() {
        // Animate KPI counters
        this.animateCounters();

        // Initialize charts
        this.initializeCharts();

        // Setup refresh intervals
        this.setupAutoRefresh();
    }

    setupEventListeners() {
        // Time range selector
        document.getElementById('time-range').addEventListener('change', (e) => {
            this.currentTimeRange = e.target.value;
            this.refreshAllCharts();
        });

        // Metric selector buttons
        document.querySelectorAll('.ml-metric-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.selectMetric(e.target.dataset.metric);
            });
        });

        // Model selector
        document.getElementById('model-selector').addEventListener('change', (e) => {
            this.updateTrainingProgressChart(e.target.value);
        });

        // Export functionality
        document.getElementById('export-report').addEventListener('click', () => {
            this.showExportModal();
        });

        document.getElementById('close-export-modal').addEventListener('click', () => {
            this.hideExportModal();
        });

        document.getElementById('generate-export').addEventListener('click', () => {
            this.generateReport();
        });
    }

    initializeCharts() {
        // Performance chart
        this.initializePerformanceChart();

        // Dataset distribution chart
        this.initializeDatasetDistributionChart();

        // Productivity chart
        this.initializeProductivityChart();

        // Training progress chart
        this.initializeTrainingProgressChart();

        // Active learning chart
        this.initializeActiveLearningChart();

        // Sparkline charts
        this.initializeSparklines();
    }

    initializePerformanceChart() {
        const ctx = document.getElementById('performance-chart').getContext('2d');

        this.charts.performance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: this.generateDateLabels(30),
                datasets: [{
                    label: 'Accuracy',
                    data: this.generateSampleData(30, 85, 95),
                    borderColor: '#4c84ff',
                    backgroundColor: 'rgba(76, 132, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Validation Accuracy',
                    data: this.generateSampleData(30, 82, 92),
                    borderColor: '#00d084',
                    backgroundColor: 'rgba(0, 208, 132, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Accuracy (%)'
                        },
                        min: 70,
                        max: 100
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    initializeDatasetDistributionChart() {
        const ctx = document.getElementById('dataset-distribution-chart').getContext('2d');

        this.charts.distribution = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['OCR Meters', 'License Plates', 'Face Recognition'],
                datasets: [{
                    data: [67, 28, 5],
                    backgroundColor: ['#4c84ff', '#00d084', '#ff6b6b'],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    initializeProductivityChart() {
        const ctx = document.getElementById('productivity-chart').getContext('2d');

        this.charts.productivity = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Labels Created',
                    data: [2840, 3210, 2950, 3380],
                    backgroundColor: '#4c84ff',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Labels'
                        }
                    }
                }
            }
        });
    }

    initializeTrainingProgressChart() {
        const ctx = document.getElementById('training-progress-chart').getContext('2d');

        this.charts.trainingProgress = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 100}, (_, i) => `Epoch ${i + 1}`),
                datasets: [{
                    label: 'Training Loss',
                    data: this.generateTrainingLossData(100),
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                    yAxisID: 'y',
                    tension: 0.4
                }, {
                    label: 'Validation Loss',
                    data: this.generateValidationLossData(100),
                    borderColor: '#ffa726',
                    backgroundColor: 'rgba(255, 167, 38, 0.1)',
                    yAxisID: 'y',
                    tension: 0.4
                }, {
                    label: 'Accuracy',
                    data: this.generateAccuracyData(100),
                    borderColor: '#4c84ff',
                    backgroundColor: 'rgba(76, 132, 255, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Epoch'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Loss'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Accuracy (%)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
    }

    initializeActiveLearningChart() {
        const ctx = document.getElementById('active-learning-chart').getContext('2d');

        this.charts.activeLearning = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'High Uncertainty',
                    data: this.generateUncertaintyData(50, 0.7, 1.0),
                    backgroundColor: '#ff6b6b',
                    pointRadius: 4
                }, {
                    label: 'Medium Uncertainty',
                    data: this.generateUncertaintyData(100, 0.4, 0.7),
                    backgroundColor: '#ffa726',
                    pointRadius: 3
                }, {
                    label: 'Low Uncertainty',
                    data: this.generateUncertaintyData(200, 0.0, 0.4),
                    backgroundColor: '#4c84ff',
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Diversity Score'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Uncertainty Score'
                        }
                    }
                }
            }
        });
    }

    initializeSparklines() {
        // Accuracy sparkline
        this.createSparkline('accuracy-sparkline', this.generateSampleData(20, 90, 95), '#4c84ff');

        // Labels sparkline
        this.createSparkline('labels-sparkline', this.generateSampleData(20, 100, 300), '#00d084');

        // Time sparkline
        this.createSparkline('time-sparkline', this.generateSampleData(20, 20, 30), '#ffa726');

        // Training sparkline
        this.createSparkline('training-sparkline', this.generateSampleData(20, 5, 10), '#ff6b6b');
    }

    createSparkline(canvasId, data, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: data.length}, (_, i) => i),
                datasets: [{
                    data: data,
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { display: false },
                    y: { display: false }
                },
                elements: {
                    point: { radius: 0 }
                }
            }
        });
    }

    // Data generation utilities
    generateDateLabels(days) {
        const labels = [];
        for (let i = days - 1; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            labels.push(date.toLocaleDateString());
        }
        return labels;
    }

    generateSampleData(length, min, max) {
        return Array.from({length}, () =>
            Math.random() * (max - min) + min
        );
    }

    generateTrainingLossData(length) {
        const data = [];
        let loss = 2.0;
        for (let i = 0; i < length; i++) {
            loss = loss * (0.98 + Math.random() * 0.02);
            data.push(loss);
        }
        return data;
    }

    generateValidationLossData(length) {
        const data = [];
        let loss = 2.2;
        for (let i = 0; i < length; i++) {
            loss = loss * (0.979 + Math.random() * 0.025);
            data.push(loss);
        }
        return data;
    }

    generateAccuracyData(length) {
        const data = [];
        let accuracy = 50;
        for (let i = 0; i < length; i++) {
            accuracy = Math.min(98, accuracy + Math.random() * 1.5);
            data.push(accuracy);
        }
        return data;
    }

    generateUncertaintyData(count, minUncertainty, maxUncertainty) {
        return Array.from({length: count}, () => ({
            x: Math.random(),
            y: Math.random() * (maxUncertainty - minUncertainty) + minUncertainty
        }));
    }

    // Event handlers
    selectMetric(metric) {
        document.querySelectorAll('.ml-metric-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-metric="${metric}"]`).classList.add('active');

        this.currentMetric = metric;
        this.updatePerformanceChart(metric);
    }

    updatePerformanceChart(metric) {
        // Update chart based on selected metric
        console.log('Updating performance chart for metric:', metric);
    }

    updateTrainingProgressChart(model) {
        // Update chart based on selected model
        console.log('Updating training progress for model:', model);
    }

    refreshAllCharts() {
        // Refresh all charts with new time range data
        console.log('Refreshing charts for time range:', this.currentTimeRange);
    }

    loadAnalyticsData() {
        // Load real analytics data from API
        console.log('Loading analytics data...');
    }

    setupAutoRefresh() {
        // Refresh data every 5 minutes
        setInterval(() => {
            this.loadAnalyticsData();
        }, 5 * 60 * 1000);
    }

    showExportModal() {
        document.getElementById('export-modal').style.display = 'flex';
    }

    hideExportModal() {
        document.getElementById('export-modal').style.display = 'none';
    }

    generateReport() {
        const reportType = document.querySelector('input[name="report_type"]:checked').value;
        const format = document.getElementById('export-format').value;
        const timeRange = document.getElementById('export-timerange').value;

        console.log('Generating report:', { reportType, format, timeRange });

        // Simulate report generation
        this.hideExportModal();
        this.showToast('Report generation started. You will be notified when ready.', 'info');
    }

    showToast(message, type) {
        // Simple toast implementation
        const toast = document.createElement('div');
        toast.className = `ml-toast ml-toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
    }
}

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize counters animation
    animateCounters();

    // Initialize analytics dashboard
    new AnalyticsDashboard();
});
</script>

<style>
/* Analytics Dashboard Specific Styles */
.ml-kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

.ml-kpi-card {
    background: var(--ml-bg-card);
    border-radius: var(--ml-border-radius-lg);
    border: 1px solid var(--ml-border-light);
    padding: 24px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.ml-kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--ml-shadow-hover);
}

.ml-kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--ml-gradient-primary);
}

.ml-kpi-primary::before { background: var(--ml-gradient-primary); }
.ml-kpi-success::before { background: linear-gradient(135deg, #00d084 0%, #00a86b 100%); }
.ml-kpi-info::before { background: linear-gradient(135deg, #4dabf7 0%, #339af0 100%); }
.ml-kpi-warning::before { background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%); }

.ml-kpi-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.ml-kpi-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--ml-border-radius);
    background: var(--ml-bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--ml-primary);
}

.ml-kpi-trend {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 12px;
}

.ml-trend-up {
    background: rgba(0, 208, 132, 0.1);
    color: var(--ml-success);
}

.ml-trend-down {
    background: rgba(255, 107, 107, 0.1);
    color: var(--ml-error);
}

.ml-trend-neutral {
    background: var(--ml-bg-secondary);
    color: var(--ml-text-secondary);
}

.ml-kpi-content {
    margin-bottom: 16px;
}

.ml-kpi-value {
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1;
    color: var(--ml-text-primary);
    margin: 0 0 4px;
}

.ml-kpi-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--ml-text-primary);
    margin: 0 0 2px;
}

.ml-kpi-sublabel {
    font-size: 0.75rem;
    color: var(--ml-text-secondary);
}

.ml-kpi-chart {
    height: 40px;
    margin-top: 16px;
}

/* Analytics Grid */
.ml-analytics-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 24px;
    margin-bottom: 32px;
}

.ml-chart-card {
    background: var(--ml-bg-card);
    border-radius: var(--ml-border-radius-lg);
    border: 1px solid var(--ml-border-light);
    padding: 24px;
    grid-column: span 6;
}

.ml-chart-large {
    grid-column: span 12;
}

.ml-chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.ml-chart-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--ml-text-primary);
    margin: 0;
}

.ml-chart-subtitle {
    font-size: 0.875rem;
    color: var(--ml-text-secondary);
    margin-top: 4px;
}

.ml-chart-info {
    color: var(--ml-text-secondary);
    cursor: help;
}

.ml-chart-controls {
    display: flex;
    align-items: center;
    gap: 16px;
}

.ml-metric-selector {
    display: flex;
    background: var(--ml-bg-secondary);
    border-radius: var(--ml-border-radius);
    padding: 4px;
}

.ml-metric-btn {
    padding: 6px 12px;
    border: none;
    background: transparent;
    color: var(--ml-text-secondary);
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: var(--ml-border-radius);
    cursor: pointer;
    transition: all 0.2s ease;
}

.ml-metric-btn:hover,
.ml-metric-btn.active {
    background: var(--ml-primary);
    color: white;
}

.ml-chart-container {
    position: relative;
    height: 300px;
}

.ml-chart-legend {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 16px;
}

.ml-legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.875rem;
    color: var(--ml-text-secondary);
}

.ml-legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

/* Quality Metrics */
.ml-quality-score {
    text-align: right;
}

.ml-score-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--ml-success);
    display: block;
}

.ml-score-label {
    font-size: 0.75rem;
    color: var(--ml-text-secondary);
}

.ml-quality-breakdown {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.ml-quality-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.ml-quality-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.ml-quality-name {
    font-size: 0.875rem;
    color: var(--ml-text-primary);
}

.ml-quality-value {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--ml-text-primary);
}

.ml-quality-bar {
    height: 6px;
    background: var(--ml-bg-secondary);
    border-radius: 3px;
    overflow: hidden;
}

.ml-quality-fill {
    height: 100%;
    background: var(--ml-gradient-primary);
    border-radius: 3px;
    transition: width 0.6s ease;
}

/* Insights Summary */
.ml-insights-summary {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--ml-border-light);
}

.ml-insight-item {
    text-align: center;
}

.ml-insight-value {
    display: block;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--ml-primary);
    line-height: 1;
}

.ml-insight-label {
    font-size: 0.75rem;
    color: var(--ml-text-secondary);
    margin-top: 4px;
}

/* Activity Feed */
.ml-activity-section {
    background: var(--ml-bg-card);
    border-radius: var(--ml-border-radius-lg);
    border: 1px solid var(--ml-border-light);
    padding: 24px;
}

.ml-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.ml-section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--ml-text-primary);
    margin: 0;
}

.ml-view-all-link {
    color: var(--ml-primary);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
}

.ml-view-all-link:hover {
    text-decoration: underline;
}

.ml-activity-feed {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.ml-activity-item {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 16px;
    background: var(--ml-bg-secondary);
    border-radius: var(--ml-border-radius);
    transition: all 0.2s ease;
}

.ml-activity-item:hover {
    background: var(--ml-bg-hover);
}

.ml-activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
}

.ml-activity-success { background: var(--ml-success); }
.ml-activity-info { background: var(--ml-info); }
.ml-activity-warning { background: var(--ml-warning); }
.ml-activity-primary { background: var(--ml-primary); }

.ml-activity-content {
    flex: 1;
    min-width: 0;
}

.ml-activity-title {
    font-weight: 600;
    color: var(--ml-text-primary);
    margin-bottom: 4px;
}

.ml-activity-details {
    font-size: 0.875rem;
    color: var(--ml-text-secondary);
    margin-bottom: 4px;
}

.ml-activity-time {
    font-size: 0.75rem;
    color: var(--ml-text-secondary);
}

.ml-activity-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
}

.ml-badge-success {
    background: rgba(0, 208, 132, 0.1);
    color: var(--ml-success);
}

.ml-badge-info {
    background: rgba(76, 132, 255, 0.1);
    color: var(--ml-primary);
}

.ml-badge-warning {
    background: rgba(255, 167, 38, 0.1);
    color: var(--ml-warning);
}

.ml-badge-primary {
    background: rgba(76, 132, 255, 0.1);
    color: var(--ml-primary);
}

/* Export Modal */
.ml-export-options {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.ml-radio-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.ml-radio-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 0.875rem;
    color: var(--ml-text-primary);
}

.ml-radio-button {
    width: 16px;
    height: 16px;
    border: 2px solid var(--ml-border-light);
    border-radius: 50%;
    position: relative;
    transition: all 0.2s ease;
}

.ml-radio-label input:checked + .ml-radio-button {
    border-color: var(--ml-primary);
}

.ml-radio-label input:checked + .ml-radio-button::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--ml-primary);
}

/* Responsive Design */
@media (max-width: 1024px) {
    .ml-analytics-grid {
        grid-template-columns: repeat(6, 1fr);
    }

    .ml-chart-card {
        grid-column: span 6;
    }

    .ml-chart-large {
        grid-column: span 6;
    }
}

@media (max-width: 768px) {
    .ml-kpi-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .ml-analytics-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }

    .ml-chart-card,
    .ml-chart-large {
        grid-column: span 1;
        padding: 16px;
    }

    .ml-chart-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }

    .ml-metric-selector {
        flex-wrap: wrap;
    }

    .ml-insights-summary {
        grid-template-columns: 1fr;
    }

    .ml-activity-item {
        padding: 12px;
    }
}

@media (max-width: 480px) {
    .ml-kpi-grid {
        grid-template-columns: 1fr;
    }

    .ml-kpi-value {
        font-size: 2rem;
    }

    .ml-chart-container {
        height: 250px;
    }
}
</style>
{% endblock %}