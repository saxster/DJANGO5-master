{% extends "ml_training/base/ml_training_base.html" %}
{% load static %}

{% block title %}ML Training - Labeling Interface{% endblock %}

{% block content %}
<div class="ml-labeling-container">
    <!-- Header with Progress -->
    <div class="ml-labeling-header">
        <div class="ml-header-content">
            <h1 class="ml-page-title">
                <i class="material-icons">label</i>
                Labeling Interface
            </h1>
            <div class="ml-task-info">
                <span class="ml-task-name">{{ task.name }}</span>
                <span class="ml-task-dataset">Dataset: {{ task.dataset.name }}</span>
            </div>
        </div>
        <div class="ml-progress-container">
            <div class="ml-progress-info">
                <span class="ml-progress-text">
                    Progress: {{ task.completion_percentage|floatformat:1 }}%
                </span>
                <span class="ml-remaining-text">
                    {{ remaining_count }} remaining
                </span>
            </div>
            <div class="ml-progress-bar ml-progress-animated">
                <div class="ml-progress-fill" style="width: {{ task.completion_percentage }}%"></div>
            </div>
        </div>
    </div>

    <!-- Main Labeling Interface -->
    <div class="ml-labeling-workspace">
        <!-- Image Display Panel -->
        <div class="ml-image-panel">
            <div class="ml-image-container">
                {% if current_example.image_path %}
                    <img id="labeling-image"
                         src="{{ current_example.image_path }}"
                         alt="Training Example"
                         class="ml-training-image">

                    <!-- Image Tools -->
                    <div class="ml-image-tools">
                        <button class="ml-tool-btn" id="zoom-in" title="Zoom In">
                            <i class="material-icons">zoom_in</i>
                        </button>
                        <button class="ml-tool-btn" id="zoom-out" title="Zoom Out">
                            <i class="material-icons">zoom_out</i>
                        </button>
                        <button class="ml-tool-btn" id="reset-zoom" title="Reset Zoom">
                            <i class="material-icons">center_focus_strong</i>
                        </button>
                        <button class="ml-tool-btn" id="rotate-image" title="Rotate">
                            <i class="material-icons">rotate_right</i>
                        </button>
                        <button class="ml-tool-btn" id="enhance-contrast" title="Enhance Contrast">
                            <i class="material-icons">tune</i>
                        </button>
                    </div>

                    <!-- Image Metadata -->
                    <div class="ml-image-metadata">
                        <div class="ml-metadata-item">
                            <span class="ml-metadata-label">Confidence:</span>
                            <div class="ml-confidence-indicator">
                                <div class="ml-confidence-bar">
                                    <div class="ml-confidence-fill"
                                         style="width: {{ current_example.uncertainty_score|add:0.0|floatformat:0 }}%"></div>
                                </div>
                                <span class="ml-confidence-text">
                                    {{ current_example.uncertainty_score|floatformat:2 }}
                                </span>
                            </div>
                        </div>
                        <div class="ml-metadata-item">
                            <span class="ml-metadata-label">Source:</span>
                            <span class="ml-metadata-value">{{ current_example.source_system|default:"Upload" }}</span>
                        </div>
                        <div class="ml-metadata-item">
                            <span class="ml-metadata-label">Priority:</span>
                            <span class="ml-priority-badge ml-priority-{{ current_example.labeling_priority|default:5 }}">
                                {{ current_example.labeling_priority|default:5 }}
                            </span>
                        </div>
                    </div>
                {% else %}
                    <div class="ml-no-image">
                        <i class="material-icons">image_not_supported</i>
                        <p>No image available</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Labeling Panel -->
        <div class="ml-labeling-panel">
            <form id="labeling-form" method="post" class="ml-labeling-form">
                {% csrf_token %}
                <input type="hidden" name="example_id" value="{{ current_example.id }}">

                <!-- Ground Truth Input -->
                <div class="ml-form-group">
                    <label for="ground-truth" class="ml-form-label">
                        <i class="material-icons">text_fields</i>
                        Ground Truth Text
                    </label>
                    <div class="ml-input-wrapper">
                        <textarea id="ground-truth"
                                  name="ground_truth_text"
                                  class="ml-textarea ml-ground-truth"
                                  placeholder="Enter the correct text reading..."
                                  rows="3">{{ current_example.ground_truth_text }}</textarea>
                        <div class="ml-input-actions">
                            <button type="button" class="ml-action-btn" id="clear-text" title="Clear">
                                <i class="material-icons">clear</i>
                            </button>
                            <button type="button" class="ml-action-btn" id="paste-clipboard" title="Paste">
                                <i class="material-icons">content_paste</i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions for Common Values -->
                {% if task.dataset.dataset_type == "OCR_METERS" %}
                <div class="ml-quick-actions">
                    <label class="ml-form-label">Quick Values:</label>
                    <div class="ml-quick-buttons">
                        <button type="button" class="ml-quick-btn" data-value="0000">0000</button>
                        <button type="button" class="ml-quick-btn" data-value="ERROR">ERROR</button>
                        <button type="button" class="ml-quick-btn" data-value="BLOCKED">BLOCKED</button>
                        <button type="button" class="ml-quick-btn" data-value="UNCLEAR">UNCLEAR</button>
                    </div>
                </div>
                {% elif task.dataset.dataset_type == "OCR_LICENSE_PLATES" %}
                <div class="ml-quick-actions">
                    <label class="ml-form-label">Quick Actions:</label>
                    <div class="ml-quick-buttons">
                        <button type="button" class="ml-quick-btn" data-value="TEMP">TEMP</button>
                        <button type="button" class="ml-quick-btn" data-value="DEALER">DEALER</button>
                        <button type="button" class="ml-quick-btn" data-value="UNCLEAR">UNCLEAR</button>
                        <button type="button" class="ml-quick-btn" data-value="FOREIGN">FOREIGN</button>
                    </div>
                </div>
                {% endif %}

                <!-- Labeling Quality Controls -->
                <div class="ml-form-group">
                    <label class="ml-form-label">
                        <i class="material-icons">verified</i>
                        Quality Assessment
                    </label>
                    <div class="ml-quality-controls">
                        <div class="ml-quality-item">
                            <input type="checkbox" id="is-confident" name="is_confident" class="ml-checkbox">
                            <label for="is-confident">High Confidence</label>
                        </div>
                        <div class="ml-quality-item">
                            <input type="checkbox" id="needs-review" name="needs_review" class="ml-checkbox">
                            <label for="needs-review">Needs Review</label>
                        </div>
                        <div class="ml-quality-item">
                            <input type="checkbox" id="is-difficult" name="is_difficult" class="ml-checkbox">
                            <label for="is-difficult">Difficult Case</label>
                        </div>
                    </div>
                </div>

                <!-- Additional Notes -->
                <div class="ml-form-group">
                    <label for="labeling-notes" class="ml-form-label">
                        <i class="material-icons">note</i>
                        Notes (Optional)
                    </label>
                    <textarea id="labeling-notes"
                              name="labeling_notes"
                              class="ml-textarea ml-notes"
                              placeholder="Add any notes about this example..."
                              rows="2"></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="ml-action-bar">
                    <div class="ml-primary-actions">
                        <button type="button" id="skip-example" class="ml-btn ml-btn-secondary">
                            <i class="material-icons">skip_next</i>
                            Skip
                        </button>
                        <button type="submit" id="save-label" class="ml-btn ml-btn-primary">
                            <i class="material-icons">save</i>
                            Save & Next
                        </button>
                    </div>
                    <div class="ml-navigation-actions">
                        <button type="button" id="previous-example" class="ml-btn ml-btn-outline"
                                {% if not task.has_previous %}disabled{% endif %}>
                            <i class="material-icons">chevron_left</i>
                            Previous
                        </button>
                    </div>
                </div>
            </form>

            <!-- Keyboard Shortcuts Help -->
            <div class="ml-shortcuts-panel">
                <button class="ml-shortcuts-toggle" id="shortcuts-toggle">
                    <i class="material-icons">keyboard</i>
                    Shortcuts
                </button>
                <div class="ml-shortcuts-content" id="shortcuts-content">
                    <div class="ml-shortcut-item">
                        <kbd>Enter</kbd>
                        <span>Save & Next</span>
                    </div>
                    <div class="ml-shortcut-item">
                        <kbd>Ctrl + S</kbd>
                        <span>Save Label</span>
                    </div>
                    <div class="ml-shortcut-item">
                        <kbd>Space</kbd>
                        <span>Skip Example</span>
                    </div>
                    <div class="ml-shortcut-item">
                        <kbd>Ctrl + Z</kbd>
                        <span>Undo</span>
                    </div>
                    <div class="ml-shortcut-item">
                        <kbd>+/-</kbd>
                        <span>Zoom In/Out</span>
                    </div>
                    <div class="ml-shortcut-item">
                        <kbd>R</kbd>
                        <span>Rotate Image</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Panel -->
    <div class="ml-stats-panel">
        <div class="ml-session-stats">
            <div class="ml-stat-item">
                <span class="ml-stat-value" id="session-labeled">0</span>
                <span class="ml-stat-label">Labeled This Session</span>
            </div>
            <div class="ml-stat-item">
                <span class="ml-stat-value" id="session-time">00:00</span>
                <span class="ml-stat-label">Session Time</span>
            </div>
            <div class="ml-stat-item">
                <span class="ml-stat-value" id="avg-time">0s</span>
                <span class="ml-stat-label">Avg Time/Label</span>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="ml-loading-overlay">
    <div class="ml-loading-content">
        <div class="ml-loading-spinner"></div>
        <p>Saving label...</p>
    </div>
</div>

<!-- Success/Error Toast -->
<div id="toast-container" class="ml-toast-container"></div>

<script>
class LabelingInterface {
    constructor() {
        this.sessionStartTime = Date.now();
        this.sessionLabeledCount = 0;
        this.labelTimes = [];
        this.currentZoom = 1;
        this.currentRotation = 0;

        this.initializeInterface();
        this.setupEventListeners();
        this.startSessionTimer();
    }

    initializeInterface() {
        // Initialize image viewer
        this.initializeImageViewer();

        // Setup form validation
        this.setupFormValidation();

        // Initialize keyboard shortcuts
        this.initializeKeyboardShortcuts();

        // Load user preferences
        this.loadUserPreferences();
    }

    setupEventListeners() {
        const form = document.getElementById('labeling-form');
        const skipBtn = document.getElementById('skip-example');
        const quickBtns = document.querySelectorAll('.ml-quick-btn');
        const imageTools = document.querySelectorAll('.ml-tool-btn');

        // Form submission
        form.addEventListener('submit', (e) => this.handleFormSubmit(e));

        // Skip button
        skipBtn.addEventListener('click', () => this.skipExample());

        // Quick value buttons
        quickBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const value = btn.dataset.value;
                document.getElementById('ground-truth').value = value;
                this.validateForm();
            });
        });

        // Image tools
        document.getElementById('zoom-in').addEventListener('click', () => this.zoomImage(1.2));
        document.getElementById('zoom-out').addEventListener('click', () => this.zoomImage(0.8));
        document.getElementById('reset-zoom').addEventListener('click', () => this.resetImage());
        document.getElementById('rotate-image').addEventListener('click', () => this.rotateImage());
        document.getElementById('enhance-contrast').addEventListener('click', () => this.enhanceImage());

        // Shortcuts toggle
        document.getElementById('shortcuts-toggle').addEventListener('click', () => {
            this.toggleShortcuts();
        });

        // Auto-save functionality
        const groundTruthInput = document.getElementById('ground-truth');
        groundTruthInput.addEventListener('input', () => {
            this.validateForm();
            this.autoSaveDraft();
        });
    }

    initializeImageViewer() {
        const image = document.getElementById('labeling-image');
        if (!image) return;

        // Enable pan and zoom
        let isPanning = false;
        let startX, startY, translateX = 0, translateY = 0;

        image.addEventListener('mousedown', (e) => {
            isPanning = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            image.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isPanning) return;

            translateX = e.clientX - startX;
            translateY = e.clientY - startY;

            this.updateImageTransform();
        });

        document.addEventListener('mouseup', () => {
            isPanning = false;
            image.style.cursor = 'grab';
        });

        // Mouse wheel zoom
        image.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            this.zoomImage(zoomFactor);
        });
    }

    updateImageTransform() {
        const image = document.getElementById('labeling-image');
        if (image) {
            image.style.transform = `scale(${this.currentZoom}) rotate(${this.currentRotation}deg) translate(${translateX}px, ${translateY}px)`;
        }
    }

    zoomImage(factor) {
        this.currentZoom *= factor;
        this.currentZoom = Math.max(0.1, Math.min(5, this.currentZoom));
        this.updateImageTransform();
    }

    rotateImage() {
        this.currentRotation += 90;
        if (this.currentRotation >= 360) this.currentRotation = 0;
        this.updateImageTransform();
    }

    resetImage() {
        this.currentZoom = 1;
        this.currentRotation = 0;
        translateX = 0;
        translateY = 0;
        this.updateImageTransform();
    }

    enhanceImage() {
        const image = document.getElementById('labeling-image');
        if (image) {
            // Toggle contrast enhancement
            const isEnhanced = image.style.filter.includes('contrast');
            if (isEnhanced) {
                image.style.filter = '';
            } else {
                image.style.filter = 'contrast(1.5) brightness(1.1) saturate(1.2)';
            }
        }
    }

    initializeKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Don't trigger shortcuts when typing in inputs
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    this.submitForm();
                }
                return;
            }

            switch(e.key.toLowerCase()) {
                case 'enter':
                    if (!e.ctrlKey) {
                        e.preventDefault();
                        this.submitForm();
                    }
                    break;
                case ' ':
                    e.preventDefault();
                    this.skipExample();
                    break;
                case '+':
                case '=':
                    e.preventDefault();
                    this.zoomImage(1.2);
                    break;
                case '-':
                    e.preventDefault();
                    this.zoomImage(0.8);
                    break;
                case 'r':
                    e.preventDefault();
                    this.rotateImage();
                    break;
                case 's':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        this.saveDraft();
                    }
                    break;
            }
        });
    }

    validateForm() {
        const groundTruth = document.getElementById('ground-truth').value.trim();
        const saveBtn = document.getElementById('save-label');

        if (groundTruth.length > 0) {
            saveBtn.disabled = false;
            saveBtn.classList.remove('ml-btn-disabled');
        } else {
            saveBtn.disabled = true;
            saveBtn.classList.add('ml-btn-disabled');
        }
    }

    async handleFormSubmit(e) {
        e.preventDefault();

        const startTime = Date.now();
        this.showLoading(true);

        try {
            const formData = new FormData(e.target);
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });

            if (response.ok) {
                const labelTime = Date.now() - startTime;
                this.recordLabelTime(labelTime);
                this.showToast('Label saved successfully!', 'success');

                // Redirect to next example or completion page
                const result = await response.json();
                if (result.next_url) {
                    window.location.href = result.next_url;
                } else {
                    this.showToast('Task completed!', 'success');
                    setTimeout(() => {
                        window.location.href = "{% url 'ml_training:labeling_dashboard' %}";
                    }, 2000);
                }
            } else {
                throw new Error('Failed to save label');
            }
        } catch (error) {
            this.showToast('Error saving label. Please try again.', 'error');
            console.error('Error:', error);
        } finally {
            this.showLoading(false);
        }
    }

    skipExample() {
        if (confirm('Are you sure you want to skip this example?')) {
            // Mark as skipped and move to next
            this.showToast('Example skipped', 'info');
            // Implementation would handle skipping logic
        }
    }

    recordLabelTime(time) {
        this.labelTimes.push(time);
        this.sessionLabeledCount++;
        this.updateSessionStats();
    }

    updateSessionStats() {
        const sessionTime = Date.now() - this.sessionStartTime;
        const avgTime = this.labelTimes.length > 0 ?
            this.labelTimes.reduce((a, b) => a + b, 0) / this.labelTimes.length : 0;

        document.getElementById('session-labeled').textContent = this.sessionLabeledCount;
        document.getElementById('avg-time').textContent = Math.round(avgTime / 1000) + 's';
    }

    startSessionTimer() {
        setInterval(() => {
            const elapsed = Date.now() - this.sessionStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('session-time').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }

    showLoading(show) {
        const overlay = document.getElementById('loading-overlay');
        overlay.style.display = show ? 'flex' : 'none';
    }

    showToast(message, type) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `ml-toast ml-toast-${type}`;
        toast.innerHTML = `
            <i class="material-icons">
                ${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}
            </i>
            <span>${message}</span>
        `;

        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 100);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => container.removeChild(toast), 300);
        }, 3000);
    }

    toggleShortcuts() {
        const content = document.getElementById('shortcuts-content');
        content.classList.toggle('show');
    }

    autoSaveDraft() {
        clearTimeout(this.draftTimeout);
        this.draftTimeout = setTimeout(() => {
            this.saveDraft();
        }, 2000);
    }

    saveDraft() {
        const groundTruth = document.getElementById('ground-truth').value;
        const notes = document.getElementById('labeling-notes').value;

        localStorage.setItem('ml_labeling_draft', JSON.stringify({
            groundTruth,
            notes,
            timestamp: Date.now()
        }));
    }

    loadUserPreferences() {
        // Load any saved preferences
        const draft = localStorage.getItem('ml_labeling_draft');
        if (draft) {
            try {
                const data = JSON.parse(draft);
                // Only load if recent (within 1 hour)
                if (Date.now() - data.timestamp < 3600000) {
                    document.getElementById('ground-truth').value = data.groundTruth || '';
                    document.getElementById('labeling-notes').value = data.notes || '';
                }
            } catch (e) {
                console.warn('Failed to load draft:', e);
            }
        }
    }
}

// Initialize the labeling interface when the page loads
document.addEventListener('DOMContentLoaded', function() {
    new LabelingInterface();
});
</script>

<style>
/* Labeling Interface Specific Styles */
.ml-labeling-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px;
}

.ml-labeling-header {
    background: var(--ml-bg-card);
    border-radius: var(--ml-border-radius-lg);
    padding: 24px;
    margin-bottom: 24px;
    border: 1px solid var(--ml-border-light);
}

.ml-task-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 8px;
}

.ml-task-name {
    font-weight: 600;
    color: var(--ml-primary);
}

.ml-task-dataset {
    font-size: 0.875rem;
    color: var(--ml-text-secondary);
}

.ml-labeling-workspace {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 24px;
    margin-bottom: 24px;
}

/* Image Panel */
.ml-image-panel {
    background: var(--ml-bg-card);
    border-radius: var(--ml-border-radius-lg);
    border: 1px solid var(--ml-border-light);
    overflow: hidden;
}

.ml-image-container {
    position: relative;
    height: 600px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
}

.ml-training-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    cursor: grab;
    transition: transform 0.2s ease;
    border-radius: var(--ml-border-radius);
}

.ml-image-tools {
    position: absolute;
    top: 16px;
    right: 16px;
    display: flex;
    gap: 8px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: var(--ml-border-radius);
    padding: 8px;
    backdrop-filter: blur(8px);
}

.ml-tool-btn {
    width: 36px;
    height: 36px;
    border: none;
    border-radius: var(--ml-border-radius);
    background: transparent;
    color: var(--ml-text-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.ml-tool-btn:hover {
    background: var(--ml-primary);
    color: white;
    transform: scale(1.05);
}

.ml-image-metadata {
    position: absolute;
    bottom: 16px;
    left: 16px;
    right: 16px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: var(--ml-border-radius);
    padding: 16px;
    backdrop-filter: blur(8px);
}

.ml-metadata-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.ml-metadata-item:last-child {
    margin-bottom: 0;
}

.ml-metadata-label {
    font-size: 0.875rem;
    color: var(--ml-text-secondary);
    font-weight: 500;
}

.ml-confidence-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
}

.ml-confidence-bar {
    width: 80px;
    height: 6px;
    background: var(--ml-bg-secondary);
    border-radius: 3px;
    overflow: hidden;
}

.ml-confidence-fill {
    height: 100%;
    background: var(--ml-gradient-primary);
    transition: width 0.3s ease;
}

.ml-confidence-text {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--ml-text-primary);
    min-width: 32px;
}

.ml-priority-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    background: var(--ml-warning);
    color: white;
}

.ml-no-image {
    text-align: center;
    color: var(--ml-text-secondary);
}

.ml-no-image .material-icons {
    font-size: 48px;
    margin-bottom: 8px;
}

/* Labeling Panel */
.ml-labeling-panel {
    background: var(--ml-bg-card);
    border-radius: var(--ml-border-radius-lg);
    border: 1px solid var(--ml-border-light);
    padding: 24px;
    height: fit-content;
}

.ml-labeling-form {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.ml-form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.ml-form-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: var(--ml-text-primary);
    font-size: 0.875rem;
}

.ml-input-wrapper {
    position: relative;
}

.ml-ground-truth {
    width: 100%;
    min-height: 80px;
    padding: 12px;
    border: 2px solid var(--ml-border-light);
    border-radius: var(--ml-border-radius);
    background: var(--ml-bg-primary);
    color: var(--ml-text-primary);
    font-family: 'Inter', monospace;
    font-size: 0.875rem;
    resize: vertical;
    transition: border-color 0.2s ease;
}

.ml-ground-truth:focus {
    outline: none;
    border-color: var(--ml-primary);
    box-shadow: 0 0 0 3px rgba(76, 132, 255, 0.1);
}

.ml-input-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 4px;
}

.ml-action-btn {
    width: 24px;
    height: 24px;
    border: none;
    border-radius: 4px;
    background: var(--ml-bg-secondary);
    color: var(--ml-text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s ease;
}

.ml-action-btn:hover {
    background: var(--ml-primary);
    color: white;
}

.ml-quick-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.ml-quick-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.ml-quick-btn {
    padding: 8px 12px;
    border: 1px solid var(--ml-border-light);
    border-radius: var(--ml-border-radius);
    background: var(--ml-bg-primary);
    color: var(--ml-text-primary);
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.ml-quick-btn:hover {
    background: var(--ml-primary);
    color: white;
    border-color: var(--ml-primary);
}

.ml-quality-controls {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.ml-quality-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.ml-checkbox {
    width: 16px;
    height: 16px;
    accent-color: var(--ml-primary);
}

.ml-notes {
    width: 100%;
    min-height: 60px;
    padding: 12px;
    border: 1px solid var(--ml-border-light);
    border-radius: var(--ml-border-radius);
    background: var(--ml-bg-primary);
    color: var(--ml-text-primary);
    font-family: 'Inter', sans-serif;
    font-size: 0.875rem;
    resize: vertical;
}

.ml-action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 16px;
    border-top: 1px solid var(--ml-border-light);
}

.ml-primary-actions {
    display: flex;
    gap: 12px;
}

/* Shortcuts Panel */
.ml-shortcuts-panel {
    margin-top: 24px;
    position: relative;
}

.ml-shortcuts-toggle {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--ml-border-light);
    border-radius: var(--ml-border-radius);
    background: var(--ml-bg-secondary);
    color: var(--ml-text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.ml-shortcuts-toggle:hover {
    background: var(--ml-bg-hover);
    color: var(--ml-text-primary);
}

.ml-shortcuts-content {
    position: absolute;
    bottom: 100%;
    left: 0;
    right: 0;
    background: var(--ml-bg-card);
    border: 1px solid var(--ml-border-light);
    border-radius: var(--ml-border-radius);
    box-shadow: var(--ml-shadow-dropdown);
    padding: 16px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(8px);
    transition: all 0.2s ease;
    z-index: 1000;
}

.ml-shortcuts-content.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.ml-shortcut-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    font-size: 0.75rem;
}

.ml-shortcut-item kbd {
    background: var(--ml-bg-secondary);
    border: 1px solid var(--ml-border-light);
    border-radius: 4px;
    padding: 2px 6px;
    font-family: monospace;
    font-size: 0.7rem;
}

/* Stats Panel */
.ml-stats-panel {
    background: var(--ml-bg-card);
    border-radius: var(--ml-border-radius-lg);
    border: 1px solid var(--ml-border-light);
    padding: 24px;
}

.ml-session-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
}

/* Loading and Toast */
.ml-loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.ml-loading-content {
    background: var(--ml-bg-card);
    border-radius: var(--ml-border-radius-lg);
    padding: 32px;
    text-align: center;
    color: var(--ml-text-primary);
}

.ml-loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--ml-border-light);
    border-top: 4px solid var(--ml-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.ml-toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9998;
}

.ml-toast {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: var(--ml-bg-card);
    border: 1px solid var(--ml-border-light);
    border-radius: var(--ml-border-radius);
    box-shadow: var(--ml-shadow-dropdown);
    margin-bottom: 8px;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
}

.ml-toast.show {
    opacity: 1;
    transform: translateX(0);
}

.ml-toast-success {
    border-left: 4px solid var(--ml-success);
}

.ml-toast-error {
    border-left: 4px solid var(--ml-error);
}

.ml-toast-info {
    border-left: 4px solid var(--ml-info);
}

/* Responsive Design */
@media (max-width: 1024px) {
    .ml-labeling-workspace {
        grid-template-columns: 1fr;
        gap: 16px;
    }

    .ml-image-container {
        height: 400px;
    }

    .ml-session-stats {
        grid-template-columns: 1fr;
        gap: 16px;
    }
}

@media (max-width: 768px) {
    .ml-labeling-container {
        padding: 16px;
    }

    .ml-quick-buttons {
        grid-template-columns: 1fr;
    }

    .ml-action-bar {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
    }

    .ml-primary-actions {
        order: 2;
    }
}
</style>
{% endblock %}