{% extends "admin/base_modern_admin.html" %}
{% load static %}

{% block title %}EXIF Analytics Dashboard - Photo Authenticity Monitoring{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .dashboard-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #e0e0e0;
    }

    .dashboard-card h3 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stat-value {
        font-size: 36px;
        font-weight: bold;
        color: #2196F3;
        margin: 10px 0;
    }

    .stat-label {
        color: #666;
        font-size: 14px;
        margin-bottom: 5px;
    }

    .risk-high { color: #f44336; }
    .risk-medium { color: #ff9800; }
    .risk-low { color: #4caf50; }

    .trend-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }

    .trend-increasing { background: #ffebee; color: #d32f2f; }
    .trend-decreasing { background: #e8f5e8; color: #388e3c; }
    .trend-stable { background: #e3f2fd; color: #1976d2; }

    .device-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
    }

    .device-item {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .device-info {
        flex: 1;
    }

    .device-name {
        font-weight: bold;
        margin-bottom: 4px;
    }

    .device-stats {
        font-size: 12px;
        color: #666;
    }

    .trust-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        text-transform: uppercase;
    }

    .trust-trusted { background: #e8f5e8; color: #388e3c; }
    .trust-neutral { background: #e3f2fd; color: #1976d2; }
    .trust-suspicious { background: #fff3e0; color: #f57c00; }
    .trust-blocked { background: #ffebee; color: #d32f2f; }

    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 20px;
    }

    .time-selector {
        margin-bottom: 20px;
    }

    .time-selector select {
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        margin-right: 10px;
    }

    .alert-box {
        padding: 15px;
        margin-bottom: 20px;
        border-left: 4px solid;
        border-radius: 4px;
    }

    .alert-warning {
        background: #fff8e1;
        border-color: #ff9800;
        color: #e65100;
    }

    .alert-error {
        background: #ffebee;
        border-color: #f44336;
        color: #c62828;
    }

    .alert-success {
        background: #e8f5e8;
        border-color: #4caf50;
        color: #2e7d32;
    }

    .refresh-button {
        background: #2196F3;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
    }

    .refresh-button:hover {
        background: #1976D2;
    }

    .export-button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
    }

    .export-button:hover {
        background: #388e3c;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>üìä EXIF Analytics Dashboard - Photo Authenticity Monitoring</h1>

    <div class="time-selector">
        <select id="timePeriod" onchange="updateDashboard()">
            <option value="7" {% if time_period == 7 %}selected{% endif %}>Last 7 Days</option>
            <option value="30" {% if time_period == 30 %}selected{% endif %}>Last 30 Days</option>
            <option value="90" {% if time_period == 90 %}selected{% endif %}>Last 90 Days</option>
        </select>
        <button class="refresh-button" onclick="refreshDashboard()">üîÑ Refresh</button>
        <button class="export-button" onclick="exportReport()">üì• Export Report</button>
    </div>
</div>

{% if error %}
    <div class="alert-box alert-error">
        <strong>‚ö†Ô∏è Dashboard Error:</strong> {{ error }}
    </div>
{% endif %}

<!-- Summary Statistics -->
{% if summary_stats %}
<div class="dashboard-grid">
    <div class="dashboard-card">
        <h3>üì∏ Total Photos Analyzed</h3>
        <div class="stat-value">{{ summary_stats.total_photos|default:"0" }}</div>
        <div class="stat-label">in {{ time_period }} days</div>
        {% if summary_stats.gps_coverage_percentage %}
            <div class="stat-label">{{ summary_stats.gps_coverage_percentage }}% with GPS data</div>
        {% endif %}
    </div>

    <div class="dashboard-card">
        <h3>üéØ Average Authenticity Score</h3>
        <div class="stat-value {% if summary_stats.avg_authenticity_score >= 0.8 %}risk-low{% elif summary_stats.avg_authenticity_score >= 0.5 %}risk-medium{% else %}risk-high{% endif %}">
            {{ summary_stats.avg_authenticity_score|floatformat:3 }}
        </div>
        <div class="stat-label">0.0 = fake, 1.0 = authentic</div>
    </div>

    <div class="dashboard-card">
        <h3>‚ö†Ô∏è High Risk Photos</h3>
        <div class="stat-value risk-high">{{ summary_stats.high_risk_photos|default:"0" }}</div>
        <div class="stat-label">
            {% if summary_stats.high_risk_percentage %}{{ summary_stats.high_risk_percentage }}% of total{% endif %}
        </div>
        {% if summary_stats.high_risk_percentage > 10 %}
            <div class="trend-indicator trend-increasing">‚ö†Ô∏è Above threshold</div>
        {% endif %}
    </div>

    <div class="dashboard-card">
        <h3>üì± Active Camera Devices</h3>
        <div class="stat-value">{{ summary_stats.unique_devices|default:"0" }}</div>
        <div class="stat-label">{{ summary_stats.flagged_devices|default:"0" }} flagged as suspicious</div>
    </div>
</div>
{% endif %}

<!-- Fraud Trends -->
{% if fraud_trends %}
<div class="dashboard-card">
    <h3>üìà Fraud Detection Trends
        {% if fraud_trends.trend_summary.trend %}
            <span class="trend-indicator trend-{{ fraud_trends.trend_summary.trend }}">
                {% if fraud_trends.trend_summary.trend == 'increasing' %}üìà Increasing
                {% elif fraud_trends.trend_summary.trend == 'decreasing' %}üìâ Decreasing
                {% else %}‚û°Ô∏è Stable{% endif %}
                {% if fraud_trends.trend_summary.change_percentage %}({{ fraud_trends.trend_summary.change_percentage }}%){% endif %}
            </span>
        {% endif %}
    </h3>
    <div class="chart-container">
        <canvas id="fraudTrendChart"></canvas>
    </div>
</div>
{% endif %}

<!-- Device Analytics -->
{% if device_analytics %}
<div class="dashboard-grid">
    <div class="dashboard-card">
        <h3>üì± Camera Device Analytics</h3>
        <div class="device-list">
            {% for device in device_analytics.top_devices %}
                <div class="device-item">
                    <div class="device-info">
                        <div class="device-name">{{ device.camera_make }} {{ device.camera_model }}</div>
                        <div class="device-stats">
                            Usage: {{ device.usage_count }} |
                            Users: {{ device.associated_users }} |
                            Fraud: {{ device.fraud_incidents }}
                        </div>
                    </div>
                    <div class="trust-badge trust-{{ device.trust_level }}">
                        {{ device.trust_level }}
                    </div>
                </div>
            {% endfor %}
        </div>

        {% if device_analytics.high_risk_devices > 0 %}
            <div class="alert-box alert-warning" style="margin-top: 15px;">
                ‚ö†Ô∏è {{ device_analytics.high_risk_devices }} high-risk device(s) detected
            </div>
        {% endif %}
    </div>

    <div class="dashboard-card">
        <h3>üîç Device Trust Distribution</h3>
        <div class="chart-container">
            <canvas id="deviceTrustChart"></canvas>
        </div>
    </div>
</div>
{% endif %}

<!-- Location Analytics -->
{% if location_analytics %}
<div class="dashboard-grid">
    <div class="dashboard-card">
        <h3>üó∫Ô∏è GPS Location Validation</h3>
        <div class="stat-value">{{ location_analytics.photos_with_gps|default:"0" }}</div>
        <div class="stat-label">photos with GPS coordinates</div>

        <div style="margin-top: 20px;">
            <div class="stat-label">Location Validations:</div>
            {% for result in location_analytics.validation_results %}
                <div style="margin: 8px 0;">
                    <span class="trust-badge trust-{% if result.validation_result == 'passed' %}trusted{% elif result.validation_result == 'failed' %}blocked{% else %}suspicious{% endif %}">
                        {{ result.validation_result|title }}: {{ result.count }}
                    </span>
                </div>
            {% endfor %}
        </div>

        {% if location_analytics.failed_validations > 0 %}
            <div class="alert-box alert-warning" style="margin-top: 15px;">
                ‚ö†Ô∏è {{ location_analytics.failed_validations }} location validation(s) failed
            </div>
        {% endif %}
    </div>

    <div class="dashboard-card">
        <h3>üìç GPS Coverage Summary</h3>
        {% if location_analytics.gps_coverage_areas %}
            <div class="stat-value">{{ location_analytics.gps_coverage_areas.unique_locations }}</div>
            <div class="stat-label">unique locations captured</div>

            {% if location_analytics.gps_coverage_areas.altitude_range.min %}
                <div style="margin-top: 15px;">
                    <div class="stat-label">Altitude Range:</div>
                    <div>{{ location_analytics.gps_coverage_areas.altitude_range.min|floatformat:1 }}m - {{ location_analytics.gps_coverage_areas.altitude_range.max|floatformat:1 }}m</div>
                </div>
            {% endif %}
        {% else %}
            <div class="stat-label">No GPS coverage data available</div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Real-time Status -->
<div class="dashboard-card">
    <h3>‚ö° Real-time Status</h3>
    <div id="realTimeStatus">
        <div class="stat-label">Last updated: <span id="lastUpdate">{{ "now"|date:"H:i:s" }}</span></div>
        <div style="margin-top: 10px;">
            <button class="refresh-button" onclick="updateRealTimeData()">üîÑ Update Now</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // Initialize charts
    let fraudTrendChart, deviceTrustChart;

    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        startAutoRefresh();
    });

    function initializeCharts() {
        // Fraud Trend Chart
        {% if fraud_trends.daily_trends %}
        const fraudCtx = document.getElementById('fraudTrendChart').getContext('2d');
        fraudTrendChart = new Chart(fraudCtx, {
            type: 'line',
            data: {
                labels: [{% for day in fraud_trends.daily_trends %}'{{ day.date }}'{% if not forloop.last %},{% endif %}{% endfor %}],
                datasets: [{
                    label: 'High Risk Photos',
                    data: [{% for day in fraud_trends.daily_trends %}{{ day.high_risk_photos }}{% if not forloop.last %},{% endif %}{% endfor %}],
                    borderColor: '#f44336',
                    backgroundColor: 'rgba(244, 67, 54, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Total Photos',
                    data: [{% for day in fraud_trends.daily_trends %}{{ day.total_photos }}{% if not forloop.last %},{% endif %}{% endfor %}],
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        {% endif %}

        // Device Trust Chart
        {% if device_analytics.trust_distribution %}
        const deviceCtx = document.getElementById('deviceTrustChart').getContext('2d');
        deviceTrustChart = new Chart(deviceCtx, {
            type: 'doughnut',
            data: {
                labels: [{% for item in device_analytics.trust_distribution %}'{{ item.trust_level|title }}'{% if not forloop.last %},{% endif %}{% endfor %}],
                datasets: [{
                    data: [{% for item in device_analytics.trust_distribution %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                    backgroundColor: [
                        '#4caf50',  // trusted
                        '#2196F3',  // neutral
                        '#ff9800',  // suspicious
                        '#f44336'   // blocked
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        {% endif %}
    }

    function updateDashboard() {
        const days = document.getElementById('timePeriod').value;
        window.location.href = `?days=${days}`;
    }

    function refreshDashboard() {
        location.reload();
    }

    function exportReport() {
        const days = document.getElementById('timePeriod').value;
        window.open(`/core/admin/photo-authenticity-report/?days=${days}&format=json`, '_blank');
    }

    function updateRealTimeData() {
        fetch('/core/admin/exif-analytics-api/?endpoint=summary&days=1')
            .then(response => response.json())
            .then(data => {
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

                // Update real-time stats if needed
                if (data.total_photos !== undefined) {
                    const statusDiv = document.getElementById('realTimeStatus');
                    statusDiv.innerHTML += `<div style="margin-top: 10px;">
                        <div class="stat-label">Last 24h: ${data.total_photos} photos, ${data.high_risk_count} high risk</div>
                    </div>`;
                }
            })
            .catch(error => {
                console.error('Failed to update real-time data:', error);
            });
    }

    function startAutoRefresh() {
        // Auto-refresh every 5 minutes
        setInterval(updateRealTimeData, 5 * 60 * 1000);
    }
</script>
{% endblock %}