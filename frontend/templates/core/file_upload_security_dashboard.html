{% extends "base.html" %}
{% load static %}

{% block title %}File Upload Security Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-shield-alt"></i> File Upload Security Dashboard</h2>
            <p class="text-muted">Real-time monitoring of file upload security events</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body">
                    <h6 class="card-title text-muted">Total Uploads (7 days)</h6>
                    <h3 class="mb-0">{{ dashboard_data.upload_stats.summary.total_uploads|default:0 }}</h3>
                    <small class="text-success">
                        <i class="fas fa-check-circle"></i>
                        {{ dashboard_data.upload_stats.summary.successful_uploads|default:0 }} successful
                    </small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body">
                    <h6 class="card-title text-muted">Failed Uploads</h6>
                    <h3 class="mb-0 text-warning">{{ dashboard_data.upload_stats.summary.failed_uploads|default:0 }}</h3>
                    <small class="text-muted">Validation or system errors</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-danger">
                <div class="card-body">
                    <h6 class="card-title text-muted">Security Incidents</h6>
                    <h3 class="mb-0 text-danger">{{ dashboard_data.upload_stats.summary.malware_detected|default:0 }}</h3>
                    <small class="text-danger">
                        <i class="fas fa-virus"></i> Malware detected
                    </small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-danger">
                <div class="card-body">
                    <h6 class="card-title text-muted">Attack Attempts</h6>
                    <h3 class="mb-0 text-danger">{{ dashboard_data.upload_stats.summary.path_traversal_attempts|default:0 }}</h3>
                    <small class="text-danger">
                        <i class="fas fa-exclamation-triangle"></i> Path traversal blocked
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Upload Trends (7 Days)</h5>
                </div>
                <div class="card-body">
                    <canvas id="uploadTrendsChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-file"></i> File Type Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="fileTypeChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5><i class="fas fa-exclamation-circle"></i> Recent Security Incidents ({{ hours_displayed }} hours)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Event</th>
                                    <th>Severity</th>
                                    <th>User</th>
                                    <th>IP Address</th>
                                    <th>Filename</th>
                                    <th>Details</th>
                                    <th>Correlation ID</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for incident in dashboard_data.recent_incidents %}
                                <tr class="{% if incident.severity == 'CRITICAL' %}table-danger{% elif incident.severity == 'ERROR' %}table-warning{% endif %}">
                                    <td>{{ incident.timestamp|date:"Y-m-d H:i:s" }}</td>
                                    <td><span class="badge badge-{{ incident.severity|lower }}">{{ incident.event_type }}</span></td>
                                    <td>{{ incident.severity }}</td>
                                    <td>{{ incident.user__peoplename|default:"Anonymous" }}</td>
                                    <td><code>{{ incident.ip_address }}</code></td>
                                    <td><code>{{ incident.filename|truncatechars:30 }}</code></td>
                                    <td>{{ incident.error_message|truncatechars:50 }}</td>
                                    <td><small><code>{{ incident.correlation_id }}</code></small></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-success">
                                        <i class="fas fa-check-circle"></i> No security incidents in the last {{ hours_displayed }} hours
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div id="recentActivityLog" style="max-height: 400px; overflow-y: auto;">
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="fas fa-lock"></i> Quarantined Files</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Files flagged for manual review</p>
                    <a href="{% url 'quarantined-files' %}" class="btn btn-warning">
                        <i class="fas fa-folder-open"></i> Manage Quarantined Files
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dashboardData = {{ dashboard_data|escapejs }};

    if (dashboardData.upload_stats && dashboardData.upload_stats.daily_trends) {
        const trendsData = dashboardData.upload_stats.daily_trends;

        const trendsChart = new Chart(
            document.getElementById('uploadTrendsChart'),
            {
                type: 'line',
                data: {
                    labels: trendsData.map(d => d.date),
                    datasets: [
                        {
                            label: 'Successful',
                            data: trendsData.map(d => d.successful),
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        },
                        {
                            label: 'Failed',
                            data: trendsData.map(d => d.failed),
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'File Upload Trends'
                        }
                    }
                }
            }
        );
    }

    if (dashboardData.upload_stats && dashboardData.upload_stats.file_type_distribution) {
        const fileTypeData = dashboardData.upload_stats.file_type_distribution;

        const fileTypeChart = new Chart(
            document.getElementById('fileTypeChart'),
            {
                type: 'doughnut',
                data: {
                    labels: fileTypeData.map(d => d.file_type),
                    datasets: [{
                        data: fileTypeData.map(d => d.count),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            }
        );
    }

    function refreshAlerts() {
        fetch('/api/file-upload/alerts/?minutes=60')
            .then(response => response.json())
            .then(data => {
                const logDiv = document.getElementById('recentActivityLog');
                if (data.alerts && data.alerts.length > 0) {
                    let html = '<ul class="list-group">';
                    data.alerts.forEach(alert => {
                        const severityClass = alert.severity === 'CRITICAL' ? 'danger' : 'warning';
                        html += `<li class="list-group-item list-group-item-${severityClass}">
                            <strong>${alert.event_type}</strong><br>
                            <small>${alert.timestamp} - ${alert.user__peoplename || 'Anonymous'}</small><br>
                            <code>${alert.filename}</code>
                        </li>`;
                    });
                    html += '</ul>';
                    logDiv.innerHTML = html;
                } else {
                    logDiv.innerHTML = '<p class="text-success"><i class="fas fa-check-circle"></i> No alerts</p>';
                }
            })
            .catch(error => {
                console.error('Error refreshing alerts:', error);
            });
    }

    refreshAlerts();
    setInterval(refreshAlerts, 30000);
});
</script>
{% endblock %}