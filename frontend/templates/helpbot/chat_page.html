{% extends 'globals/base.html' %}

{% block title %}AI Assistant - Help & Support{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Main Chat Area -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-robot me-3 fa-lg"></i>
                        <div>
                            <h5 class="mb-0">AI Assistant</h5>
                            <small class="opacity-75">Intelligent help for YOUTILITY5</small>
                        </div>
                        <div class="ms-auto">
                            <span class="badge bg-success">Online</span>
                        </div>
                    </div>
                </div>

                <div class="card-body p-0">
                    <!-- Chat Messages -->
                    <div id="fullscreen-chat-messages" class="p-4" style="height: 60vh; overflow-y: auto; background-color: #f8f9fa;">
                        <div class="text-center text-muted">
                            <i class="fas fa-robot fa-3x mb-3 text-primary"></i>
                            <p>Welcome! I'm your AI assistant. How can I help you today?</p>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="border-top bg-white p-3">
                        <div class="row g-2" id="quick-actions">
                            <div class="col-6 col-md-3">
                                <button class="btn btn-outline-primary btn-sm w-100 quick-action-btn" data-action="getting_started">
                                    <i class="fas fa-play-circle me-1"></i> Getting Started
                                </button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button class="btn btn-outline-info btn-sm w-100 quick-action-btn" data-action="features">
                                    <i class="fas fa-list-ul me-1"></i> Features Guide
                                </button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button class="btn btn-outline-warning btn-sm w-100 quick-action-btn" data-action="troubleshooting">
                                    <i class="fas fa-tools me-1"></i> Troubleshooting
                                </button>
                            </div>
                            <div class="col-6 col-md-3">
                                <button class="btn btn-outline-success btn-sm w-100 quick-action-btn" data-action="api_docs">
                                    <i class="fas fa-code me-1"></i> API Docs
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="border-top p-3 bg-white">
                        <div class="input-group">
                            <textarea
                                id="fullscreen-chat-input"
                                class="form-control"
                                placeholder="Type your question here..."
                                rows="2"
                                style="resize: none;"
                            ></textarea>
                            <div class="input-group-append">
                                {% if settings.HELPBOT_VOICE_ENABLED %}
                                <button class="btn btn-outline-secondary" type="button" id="voice-input-btn" title="Voice input">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-primary" type="button" id="send-message-btn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-muted">
                                <span id="char-count">0</span>/{{ settings.HELPBOT_MAX_MESSAGE_LENGTH|default:2000 }}
                            </small>
                            <small class="text-muted">Press Enter to send, Shift+Enter for new line</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Knowledge Search -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-search me-2"></i>Knowledge Search
                    </h6>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="knowledge-search" placeholder="Search help articles...">
                        <button class="btn btn-outline-secondary" type="button" id="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="search-results">
                        <!-- Search results will appear here -->
                    </div>
                </div>
            </div>

            <!-- Popular Help Topics -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-fire me-2"></i>Popular Topics
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-decoration-none topic-link" data-topic="How to create a new task">üìã How to create a new task</a></li>
                        <li><a href="#" class="text-decoration-none topic-link" data-topic="Managing user permissions">üë• Managing user permissions</a></li>
                        <li><a href="#" class="text-decoration-none topic-link" data-topic="Generating reports">üìä Generating reports</a></li>
                        <li><a href="#" class="text-decoration-none topic-link" data-topic="Attendance tracking help">‚è∞ Attendance tracking</a></li>
                        <li><a href="#" class="text-decoration-none topic-link" data-topic="Asset management guide">üè≠ Asset management</a></li>
                    </ul>
                </div>
            </div>

            <!-- Session Info -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Session Info
                    </h6>
                </div>
                <div class="card-body">
                    <div id="session-info">
                        <p class="mb-2"><strong>Status:</strong> <span id="session-status">Initializing...</span></p>
                        <p class="mb-2"><strong>Messages:</strong> <span id="message-count">0</span></p>
                        <p class="mb-0"><strong>Started:</strong> <span id="session-start">-</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom styles for full-screen chat -->
<style>
.quick-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

.topic-link:hover {
    color: #007bff !important;
    text-decoration: underline !important;
}

#fullscreen-chat-messages {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.chat-message {
    margin-bottom: 1rem;
}

.chat-message-user {
    text-align: right;
}

.chat-message-bot {
    text-align: left;
}

.chat-message-content {
    display: inline-block;
    max-width: 80%;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    word-wrap: break-word;
}

.chat-message-user .chat-message-content {
    background-color: #007bff;
    color: white;
}

.chat-message-bot .chat-message-content {
    background-color: white;
    color: #333;
    border: 1px solid #dee2e6;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.chat-message-meta {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.typing-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.typing-dot {
    width: 0.5rem;
    height: 0.5rem;
    background-color: #6c757d;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}
</style>

<script>
class FullScreenHelpBot {
    constructor() {
        this.sessionId = null;
        this.messageCount = 0;
        this.startTime = new Date();

        this.init();
    }

    init() {
        this.bindEvents();
        this.startSession();
        this.updateSessionInfo();
    }

    bindEvents() {
        // Send button
        document.getElementById('send-message-btn').addEventListener('click', () => {
            this.sendMessage();
        });

        // Input handling
        const input = document.getElementById('fullscreen-chat-input');
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        input.addEventListener('input', () => {
            this.updateCharCount();
        });

        // Quick actions
        document.querySelectorAll('.quick-action-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const action = e.target.dataset.action || e.target.closest('button').dataset.action;
                this.handleQuickAction(action);
            });
        });

        // Topic links
        document.querySelectorAll('.topic-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const topic = e.target.dataset.topic;
                this.sendMessage(topic);
            });
        });

        // Knowledge search
        document.getElementById('search-btn').addEventListener('click', () => {
            this.searchKnowledge();
        });

        document.getElementById('knowledge-search').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                this.searchKnowledge();
            }
        });
    }

    async startSession() {
        try {
            document.getElementById('session-status').textContent = 'Connecting...';

            const response = await fetch('/api/v1/helpbot/api/v1/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    action: 'start_session',
                    session_type: 'general_help',
                    context: {
                        current_url: window.location.href,
                        page_title: document.title,
                        fullscreen_mode: true
                    }
                })
            });

            const data = await response.json();

            if (data.success) {
                this.sessionId = data.session_id;
                document.getElementById('session-status').textContent = 'Connected';

                // Display initial messages
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        const type = msg.type === 'user_text' ? 'user' : 'bot';
                        this.addMessage(msg.content, type);
                    });
                }

                this.updateSessionInfo();
            } else {
                document.getElementById('session-status').textContent = 'Connection failed';
            }

        } catch (error) {
            console.error('Error starting session:', error);
            document.getElementById('session-status').textContent = 'Connection error';
        }
    }

    async sendMessage(messageText = null) {
        const input = document.getElementById('fullscreen-chat-input');
        const message = messageText || input.value.trim();

        if (!message) return;

        // Clear input
        if (!messageText) {
            input.value = '';
            this.updateCharCount();
        }

        // Add user message
        this.addMessage(message, 'user');

        // Show typing indicator
        this.showTypingIndicator();

        try {
            const response = await fetch('/api/v1/helpbot/api/v1/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    action: 'message',
                    session_id: this.sessionId,
                    message: message
                })
            });

            const data = await response.json();

            if (data.success) {
                const botResponse = data.response;
                this.addMessage(botResponse.content, 'bot', {
                    confidence: botResponse.confidence_score,
                    sources: botResponse.knowledge_sources
                });

                this.messageCount += 2; // User + Bot message
                this.updateSessionInfo();
            } else {
                this.addMessage('‚ùå ' + (data.error || 'Sorry, I could not process your message.'), 'bot');
            }

        } catch (error) {
            console.error('Error sending message:', error);
            this.addMessage('‚ùå Connection error. Please try again.', 'bot');
        } finally {
            this.hideTypingIndicator();
        }
    }

    addMessage(content, type, metadata = {}) {
        const messagesArea = document.getElementById('fullscreen-chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message chat-message-${type}`;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'chat-message-content';
        contentDiv.textContent = content;

        messageDiv.appendChild(contentDiv);

        // Add metadata for bot messages
        if (type === 'bot' && metadata.confidence) {
            const metaDiv = document.createElement('div');
            metaDiv.className = 'chat-message-meta';
            metaDiv.textContent = `Confidence: ${(metadata.confidence * 100).toFixed(0)}%`;
            if (metadata.sources && metadata.sources.length > 0) {
                metaDiv.textContent += ` ‚Ä¢ Sources: ${metadata.sources.length}`;
            }
            messageDiv.appendChild(metaDiv);
        }

        messagesArea.appendChild(messageDiv);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    showTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'chat-message chat-message-bot typing-message';
        indicator.innerHTML = `
            <div class="chat-message-content">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        `;

        document.getElementById('fullscreen-chat-messages').appendChild(indicator);
        document.getElementById('fullscreen-chat-messages').scrollTop =
            document.getElementById('fullscreen-chat-messages').scrollHeight;
    }

    hideTypingIndicator() {
        const typingMessage = document.querySelector('.typing-message');
        if (typingMessage) {
            typingMessage.remove();
        }
    }

    handleQuickAction(action) {
        const actionMessages = {
            'getting_started': 'How do I get started with the platform?',
            'features': 'Show me the main features of YOUTILITY5',
            'troubleshooting': 'I need help troubleshooting an issue',
            'api_docs': 'Show me API documentation and examples'
        };

        const message = actionMessages[action];
        if (message) {
            this.sendMessage(message);
        }
    }

    async searchKnowledge() {
        const query = document.getElementById('knowledge-search').value.trim();
        if (!query) return;

        try {
            const response = await fetch(`/api/v1/helpbot/api/v1/knowledge/?q=${encodeURIComponent(query)}&limit=5`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': this.getCSRFToken()
                }
            });

            const data = await response.json();

            if (data.results) {
                this.displaySearchResults(data.results);
            }

        } catch (error) {
            console.error('Error searching knowledge:', error);
        }
    }

    displaySearchResults(results) {
        const resultsArea = document.getElementById('search-results');
        resultsArea.innerHTML = '';

        if (results.length === 0) {
            resultsArea.innerHTML = '<p class="text-muted">No results found.</p>';
            return;
        }

        results.forEach(result => {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'mb-2 p-2 border rounded';
            resultDiv.innerHTML = `
                <div class="fw-bold">${result.title}</div>
                <div class="text-muted small">${result.category} ‚Ä¢ ${result.knowledge_type}</div>
                <div class="small mt-1">${result.content.substring(0, 150)}...</div>
            `;

            resultDiv.addEventListener('click', () => {
                this.sendMessage(`Tell me about: ${result.title}`);
            });

            resultsArea.appendChild(resultDiv);
        });
    }

    updateCharCount() {
        const input = document.getElementById('fullscreen-chat-input');
        document.getElementById('char-count').textContent = input.value.length;
    }

    updateSessionInfo() {
        document.getElementById('message-count').textContent = this.messageCount;
        document.getElementById('session-start').textContent = this.startTime.toLocaleTimeString();
    }

    getCSRFToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        return '';
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    {% if user.is_authenticated and settings.HELPBOT_ENABLED %}
    window.fullScreenHelpBot = new FullScreenHelpBot();
    {% endif %}
});
</script>
{% endblock %}