{% extends 'mentor/base.html' %}

{% block title %}AI Mentor - Test{% endblock %}

{% block extra_css %}
<style>
    .test-dashboard {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 1.5rem;
        min-height: 70vh;
    }

    .test-controls {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        height: fit-content;
    }

    .test-results {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }

    .test-result-header {
        background: #f8f9fa;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .test-result-content {
        padding: 0;
        max-height: 60vh;
        overflow-y: auto;
    }

    .test-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f1f3f4;
        display: flex;
        align-items: center;
        transition: background-color 0.2s;
    }

    .test-item:hover {
        background-color: #f8f9fa;
    }

    .test-item:last-child {
        border-bottom: none;
    }

    .test-status {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 0.75rem;
        flex-shrink: 0;
    }

    .status-passed { background-color: #10b981; }
    .status-failed { background-color: #ef4444; }
    .status-skipped { background-color: #6b7280; }
    .status-running {
        background-color: #3b82f6;
        animation: pulse 1.5s ease-in-out infinite alternate;
    }

    @keyframes pulse {
        from { opacity: 0.6; }
        to { opacity: 1; }
    }

    .test-info {
        flex: 1;
        min-width: 0;
    }

    .test-name {
        font-weight: 500;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .test-meta {
        font-size: 0.85rem;
        color: #6b7280;
    }

    .test-duration {
        font-size: 0.85rem;
        color: #6b7280;
        margin-left: auto;
        padding-left: 1rem;
    }

    .coverage-bar {
        background: #e5e7eb;
        border-radius: 4px;
        height: 8px;
        overflow: hidden;
        margin: 0.5rem 0;
    }

    .coverage-fill {
        height: 100%;
        background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
        transition: width 0.3s ease;
    }

    .test-filter-btn {
        padding: 0.25rem 0.75rem;
        margin: 0.25rem;
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 16px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .test-filter-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .test-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .test-stat {
        text-align: center;
        padding: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
    }

    .test-stat-value {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .test-stat-label {
        font-size: 0.85rem;
        color: #6b7280;
    }

    .target-selector {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .target-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .target-chip {
        background: #e9ecef;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .target-chip .remove {
        cursor: pointer;
        color: #6b7280;
    }

    .target-chip .remove:hover {
        color: #ef4444;
    }

    .test-log {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.8rem;
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 1rem;
        border-radius: 6px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
    }

    .running-indicator {
        display: inline-block;
        margin-left: 0.5rem;
    }

    .running-indicator .spinner-mentor {
        width: 1rem;
        height: 1rem;
        border-width: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="fas fa-vials me-2"></i>
            Smart Test Runner
        </h2>
        <p class="text-muted">Run targeted tests based on code changes, symbols, or custom criteria.</p>
    </div>
</div>

<div class="test-dashboard">
    <!-- Test Controls -->
    <div class="test-controls">
        <h5 class="mb-3">Test Configuration</h5>

        <!-- Target Selection -->
        <div class="target-selector">
            <label class="form-label">Test Targets</label>
            <input
                type="text"
                class="form-control form-control-sm"
                id="targetInput"
                placeholder="Enter file path, symbol, or test name..."
            >
            <div class="target-chips" id="targetChips">
                <!-- Dynamic chips will appear here -->
            </div>
        </div>

        <!-- Quick Filters -->
        <div class="mb-3">
            <label class="form-label">Quick Filters</label>
            <div>
                <button type="button" class="test-filter-btn" data-filter="changed">
                    <i class="fas fa-code-branch"></i> Changed Files
                </button>
                <button type="button" class="test-filter-btn" data-filter="affected">
                    <i class="fas fa-project-diagram"></i> Impact Analysis
                </button>
                <button type="button" class="test-filter-btn" data-filter="flaky">
                    <i class="fas fa-exclamation-triangle"></i> Flaky Tests
                </button>
                <button type="button" class="test-filter-btn" data-filter="slow">
                    <i class="fas fa-clock"></i> Slow Tests
                </button>
                <button type="button" class="test-filter-btn" data-filter="failed">
                    <i class="fas fa-times"></i> Last Failed
                </button>
            </div>
        </div>

        <!-- Test Options -->
        <div class="mb-3">
            <label class="form-label">Options</label>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="coverage" checked>
                <label class="form-check-label" for="coverage">
                    Collect Coverage
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="parallel" checked>
                <label class="form-check-label" for="parallel">
                    Run in Parallel
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="verbose">
                <label class="form-check-label" for="verbose">
                    Verbose Output
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="failFast">
                <label class="form-check-label" for="failFast">
                    Stop on First Failure
                </label>
            </div>
        </div>

        <!-- Timeout -->
        <div class="mb-3">
            <label for="timeout" class="form-label">Timeout (seconds)</label>
            <input type="number" class="form-control" id="timeout" value="300" min="30" max="1800">
        </div>

        <!-- Actions -->
        <div class="d-grid gap-2">
            <button type="button" class="btn btn-mentor" id="runTestsBtn">
                <i class="fas fa-play"></i> Run Tests
            </button>
            <button type="button" class="btn btn-outline-secondary" id="stopTestsBtn" disabled>
                <i class="fas fa-stop"></i> Stop Tests
            </button>
            <button type="button" class="btn btn-outline-secondary" id="clearResultsBtn">
                <i class="fas fa-trash"></i> Clear Results
            </button>
        </div>
    </div>

    <!-- Test Results -->
    <div class="test-results">
        <div class="test-result-header">
            <h5 class="mb-0">
                Test Results
                <span id="runningIndicator" class="running-indicator" style="display: none;">
                    <div class="spinner-mentor"></div>
                </span>
            </h5>
            <div>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="expandAll">
                    <i class="fas fa-expand-arrows-alt"></i> Expand
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="collapseAll">
                    <i class="fas fa-compress-arrows-alt"></i> Collapse
                </button>
            </div>
        </div>

        <!-- Test Statistics -->
        <div id="testStats" class="p-3 border-bottom" style="display: none;">
            <div class="test-stats">
                <div class="test-stat">
                    <div class="test-stat-value text-success" id="passedCount">0</div>
                    <div class="test-stat-label">Passed</div>
                </div>
                <div class="test-stat">
                    <div class="test-stat-value text-danger" id="failedCount">0</div>
                    <div class="test-stat-label">Failed</div>
                </div>
                <div class="test-stat">
                    <div class="test-stat-value text-muted" id="skippedCount">0</div>
                    <div class="test-stat-label">Skipped</div>
                </div>
                <div class="test-stat">
                    <div class="test-stat-value" id="totalDuration">0s</div>
                    <div class="test-stat-label">Duration</div>
                </div>
            </div>

            <!-- Coverage Bar -->
            <div id="coverageSection" style="display: none;">
                <label class="form-label mb-1">Coverage: <span id="coveragePercent">0%</span></label>
                <div class="coverage-bar">
                    <div class="coverage-fill" id="coverageFill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Test List -->
        <div class="test-result-content" id="testResultsContainer">
            <div class="text-center text-muted py-5" id="noResultsMessage">
                <i class="fas fa-flask fa-2x mb-3"></i>
                <p>Configure and run tests to see results here</p>
            </div>
        </div>
    </div>
</div>

<!-- Test Detail Modal -->
<div class="modal fade" id="testDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="testDetailContent">
                <!-- Test details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
class SmartTestRunner {
    constructor() {
        this.targets = [];
        this.testResults = [];
        this.isRunning = false;
        this.eventSource = null;
        this.sessionId = null;

        this.initializeEventListeners();
        this.loadQuickFilters();
    }

    initializeEventListeners() {
        // Target input
        document.getElementById('targetInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.addTarget(e.target.value);
                e.target.value = '';
            }
        });

        // Quick filter buttons
        document.querySelectorAll('.test-filter-btn').forEach(btn => {
            btn.addEventListener('click', () => this.toggleFilter(btn));
        });

        // Action buttons
        document.getElementById('runTestsBtn').addEventListener('click', () => {
            this.runTests();
        });

        document.getElementById('stopTestsBtn').addEventListener('click', () => {
            this.stopTests();
        });

        document.getElementById('clearResultsBtn').addEventListener('click', () => {
            this.clearResults();
        });

        // Result actions
        document.getElementById('expandAll').addEventListener('click', () => {
            this.expandAllResults();
        });

        document.getElementById('collapseAll').addEventListener('click', () => {
            this.collapseAllResults();
        });
    }

    addTarget(target) {
        if (!target || this.targets.includes(target)) return;

        this.targets.push(target);
        this.updateTargetChips();
    }

    removeTarget(target) {
        this.targets = this.targets.filter(t => t !== target);
        this.updateTargetChips();
    }

    updateTargetChips() {
        const container = document.getElementById('targetChips');
        container.innerHTML = this.targets.map(target => `
            <div class="target-chip">
                <span>${target}</span>
                <span class="remove" onclick="testRunner.removeTarget('${target}')">Ã—</span>
            </div>
        `).join('');
    }

    toggleFilter(button) {
        const isActive = button.classList.toggle('active');
        const filter = button.dataset.filter;

        if (isActive) {
            this.applyQuickFilter(filter);
        } else {
            this.removeQuickFilter(filter);
        }
    }

    async applyQuickFilter(filter) {
        try {
            let targets = [];

            switch (filter) {
                case 'changed':
                    targets = await this.getChangedFiles();
                    break;
                case 'affected':
                    targets = await this.getAffectedTests();
                    break;
                case 'flaky':
                    targets = await this.getFlakyTests();
                    break;
                case 'slow':
                    targets = await this.getSlowTests();
                    break;
                case 'failed':
                    targets = await this.getFailedTests();
                    break;
            }

            targets.forEach(target => this.addTarget(target));

        } catch (error) {
            showToast(`Failed to load ${filter} tests: ${error.message}`, 'error');
        }
    }

    removeQuickFilter(filter) {
        // Implementation would remove targets added by this filter
        // For demo purposes, we'll just show a message
        showToast(`Removed ${filter} filter`, 'info');
    }

    async runTests() {
        if (this.isRunning) return;

        const config = {
            targets: this.targets,
            coverage: document.getElementById('coverage').checked,
            parallel: document.getElementById('parallel').checked,
            verbose: document.getElementById('verbose').checked,
            fail_fast: document.getElementById('failFast').checked,
            timeout: parseInt(document.getElementById('timeout').value),
            // Add quick filter selections
            changed: document.querySelector('[data-filter="changed"]').classList.contains('active'),
            flaky: document.querySelector('[data-filter="flaky"]').classList.contains('active'),
            slow: document.querySelector('[data-filter="slow"]').classList.contains('active'),
        };

        this.startTestRun();

        try {
            const response = await fetch('/api/mentor/test/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify(config)
            });

            if (!response.ok) {
                throw new Error('Failed to start test run');
            }

            const result = await response.json();
            this.sessionId = result.session_id;

            // Start streaming updates if available
            this.startStreaming();

            // Process initial results
            this.processTestResults(result);

        } catch (error) {
            this.stopTestRun();
            showToast(`Test run failed: ${error.message}`, 'error');
        }
    }

    startTestRun() {
        this.isRunning = true;
        this.testResults = [];

        document.getElementById('runTestsBtn').disabled = true;
        document.getElementById('stopTestsBtn').disabled = false;
        document.getElementById('runningIndicator').style.display = 'inline-block';

        // Show stats section
        document.getElementById('testStats').style.display = 'block';
        document.getElementById('noResultsMessage').style.display = 'none';

        this.updateStats();
    }

    stopTestRun() {
        this.isRunning = false;

        document.getElementById('runTestsBtn').disabled = false;
        document.getElementById('stopTestsBtn').disabled = true;
        document.getElementById('runningIndicator').style.display = 'none';

        if (this.eventSource) {
            this.eventSource.close();
            this.eventSource = null;
        }
    }

    stopTests() {
        if (!this.sessionId) return;

        // Implementation would call API to stop running tests
        showToast('Stopping tests...', 'info');
        this.stopTestRun();
    }

    startStreaming() {
        if (!this.sessionId) return;

        this.eventSource = new EventSource(`/api/mentor/test/stream/${this.sessionId}/`);

        this.eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.handleTestUpdate(data);
        };

        this.eventSource.onerror = (error) => {
            console.error('Test streaming error:', error);
            if (this.isRunning) {
                // Continue polling for updates
                setTimeout(() => this.pollTestStatus(), 2000);
            }
        };
    }

    handleTestUpdate(data) {
        switch (data.type) {
            case 'test_start':
                this.addTestResult({
                    node_id: data.node_id,
                    status: 'running',
                    duration: null,
                    output: '',
                    error_message: null
                });
                break;

            case 'test_result':
                this.updateTestResult(data.node_id, {
                    status: data.status,
                    duration: data.duration,
                    output: data.output,
                    error_message: data.error_message
                });
                break;

            case 'session_complete':
                this.handleSessionComplete(data);
                break;
        }

        this.updateStats();
        this.updateTestDisplay();
    }

    addTestResult(result) {
        const existingIndex = this.testResults.findIndex(r => r.node_id === result.node_id);
        if (existingIndex >= 0) {
            this.testResults[existingIndex] = result;
        } else {
            this.testResults.push(result);
        }
    }

    updateTestResult(nodeId, updates) {
        const index = this.testResults.findIndex(r => r.node_id === nodeId);
        if (index >= 0) {
            Object.assign(this.testResults[index], updates);
        }
    }

    processTestResults(data) {
        this.testResults = data.results || [];

        if (data.coverage_percentage !== undefined) {
            this.updateCoverage(data.coverage_percentage);
        }

        this.updateStats();
        this.updateTestDisplay();
    }

    updateStats() {
        const stats = this.calculateStats();

        document.getElementById('passedCount').textContent = stats.passed;
        document.getElementById('failedCount').textContent = stats.failed;
        document.getElementById('skippedCount').textContent = stats.skipped;
        document.getElementById('totalDuration').textContent = `${stats.duration}s`;
    }

    calculateStats() {
        const stats = {
            passed: 0,
            failed: 0,
            skipped: 0,
            duration: 0
        };

        this.testResults.forEach(result => {
            switch (result.status) {
                case 'passed':
                    stats.passed++;
                    break;
                case 'failed':
                case 'error':
                    stats.failed++;
                    break;
                case 'skipped':
                    stats.skipped++;
                    break;
            }

            if (result.duration) {
                stats.duration += parseFloat(result.duration);
            }
        });

        stats.duration = Math.round(stats.duration * 100) / 100;
        return stats;
    }

    updateCoverage(percentage) {
        document.getElementById('coverageSection').style.display = 'block';
        document.getElementById('coveragePercent').textContent = `${Math.round(percentage)}%`;
        document.getElementById('coverageFill').style.width = `${percentage}%`;
    }

    updateTestDisplay() {
        const container = document.getElementById('testResultsContainer');

        if (this.testResults.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-flask fa-2x mb-3"></i>
                    <p>No test results to display</p>
                </div>
            `;
            return;
        }

        container.innerHTML = this.testResults.map(result => `
            <div class="test-item" onclick="testRunner.showTestDetail('${result.node_id}')">
                <div class="test-status status-${result.status}"></div>
                <div class="test-info">
                    <div class="test-name">${this.formatTestName(result.node_id)}</div>
                    <div class="test-meta">${this.formatTestPath(result.node_id)}</div>
                </div>
                <div class="test-duration">
                    ${result.duration ? Math.round(result.duration * 1000) + 'ms' : ''}
                </div>
            </div>
        `).join('');
    }

    formatTestName(nodeId) {
        const parts = nodeId.split('::');
        return parts[parts.length - 1];
    }

    formatTestPath(nodeId) {
        const parts = nodeId.split('::');
        return parts.length > 1 ? parts.slice(0, -1).join('::') : nodeId;
    }

    showTestDetail(nodeId) {
        const result = this.testResults.find(r => r.node_id === nodeId);
        if (!result) return;

        const modal = new bootstrap.Modal(document.getElementById('testDetailModal'));
        const content = document.getElementById('testDetailContent');

        content.innerHTML = `
            <h6>Test: ${result.node_id}</h6>
            <table class="table table-sm mt-3">
                <tr><th>Status:</th><td><span class="badge bg-${this.getStatusColor(result.status)}">${result.status}</span></td></tr>
                <tr><th>Duration:</th><td>${result.duration ? Math.round(result.duration * 1000) + 'ms' : 'N/A'}</td></tr>
            </table>

            ${result.output ? `
                <h6 class="mt-3">Output</h6>
                <div class="test-log">${this.escapeHtml(result.output)}</div>
            ` : ''}

            ${result.error_message ? `
                <h6 class="mt-3">Error</h6>
                <div class="alert alert-danger">
                    <pre class="mb-0">${this.escapeHtml(result.error_message)}</pre>
                </div>
            ` : ''}
        `;

        modal.show();
    }

    getStatusColor(status) {
        const colorMap = {
            'passed': 'success',
            'failed': 'danger',
            'error': 'danger',
            'skipped': 'secondary',
            'running': 'primary'
        };
        return colorMap[status] || 'secondary';
    }

    clearResults() {
        this.testResults = [];
        this.sessionId = null;

        document.getElementById('testStats').style.display = 'none';
        document.getElementById('coverageSection').style.display = 'none';
        document.getElementById('noResultsMessage').style.display = 'block';

        this.updateTestDisplay();
        this.stopTestRun();
    }

    expandAllResults() {
        // Implementation for expanding detailed views
        showToast('Expanded all test details', 'info');
    }

    collapseAllResults() {
        // Implementation for collapsing detailed views
        showToast('Collapsed all test details', 'info');
    }

    // Mock API methods for quick filters
    async getChangedFiles() {
        // In real implementation, this would call git diff API
        return ['apps/core/tests/test_models.py', 'apps/api/tests/test_views.py'];
    }

    async getAffectedTests() {
        // Would use impact analyzer to find affected tests
        return ['tests.test_integration.TestUserFlow'];
    }

    async getFlakyTests() {
        // Would query test history for flaky tests
        return ['tests.test_external_api.TestWeatherService'];
    }

    async getSlowTests() {
        // Would query test metrics for slow tests
        return ['tests.test_performance.TestDatabaseQueries'];
    }

    async getFailedTests() {
        // Would query last test run for failed tests
        return ['tests.test_auth.TestPasswordReset'];
    }

    loadQuickFilters() {
        // Load previously used filters from localStorage
        const savedFilters = localStorage.getItem('mentor_test_filters');
        if (savedFilters) {
            const filters = JSON.parse(savedFilters);
            filters.forEach(filter => {
                document.querySelector(`[data-filter="${filter}"]`)?.classList.add('active');
            });
        }
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }
}

// Initialize test runner
let testRunner;
document.addEventListener('DOMContentLoaded', () => {
    testRunner = new SmartTestRunner();
});
</script>
{% endblock %}