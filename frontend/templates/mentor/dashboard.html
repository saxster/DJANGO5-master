{% extends 'mentor/base.html' %}

{% block title %}AI Mentor Dashboard{% endblock %}

{% block content %}
<div class="row">
    <!-- Welcome Section -->
    <div class="col-12 mb-4">
        <div class="card card-mentor">
            <div class="card-body">
                <h2 class="card-title">Welcome to AI Mentor</h2>
                <p class="card-text text-muted">
                    Intelligent code analysis, generation, and assistance powered by advanced AI.
                    Use the workflow below to plan, implement, and validate your code changes.
                </p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-lg-8 mb-4">
        <div class="card card-mentor">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-rocket"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <button class="btn btn-mentor w-100" onclick="showPlanModal()">
                            <i class="fas fa-project-diagram"></i>
                            Plan Changes
                        </button>
                        <small class="text-muted d-block mt-1">
                            Generate structured change plans from natural language
                        </small>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary w-100" onclick="showPatchModal()">
                            <i class="fas fa-code"></i>
                            Generate Patches
                        </button>
                        <small class="text-muted d-block mt-1">
                            Create and apply code patches automatically
                        </small>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-success w-100" onclick="showTestModal()">
                            <i class="fas fa-vials"></i>
                            Run Tests
                        </button>
                        <small class="text-muted d-block mt-1">
                            Execute targeted tests based on changes
                        </small>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-info w-100" onclick="showExplainModal()">
                            <i class="fas fa-question-circle"></i>
                            Explain Code
                        </button>
                        <small class="text-muted d-block mt-1">
                            Get detailed explanations of code elements
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="col-lg-4 mb-4">
        <div class="card card-mentor">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-heartbeat"></i> System Status
                </h5>
            </div>
            <div class="card-body" id="system-status">
                <div class="text-center">
                    <div class="spinner-mentor mx-auto"></div>
                    <p class="text-muted mt-2">Loading status...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Section -->
<div class="row">
    <div class="col-12">
        <div class="card card-mentor">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-sitemap"></i> AI Mentor Workflow
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="workflow-step">
                            <div class="text-center">
                                <div class="mb-3">
                                    <i class="fas fa-lightbulb fa-2x text-primary"></i>
                                </div>
                                <h6>1. Plan</h6>
                                <p class="text-muted small">
                                    Describe what you want to change in natural language.
                                    Get a structured plan with risk assessment.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="workflow-step">
                            <div class="text-center">
                                <div class="mb-3">
                                    <i class="fas fa-eye fa-2x text-info"></i>
                                </div>
                                <h6>2. Preview</h6>
                                <p class="text-muted small">
                                    Review generated patches and changes before applying.
                                    See exactly what will be modified.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="workflow-step">
                            <div class="text-center">
                                <div class="mb-3">
                                    <i class="fas fa-shield-alt fa-2x text-success"></i>
                                </div>
                                <h6>3. Validate</h6>
                                <p class="text-muted small">
                                    Run safety checks and guard validations.
                                    Ensure changes meet quality standards.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="workflow-step">
                            <div class="text-center">
                                <div class="mb-3">
                                    <i class="fas fa-rocket fa-2x text-warning"></i>
                                </div>
                                <h6>4. Apply</h6>
                                <p class="text-muted small">
                                    Apply changes with rollback capability.
                                    Run tests and validate results.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card card-mentor">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history"></i> Recent Activity
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshActivity()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="card-body" id="recent-activity">
                <div class="text-center text-muted">
                    <i class="fas fa-clock fa-2x mb-3"></i>
                    <p>No recent activity to display.</p>
                    <small>Activity will appear here after you start using the mentor system.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->

<!-- Plan Modal -->
<div class="modal fade" id="planModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Plan Changes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <div class="mb-3">
                        <label for="planRequest" class="form-label">What would you like to change?</label>
                        <textarea class="form-control" id="planRequest" rows="4"
                                placeholder="Describe your request in natural language. For example: 'Add user role management to the API' or 'Fix performance issues in the task list view'"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="planScope" class="form-label">Scope (optional)</label>
                        <input type="text" class="form-control" id="planScope"
                               placeholder="apps/users/, specific-file.py">
                        <small class="text-muted">Limit changes to specific directories or files</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-mentor" onclick="generatePlan()">
                    <i class="fas fa-project-diagram"></i> Generate Plan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Other modals would be similar... -->

{% endblock %}

{% block extra_js %}
<script>
// Dashboard-specific JavaScript

// Load system status
async function loadSystemStatus() {
    try {
        const response = await fetch('/api/v1/mentor/status/');
        const data = await response.json();

        const statusContainer = document.getElementById('system-status');

        let statusClass = 'text-success';
        let statusIcon = 'fas fa-check-circle';

        if (data.status === 'degraded') {
            statusClass = 'text-warning';
            statusIcon = 'fas fa-exclamation-triangle';
        } else if (data.status === 'unhealthy') {
            statusClass = 'text-danger';
            statusIcon = 'fas fa-times-circle';
        }

        statusContainer.innerHTML = `
            <div class="${statusClass}">
                <i class="${statusIcon} fa-2x mb-3"></i>
                <h6>System ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}</h6>
            </div>
            <hr>
            <small class="text-muted">
                <div class="mb-2">
                    <strong>Files Indexed:</strong> ${data.index_health.indexed_files?.toLocaleString() || 'N/A'}
                </div>
                <div class="mb-2">
                    <strong>Coverage:</strong> ${data.index_health.coverage_percentage?.toFixed(1) || 'N/A'}%
                </div>
                <div>
                    <strong>Last Update:</strong> ${data.last_update ? new Date(data.last_update).toLocaleDateString() : 'Never'}
                </div>
            </small>
        `;
    } catch (error) {
        console.error('Failed to load system status:', error);
        document.getElementById('system-status').innerHTML = `
            <div class="text-danger text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <p>Failed to load status</p>
            </div>
        `;
    }
}

// Show plan modal
function showPlanModal() {
    const modal = new bootstrap.Modal(document.getElementById('planModal'));
    modal.show();
}

// Generate plan
async function generatePlan() {
    const request = document.getElementById('planRequest').value.trim();
    const scope = document.getElementById('planScope').value.trim();

    if (!request) {
        showToast('Please enter a request description', 'warning');
        return;
    }

    const modal = bootstrap.Modal.getInstance(document.getElementById('planModal'));
    modal.hide();

    showToast('Generating plan...', 'info');

    try {
        const payload = { request };
        if (scope) {
            payload.scope = scope.split(',').map(s => s.trim());
        }

        const response = await fetch('/api/v1/mentor/plan/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            const data = await response.json();
            showToast(`Plan generated with ${data.steps.length} steps!`, 'success');
            // Could redirect to plan detail page or show in modal
            window.location.href = `/mentor/plan/${data.plan_id}/`;
        } else {
            const error = await response.json();
            showToast(`Plan generation failed: ${error.error || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        console.error('Plan generation failed:', error);
        showToast('Plan generation failed', 'error');
    }
}

// Show patch modal (placeholder)
function showPatchModal() {
    showToast('Patch generation modal - Coming soon!', 'info');
}

// Show test modal (placeholder)
function showTestModal() {
    showToast('Test execution modal - Coming soon!', 'info');
}

// Show explain modal (placeholder)
function showExplainModal() {
    showToast('Code explanation modal - Coming soon!', 'info');
}

// Refresh activity (placeholder)
function refreshActivity() {
    showToast('Activity refreshed', 'success');
}

// Get CSRF token
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadSystemStatus();
});
</script>
{% endblock %}