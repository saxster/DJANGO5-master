{% extends 'mentor/base.html' %}

{% block title %}AI Mentor - Impact-Aware Planning{% endblock %}

{% block extra_css %}
<style>
    .impact-visualization {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        background: #f9fafb;
    }

    .call-graph {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
        min-height: 200px;
        padding: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: white;
    }

    .graph-node {
        position: relative;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        min-width: 150px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .graph-node:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .graph-node.affected {
        border-color: #f59e0b;
        background: #fffbeb;
    }

    .graph-node.critical {
        border-color: #ef4444;
        background: #fef2f2;
    }

    .graph-node.safe {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .node-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #374151;
        font-size: 0.9rem;
    }

    .node-type {
        font-size: 0.75rem;
        color: #6b7280;
        background: #f3f4f6;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        display: inline-block;
        margin-bottom: 0.5rem;
    }

    .node-impact {
        font-size: 0.75rem;
        font-weight: 500;
    }

    .impact-affected { color: #d97706; }
    .impact-critical { color: #dc2626; }
    .impact-safe { color: #059669; }

    .risk-matrix {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .risk-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        transition: transform 0.2s;
    }

    .risk-card:hover {
        transform: translateY(-2px);
    }

    .risk-card.low {
        border-left: 4px solid #10b981;
    }

    .risk-card.medium {
        border-left: 4px solid #f59e0b;
    }

    .risk-card.high {
        border-left: 4px solid #ef4444;
    }

    .risk-card.critical {
        border-left: 4px solid #dc2626;
    }

    .risk-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .risk-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }

    .confidence-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 2rem;
    }

    .confidence-bar {
        flex: 1;
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
    }

    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
        transition: width 0.3s;
        border-radius: 3px;
    }

    .expandable-section {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .section-header {
        background: #f9fafb;
        padding: 1rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s;
    }

    .section-header:hover {
        background: #f3f4f6;
    }

    .section-content {
        padding: 1.5rem;
        display: none;
    }

    .section-content.expanded {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .affected-artifacts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .artifact-section {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
    }

    .artifact-section h6 {
        color: #374151;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .artifact-list {
        max-height: 200px;
        overflow-y: auto;
    }

    .artifact-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        margin-bottom: 0.25rem;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 0.875rem;
    }

    .artifact-item:hover {
        background: #f9fafb;
    }

    .artifact-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .status-safe { background: #10b981; }
    .status-affected { background: #f59e0b; }
    .status-critical { background: #ef4444; }

    .breaking-changes-alert {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 2rem;
    }

    .plan-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .metric-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        transition: transform 0.2s;
    }

    .metric-card:hover {
        transform: translateY(-2px);
    }

    .metric-value {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
        color: #374151;
    }

    .metric-label {
        font-size: 0.75rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .plan-actions {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        margin-top: 2rem;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .timeline-visualization {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .timeline-item {
        position: relative;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .timeline-item:hover {
        border-color: #667eea;
        background: #f8faff;
    }

    .timeline-item.high-risk {
        border-left: 4px solid #ef4444;
    }

    .timeline-item.medium-risk {
        border-left: 4px solid #f59e0b;
    }

    .timeline-item.low-risk {
        border-left: 4px solid #10b981;
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 0.5rem;
    }

    .timeline-title {
        font-weight: 600;
        color: #374151;
    }

    .timeline-meta {
        font-size: 0.875rem;
        color: #6b7280;
        text-align: right;
    }

    .step-details {
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>
            <i class="fas fa-project-diagram me-2"></i>
            Impact-Aware Plan Generator
        </h2>
        <p class="text-muted">Generate structured change plans with comprehensive impact analysis and risk visualization.</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-8">
        <div class="card card-mentor">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-project-diagram"></i> Plan Changes
                </h5>
            </div>
            <div class="card-body">
                <form id="planForm">
                    <div class="mb-4">
                        <label for="requestInput" class="form-label">
                            <strong>What would you like to change?</strong>
                        </label>
                        <textarea class="form-control" id="requestInput" rows="4"
                                placeholder="Describe your request in natural language. Examples:

• Add user authentication to the GraphQL API
• Fix N+1 query issues in the task list view
• Implement caching for expensive database operations
• Add validation to the user registration form
• Refactor the payment processing module"></textarea>
                        <small class="text-muted">
                            Be specific about what you want to achieve. The more detail you provide, the better the plan will be.
                        </small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="scopeInput" class="form-label">Scope (Optional)</label>
                            <input type="text" class="form-control" id="scopeInput"
                                   placeholder="apps/users/, specific-file.py">
                            <small class="text-muted">Limit changes to specific directories or files</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="complexityInput" class="form-label">Complexity</label>
                            <select class="form-select" id="complexityInput">
                                <option value="">Auto-detect</option>
                                <option value="simple">Simple</option>
                                <option value="medium">Medium</option>
                                <option value="complex">Complex</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="enableImpactAnalysis" checked>
                        <label class="form-check-label" for="enableImpactAnalysis">
                            Enable comprehensive impact analysis (recommended)
                        </label>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-mentor" onclick="generatePlan()">
                            <i class="fas fa-project-diagram"></i> Generate Plan
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="generatePlanStream()">
                            <i class="fas fa-stream"></i> Generate with Progress
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="showSpecWizard()">
                            <i class="fas fa-wand-magic-sparkles"></i> Use Spec Wizard
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="card card-mentor mt-4" id="progressCard" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-cogs"></i> Generating Plan...
                </h6>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         id="progressBar" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progressText">Initializing...</div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Tips Card -->
        <div class="card card-mentor mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb"></i> Planning Tips
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Be specific:</strong> Mention exact models, views, or components
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Include context:</strong> Describe current state and desired outcome
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Set scope:</strong> Limit changes to specific areas if needed
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Consider impact:</strong> Mention if backward compatibility is important
                    </li>
                </ul>
            </div>
        </div>

        <!-- Examples Card -->
        <div class="card card-mentor">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-examples"></i> Example Requests
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-info w-100 text-start"
                            onclick="setExample('Add JWT authentication to the user API endpoints with proper token validation and refresh mechanism')">
                        <strong>Authentication:</strong> Add JWT auth to API
                    </button>
                </div>
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-info w-100 text-start"
                            onclick="setExample('Optimize the dashboard query that loads user statistics by adding database indexes and implementing caching')">
                        <strong>Performance:</strong> Optimize dashboard queries
                    </button>
                </div>
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-info w-100 text-start"
                            onclick="setExample('Add comprehensive input validation to the user registration form including email format, password strength, and duplicate checking')">
                        <strong>Validation:</strong> Enhance form validation
                    </button>
                </div>
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-info w-100 text-start"
                            onclick="setExample('Refactor the payment processing module to use the Strategy pattern and add support for multiple payment providers')">
                        <strong>Refactoring:</strong> Improve payment system
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Impact Analysis Results -->
<div id="impactResults" style="display: none;">
    <!-- Impact Visualization Header -->
    <div class="impact-visualization">
        <h4><i class="fas fa-project-diagram"></i> Impact Analysis & Risk Visualization</h4>

        <div class="confidence-indicator">
            <span>Analysis Confidence:</span>
            <div class="confidence-bar">
                <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
            </div>
            <span id="confidenceText">0%</span>
        </div>

        <!-- Plan Metrics -->
        <div class="plan-metrics" id="planMetrics">
            <!-- Metrics will be populated here -->
        </div>

        <!-- Breaking Changes Alert -->
        <div class="breaking-changes-alert" id="breakingChangesAlert" style="display: none;">
            <h6><i class="fas fa-exclamation-triangle text-danger"></i> Breaking Changes Detected</h6>
            <div id="breakingChangesList"></div>
        </div>

        <!-- Risk Matrix -->
        <div class="risk-matrix" id="riskMatrix">
            <!-- Risk cards will be populated here -->
        </div>
    </div>

    <!-- Call Graph Visualization -->
    <div class="expandable-section">
        <div class="section-header" onclick="toggleSection('callGraph')">
            <h5><i class="fas fa-share-alt"></i> Dependency Call Graph</h5>
            <i class="fas fa-chevron-down" id="callGraphChevron"></i>
        </div>
        <div class="section-content" id="callGraphContent">
            <div class="call-graph" id="callGraph">
                <!-- Call graph nodes will be populated here -->
            </div>
        </div>
    </div>

    <!-- Affected Artifacts -->
    <div class="expandable-section">
        <div class="section-header" onclick="toggleSection('artifacts')">
            <h5><i class="fas fa-sitemap"></i> Affected Artifacts</h5>
            <i class="fas fa-chevron-down" id="artifactsChevron"></i>
        </div>
        <div class="section-content expanded" id="artifactsContent">
            <div class="affected-artifacts" id="artifactGrid">
                <!-- Artifact sections will be populated here -->
            </div>
        </div>
    </div>

    <!-- Implementation Timeline -->
    <div class="timeline-visualization">
        <h5><i class="fas fa-clock"></i> Implementation Timeline</h5>
        <div id="implementationTimeline">
            <!-- Timeline items will be populated here -->
        </div>
    </div>

    <!-- Plan Actions -->
    <div class="plan-actions">
        <h5>Next Steps</h5>
        <p class="text-muted mb-3">Review the plan and choose your next action</p>
        <div class="action-buttons">
            <button class="btn btn-success" onclick="generatePatches()">
                <i class="fas fa-code"></i> Generate Patches
            </button>
            <button class="btn btn-outline-primary" onclick="downloadPlan()">
                <i class="fas fa-download"></i> Download Plan
            </button>
            <button class="btn btn-outline-secondary" onclick="sharePlan()">
                <i class="fas fa-share"></i> Share Plan
            </button>
            <button class="btn btn-outline-warning" onclick="reviewRisks()">
                <i class="fas fa-shield-alt"></i> Review Risks
            </button>
        </div>
    </div>
</div>

<script>
class ImpactAwarePlanner {
    constructor() {
        this.currentPlan = null;
        this.currentEventSource = null;
        this.expandedSections = new Set(['artifacts']); // Start with artifacts expanded
        this.initializeEventListeners();
    }

    initializeEventListeners() {
        // Initialize event listeners for the form
        document.getElementById('planForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.generatePlan();
        });
    }

    async generatePlan() {
        const request = document.getElementById('requestInput').value.trim();
        if (!request) {
            showToast('Please enter a request description', 'warning');
            return;
        }

        this.showProgressCard();
        this.updateProgress(20, 'Analyzing request and building impact graph...');

        try {
            const payload = {
                request: request,
                format: 'json',
                enable_impact_analysis: document.getElementById('enableImpactAnalysis').checked
            };

            const scope = document.getElementById('scopeInput').value.trim();
            if (scope) {
                payload.scope = scope.split(',').map(s => s.trim());
            }

            const complexity = document.getElementById('complexityInput').value;
            if (complexity) {
                payload.complexity = complexity;
            }

            this.updateProgress(40, 'Running impact analysis...');

            const response = await fetch('/api/v1/mentor/plan/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify(payload)
            });

            this.updateProgress(80, 'Processing results...');

            if (response.ok) {
                const data = await response.json();
                this.updateProgress(100, 'Plan generated successfully!');
                setTimeout(() => {
                    this.hideProgressCard();
                    this.displayImpactAwarePlan(data);
                    showToast(`Impact-aware plan generated with ${data.steps.length} steps!`, 'success');
                }, 500);
            } else {
                const error = await response.json();
                this.hideProgressCard();
                showToast(`Plan generation failed: ${error.error || 'Unknown error'}`, 'error');
            }
        } catch (error) {
            console.error('Plan generation failed:', error);
            this.hideProgressCard();
            showToast('Plan generation failed', 'error');
        }
    }

    displayImpactAwarePlan(planData) {
        this.currentPlan = planData;

        // Show impact results section
        document.getElementById('impactResults').style.display = 'block';

        // Display impact analysis if available
        if (planData.impact_analysis) {
            this.displayImpactAnalysis(planData.impact_analysis);
            this.displayCallGraph(planData.impact_analysis);
            this.displayAffectedArtifacts(planData.impact_analysis);
        } else {
            // Fallback display without impact analysis
            this.displayBasicMetrics(planData);
        }

        // Display implementation timeline
        this.displayImplementationTimeline(planData);

        // Scroll to results
        document.getElementById('impactResults').scrollIntoView({ behavior: 'smooth' });
    }

    displayImpactAnalysis(impact) {
        // Update confidence indicator
        const confidencePercent = Math.round(impact.confidence * 100);
        document.getElementById('confidenceFill').style.width = `${confidencePercent}%`;
        document.getElementById('confidenceText').textContent = `${confidencePercent}%`;

        // Display metrics
        this.displayMetrics(impact);

        // Display breaking changes alert
        if (impact.breaking_changes && impact.breaking_changes.length > 0) {
            const alert = document.getElementById('breakingChangesAlert');
            const list = document.getElementById('breakingChangesList');

            alert.style.display = 'block';
            list.innerHTML = impact.breaking_changes.map(change =>
                `<div class="mb-2">
                    <strong>${change.type}:</strong> ${change.description}
                    <br><small class="text-muted">${change.file_path}</small>
                </div>`
            ).join('');
        }

        // Display risk matrix
        this.displayRiskMatrix(impact);
    }

    displayMetrics(impact) {
        const metricsContainer = document.getElementById('planMetrics');

        const metrics = [
            { value: impact.affected_files.length, label: 'Files', icon: 'fas fa-file' },
            { value: impact.affected_symbols.length, label: 'Symbols', icon: 'fas fa-code' },
            { value: impact.affected_tests.length, label: 'Tests', icon: 'fas fa-vial' },
            { value: impact.affected_urls.length, label: 'URLs', icon: 'fas fa-link' },
            { value: impact.breaking_changes.length, label: 'Breaking', icon: 'fas fa-exclamation-triangle' },
            { value: impact.severity, label: 'Severity', icon: 'fas fa-shield-alt' }
        ];

        metricsContainer.innerHTML = metrics.map(metric =>
            `<div class="metric-card">
                <div class="metric-value">${metric.value}</div>
                <div class="metric-label">
                    <i class="${metric.icon}"></i> ${metric.label}
                </div>
            </div>`
        ).join('');
    }

    displayBasicMetrics(planData) {
        const metricsContainer = document.getElementById('planMetrics');

        const metrics = [
            { value: planData.steps.length, label: 'Steps', icon: 'fas fa-list' },
            { value: planData.impacted_files.length, label: 'Files', icon: 'fas fa-file' },
            { value: planData.required_tests.length, label: 'Tests', icon: 'fas fa-vial' },
            { value: planData.estimated_total_time + 'min', label: 'Time Est.', icon: 'fas fa-clock' },
            { value: planData.overall_risk, label: 'Risk Level', icon: 'fas fa-shield-alt' },
            { value: planData.migration_needed ? 'Yes' : 'No', label: 'Migration', icon: 'fas fa-database' }
        ];

        metricsContainer.innerHTML = metrics.map(metric =>
            `<div class="metric-card">
                <div class="metric-value">${metric.value}</div>
                <div class="metric-label">
                    <i class="${metric.icon}"></i> ${metric.label}
                </div>
            </div>`
        ).join('');
    }

    displayRiskMatrix(impact) {
        const riskContainer = document.getElementById('riskMatrix');

        const riskCategories = [
            {
                type: 'Code Impact',
                level: impact.severity.toLowerCase(),
                value: impact.affected_files.length,
                description: `${impact.affected_files.length} files affected`
            },
            {
                type: 'Breaking Changes',
                level: impact.breaking_changes.length > 0 ? 'critical' : 'low',
                value: impact.breaking_changes.length,
                description: `${impact.breaking_changes.length} breaking changes`
            },
            {
                type: 'Test Coverage',
                level: impact.test_coverage_gaps.length > 5 ? 'high' : impact.test_coverage_gaps.length > 2 ? 'medium' : 'low',
                value: impact.test_coverage_gaps.length,
                description: `${impact.test_coverage_gaps.length} coverage gaps`
            },
            {
                type: 'Migration Risk',
                level: impact.migration_required ? 'high' : 'low',
                value: impact.migration_required ? 'Required' : 'None',
                description: impact.migration_required ? 'Database changes required' : 'No DB changes'
            }
        ];

        riskContainer.innerHTML = riskCategories.map(risk =>
            `<div class="risk-card ${risk.level}">
                <div class="risk-value">${risk.value}</div>
                <div class="risk-label">${risk.type}</div>
                <div style="font-size: 0.75rem; color: #9ca3af;">${risk.description}</div>
            </div>`
        ).join('');
    }

    displayCallGraph(impact) {
        const callGraph = document.getElementById('callGraph');

        if (!impact.affected_files || impact.affected_files.length === 0) {
            callGraph.innerHTML = '<p class="text-muted text-center">No dependency information available</p>';
            return;
        }

        // Create nodes for affected files
        const nodes = [...impact.affected_files].slice(0, 12).map(file => {
            const isCritical = impact.breaking_changes.some(change => change.file_path === file);
            const status = isCritical ? 'critical' : 'affected';

            return {
                id: file,
                title: this.getFileName(file),
                path: file,
                status: status,
                type: this.getFileType(file)
            };
        });

        callGraph.innerHTML = nodes.map(node =>
            `<div class="graph-node ${node.status}" onclick="explainArtifact('${node.id}')">
                <div class="node-title">${node.title}</div>
                <div class="node-type">${node.type}</div>
                <div class="node-impact impact-${node.status}">
                    ${node.status === 'critical' ? 'Critical Impact' : 'Affected'}
                </div>
            </div>`
        ).join('');
    }

    displayAffectedArtifacts(impact) {
        const artifactGrid = document.getElementById('artifactGrid');

        const sections = [
            {
                title: 'Files',
                icon: 'fas fa-file-code',
                items: [...impact.affected_files].slice(0, 10),
                getStatus: (item) => impact.breaking_changes.some(c => c.file_path === item) ? 'critical' : 'affected'
            },
            {
                title: 'Symbols',
                icon: 'fas fa-code',
                items: [...impact.affected_symbols].slice(0, 10),
                getStatus: () => 'affected'
            },
            {
                title: 'Tests',
                icon: 'fas fa-vial',
                items: [...impact.affected_tests].slice(0, 10),
                getStatus: () => 'safe'
            },
            {
                title: 'URLs',
                icon: 'fas fa-link',
                items: [...impact.affected_urls].slice(0, 10),
                getStatus: () => 'affected'
            }
        ];

        artifactGrid.innerHTML = sections.map(section =>
            `<div class="artifact-section">
                <h6><i class="${section.icon}"></i> ${section.title} (${section.items.length})</h6>
                <div class="artifact-list">
                    ${section.items.map(item =>
                        `<div class="artifact-item" onclick="explainArtifact('${item}')">
                            <div class="artifact-status status-${section.getStatus(item)}"></div>
                            <span title="${item}">${this.getDisplayName(item)}</span>
                        </div>`
                    ).join('')}
                    ${section.items.length === 0 ? '<div class="text-muted text-center py-2">None identified</div>' : ''}
                </div>
            </div>`
        ).join('');
    }

    displayImplementationTimeline(planData) {
        const timeline = document.getElementById('implementationTimeline');

        timeline.innerHTML = planData.steps.map((step, index) =>
            `<div class="timeline-item ${step.risk_level}-risk">
                <div class="timeline-header">
                    <div class="timeline-title">${index + 1}. ${step.description}</div>
                    <div class="timeline-meta">
                        ${step.estimated_time} min<br>
                        <span class="badge bg-${this.getRiskColor(step.risk_level)}">${step.risk_level}</span>
                    </div>
                </div>
                <div class="step-details">
                    <strong>Type:</strong> ${step.step_type}
                    ${step.target_files && step.target_files.length > 0 ?
                        `<br><strong>Files:</strong> ${step.target_files.slice(0, 3).join(', ')}${step.target_files.length > 3 ? '...' : ''}` : ''
                    }
                    ${step.dependencies && step.dependencies.length > 0 ?
                        `<br><strong>Dependencies:</strong> ${step.dependencies.join(', ')}` : ''
                    }
                </div>
            </div>`
        ).join('');
    }

    getFileName(path) {
        return path.split('/').pop() || path;
    }

    getFileType(path) {
        if (path.includes('models')) return 'Model';
        if (path.includes('views')) return 'View';
        if (path.includes('urls')) return 'URL';
        if (path.includes('tests')) return 'Test';
        if (path.includes('api')) return 'API';
        return 'File';
    }

    getDisplayName(item) {
        if (item.includes('::')) {
            return item.split('::').pop();
        }
        return this.getFileName(item);
    }

    getRiskColor(risk) {
        const colorMap = {
            'low': 'success',
            'medium': 'warning',
            'high': 'danger',
            'critical': 'dark'
        };
        return colorMap[risk.toLowerCase()] || 'secondary';
    }

    showProgressCard() {
        document.getElementById('progressCard').style.display = 'block';
        document.getElementById('impactResults').style.display = 'none';
    }

    hideProgressCard() {
        document.getElementById('progressCard').style.display = 'none';
    }

    updateProgress(percent, text) {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        progressBar.style.width = `${percent}%`;
        progressText.textContent = text;
    }

    getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }
}

// Global functions
let planner;

function generatePlan() {
    planner.generatePlan();
}

function generatePlanStream() {
    const request = document.getElementById('requestInput').value.trim();
    if (!request) {
        showToast('Please enter a request description', 'warning');
        return;
    }

    planner.showProgressCard();
    planner.updateProgress(10, 'Starting streaming analysis...');

    // Implementation for streaming would go here
    showToast('Streaming plan generation - Coming soon!', 'info');
}

function toggleSection(sectionName) {
    const content = document.getElementById(sectionName + 'Content');
    const chevron = document.getElementById(sectionName + 'Chevron');

    if (planner.expandedSections.has(sectionName)) {
        content.classList.remove('expanded');
        chevron.classList.remove('fa-chevron-up');
        chevron.classList.add('fa-chevron-down');
        planner.expandedSections.delete(sectionName);
    } else {
        content.classList.add('expanded');
        chevron.classList.remove('fa-chevron-down');
        chevron.classList.add('fa-chevron-up');
        planner.expandedSections.add(sectionName);
    }
}

function explainArtifact(artifactPath) {
    // Navigate to explain page with the artifact
    window.location.href = `/mentor/explain?target=${encodeURIComponent(artifactPath)}`;
}

function generatePatches() {
    if (planner.currentPlan) {
        sessionStorage.setItem('planContext', JSON.stringify(planner.currentPlan));
        window.location.href = '/mentor/patch';
    }
}

function downloadPlan() {
    if (planner.currentPlan) {
        const content = JSON.stringify(planner.currentPlan, null, 2);
        const blob = new Blob([content], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `impact_aware_plan_${planner.currentPlan.plan_id}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Plan downloaded successfully!', 'success');
    }
}

function sharePlan() {
    if (planner.currentPlan) {
        const url = `${window.location.origin}/mentor/plan?plan_id=${planner.currentPlan.plan_id}`;
        if (navigator.share) {
            navigator.share({
                title: 'AI Mentor Impact-Aware Plan',
                text: planner.currentPlan.request,
                url: url
            });
        } else {
            navigator.clipboard.writeText(url).then(() => {
                showToast('Plan URL copied to clipboard', 'success');
            });
        }
    }
}

function reviewRisks() {
    if (planner.currentPlan && planner.currentPlan.impact_analysis) {
        const impact = planner.currentPlan.impact_analysis;
        const risks = impact.breaking_changes;

        if (risks.length > 0) {
            const riskDetails = risks.map(r => `• ${r.description} (${r.severity})`).join('\n');
            alert(`Breaking Changes Detected:\n\n${riskDetails}\n\nPlease review these carefully before proceeding.`);
        } else {
            showToast('No breaking changes detected in this plan', 'success');
        }
    } else {
        showToast('No detailed risk information available', 'info');
    }
}

function showSpecWizard() {
    window.location.href = '/mentor/wizard';
}

function setExample(text) {
    document.getElementById('requestInput').value = text;
    showToast('Example loaded! You can modify it or generate the plan.', 'info');
}

function clearForm() {
    document.getElementById('requestInput').value = '';
    document.getElementById('scopeInput').value = '';
    document.getElementById('complexityInput').value = '';
    document.getElementById('impactResults').style.display = 'none';
    planner.hideProgressCard();

    if (planner.currentEventSource) {
        planner.currentEventSource.close();
        planner.currentEventSource = null;
    }
}

// Initialize planner
document.addEventListener('DOMContentLoaded', () => {
    planner = new ImpactAwarePlanner();
});
</script>
{% endblock %}