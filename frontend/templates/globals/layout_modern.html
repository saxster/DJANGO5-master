{% extends "globals/base_modern.html" %}

<!------------------------------------------------ BEGIN MACROS ------------------------------------------------------->
<!-------------------- BEGIN PAGINATOR MACRO ------------------------->
{% macro paginator(list) %}
<div class="d-flex justify-content-end align-items-center my-3">
  <nav aria-label="Page navigation">
    <ul class="pagination pagination-sm mb-0">
      {% if list.has_previous() %}
      <li class="page-item">
        <a class="page-link" href="?page=1&action=list" aria-label="First">
          <span aria-hidden="true">&laquo;&laquo;</span>
        </a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ list.previous_page_number() }}&action=list" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </span>
      </li>
      {% endif %}

      {% for i in list.paginator.page_range %}
        {% if list.number == i %}
          <li class="page-item active" aria-current="page">
            <span class="page-link">{{ i }}</span>
          </li>
        {% else %}
          <li class="page-item">
            <a class="page-link" href="?page={{ i }}&action=list">{{ i }}</a>
          </li>
        {% endif %}
      {% endfor %}

      {% if list.has_next() %}
      <li class="page-item">
        <a class="page-link" href="?page={{ list.next_page_number() }}&action=list" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ list.paginator.num_pages }}&action=list" aria-label="Last">
          <span aria-hidden="true">&raquo;&raquo;</span>
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </span>
      </li>
      {% endif %}
    </ul>
  </nav>
</div>
{% endmacro %}
<!------------------- END PAGINATOR MACRO ------------------------>

{% macro report_parameters_form(form) %}
<div class="modern-card mb-4">
  <div class="card-header-modern">
    <h5 class="mb-0">
      <i class="material-icons me-2">tune</i>
      Report Parameters
    </h5>
  </div>
  <div class="card-body-modern">
    <div class="row g-3">
      <!--SITE/GROUP-->
      <div class="col-md-6 datafield d-none">
        <label for="{{ form.site_or_people.id_for_label }}" class="form-label required">{{ form.site_or_people.label }}:</label>
        <div class="btn-group w-100" role="group" id="id_site_or_people">
          <input type="radio" class="btn-check" name="{{ form.site_or_people.name }}" id="id_peopleradio"
            value="PEOPLE" onchange="showHideSelectField('PEOPLE')">
          <label class="btn btn-outline-primary" for="id_peopleradio">People</label>
          
          <input type="radio" class="btn-check" name="{{ form.site_or_people.name }}" id="id_siteradio"
            value="SITE" onchange="showHideSelectField('SITE')">
          <label class="btn btn-outline-primary" for="id_siteradio">Site</label>
        </div>
      </div>

      <!--SITE-->
      <div class="col-md-6 datafield site d-none">
        <label for="{{ form.site.id_for_label }}" class="form-label">{{ form.site.label }}</label>
        {{ form.site }}
        {% if form.site.errors %}
          <div class="invalid-feedback d-block">{{ form.site.errors }}</div>
        {% endif %}
      </div>
      
      <!--SITEGROUP-->
      <div class="col-md-6 datafield d-none">
        <label for="{{ form.sitegroup.id_for_label }}" class="form-label">{{ form.sitegroup.label }}</label>
        {{ form.sitegroup }}
        {% if form.sitegroup.errors %}
          <div class="invalid-feedback d-block">{{ form.sitegroup.errors }}</div>
        {% endif %}
      </div>
      
      <!--PEOPLEGROUP-->
      <div class="col-md-6 datafield d-none">
        <label for="{{ form.peoplegroup.id_for_label }}" class="form-label">{{ form.peoplegroup.label }}</label>
        {{ form.peoplegroup }}
        {% if form.peoplegroup.errors %}
          <div class="invalid-feedback d-block">{{ form.peoplegroup.errors }}</div>
        {% endif %}
      </div>
      
      <!--PEOPLE-->
      <div class="col-md-6 datafield d-none">
        <label for="{{ form.people.id_for_label }}" class="form-label">{{ form.people.label }}</label>
        {{ form.people }}
        {% if form.people.errors %}
          <div class="invalid-feedback d-block">{{ form.people.errors }}</div>
        {% endif %}
      </div>
      
      <div class="col-md-6 datafield people d-none">
        <label for="{{ form.mult_people.id_for_label }}" class="form-label">{{ form.mult_people.label }}</label>
        {{ form.mult_people }}
        {% if form.mult_people.errors %}
          <div class="invalid-feedback d-block">{{ form.mult_people.errors }}</div>
        {% endif %}
      </div>
      
      <div class="col-md-6 datafield d-none">
        <label for="{{ form.assettype.id_for_label }}" class="form-label">{{ form.assettype.label }}</label>
        {{ form.assettype }}
        {% if form.assettype.errors %}
          <div class="invalid-feedback d-block">{{ form.assettype.errors }}</div>
        {% endif %}
      </div>
      
      <!--ASSET-->
      <div class="col-md-6 datafield d-none">
        <label for="{{ form.asset.id_for_label }}" class="form-label">{{ form.asset.label }}</label>
        {{ form.asset }}
        {% if form.asset.errors %}
          <div class="invalid-feedback d-block">{{ form.asset.errors }}</div>
        {% endif %}
      </div>
      
      <!--FORMAT-->
      <div class="col-md-6">
        <label for="{{ form.format.id_for_label }}" class="form-label">{{ form.format.label }}</label>
        {{ form.format }}
      </div>
      
      <!--email_body-->
      <div class="col-md-12 d-none emailfile">
        <label for="{{ form.email_body.id_for_label }}" class="form-label">{{ form.email_body.label }}</label>
        {{ form.email_body }}
        {% if form.email_body.errors %}
          <div class="invalid-feedback d-block">{{ form.email_body.errors }}</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endmacro %}

{% macro fileupoad(create) %}
<div class="modern-card mb-4">
  <div class="card-header-modern">
    <h5 class="mb-0">
      <i class="material-icons me-2">attach_file</i>
      Attachments
    </h5>
  </div>
  <div class="card-body-modern">
    <div class="border-2 border-dashed border-light-primary rounded p-4 text-center">
      <div class="mb-3">
        <i class="material-icons text-primary" style="font-size: 3rem;">cloud_upload</i>
      </div>
      <h6 class="mb-2">Drop files here or click to upload</h6>
      <p class="text-muted mb-0">Upload up to 5 files</p>
      
      <div class="mt-3">
        <input type="file" class="form-control" id="attachmentfile" name="attachmentfile" multiple>
      </div>
      
      <div class="mt-3">
        <button type="button" class="btn btn-success btn-sm me-2" id="btnuploadattachment">
          <i class="material-icons me-1">save</i>Save
        </button>
        <button type="button" class="btn btn-secondary btn-sm me-2" id="clearattachment">
          <i class="material-icons me-1">refresh</i>Clear
        </button>
        <button type="button" class="btn btn-danger btn-sm" id="cancelattachment">
          <i class="material-icons me-1">close</i>Cancel
        </button>
      </div>
    </div>
    
    <div class="mt-4">
      <div class="alert alert-danger fade show d-none" id="nonfield_errors" role="alert">
        <strong>Error:</strong> <span></span>
      </div>
      
      <table id="tabAttachment" class="table table-striped table-hover" style="width:100%">
        <!-- Attachment list will be populated here -->
      </table>
    </div>
  </div>
</div>
{% endmacro %}

<!------------------ BEGIN FORM CREATE MACRO ----------------------->
{% macro form_create(form_id) %}
<div class="d-flex align-items-center justify-content-end gap-2 py-3">
  <button type="submit" form="{{ form_id }}" id="savebtn" class="btn btn-primary">
    <i class="material-icons me-1">save</i>
    Save
  </button>
  <button type="button" class="btn btn-secondary" id="btn_clear">
    <i class="material-icons me-1">clear</i>
    Clear
  </button>
</div>
{% endmacro %}
<!------------------ END FORM CREATE MACRO ----------------------->

<!------------------ BEGIN FORM UPDATE MACRO ----------------------->
{% macro form_update(form_id) %}
<div class="d-flex align-items-center justify-content-end gap-2 py-3">
  <button type="submit" form="{{ form_id }}" id="form_update" class="btn btn-primary">
    <i class="material-icons me-1">save</i>
    Update
  </button>
  <button type="button" class="btn btn-secondary" id="btn_clear">
    <i class="material-icons me-1">clear</i>
    Clear
  </button>
  <button type="button" class="btn btn-danger" id="btn_del" data-bs-toggle="modal" data-bs-target="#{{ kwargs['popup_id'] }}">
    <i class="material-icons me-1">delete</i>
    Delete
  </button>
</div>
{% endmacro %}
<!------------------ END FORM UPDATE MACRO ----------------------->

<!------------------ BEGIN FORM ADD MACRO ----------------------->
{% macro form_add(url_path) %}
<div class="d-flex align-items-center justify-content-end py-3">
  <a href="{{ url(url_path) }}" class="btn btn-success">
    <i class="material-icons me-1">add</i>
    Add New
  </a>
</div>
{% endmacro %}

{% macro form_addnew(url_path) %}
<div class="d-flex align-items-center justify-content-end py-3">
  <a href="{{ url(url_path) }}?action=form" class="btn btn-success">
    <i class="material-icons me-1">add</i>
    Add New
  </a>
</div>
{% endmacro %}
<!---------------- END FORM ADD MACRO ------------------>

{% macro general_popup() %}
<div class="modal fade" id="{{ kwargs['popup_id'] }}" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
  aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered {{ kwargs.get('modal_size') }}">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="staticBackdropLabel">{{ kwargs['title'] }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      {{ caller() }}
    </div>
  </div>
</div>
{% endmacro %}

{% macro mainattachment() %}
<div class="modal fade" id="popup_attachment" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
  aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="material-icons me-2">attach_file</i>
          Attachments
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-md-8">
            <input type="hidden" id="id_att_owner" name="owner" value="{{ kwargs.get('owner') }}">
            <input type="hidden" id="id_att_datasource" name="datasource" value="{{ kwargs.get('datasource') }}">
            <input type="file" class="form-control" id="attachmentfile" name="attachmentfile">
          </div>
          <div class="col-md-4">
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-success btn-sm" id="btnuploadattachment">
                <i class="material-icons me-1">save</i>Save
              </button>
              <button type="button" class="btn btn-secondary btn-sm" id="clearattachment">
                <i class="material-icons me-1">refresh</i>Clear
              </button>
              <button type="button" class="btn btn-danger btn-sm" id="cancelattachment" data-bs-dismiss="modal">
                <i class="material-icons me-1">close</i>Cancel
              </button>
            </div>
          </div>
        </div>
        
        <div class="alert alert-danger fade show d-none" id="nonfield_errors" role="alert">
          <strong>Error:</strong> <span></span>
        </div>
        
        <table id="tabAttachment" class="table table-striped table-hover" style="width:100%">
          <!-- Attachment list will be populated here -->
        </table>
      </div>
    </div>
  </div>
</div>
{% endmacro %}

{% macro modal_for_table_view() %}
<div class="modal fade" id="popup_table" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
  aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="material-icons me-2">table_view</i>
          Data View
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger fade show d-none" id="nonfield_errors" role="alert">
          <strong>Error:</strong> <span id="table_error"></span>
        </div>
        
        <table id="dashboardTable" class="table table-striped table-hover" style="width:100%">
          <!-- Table data will be populated here -->
        </table>
      </div>
    </div>
  </div>
</div>
{% endmacro %}

{% macro reset_form_btn() %}
<div class="d-flex justify-content-end mb-3">
  <button type="button" class="btn btn-outline-secondary" onclick="location.reload();$('{{ kwargs['id'] }}').trigger('reset')">
    <i class="material-icons me-1">refresh</i>
    Reset Form
  </button>
</div>
{% endmacro %}

{% macro render_questions(section, formsection) %}
<!-----------------------------------------------Render Question and answer fields--------------------------------------------------->
{% for question in section['questions'] %}
  {% set fieldID = question['id'] %}
  {% set name = question['id']|string + '_' + question['qset_id']|string %}
  <div class="col-md-6 mb-3">
    {% if question['answertype'] in ['DROPDOWN', 'CHECKBOX','MULTISELECT'] %}
    <div class="form-group {{ formsection }}">
      <label class="form-label" for="{{ fieldID }}_field">{{ question['question__quesname'] }}</label>
      <select name="{{ name }}" {% if question['answertype'] == 'MULTISELECT'%} multiple {% endif %} {% if question['ismandatory'] %} required {% endif %} id="{{ fieldID }}_field"
        class="form-select">
        <option value="">Select from menu</option>
        {% if question['question__quesname'] == 'Permit Authorized by' and question['answertype'] == 'MULTISELECT' %}
          {% for approver in approvers %}
            <option value="{{ approver.peoplename }}" {% if 'answer' in question and approver.peoplename in question['answer'].split(',') %} selected {% endif %}>{{ approver.peoplename }}</option>
          {% endfor %}
        {% else %}
        {% set options = question['options'].split(',') %}
        {% for opt in options %}
          <option value="{{ opt }}" {% if 'answer' in question and opt in question['answer'].split(',') %} selected {% elif opt == ' N/A' and 'answer' not in question %} selected {% endif %}>{{ opt }}</option>
        {% endfor %}
        {% endif %}
      </select>
    </div>
    {% elif question['answertype'] == 'TIME' or question['answertype'] == 'DATE' %}
    <div class="form-group {{ formsection }}">
      <label class="form-label" for="{{ fieldID }}_field">{{ question['question__quesname'] }}</label>
      <input type="datetime-local" class="form-control datetimes" {% if question['ismandatory'] %} required {% endif %} id="{{ fieldID }}_field" name="{{ name }}" {% if 'answer' in question %} value="{{ question['answer'] }}" {% endif %}>
    </div>
    {% elif question['answertype'] == 'MULTILINE' %}
    <div class="form-group {{ formsection }}">
      <label class="form-label" for="{{ fieldID }}_field">{{ question['question__quesname'] }}</label>
      <textarea class="form-control" id="{{ fieldID }}_field" {% if question['ismandatory'] %} required {% endif %} rows="3" name="{{ name }}">{% if 'answer' in question %}{{ question['answer'] }}{% endif %}</textarea>
    </div>
    {% elif question['answertype'] == 'NUMERIC' %}
    <div class="form-group {{ formsection }}">
      <label class="form-label" for="{{ fieldID }}_field">{{ question['question__quesname'] }}</label>
      <input type="number" class="form-control" id="{{ fieldID }}_field" {% if question['ismandatory'] %} required {% endif %} name="{{ name }}" {% if 'answer' in question %} value="{{ question['answer'] }}" {% endif %}>
      <div class="form-text">Value should be between {{ question['min'] }} and {{ question['max'] }}</div>
    </div>
    {% elif question['answertype'] in ['SINGLELINE', 'SIGNATURE', 'EMAIL'] %}
    <div class="form-group {{ formsection }}">
      <label class="form-label" for="{{ fieldID }}_field">{{ question['question__quesname'] }}</label>
      <input type="{% if question['answertype'] == 'EMAIL' %}email{% else %}text{% endif %}" class="form-control" id="{{ fieldID }}_field" {% if question['ismandatory'] %} required {% endif %} name="{{ name }}" {% if 'answer' in question %} value="{{ question['answer'] }}" {% endif %}>
    </div>
    {% elif question['answertype'] == 'RATING' %}
    <div class="form-group {{ formsection }}">
      <label class="form-label" for="{{ fieldID }}_field">
        {{ question['question__quesname'] }}
        <span id="range_value" class="badge bg-primary ms-2">
          {% if 'answer' in question %}{{ question['answer'] }}{% endif %}
        </span>
      </label>
      <input type="range" class="form-range" min="{{ question['min'] }}" max="{{ question['max'] }}" {% if question['ismandatory'] %} required {% endif %} step="0.5" id="{{ fieldID }}_field" name="{{ name }}" {% if 'answer' in question %} value="{{ question['answer'] }}" {% endif %}>
    </div>
    {% endif %}
  </div>
{% endfor %}
{% endmacro %}

<!------------Workpermit Section and question plotter-------------->
{% macro plot_sections_questions(wp_details, id, formsection) %}
<div class="accordion" id="{{ id }}">
  {% for section in wp_details %}
    {% set accordionID = "accordion_" + section['sectionID']|string %}
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#{{ accordionID }}" aria-expanded="false" aria-controls="{{ accordionID }}">
          <strong>{{ section["sectionID"] }}. {{ section['section'] }}</strong>
        </button>
      </h2>
      <div id="{{ accordionID }}" class="accordion-collapse collapse" data-bs-parent="#{{ id }}">
        <div class="accordion-body">
          <div class="row">
            {{ render_questions(section, formsection) }}
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>
{% endmacro %}

{% macro load_leaflet_tags() %}
  <link href="{{ static('assets/plugins/custom/leaflet/leaflet.css') }}" rel="stylesheet" type="text/css" />
  <script src="{{ static('assets/plugins/custom/leaflet/leaflet.js') }}"></script>
  <link href="{{ static('assets/plugins/custom/leaflet.fullscreen/Control.FullScreen.css') }}" rel="stylesheet" type="text/css" />
  <script src="{{ static('assets/plugins/custom/leaflet.fullscreen/Control.FullScreen.js') }}"></script>
{% endmacro %}

{% macro load_google_maps() %}
{% load google_maps_tags %}
{% google_maps_script callback='initGoogleMaps' %}
{% endmacro %}

<!------------------------------------------------ END MACROS ------------------------------------------------------->

<!-- Override content block with modern styling -->
{% block content %}
<div class="container-fluid px-0">
  <!-- Page Content -->
  {% block pagebody_container_fluid %}
  {% endblock pagebody_container_fluid %}

  <!-- Main Container -->
  <div class="modern-card">
    <div class="card-body-modern">
      {% block pagebody_container %}
      <p class="text-muted">Content goes here...</p>
      {% endblock pagebody_container %}
    </div>
  </div>
</div>
{% endblock content %}