<!-- Modern Form Component with Enhanced UX -->
<!-- Features: Real-time validation, accessibility, progressive enhancement, auto-save -->

{% load static %}

<!-- Form Container -->
<form
  class="yt-form"
  {% if form_id %}id="{{ form_id }}"{% endif %}
  {% if form_action %}action="{{ form_action }}"{% endif %}
  method="{{ form_method|default:'post' }}"
  {% if form_enctype %}enctype="{{ form_enctype }}"{% endif %}
  novalidate
  data-form-enhanced="true"
  {% if auto_save %}data-auto-save="true"{% endif %}
  {% if form_name %}data-form-name="{{ form_name }}"{% endif %}
>

  <!-- CSRF Token -->
  {% csrf_token %}

  <!-- Form Status Announcer for Screen Readers -->
  <div class="yt-sr-only" aria-live="polite" aria-atomic="true" id="form-status-{{ form_id|default:'form' }}"></div>

  <!-- Form Progress (for multi-step forms) -->
  {% if show_progress and total_steps %}
  <div class="form-progress" role="progressbar" aria-valuenow="{{ current_step|default:1 }}" aria-valuemin="1" aria-valuemax="{{ total_steps }}" aria-label="Form progress">
    <div class="form-progress-track">
      <div class="form-progress-fill" style="width: {{ current_step|default:1|mul:100|div:total_steps }}%"></div>
    </div>
    <div class="form-progress-text">
      Step {{ current_step|default:1 }} of {{ total_steps }}
    </div>
  </div>
  {% endif %}

  <!-- Form Header -->
  {% if form_title or form_description %}
  <div class="form-header">
    {% if form_title %}
    <h1 class="form-title" id="form-title-{{ form_id|default:'form' }}">
      {% if form_icon %}
      <i class="form-title-icon material-icons" aria-hidden="true">{{ form_icon }}</i>
      {% endif %}
      {{ form_title }}
    </h1>
    {% endif %}

    {% if form_description %}
    <p class="form-description">{{ form_description }}</p>
    {% endif %}
  </div>
  {% endif %}

  <!-- Form Content -->
  <div class="form-body">
    {% block form_content %}

    <!-- Example Form Sections -->
    {% if form_sections %}
      {% for section in form_sections %}
      <div class="form-section" {% if section.id %}id="{{ section.id }}"{% endif %}>
        <h2 class="form-section-title">
          {% if section.icon %}
          <i class="material-icons" aria-hidden="true">{{ section.icon }}</i>
          {% endif %}
          {{ section.title }}
        </h2>

        {% if section.description %}
        <p class="form-section-description">{{ section.description }}</p>
        {% endif %}

        <div class="form-section-content">
          {% for field in section.fields %}
            {% include "globals/components/form_field.html" with field=field %}
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    {% else %}
      <!-- Default single section -->
      {% for field in form %}
        {% include "globals/components/form_field.html" with field=field %}
      {% endfor %}
    {% endif %}

    {% endblock form_content %}
  </div>

  <!-- Form Actions -->
  <div class="form-actions">
    {% block form_actions %}

    <!-- Primary Actions -->
    <div class="form-actions-primary">
      <button type="submit"
              class="yt-button yt-button-primary"
              id="submit-btn-{{ form_id|default:'form' }}"
              {% if submit_label %}aria-label="{{ submit_label }}"{% endif %}>
        <span class="button-content">
          <i class="material-icons button-icon" aria-hidden="true">save</i>
          <span class="button-text">{{ submit_text|default:'Save' }}</span>
        </span>
        <span class="button-loading" style="display: none;">
          <i class="material-icons button-spinner" aria-hidden="true">hourglass_empty</i>
          <span class="button-text">{{ submit_loading_text|default:'Saving...' }}</span>
        </span>
      </button>

      {% if show_save_draft %}
      <button type="button"
              class="yt-button yt-button-secondary"
              id="save-draft-btn-{{ form_id|default:'form' }}"
              onclick="saveDraft()"
              aria-label="Save form as draft">
        <i class="material-icons" aria-hidden="true">drafts</i>
        Save Draft
      </button>
      {% endif %}
    </div>

    <!-- Secondary Actions -->
    <div class="form-actions-secondary">
      {% if show_cancel %}
      <button type="button"
              class="yt-button yt-button-text"
              onclick="{{ cancel_action|default:'history.back()' }}"
              aria-label="Cancel and go back">
        <i class="material-icons" aria-hidden="true">cancel</i>
        {{ cancel_text|default:'Cancel' }}
      </button>
      {% endif %}

      {% if show_reset %}
      <button type="reset"
              class="yt-button yt-button-text"
              onclick="resetForm()"
              aria-label="Reset form to original values">
        <i class="material-icons" aria-hidden="true">refresh</i>
        {{ reset_text|default:'Reset' }}
      </button>
      {% endif %}
    </div>

    {% endblock form_actions %}
  </div>

  <!-- Auto-save Status -->
  {% if auto_save %}
  <div class="form-autosave-status" id="autosave-status-{{ form_id|default:'form' }}" aria-live="polite">
    <i class="material-icons" aria-hidden="true">cloud_done</i>
    <span class="autosave-text">All changes saved</span>
  </div>
  {% endif %}

</form>

<!-- Form Styles -->
<style>
  .yt-form {
    max-width: 800px;
    margin: 0 auto;
    background: var(--yt-bg-surface);
    border-radius: var(--yt-radius-2xl);
    box-shadow: var(--yt-shadow-lg);
    border: var(--yt-border-1) solid var(--yt-border-primary);
    overflow: hidden;
  }

  /* Form Progress */
  .form-progress {
    padding: var(--yt-space-6) var(--yt-space-6) 0;
    margin-bottom: var(--yt-space-6);
  }

  .form-progress-track {
    height: 8px;
    background: var(--yt-gray-200);
    border-radius: var(--yt-radius-full);
    overflow: hidden;
    margin-bottom: var(--yt-space-2);
  }

  .form-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--yt-primary-500), var(--yt-primary-600));
    border-radius: var(--yt-radius-full);
    transition: width var(--yt-duration-500) var(--yt-ease-out);
  }

  .form-progress-text {
    text-align: center;
    font-size: var(--yt-text-sm);
    color: var(--yt-text-secondary);
    font-weight: var(--yt-font-medium);
  }

  /* Form Header */
  .form-header {
    background: linear-gradient(135deg, var(--yt-primary-500) 0%, var(--yt-primary-600) 100%);
    color: var(--yt-text-inverse);
    padding: var(--yt-space-8);
    text-align: center;
  }

  .form-title {
    font-size: var(--yt-text-3xl);
    font-weight: var(--yt-font-semibold);
    margin: 0 0 var(--yt-space-2) 0;
    color: inherit;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--yt-space-3);
  }

  .form-title-icon {
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: var(--yt-radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--yt-text-2xl);
  }

  .form-description {
    margin: 0;
    color: rgba(255, 255, 255, 0.9);
    font-size: var(--yt-text-lg);
    line-height: var(--yt-leading-relaxed);
  }

  /* Form Body */
  .form-body {
    padding: var(--yt-space-8);
  }

  /* Form Sections */
  .form-section {
    margin-bottom: var(--yt-space-8);
  }

  .form-section:last-child {
    margin-bottom: 0;
  }

  .form-section-title {
    font-size: var(--yt-text-xl);
    font-weight: var(--yt-font-semibold);
    color: var(--yt-text-primary);
    margin: 0 0 var(--yt-space-3) 0;
    display: flex;
    align-items: center;
    gap: var(--yt-space-2);
    padding-bottom: var(--yt-space-2);
    border-bottom: var(--yt-border-1) solid var(--yt-border-primary);
  }

  .form-section-title i {
    color: var(--yt-primary-500);
    font-size: var(--yt-text-xl);
  }

  .form-section-description {
    color: var(--yt-text-secondary);
    font-size: var(--yt-text-sm);
    margin: var(--yt-space-2) 0 var(--yt-space-4) 0;
    line-height: var(--yt-leading-normal);
  }

  .form-section-content {
    display: grid;
    gap: var(--yt-space-6);
  }

  /* Form Actions */
  .form-actions {
    padding: var(--yt-space-6) var(--yt-space-8);
    background: var(--yt-bg-secondary);
    border-top: var(--yt-border-1) solid var(--yt-border-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--yt-space-4);
  }

  .form-actions-primary {
    display: flex;
    gap: var(--yt-space-3);
    align-items: center;
  }

  .form-actions-secondary {
    display: flex;
    gap: var(--yt-space-2);
    align-items: center;
  }

  /* Button States */
  .yt-button {
    position: relative;
    overflow: hidden;
  }

  .button-content,
  .button-loading {
    display: flex;
    align-items: center;
    gap: var(--yt-space-2);
    transition: opacity var(--yt-duration-200) var(--yt-ease-in-out);
  }

  .yt-button[data-loading="true"] .button-content {
    opacity: 0;
  }

  .yt-button[data-loading="true"] .button-loading {
    display: flex;
  }

  .button-spinner {
    animation: spin var(--yt-duration-1000) linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Auto-save Status */
  .form-autosave-status {
    position: fixed;
    bottom: var(--yt-space-4);
    right: var(--yt-space-4);
    background: var(--yt-success-500);
    color: var(--yt-text-inverse);
    padding: var(--yt-space-2) var(--yt-space-4);
    border-radius: var(--yt-radius-full);
    font-size: var(--yt-text-sm);
    font-weight: var(--yt-font-medium);
    display: flex;
    align-items: center;
    gap: var(--yt-space-2);
    box-shadow: var(--yt-shadow-lg);
    z-index: var(--yt-z-toast);
    opacity: 0;
    transform: translateY(100%);
    transition: all var(--yt-duration-300) var(--yt-ease-out);
  }

  .form-autosave-status.show {
    opacity: 1;
    transform: translateY(0);
  }

  .form-autosave-status.saving {
    background: var(--yt-warning-500);
  }

  .form-autosave-status.error {
    background: var(--yt-danger-500);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .yt-form {
      margin: var(--yt-space-4);
      border-radius: var(--yt-radius-xl);
    }

    .form-header {
      padding: var(--yt-space-6);
    }

    .form-title {
      font-size: var(--yt-text-2xl);
      flex-direction: column;
    }

    .form-body {
      padding: var(--yt-space-6);
    }

    .form-actions {
      padding: var(--yt-space-4) var(--yt-space-6);
      flex-direction: column;
      align-items: stretch;
    }

    .form-actions-primary,
    .form-actions-secondary {
      justify-content: center;
    }

    .form-actions-primary .yt-button {
      flex: 1;
    }
  }

  @media (max-width: 480px) {
    .yt-form {
      margin: var(--yt-space-2);
      border-radius: var(--yt-radius-lg);
    }

    .form-header {
      padding: var(--yt-space-4);
    }

    .form-body {
      padding: var(--yt-space-4);
    }

    .form-section-content {
      gap: var(--yt-space-4);
    }
  }

  /* Dark Mode */
  .dark .form-actions {
    background: var(--yt-gray-800);
  }

  /* High Contrast */
  @media (prefers-contrast: high) {
    .form-progress-track {
      border: var(--yt-border-1) solid var(--yt-text-primary);
    }

    .form-section-title {
      border-bottom-width: var(--yt-border-2);
    }
  }

  /* Reduced Motion */
  @media (prefers-reduced-motion: reduce) {
    .form-progress-fill,
    .button-content,
    .button-loading,
    .form-autosave-status {
      transition: none;
    }

    .button-spinner {
      animation: none;
    }
  }
</style>

<!-- Enhanced Form JavaScript -->
<script>
(function() {
  'use strict';

  // Form Enhancement Class
  class FormEnhancer {
    constructor(form) {
      this.form = form;
      this.formId = form.getAttribute('id') || 'form';
      this.autoSave = form.hasAttribute('data-auto-save');
      this.formName = form.getAttribute('data-form-name') || this.formId;
      this.statusAnnouncer = document.getElementById(`form-status-${this.formId}`);
      this.autosaveStatus = document.getElementById(`autosave-status-${this.formId}`);
      this.submitButton = form.querySelector('button[type="submit"]');
      this.isSubmitting = false;
      this.validationTimer = null;
      this.autoSaveTimer = null;
      this.originalData = new FormData(form);

      this.init();
    }

    init() {
      this.setupEventListeners();
      this.setupValidation();
      if (this.autoSave) {
        this.setupAutoSave();
        this.loadDraft();
      }
      this.setupKeyboardShortcuts();
      this.announceToScreenReader('Form loaded and ready for input');
    }

    setupEventListeners() {
      // Form submission
      this.form.addEventListener('submit', (e) => this.handleSubmit(e));

      // Input events for real-time validation
      this.form.addEventListener('input', (e) => this.handleInput(e));
      this.form.addEventListener('blur', (e) => this.handleBlur(e), true);

      // Paste events
      this.form.addEventListener('paste', (e) => this.handlePaste(e));

      // Prevent accidental navigation
      window.addEventListener('beforeunload', (e) => this.handleBeforeUnload(e));
    }

    setupValidation() {
      const fields = this.form.querySelectorAll('input, select, textarea');
      fields.forEach(field => {
        // Set up ARIA attributes
        const fieldGroup = field.closest('.form-field');
        const errorElement = fieldGroup?.querySelector('.field-error');
        const helpElement = fieldGroup?.querySelector('.field-help');

        if (errorElement) {
          field.setAttribute('aria-describedby', errorElement.id || `${field.id}-error`);
        }

        if (helpElement) {
          const describedBy = field.getAttribute('aria-describedby') || '';
          field.setAttribute('aria-describedby', `${describedBy} ${helpElement.id || `${field.id}-help`}`.trim());
        }
      });
    }

    setupAutoSave() {
      if (!this.autoSave) return;

      this.form.addEventListener('input', () => {
        this.showAutoSaveStatus('saving');

        clearTimeout(this.autoSaveTimer);
        this.autoSaveTimer = setTimeout(() => {
          this.saveDraft();
        }, 2000); // Save after 2 seconds of inactivity
      });
    }

    setupKeyboardShortcuts() {
      this.form.addEventListener('keydown', (e) => {
        // Ctrl+S to save
        if (e.ctrlKey && e.key === 's') {
          e.preventDefault();
          if (this.autoSave) {
            this.saveDraft();
          } else {
            this.form.requestSubmit();
          }
        }

        // Ctrl+Enter to submit
        if (e.ctrlKey && e.key === 'Enter') {
          e.preventDefault();
          this.form.requestSubmit();
        }
      });
    }

    handleSubmit(e) {
      if (this.isSubmitting) {
        e.preventDefault();
        return;
      }

      // Validate form
      if (!this.validateForm()) {
        e.preventDefault();
        this.announceToScreenReader('Form has validation errors. Please review and correct.');
        return;
      }

      this.isSubmitting = true;
      this.setSubmitButtonState(true);
      this.announceToScreenReader('Submitting form...');
    }

    handleInput(e) {
      const field = e.target;

      if (field.matches('input, select, textarea')) {
        // Clear previous validation timer
        clearTimeout(this.validationTimer);

        // Validate after short delay
        this.validationTimer = setTimeout(() => {
          this.validateField(field);
        }, 300);

        // Remove error state immediately on input
        this.clearFieldError(field);
      }
    }

    handleBlur(e) {
      const field = e.target;

      if (field.matches('input, select, textarea')) {
        // Validate immediately on blur
        this.validateField(field);
      }
    }

    handlePaste(e) {
      const field = e.target;

      if (field.matches('input[type="email"], input[type="tel"], input[type="url"]')) {
        // Validate pasted content after a short delay
        setTimeout(() => {
          this.validateField(field);
        }, 100);
      }
    }

    handleBeforeUnload(e) {
      if (this.hasUnsavedChanges() && !this.isSubmitting) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
      }
    }

    validateForm() {
      const fields = this.form.querySelectorAll('input, select, textarea');
      let isValid = true;
      let firstErrorField = null;

      fields.forEach(field => {
        if (!this.validateField(field) && !firstErrorField) {
          firstErrorField = field;
          isValid = false;
        }
      });

      if (firstErrorField) {
        firstErrorField.focus();
        this.scrollToField(firstErrorField);
      }

      return isValid;
    }

    validateField(field) {
      const fieldGroup = field.closest('.form-field');
      if (!fieldGroup) return true;

      let isValid = true;
      let errorMessage = '';

      // Required field validation
      if (field.hasAttribute('required') && !field.value.trim()) {
        isValid = false;
        errorMessage = 'This field is required.';
      }

      // Type-specific validation
      if (isValid && field.value.trim()) {
        switch (field.type) {
          case 'email':
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(field.value)) {
              isValid = false;
              errorMessage = 'Please enter a valid email address.';
            }
            break;

          case 'tel':
            const phoneRegex = /^[\+]?[\d\s\-\(\)]{10,}$/;
            if (!phoneRegex.test(field.value)) {
              isValid = false;
              errorMessage = 'Please enter a valid phone number.';
            }
            break;

          case 'url':
            try {
              new URL(field.value);
            } catch {
              isValid = false;
              errorMessage = 'Please enter a valid URL.';
            }
            break;

          case 'password':
            if (field.value.length < 8) {
              isValid = false;
              errorMessage = 'Password must be at least 8 characters long.';
            }
            break;
        }

        // Custom validation patterns
        if (isValid && field.hasAttribute('pattern')) {
          const pattern = new RegExp(field.getAttribute('pattern'));
          if (!pattern.test(field.value)) {
            isValid = false;
            errorMessage = field.getAttribute('data-error-message') || 'Please enter a valid value.';
          }
        }

        // Min/Max length validation
        if (isValid && field.hasAttribute('minlength')) {
          const minLength = parseInt(field.getAttribute('minlength'));
          if (field.value.length < minLength) {
            isValid = false;
            errorMessage = `Minimum ${minLength} characters required.`;
          }
        }

        if (isValid && field.hasAttribute('maxlength')) {
          const maxLength = parseInt(field.getAttribute('maxlength'));
          if (field.value.length > maxLength) {
            isValid = false;
            errorMessage = `Maximum ${maxLength} characters allowed.`;
          }
        }
      }

      // Update field state
      if (isValid) {
        this.setFieldState(field, 'valid');
      } else {
        this.setFieldState(field, 'invalid', errorMessage);
      }

      return isValid;
    }

    setFieldState(field, state, message = '') {
      const fieldGroup = field.closest('.form-field');
      if (!fieldGroup) return;

      // Update field classes
      fieldGroup.classList.remove('field-valid', 'field-invalid');
      field.classList.remove('is-valid', 'is-invalid');

      if (state === 'valid') {
        fieldGroup.classList.add('field-valid');
        field.classList.add('is-valid');
        field.setAttribute('aria-invalid', 'false');
      } else if (state === 'invalid') {
        fieldGroup.classList.add('field-invalid');
        field.classList.add('is-invalid');
        field.setAttribute('aria-invalid', 'true');
      }

      // Update error message
      const errorElement = fieldGroup.querySelector('.field-error');
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = message ? 'block' : 'none';
      }
    }

    clearFieldError(field) {
      const fieldGroup = field.closest('.form-field');
      if (!fieldGroup) return;

      fieldGroup.classList.remove('field-invalid');
      field.classList.remove('is-invalid');
      field.setAttribute('aria-invalid', 'false');

      const errorElement = fieldGroup.querySelector('.field-error');
      if (errorElement) {
        errorElement.textContent = '';
        errorElement.style.display = 'none';
      }
    }

    setSubmitButtonState(loading) {
      if (!this.submitButton) return;

      this.submitButton.setAttribute('data-loading', loading);
      this.submitButton.disabled = loading;

      if (loading) {
        this.submitButton.setAttribute('aria-label', 'Submitting form, please wait');
      } else {
        this.submitButton.removeAttribute('aria-label');
      }
    }

    scrollToField(field) {
      field.scrollIntoView({
        behavior: 'smooth',
        block: 'center'
      });
    }

    hasUnsavedChanges() {
      const currentData = new FormData(this.form);

      // Compare with original data
      for (let [key, value] of this.originalData.entries()) {
        if (currentData.get(key) !== value) {
          return true;
        }
      }

      for (let [key, value] of currentData.entries()) {
        if (this.originalData.get(key) !== value) {
          return true;
        }
      }

      return false;
    }

    saveDraft() {
      if (!this.autoSave) return;

      const formData = new FormData(this.form);
      const draftData = {};

      for (let [key, value] of formData.entries()) {
        draftData[key] = value;
      }

      localStorage.setItem(`form_draft_${this.formName}`, JSON.stringify(draftData));
      this.showAutoSaveStatus('saved');
      this.announceToScreenReader('Draft saved automatically');
    }

    loadDraft() {
      if (!this.autoSave) return;

      const draftData = localStorage.getItem(`form_draft_${this.formName}`);
      if (!draftData) return;

      try {
        const data = JSON.parse(draftData);

        Object.entries(data).forEach(([key, value]) => {
          const field = this.form.querySelector(`[name="${key}"]`);
          if (field && field.type !== 'hidden') {
            if (field.type === 'checkbox' || field.type === 'radio') {
              field.checked = field.value === value;
            } else {
              field.value = value;
            }
          }
        });

        this.showAutoSaveStatus('loaded');
        this.announceToScreenReader('Draft loaded from previous session');
      } catch (e) {
        console.warn('Failed to load draft:', e);
      }
    }

    showAutoSaveStatus(status) {
      if (!this.autosaveStatus) return;

      const icon = this.autosaveStatus.querySelector('i');
      const text = this.autosaveStatus.querySelector('.autosave-text');

      this.autosaveStatus.className = 'form-autosave-status show';

      switch (status) {
        case 'saving':
          this.autosaveStatus.classList.add('saving');
          if (icon) icon.textContent = 'cloud_sync';
          if (text) text.textContent = 'Saving...';
          break;

        case 'saved':
          this.autosaveStatus.classList.remove('saving', 'error');
          if (icon) icon.textContent = 'cloud_done';
          if (text) text.textContent = 'All changes saved';
          break;

        case 'error':
          this.autosaveStatus.classList.add('error');
          if (icon) icon.textContent = 'cloud_off';
          if (text) text.textContent = 'Save failed';
          break;

        case 'loaded':
          this.autosaveStatus.classList.remove('saving', 'error');
          if (icon) icon.textContent = 'cloud_download';
          if (text) text.textContent = 'Draft loaded';
          break;
      }

      // Hide after 3 seconds for success states
      if (status === 'saved' || status === 'loaded') {
        setTimeout(() => {
          this.autosaveStatus.classList.remove('show');
        }, 3000);
      }
    }

    announceToScreenReader(message) {
      if (this.statusAnnouncer) {
        this.statusAnnouncer.textContent = message;
        setTimeout(() => {
          this.statusAnnouncer.textContent = '';
        }, 1000);
      }
    }
  }

  // Initialize form enhancement
  document.addEventListener('DOMContentLoaded', function() {
    const enhancedForms = document.querySelectorAll('form[data-form-enhanced="true"]');

    enhancedForms.forEach(form => {
      new FormEnhancer(form);
    });
  });

  // Global form utilities
  window.saveDraft = function() {
    const form = document.querySelector('form[data-auto-save="true"]');
    if (form && form.formEnhancer) {
      form.formEnhancer.saveDraft();
    }
  };

  window.resetForm = function() {
    const form = document.querySelector('form[data-form-enhanced="true"]');
    if (form) {
      if (confirm('Are you sure you want to reset the form? All changes will be lost.')) {
        form.reset();

        // Clear validation states
        const fieldGroups = form.querySelectorAll('.form-field');
        fieldGroups.forEach(group => {
          group.classList.remove('field-valid', 'field-invalid');
        });

        // Clear localStorage draft
        const formName = form.getAttribute('data-form-name') || 'form';
        localStorage.removeItem(`form_draft_${formName}`);
      }
    }
  };

})();
</script>