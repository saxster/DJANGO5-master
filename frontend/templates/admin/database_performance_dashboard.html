{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Database Performance Monitor{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        .dashboard-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: box-shadow 0.3s ease;
        }

        .dashboard-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .status-indicator {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-healthy {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-critical {
            background: #f8d7da;
            color: #721c24;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            color: #555;
        }

        .metric-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }

        .alert-item {
            padding: 12px;
            border-left: 4px solid;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 0 4px 4px 0;
        }

        .alert-critical {
            border-left-color: #dc3545;
        }

        .alert-warning {
            border-left-color: #ffc107;
        }

        .alert-info {
            border-left-color: #17a2b8;
        }

        .alert-meta {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .alert-query {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            background: #f1f3f4;
            padding: 4px 8px;
            border-radius: 3px;
            overflow-x: auto;
        }

        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-refresh {
            background: #007cba;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-refresh:hover {
            background: #005a87;
        }

        .btn-export {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-export:hover {
            background: #1e7e34;
        }

        .last-updated {
            font-size: 12px;
            color: #6c757d;
        }

        .loading-indicator {
            display: none;
            color: #007cba;
            font-size: 14px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .controls-bar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
{% endblock %}

{% block content_title %}
    <h1>{{ dashboard_title }}</h1>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Controls Bar -->
    <div class="controls-bar">
        <div class="control-group">
            <button id="refreshBtn" class="btn-refresh">ðŸ”„ Refresh Now</button>
            <button id="exportBtn" class="btn-export">ðŸ“Š Export Report</button>
            <select id="timeRangeSelect">
                <option value="1">Last Hour</option>
                <option value="6">Last 6 Hours</option>
                <option value="24" selected>Last 24 Hours</option>
                <option value="168">Last Week</option>
            </select>
        </div>
        <div class="control-group">
            <span class="loading-indicator" id="loadingIndicator">ðŸ”„ Loading...</span>
            <span class="last-updated" id="lastUpdated">Last updated: {{ last_updated|date:"H:i:s" }}</span>
        </div>
    </div>

    <!-- Error Message -->
    <div class="error-message" id="errorMessage"></div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Connection Pool Status -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">Connection Pool Status</h3>
                <span class="status-indicator status-healthy" id="connectionStatus">Healthy</span>
            </div>
            <div id="connectionMetrics">
                <div class="metric-row">
                    <span class="metric-label">Active Connections</span>
                    <span class="metric-value" id="activeConnections">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Pool Usage</span>
                    <span class="metric-value" id="poolUsage">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Idle Connections</span>
                    <span class="metric-value" id="idleConnections">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Executing Queries</span>
                    <span class="metric-value" id="executingQueries">-</span>
                </div>
            </div>
        </div>

        <!-- Slow Query Alerts -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">Recent Slow Query Alerts</h3>
                <span class="metric-value" id="totalAlerts">-</span>
            </div>
            <div id="alertsList" style="max-height: 300px; overflow-y: auto;">
                <!-- Alerts will be populated by JavaScript -->
            </div>
        </div>

        <!-- Performance Trends Chart -->
        <div class="dashboard-card" style="grid-column: 1 / -1;">
            <div class="card-header">
                <h3 class="card-title">Query Performance Trends</h3>
                <span class="metric-value" id="chartTimeRange">Last 24 Hours</span>
            </div>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <!-- Database Statistics -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">Database Statistics</h3>
            </div>
            <div id="databaseStats">
                <div class="metric-row">
                    <span class="metric-label">Database Size</span>
                    <span class="metric-value" id="databaseSize">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Active Queries</span>
                    <span class="metric-value" id="activeQueries">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Total Connections</span>
                    <span class="metric-value" id="totalConnections">-</span>
                </div>
            </div>
        </div>

        <!-- Top Slow Patterns -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">Top Slow Query Patterns</h3>
            </div>
            <div id="slowPatterns" style="max-height: 300px; overflow-y: auto;">
                <!-- Patterns will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';

    // Dashboard state
    let performanceChart = null;
    let refreshInterval = null;
    const REFRESH_INTERVAL_MS = {{ refresh_interval|default:30000 }};

    // DOM elements
    const elements = {
        refreshBtn: document.getElementById('refreshBtn'),
        exportBtn: document.getElementById('exportBtn'),
        timeRangeSelect: document.getElementById('timeRangeSelect'),
        loadingIndicator: document.getElementById('loadingIndicator'),
        lastUpdated: document.getElementById('lastUpdated'),
        errorMessage: document.getElementById('errorMessage'),

        // Connection metrics
        connectionStatus: document.getElementById('connectionStatus'),
        activeConnections: document.getElementById('activeConnections'),
        poolUsage: document.getElementById('poolUsage'),
        idleConnections: document.getElementById('idleConnections'),
        executingQueries: document.getElementById('executingQueries'),

        // Alerts
        totalAlerts: document.getElementById('totalAlerts'),
        alertsList: document.getElementById('alertsList'),

        // Chart and stats
        performanceChart: document.getElementById('performanceChart'),
        chartTimeRange: document.getElementById('chartTimeRange'),
        databaseSize: document.getElementById('databaseSize'),
        activeQueries: document.getElementById('activeQueries'),
        totalConnections: document.getElementById('totalConnections'),
        slowPatterns: document.getElementById('slowPatterns')
    };

    // Utility functions
    function showLoading(show = true) {
        elements.loadingIndicator.style.display = show ? 'inline' : 'none';
    }

    function showError(message) {
        elements.errorMessage.textContent = message;
        elements.errorMessage.style.display = 'block';
        setTimeout(() => {
            elements.errorMessage.style.display = 'none';
        }, 5000);
    }

    function updateTimestamp() {
        const now = new Date();
        elements.lastUpdated.textContent = `Last updated: ${now.toLocaleTimeString()}`;
    }

    // API calls
    async function fetchConnectionStatus() {
        try {
            const response = await fetch('/admin/database/api/connection-status/');
            const data = await response.json();

            if (data.status === 'success') {
                updateConnectionMetrics(data);
            } else {
                throw new Error(data.error || 'Failed to fetch connection status');
            }
        } catch (error) {
            console.error('Connection status error:', error);
            showError('Failed to fetch connection status');
        }
    }

    async function fetchSlowQueryAlerts() {
        try {
            const hours = elements.timeRangeSelect.value;
            const response = await fetch(`/admin/database/api/slow-query-alerts/?hours=${hours}`);
            const data = await response.json();

            if (data.status === 'success') {
                updateSlowQueryAlerts(data);
            } else {
                throw new Error(data.error || 'Failed to fetch slow query alerts');
            }
        } catch (error) {
            console.error('Slow query alerts error:', error);
            showError('Failed to fetch slow query alerts');
        }
    }

    async function fetchPerformanceMetrics() {
        try {
            const hours = elements.timeRangeSelect.value;
            const response = await fetch(`/admin/database/api/performance-metrics/?hours=${hours}`);
            const data = await response.json();

            if (data.status === 'success') {
                updatePerformanceChart(data.metrics);
                updateDatabaseStats(data.metrics.database_stats);
            } else {
                throw new Error(data.error || 'Failed to fetch performance metrics');
            }
        } catch (error) {
            console.error('Performance metrics error:', error);
            showError('Failed to fetch performance metrics');
        }
    }

    // Update functions
    function updateConnectionMetrics(data) {
        const summary = data.summary;
        const defaultDb = data.databases.default || {};

        // Update status indicator
        const statusElement = elements.connectionStatus;
        statusElement.textContent = summary.health_status;
        statusElement.className = `status-indicator status-${summary.health_status}`;

        // Update metrics
        elements.activeConnections.textContent = defaultDb.active_connections || '-';
        elements.poolUsage.textContent = defaultDb.usage_percentage
            ? `${defaultDb.usage_percentage}%`
            : '-';
        elements.idleConnections.textContent = defaultDb.idle_connections || '-';
        elements.executingQueries.textContent = defaultDb.executing_queries || '-';
    }

    function updateSlowQueryAlerts(data) {
        elements.totalAlerts.textContent = data.summary.total_alerts;

        // Update alerts list
        const alertsHtml = data.recent_alerts.map(alert => {
            const alertTime = new Date(alert.alert_time).toLocaleString();
            return `
                <div class="alert-item alert-${alert.severity}">
                    <div class="alert-meta">
                        ${alert.severity.toUpperCase()} â€¢ ${alertTime} â€¢ ${alert.execution_time}ms
                    </div>
                    <div class="alert-query">${alert.query_preview}</div>
                </div>
            `;
        }).join('');

        elements.alertsList.innerHTML = alertsHtml || '<p>No recent alerts</p>';

        // Update slow patterns
        const patternsHtml = data.slow_patterns.map(pattern => {
            return `
                <div class="metric-row">
                    <span class="metric-label">${pattern.query_type} (${pattern.total_queries} calls)</span>
                    <span class="metric-value">${pattern.avg_execution_time.toFixed(1)}ms</span>
                </div>
            `;
        }).join('');

        elements.slowPatterns.innerHTML = patternsHtml || '<p>No slow patterns detected</p>';
    }

    function updateDatabaseStats(stats) {
        elements.databaseSize.textContent = stats.database_size || '-';
        elements.activeQueries.textContent = stats.active_queries || '-';
        elements.totalConnections.textContent = stats.total_connections || '-';
    }

    function updatePerformanceChart(metrics) {
        const ctx = elements.performanceChart.getContext('2d');

        if (performanceChart) {
            performanceChart.destroy();
        }

        const timeSeriesData = metrics.time_series || [];
        const labels = timeSeriesData.map(d => new Date(d.timestamp).toLocaleTimeString());
        const avgTimes = timeSeriesData.map(d => d.avg_execution_time || 0);
        const slowQueries = timeSeriesData.map(d => d.slow_queries || 0);

        performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Avg Execution Time (ms)',
                    data: avgTimes,
                    borderColor: '#007cba',
                    backgroundColor: 'rgba(0, 124, 186, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                }, {
                    label: 'Slow Queries Count',
                    data: slowQueries,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Execution Time (ms)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Slow Query Count'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });

        // Update time range label
        const hours = elements.timeRangeSelect.value;
        const rangeText = hours == 1 ? 'Last Hour' :
                         hours == 6 ? 'Last 6 Hours' :
                         hours == 24 ? 'Last 24 Hours' : 'Last Week';
        elements.chartTimeRange.textContent = rangeText;
    }

    // Refresh all data
    async function refreshDashboard() {
        showLoading(true);

        try {
            await Promise.all([
                fetchConnectionStatus(),
                fetchSlowQueryAlerts(),
                fetchPerformanceMetrics()
            ]);

            updateTimestamp();
        } catch (error) {
            console.error('Dashboard refresh error:', error);
            showError('Failed to refresh dashboard data');
        } finally {
            showLoading(false);
        }
    }

    // Export functionality
    function exportReport() {
        const hours = elements.timeRangeSelect.value;
        window.open(`/admin/database/export-report/?hours=${hours}`, '_blank');
    }

    // Event listeners
    elements.refreshBtn.addEventListener('click', refreshDashboard);
    elements.exportBtn.addEventListener('click', exportReport);
    elements.timeRangeSelect.addEventListener('change', refreshDashboard);

    // Auto-refresh setup
    function startAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        refreshInterval = setInterval(refreshDashboard, REFRESH_INTERVAL_MS);
    }

    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }

    // Visibility API for pausing refresh when tab is hidden
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopAutoRefresh();
        } else {
            startAutoRefresh();
        }
    });

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        refreshDashboard();
        startAutoRefresh();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        stopAutoRefresh();
        if (performanceChart) {
            performanceChart.destroy();
        }
    });
})();
</script>
{% endblock %}