{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Redis Performance Dashboard{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .redis-dashboard {
        margin: 20px;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .metric-card h3 {
        margin: 0 0 10px 0;
        color: #495057;
        font-size: 1.1em;
    }

    .metric-value {
        font-size: 2em;
        font-weight: bold;
        margin: 10px 0;
    }

    .metric-value.healthy { color: #28a745; }
    .metric-value.warning { color: #ffc107; }
    .metric-value.critical { color: #dc3545; }

    .metric-subtitle {
        color: #6c757d;
        font-size: 0.9em;
    }

    .alerts-section {
        margin: 30px 0;
    }

    .alert-item {
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border-left: 4px solid;
    }

    .alert-critical {
        background: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
    }

    .alert-warning {
        background: #fff3cd;
        border-color: #ffc107;
        color: #856404;
    }

    .alert-info {
        background: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }

    .charts-section {
        margin: 30px 0;
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
    }

    .health-checks {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }

    .health-check {
        padding: 15px;
        border-radius: 5px;
        text-align: center;
    }

    .health-check.healthy {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .health-check.degraded {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }

    .health-check.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .refresh-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 10px 5px;
    }

    .optimize-button {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 10px 5px;
    }

    .recommendations {
        background: #e2e3e5;
        border-radius: 5px;
        padding: 20px;
        margin: 20px 0;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="redis-dashboard">
    <h1>üî• Redis Performance Dashboard</h1>

    <div class="dashboard-controls">
        <button class="refresh-button" onclick="refreshDashboard()">üîÑ Refresh Metrics</button>
        <button class="optimize-button" onclick="optimizeMemory()">üß† Optimize Memory</button>
        <span class="loading" id="loading-indicator" style="display: none;">Loading...</span>
    </div>

    {% if metrics_error or dashboard_error %}
        <div class="alert-item alert-critical">
            <h3>‚ùå Dashboard Error</h3>
            <p>{{ metrics_error|default:dashboard_error }}</p>
            <p>Please check Redis connectivity and try again.</p>
        </div>
    {% else %}

    <!-- Overall Health Status -->
    <div class="metric-card" style="text-align: center; margin-bottom: 30px;">
        <h2>Overall Redis Health</h2>
        <div class="metric-value {{ overall_health }}">
            {% if overall_health == 'healthy' %}
                ‚úÖ HEALTHY
            {% elif overall_health == 'degraded' %}
                ‚ö†Ô∏è DEGRADED
            {% else %}
                ‚ùå CRITICAL
            {% endif %}
        </div>
        <div class="metric-subtitle">
            {{ critical_alerts_count }} critical, {{ warning_alerts_count }} warning alerts
        </div>
    </div>

    <!-- Key Metrics Grid -->
    <div class="metrics-grid">
        {% if current_metrics %}
            <div class="metric-card">
                <h3>üíæ Memory Usage</h3>
                <div class="metric-value {% if current_metrics.maxmemory > 0 %}{% if current_metrics.used_memory|div:current_metrics.maxmemory > 0.85 %}critical{% elif current_metrics.used_memory|div:current_metrics.maxmemory > 0.70 %}warning{% else %}healthy{% endif %}{% else %}healthy{% endif %}">
                    {{ current_metrics.used_memory_human }}
                </div>
                <div class="metric-subtitle">
                    {% if current_metrics.maxmemory > 0 %}
                        {{ current_metrics.used_memory|div:current_metrics.maxmemory|mul:100|floatformat:1 }}% of {{ current_metrics.maxmemory|div:1048576|floatformat:0 }}MB
                    {% else %}
                        No memory limit set
                    {% endif %}
                </div>
            </div>

            <div class="metric-card">
                <h3>üéØ Cache Hit Ratio</h3>
                <div class="metric-value {% if current_metrics.hit_ratio < 60 %}critical{% elif current_metrics.hit_ratio < 80 %}warning{% else %}healthy{% endif %}">
                    {{ current_metrics.hit_ratio }}%
                </div>
                <div class="metric-subtitle">
                    {{ current_metrics.keyspace_hits|floatformat:0 }} hits, {{ current_metrics.keyspace_misses|floatformat:0 }} misses
                </div>
            </div>

            <div class="metric-card">
                <h3>‚ö° Operations/Second</h3>
                <div class="metric-value {% if current_metrics.instantaneous_ops_per_sec > 50000 %}critical{% elif current_metrics.instantaneous_ops_per_sec > 10000 %}warning{% else %}healthy{% endif %}">
                    {{ current_metrics.instantaneous_ops_per_sec|floatformat:0 }}
                </div>
                <div class="metric-subtitle">
                    {{ current_metrics.total_commands_processed|floatformat:0 }} total commands
                </div>
            </div>

            <div class="metric-card">
                <h3>üîó Connections</h3>
                <div class="metric-value {% if current_metrics.connected_clients > 8000 %}critical{% elif current_metrics.connected_clients > 5000 %}warning{% else %}healthy{% endif %}">
                    {{ current_metrics.connected_clients }}
                </div>
                <div class="metric-subtitle">
                    {{ current_metrics.blocked_clients }} blocked clients
                </div>
            </div>

            <div class="metric-card">
                <h3>üß© Memory Fragmentation</h3>
                <div class="metric-value {% if current_metrics.memory_fragmentation_ratio > 2.0 %}critical{% elif current_metrics.memory_fragmentation_ratio > 1.5 %}warning{% else %}healthy{% endif %}">
                    {{ current_metrics.memory_fragmentation_ratio|floatformat:2 }}
                </div>
                <div class="metric-subtitle">
                    Fragmentation ratio
                </div>
            </div>

            <div class="metric-card">
                <h3>‚è±Ô∏è Uptime</h3>
                <div class="metric-value healthy">
                    {{ current_metrics.uptime_in_seconds|div:3600|floatformat:1 }}h
                </div>
                <div class="metric-subtitle">
                    Redis {{ current_metrics.redis_version }}
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Performance Alerts -->
    {% if performance_alerts %}
    <div class="alerts-section">
        <h2>üö® Performance Alerts</h2>
        {% for alert in performance_alerts %}
            <div class="alert-item alert-{{ alert.alert_level }}">
                <strong>{{ alert.message }}</strong>
                <p>{{ alert.recommendation }}</p>
                <small>Current: {{ alert.current_value }}, Threshold: {{ alert.threshold_value }}</small>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Health Checks -->
    <div class="health-checks-section">
        <h2>üè• Health Checks</h2>
        <div class="health-checks">
            {% for check_name, check_result in health_checks.items %}
                <div class="health-check {{ check_result.status }}">
                    <h4>{{ check_name|title|replace:"_":" " }}</h4>
                    <p>{{ check_result.message }}</p>
                    <small>{{ check_result.duration_ms|floatformat:1 }}ms</small>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Performance Charts -->
    <div class="charts-section">
        <h2>üìä Performance Trends (24 Hours)</h2>

        <div class="chart-container">
            <canvas id="memoryChart"></canvas>
        </div>

        <div class="chart-container">
            <canvas id="performanceChart"></canvas>
        </div>

        <div class="chart-container">
            <canvas id="connectionsChart"></canvas>
        </div>
    </div>

    <!-- Capacity Recommendations -->
    {% if capacity_recommendations %}
    <div class="recommendations">
        <h2>üí° Capacity Recommendations</h2>
        <ul>
            {% for recommendation in capacity_recommendations %}
                <li>{{ recommendation }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% endif %}

    <!-- Dashboard Information -->
    <div class="metric-card" style="margin-top: 30px; text-align: center;">
        <p><strong>Dashboard Last Updated:</strong> {{ dashboard_timestamp|date:"Y-m-d H:i:s" }} UTC</p>
        <p><em>Auto-refresh: 30 seconds | Manual refresh available</em></p>
    </div>
</div>

<script>
// Auto-refresh functionality
let refreshInterval;

function startAutoRefresh() {
    refreshInterval = setInterval(function() {
        refreshMetrics();
    }, 30000); // 30 seconds
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
}

function refreshDashboard() {
    window.location.reload();
}

function refreshMetrics() {
    // Show loading indicator
    document.getElementById('loading-indicator').style.display = 'inline';

    // Fetch new metrics via AJAX
    fetch('{% url "admin:redis_metrics_api" %}')
        .then(response => response.json())
        .then(data => {
            updateMetricsDisplay(data);
            updateCharts(data);
        })
        .catch(error => {
            console.error('Error refreshing metrics:', error);
        })
        .finally(() => {
            document.getElementById('loading-indicator').style.display = 'none';
        });
}

function updateMetricsDisplay(data) {
    // Update memory usage
    if (data.memory) {
        const memoryElement = document.querySelector('.metric-value');
        if (memoryElement) {
            memoryElement.textContent = data.memory.used_memory_human;
        }
    }

    // Update other metrics as needed
    // This is a simplified implementation
}

function optimizeMemory() {
    if (confirm('This will optimize Redis memory usage. Continue?')) {
        document.getElementById('loading-indicator').style.display = 'inline';

        fetch('{% url "admin:redis_memory_optimization" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({force: false})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'completed') {
                alert('Memory optimization completed successfully!');
                refreshDashboard();
            } else {
                alert('Memory optimization failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error during memory optimization: ' + error);
        })
        .finally(() => {
            document.getElementById('loading-indicator').style.display = 'none';
        });
    }
}

// Initialize charts
function initializeCharts() {
    {% if performance_trends and performance_trends.trends %}

    // Memory usage chart
    const memoryCtx = document.getElementById('memoryChart').getContext('2d');
    new Chart(memoryCtx, {
        type: 'line',
        data: {
            labels: ['Now - 24h', 'Now - 18h', 'Now - 12h', 'Now - 6h', 'Now'],
            datasets: [{
                label: 'Memory Usage (MB)',
                data: [
                    {% if performance_trends.trends.used_memory %}
                        {{ performance_trends.trends.used_memory.min|div:1048576|floatformat:1 }},
                        {{ performance_trends.trends.used_memory.average|div:1048576|floatformat:1 }},
                        {{ performance_trends.trends.used_memory.average|div:1048576|floatformat:1 }},
                        {{ performance_trends.trends.used_memory.average|div:1048576|floatformat:1 }},
                        {{ performance_trends.trends.used_memory.current|div:1048576|floatformat:1 }}
                    {% else %}
                        0, 0, 0, 0, 0
                    {% endif %}
                ],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Memory (MB)'
                    }
                }
            }
        }
    });

    // Performance metrics chart
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: ['Now - 24h', 'Now - 18h', 'Now - 12h', 'Now - 6h', 'Now'],
            datasets: [
                {
                    label: 'Hit Ratio (%)',
                    data: [
                        {% if performance_trends.trends.hit_ratio %}
                            {{ performance_trends.trends.hit_ratio.min }},
                            {{ performance_trends.trends.hit_ratio.average }},
                            {{ performance_trends.trends.hit_ratio.average }},
                            {{ performance_trends.trends.hit_ratio.average }},
                            {{ performance_trends.trends.hit_ratio.current }}
                        {% else %}
                            0, 0, 0, 0, 0
                        {% endif %}
                    ],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    yAxisID: 'y'
                },
                {
                    label: 'Ops/Second',
                    data: [
                        {% if performance_trends.trends.instantaneous_ops_per_sec %}
                            {{ performance_trends.trends.instantaneous_ops_per_sec.min }},
                            {{ performance_trends.trends.instantaneous_ops_per_sec.average }},
                            {{ performance_trends.trends.instantaneous_ops_per_sec.average }},
                            {{ performance_trends.trends.instantaneous_ops_per_sec.average }},
                            {{ performance_trends.trends.instantaneous_ops_per_sec.current }}
                        {% else %}
                            0, 0, 0, 0, 0
                        {% endif %}
                    ],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Hit Ratio (%)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Operations/Second'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });

    // Connections chart
    const connectionsCtx = document.getElementById('connectionsChart').getContext('2d');
    new Chart(connectionsCtx, {
        type: 'bar',
        data: {
            labels: ['Connected', 'Blocked', 'Tracking'],
            datasets: [{
                label: 'Client Connections',
                data: [
                    {{ current_metrics.connected_clients|default:0 }},
                    {{ current_metrics.blocked_clients|default:0 }},
                    {{ current_metrics.tracking_clients|default:0 }}
                ],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(255, 205, 86, 0.8)'
                ],
                borderColor: [
                    'rgb(75, 192, 192)',
                    'rgb(255, 99, 132)',
                    'rgb(255, 205, 86)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Client Count'
                    }
                }
            }
        }
    });

    {% endif %}
}

// Start auto-refresh when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    startAutoRefresh();
});

// Stop auto-refresh when page is hidden (to save resources)
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopAutoRefresh();
    } else {
        startAutoRefresh();
    }
});
</script>

{% csrf_token %}
{% endblock %}