{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Unified Monitoring Dashboard - {{ block.super }}{% endblock %}

{% block extrastyle %}
<style>
    .dashboard-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    .dashboard-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dashboard-section h2 {
        margin-top: 0;
        color: #417690;
        border-bottom: 2px solid #417690;
        padding-bottom: 10px;
    }
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    .metric-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #417690;
    }
    .metric-card.warning {
        border-left-color: #ff9800;
    }
    .metric-card.critical {
        border-left-color: #f44336;
    }
    .metric-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
    }
    .metric-value {
        font-size: 24px;
        font-weight: bold;
        color: #333;
    }
    .metric-unit {
        font-size: 14px;
        color: #999;
    }
    .anomaly-timeline {
        margin-top: 15px;
    }
    .anomaly-item {
        padding: 10px;
        margin-bottom: 10px;
        border-left: 4px solid #666;
        background: #f8f9fa;
    }
    .anomaly-item.low {
        border-left-color: #2196F3;
    }
    .anomaly-item.medium {
        border-left-color: #ff9800;
    }
    .anomaly-item.high {
        border-left-color: #ff5722;
    }
    .anomaly-item.critical {
        border-left-color: #f44336;
    }
    .model-performance {
        display: flex;
        justify-content: space-around;
        margin-top: 15px;
    }
    .model-stat {
        text-align: center;
    }
    .model-stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #417690;
    }
    .model-stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
    }
    .refresh-btn {
        float: right;
        background: #417690;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .refresh-btn:hover {
        background: #2e5266;
    }
    .timestamp {
        font-size: 11px;
        color: #999;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1>
        Unified Monitoring Dashboard
        <button class="refresh-btn" onclick="location.reload()">Refresh</button>
    </h1>
    <p class="timestamp">Last updated: {{ last_updated|date:"Y-m-d H:i:s" }} UTC</p>

    <!-- Infrastructure Health Section -->
    <div class="dashboard-section">
        <h2>Infrastructure Health</h2>
        <div class="metric-grid">
            {% for metric in infrastructure_metrics %}
            <div class="metric-card {% if metric.severity %}{{ metric.severity }}{% endif %}">
                <div class="metric-label">{{ metric.name }}</div>
                <div class="metric-value">
                    {{ metric.value|floatformat:1 }}
                    <span class="metric-unit">{{ metric.unit }}</span>
                </div>
            </div>
            {% empty %}
            <p>No infrastructure metrics available</p>
            {% endfor %}
        </div>
    </div>

    <!-- Anomaly Timeline Section -->
    <div class="dashboard-section">
        <h2>Anomaly Timeline (Last 24 Hours)</h2>
        <div class="anomaly-timeline">
            {% for anomaly in anomaly_timeline %}
            <div class="anomaly-item {{ anomaly.severity }}">
                <strong>{{ anomaly.metric_name }}</strong> - {{ anomaly.detection_method }}
                <br>
                <small>
                    Value: {{ anomaly.value|floatformat:2 }}, Expected: {{ anomaly.expected_value|floatformat:2 }}
                    ({{ anomaly.timestamp|date:"H:i:s" }})
                </small>
            </div>
            {% empty %}
            <p>No anomalies detected in the last 24 hours</p>
            {% endfor %}
        </div>
    </div>

    <!-- ML Model Performance Section -->
    <div class="dashboard-section">
        <h2>ML Model Performance</h2>
        <div class="model-performance">
            <div class="model-stat">
                <div class="model-stat-value">{{ conflict_accuracy|floatformat:1 }}%</div>
                <div class="model-stat-label">Conflict Predictor Accuracy</div>
            </div>
            <div class="model-stat">
                <div class="model-stat-value">{{ fraud_accuracy|floatformat:1 }}%</div>
                <div class="model-stat-label">Fraud Detector Accuracy</div>
            </div>
            <div class="model-stat">
                <div class="model-stat-value">{{ total_predictions }}</div>
                <div class="model-stat-label">Total Predictions (24h)</div>
            </div>
        </div>
    </div>

    <!-- ML Drift Alerts Section -->
    <div class="dashboard-section">
        <h2>ML Drift Alerts</h2>
        {% if drift_alerts %}
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa; text-align: left;">
                    <th style="padding: 10px;">Model Type</th>
                    <th style="padding: 10px;">Drift Detected</th>
                    <th style="padding: 10px;">K-S Statistic</th>
                    <th style="padding: 10px;">P-value</th>
                    <th style="padding: 10px;">Samples</th>
                </tr>
            </thead>
            <tbody>
                {% for drift in drift_alerts %}
                <tr style="border-bottom: 1px solid #ddd;">
                    <td style="padding: 10px;">{{ drift.model_type }}</td>
                    <td style="padding: 10px;">
                        {% if drift.drift_detected %}
                        <span style="color: #f44336; font-weight: bold;">YES</span>
                        {% else %}
                        <span style="color: #4caf50;">NO</span>
                        {% endif %}
                    </td>
                    <td style="padding: 10px;">{{ drift.ks_statistic|floatformat:4 }}</td>
                    <td style="padding: 10px;">{{ drift.p_value|floatformat:4 }}</td>
                    <td style="padding: 10px;">{{ drift.recent_samples }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No drift detection results available</p>
        {% endif %}
    </div>

    <!-- Alert Correlation Section -->
    <div class="dashboard-section">
        <h2>Alert Correlation (Anomalies â†’ NOC Alerts)</h2>
        <div class="metric-grid">
            <div class="metric-card">
                <div class="metric-label">Anomalies Detected (24h)</div>
                <div class="metric-value">{{ total_anomalies }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Alerts Created (24h)</div>
                <div class="metric-value">{{ total_alerts_created }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Alert Conversion Rate</div>
                <div class="metric-value">
                    {% if total_anomalies > 0 %}
                    {{ total_alerts_created|floatformat:0 }}/{{ total_anomalies }}
                    <span class="metric-unit">({{ conversion_rate|floatformat:1 }}%)</span>
                    {% else %}
                    N/A
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
