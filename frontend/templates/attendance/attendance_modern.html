{% extends "globals/layout.html" %}

{% block extra_css %}
{{ super() }}
<!-- DataTables CSS -->
<link href="{{ static('assets/plugins/custom/DataTables/datatables.min.css') }}" rel="stylesheet" type="text/css" />
<link href="{{ static('assets/plugins/custom/Editor-2.0.8/css/editor.dataTables.min.css') }}" rel="stylesheet" type="text/css" />

<style>
  /* Dropdown z-index fix to prevent it from being hidden */
  #columnVisibilityMenu {
    max-height: 400px !important;
    overflow-y: auto !important;
    z-index: 999999 !important;
    min-width: 200px !important;
    position: fixed !important;
  }
  
  /* Ensure attendance cards don't overlap dropdown */
  #attendance-list > div {
    position: relative;
    z-index: 1;
  }
  
  #columnVisibilityMenu label {
    transition: background-color 0.2s ease;
    margin: 0;
    border-radius: 4px;
  }
  
  #columnVisibilityMenu label:hover {
    background-color: #f3f4f6 !important;
  }
  
  #columnVisibilityMenu input[type="checkbox"] {
    margin-right: 8px;
    cursor: pointer;
  }
  
  .modern-filter-bar {
    position: relative;
    z-index: 100;
    overflow: visible !important;
  }
  
  .modern-action-group {
    overflow: visible !important;
  }
  
  #attendance-list {
    position: relative;
    z-index: 1;
  }
  
  /* Ensure the parent container doesn't clip the dropdown */
  .card-body {
    overflow: visible !important;
  }
  
  .kt-portlet__body {
    overflow: visible !important;
  }
  
  /* Modern Animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Inter Font Family */
  body {
    font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
  }

  .attendance-header {
    background: linear-gradient(135deg, #4c84ff 0%, var(--primary-color) 100%);
    color: white;
    border-radius: 1rem;
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
  }


  .date-filter-card {
    background: white;
    border-radius: 0.75rem;
    border: 1px solid #e7eaf3;
    padding: 1rem;
    margin-bottom: 0.25rem;
  }

  .date-filter-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .face-recognition-modal .modal-content {
    border-radius: 1rem;
    border: none;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }
  
  .face-recognition-modal .modal-body {
    padding: 0.75rem;  /* Minimal padding for compact layout */
  }
  
  .face-recognition-modal .modal-dialog {
    max-width: 900px;  /* Slightly smaller modal width */
  }
  
  /* Ensure modal appears on top */
  #frStatusModal {
    z-index: 9999 !important;
  }
  
  #frStatusModal.show {
    display: block !important;
    padding-right: 17px;
  }
  
  .modal-backdrop {
    z-index: 9998 !important;
    background-color: rgba(0, 0, 0, 0.5);
  }
  
  /* Pagination Controls Styling */
  .pagination-container {
    background: white;
    border-radius: 0 0 16px 16px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }
  
  .pagination-btn:hover:not(:disabled) {
    background: #f8fafc !important;
    border-color: #3b82f6 !important;
    color: #3b82f6 !important;
  }
  
  .pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  @media (max-width: 768px) {
    .pagination-container {
      flex-direction: column;
      gap: 1rem;
      align-items: stretch !important;
    }
    
    .pagination-buttons {
      justify-content: center;
    }
    
    .page-size-selector {
      justify-content: center;
    }
  }

  .face-recognition-modal .modal-header {
    background: linear-gradient(135deg, var(--primary-color), #4c84ff);
    color: white;
    border-radius: 1rem 1rem 0 0;
  }

  /* Images Section */
  .fr-images-section {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: #f8fafd;
    border-radius: 0.5rem;
  }

  .fr-image-column {
    text-align: center;
  }

  .fr-image-title {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 0.5rem;
    padding-bottom: 0.3rem;
    border-bottom: 1px solid #e7eaf3;
  }

  .fr-image-container {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 220px;  /* Fixed height for consistency */
    background: white;
    border-radius: 0.4rem;
    padding: 8px;
    border: 1px solid #e7eaf3;
    overflow: hidden;
  }

  .fr-image-container img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 0.3rem;
  }

  /* Details Section */
  .fr-details-section {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
    max-height: 250px;  /* Limit details section height */
    overflow-y: auto;   /* Scroll if needed */
  }

  .fr-detail-card {
    background: white;
    border-radius: 0.4rem;
    border: 1px solid #e7eaf3;
    overflow: hidden;
    height: fit-content;
  }

  .fr-detail-header {
    padding: 0.5rem 0.75rem;
    background: linear-gradient(135deg, #f8fafd, #e7eaf3);
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--dark-color);
    border-bottom: 1px solid #e7eaf3;
  }

  .fr-detail-content {
    padding: 0.5rem;
    font-size: 0.75rem;
  }

  .fr-detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.25rem 0;
    border-bottom: 1px solid #f1f3f4;
    font-size: 0.72rem;
    line-height: 1.2;
  }

  .fr-detail-item:last-child {
    border-bottom: none;
  }

  .fr-detail-label {
    font-weight: 500;
    color: #8392a5;
  }

  .fr-detail-value {
    color: var(--dark-color);
    font-weight: 500;
  }

  .location-modal .modal-dialog {
    max-width: 90vw;
  }

  .location-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .location-detail-card {
    background: #f8fafd;
    border-radius: 0.5rem;
    padding: 1rem;
    border: 1px solid #e7eaf3;
  }

  .location-detail-label {
    font-size: 0.75rem;
    color: #8392a5;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 0.25rem;
  }

  .location-detail-value {
    font-size: 0.875rem;
    color: var(--dark-color);
    font-weight: 500;
  }

  .map-container {
    border-radius: 0.75rem;
    overflow: hidden;
    border: 1px solid #e7eaf3;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .status-badge.matched {
    background: rgba(0, 201, 167, 0.1);
    color: var(--success-color);
    border: 1px solid rgba(0, 201, 167, 0.2);
  }

  .status-badge.not-matched {
    background: rgba(222, 68, 55, 0.1);
    color: var(--danger-color);
    border: 1px solid rgba(222, 68, 55, 0.2);
  }

  .status-badge.pending {
    background: rgba(255, 193, 7, 0.1);
    color: var(--warning-color);
    border: 1px solid rgba(255, 193, 7, 0.2);
  }

  .employee-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0;
  }

  .employee-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
    flex-shrink: 0;
  }

  .employee-info {
    flex: 1;
    min-width: 0;
  }

  .employee-name {
    font-weight: 500;
    color: var(--dark-color);
    font-size: 0.875rem;
    margin: 0;
  }

  .employee-code {
    font-size: 0.75rem;
    color: #8392a5;
    margin: 0;
  }

  /* Enhanced Responsive design */
  @media (max-width: 1200px) {
    .attendance-table-container {
      font-size: 0.8rem;
    }
    
    #attendance_table thead th {
      padding: 0.75rem 0.5rem;
      font-size: 0.75rem;
    }
    
    #attendance_table tbody td {
      padding: 0.75rem 0.5rem;
    }
  }

  @media (max-width: 992px) {
    .table-controls {
      flex-direction: column;
      gap: 0.5rem;
      text-align: center;
    }
    
    .attendance-header {
      margin-bottom: 0.25rem;
      padding: 0.5rem 0.75rem;
    }
    
    .date-filter-card {
      margin-bottom: 0.25rem;
    }
  }

  @media (max-width: 768px) {
    .attendance-header {
      padding: 0.5rem;
      text-align: center;
      margin-bottom: 0.125rem;
    }
    
    .attendance-header h1 {
      font-size: 1.125rem;
      margin-bottom: 0;
    }

    .date-filter-card {
      padding: 0.5rem;
      margin-bottom: 0.125rem;
    }
    
    .date-filter-card .row {
      flex-direction: column;
    }
    
    .date-filter-card .col-md-4 {
      margin-top: 1rem;
    }

    .fr-images-section {
      grid-template-columns: 1fr;
    }
    
    .fr-details-section {
      grid-template-columns: 1fr;
    }

    .location-details {
      grid-template-columns: 1fr;
    }
    
    .dataTables_wrapper .dataTables_filter input {
      width: 100%;
    }
    
    .dataTables_wrapper {
      padding: 0.75rem 0.5rem;
    }
    
    #attendance_table thead th {
      padding: 0.5rem 0.25rem;
      font-size: 0.7rem;
    }
    
    #attendance_table tbody td {
      padding: 0.5rem 0.25rem;
      font-size: 0.8rem;
    }
    
    .employee-card {
      flex-direction: column;
      text-align: center;
      gap: 0.5rem;
    }
    
    .employee-avatar {
      align-self: center;
    }
  }
  
  @media (max-width: 576px) {
    .attendance-header {
      padding: 0.375rem 0.5rem;
      margin-bottom: 0;
    }
    
    .attendance-header h1 {
      font-size: 1rem;
      margin-bottom: 0;
    }
    
    .attendance-header p {
      font-size: 0.75rem;
      margin-bottom: 0;
    }
    
    .date-filter-card {
      padding: 0.5rem;
      margin-bottom: 0.125rem;
    }
  }

  /* Table enhancements */
  .attendance-table-container {
    background: white;
    border-radius: 1rem;
    border: 1px solid #e7eaf3;
    overflow: hidden;
  }

  .table-controls {
    padding: 1rem;
    background: #f8fafd;
    border-bottom: 1px solid #e7eaf3;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .time-badge {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    background: rgba(55, 125, 255, 0.1);
    color: var(--primary-color);
    font-size: 0.875rem;
  }

  .location-link {
    color: var(--info-color);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
  }

  .location-link:hover {
    color: var(--primary-color);
    text-decoration: none;
  }

  /* Loading states */
  .loading-map {
    background: #f8fafd;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 400px;
    color: #8392a5;
  }

  .loading-spinner {
    width: 2rem;
    height: 2rem;
    border: 0.25rem solid #e7eaf3;
    border-top: 0.25rem solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  /* Modern Table styling */
  .attendance-table-container {
    background: white;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-top: 0rem;
    border: 1px solid #e7eaf3;
  }
  
  #attendance_table {
    margin-bottom: 0 !important;
    font-size: 0.875rem;
  }
  
  #attendance_table thead th {
    background: linear-gradient(135deg, #4c84ff 0%, #377dff 100%) !important;
    color: white !important;
    border: none !important;
    padding: 1rem 0.75rem;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    position: relative;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  #attendance_table thead th:last-child {
    border-right: none;
  }
  
  #attendance_table tbody td {
    padding: 1rem 0.75rem;
    border-top: 1px solid #f1f3f4;
    vertical-align: middle;
    font-size: 0.875rem;
    border-right: 1px solid #f8f9fa;
    transition: all 0.2s ease;
  }
  
  #attendance_table tbody td:last-child {
    border-right: none;
  }
  
  #attendance_table tbody tr:hover {
    background-color: #f8fafd;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  #attendance_table tbody tr:nth-child(even) {
    background-color: #fafbfc;
  }
  
  #attendance_table tbody tr:nth-child(even):hover {
    background-color: #f8fafd;
  }
  
  /* Enhanced Status badges styling */
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 2px solid transparent;
    transition: all 0.2s ease;
  }
  
  .status-badge.matched {
    background: linear-gradient(135deg, #00c9a7 0%, #00a085 100%);
    color: white;
    border-color: rgba(0, 201, 167, 0.3);
    box-shadow: 0 2px 8px rgba(0, 201, 167, 0.2);
  }
  
  .status-badge.not-matched {
    background: linear-gradient(135deg, #de4437 0%, #c73e1d 100%);
    color: white;
    border-color: rgba(222, 68, 55, 0.3);
    box-shadow: 0 2px 8px rgba(222, 68, 55, 0.2);
  }
  
  .status-badge.pending {
    background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
    color: #663c00;
    border-color: rgba(255, 193, 7, 0.3);
    box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
  }
  
  .status-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  /* Modern DataTables styling */
  .dataTables_wrapper {
    padding: 1rem 0.5rem;
    background: white;
  }
  
  .dataTables_wrapper .dataTables_length,
  .dataTables_wrapper .dataTables_filter {
    margin-bottom: 1rem;
  }
  
  .dataTables_wrapper .dataTables_length select {
    border: 2px solid #e7eaf3;
    border-radius: 0.5rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    background-color: white;
    transition: border-color 0.2s ease;
  }
  
  .dataTables_wrapper .dataTables_length select:focus {
    border-color: #4c84ff;
    outline: none;
    box-shadow: 0 0 0 3px rgba(76, 132, 255, 0.1);
  }
  
  .dataTables_wrapper .dataTables_filter input {
    border: 2px solid #e7eaf3;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    width: 300px;
  }
  
  .dataTables_wrapper .dataTables_filter input:focus {
    border-color: #4c84ff;
    outline: none;
    box-shadow: 0 0 0 3px rgba(76, 132, 255, 0.1);
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button {
    padding: 0.5rem 0.75rem !important;
    margin: 0 0.125rem;
    border-radius: 0.5rem;
    border: 1px solid #e7eaf3;
    background: white;
    color: #8392a5 !important;
    transition: all 0.2s ease;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
    background: #f8fafd !important;
    border-color: #4c84ff !important;
    color: #4c84ff !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background: #4c84ff !important;
    border-color: #4c84ff !important;
    color: white !important;
  }
  
  .dataTables_wrapper .dataTables_info {
    padding-top: 1rem;
    color: #8392a5;
    font-size: 0.875rem;
  }
  
  .dataTables_wrapper .dataTables_processing {
    background: rgba(255, 255, 255, 0.95);
    color: #4c84ff;
    font-weight: 600;
    border-radius: 0.5rem;
    border: 2px solid #e7eaf3;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }
  
  /* Enhanced button styling */
  .btn {
    border-radius: 0.5rem;
    font-weight: 600;
    padding: 0.5rem 1rem;
    transition: all 0.2s ease;
    border-width: 2px;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #4c84ff 0%, #377dff 100%);
    border-color: #4c84ff;
    box-shadow: 0 2px 8px rgba(76, 132, 255, 0.3);
  }
  
  .btn-primary:hover {
    background: linear-gradient(135deg, #377dff 0%, #2968ff 100%);
    border-color: #377dff;
    box-shadow: 0 4px 12px rgba(76, 132, 255, 0.4);
    transform: translateY(-1px);
  }
  
  .btn-outline-primary {
    border-color: #4c84ff;
    color: #4c84ff;
    background: transparent;
  }
  
  .btn-outline-primary:hover {
    background: #4c84ff;
    border-color: #4c84ff;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(76, 132, 255, 0.3);
  }
  
  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.8rem;
  }
  
  /* Action button enhancements */
  .btn-group .btn {
    margin: 0 0.125rem;
  }
  
  .table-actions .btn-group {
    gap: 0.25rem;
  }
</style>
{% endblock extra_css %}

{% block pagebreadcumb %}
<li class="breadcrumb-item pe-3"><a href="{{ url('onboarding:rp_dashboard') }}" class="pe-3">Home</a></li>
<li class="breadcrumb-item active pe-3">Attendance</li>
{% endblock pagebreadcumb %}

{% block pagebody_container %}
<div class="container-fluid px-4">
  <!-- Page Header -->
  <div class="attendance-header">
    <h1>Attendance Management</h1>
    <p>Monitor and manage staff attendance with face recognition and geolocation</p>
  </div>


<!-- Modern Header Controls -->
<div class="modern-header-controls" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important; padding: 1.25rem 1.5rem !important; border-radius: 16px !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important; margin-bottom: 1rem !important; border: 1px solid #e2e8f0 !important; backdrop-filter: blur(10px) !important;">
	<div class="d-flex align-items-center justify-content-between flex-wrap gap-4">
		<!-- Search Section -->
		<div class="modern-search" style="position: relative; flex: 1; max-width: 400px; margin-right: 2rem;">
			<i class="material-icons search-icon" style="position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #6b7280; z-index: 10; font-size: 16px; font-weight: 500;">search</i>
			<input type="text" id="modern-search-input" placeholder="Search attendance records..." style="width: 100% !important; padding: 14px 20px 14px 52px !important; background-color: #ffffff !important; border: 2px solid #e5e7eb !important; border-radius: 12px !important; font-size: 15px !important; font-weight: 600 !important; color: #1f2937 !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06) !important; font-family: 'Inter', system-ui, -apple-system, sans-serif !important; height: auto !important;">
		</div>
		
		<!-- Date Range Picker -->
		<div class="modern-date-range" style="position: relative; margin-right: 2rem;">
			<i class="material-icons search-icon" style="position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #6b7280; z-index: 10; font-size: 16px; font-weight: 500;">date_range</i>
			<input type="text" id="dateRangeInput" placeholder="Select date range..." readonly style="width: 280px !important; padding: 14px 20px 14px 52px !important; background-color: #ffffff !important; border: 2px solid #e5e7eb !important; border-radius: 12px !important; font-size: 15px !important; font-weight: 600 !important; color: #1f2937 !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06) !important; font-family: 'Inter', system-ui, -apple-system, sans-serif !important; height: auto !important; cursor: pointer;">
		</div>
		
		<!-- Action Buttons -->
		<div class="modern-action-group" style="display: flex; align-items: center; gap: 12px;">
			<!-- Column Visibility -->
			<div class="dropdown" style="position: relative;">
				<button type="button" class="modern-export-btn" id="columnToggleBtn" style="padding: 10px 18px !important; border: 2px solid #d1d5db !important; border-radius: 10px !important; background: #ffffff !important; color: #6b7280 !important; font-size: 14px !important; font-weight: 700 !important; cursor: pointer !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; display: inline-flex !important; align-items: center !important; gap: 8px !important; white-space: nowrap !important; font-family: 'Inter', system-ui, -apple-system, sans-serif !important; letter-spacing: 0.025em !important; text-decoration: none !important; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;">
					<i class="bi bi-eye"></i> Columns <i class="bi bi-chevron-down" style="font-size: 12px;"></i>
				</button>
				<div id="columnVisibilityMenu" style="display: none; position: fixed; z-index: 999999 !important; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); min-width: 200px; max-height: 400px; overflow-y: auto; margin-top: 4px;">
					<div style="padding: 8px;">
						<label style="display: block; padding: 8px 12px; cursor: pointer; hover: background-color: #f3f4f6;"><input type="checkbox" class="column-toggle" data-column="type" checked style="margin-right: 8px;"> Type</label>
						<label style="display: block; padding: 8px 12px; cursor: pointer;"><input type="checkbox" class="column-toggle" data-column="site" checked style="margin-right: 8px;"> Site</label>
						<label style="display: block; padding: 8px 12px; cursor: pointer;"><input type="checkbox" class="column-toggle" data-column="code" checked style="margin-right: 8px;"> Code</label>
						<label style="display: block; padding: 8px 12px; cursor: pointer;"><input type="checkbox" class="column-toggle" data-column="employee" checked style="margin-right: 8px;"> Employee</label>
						<label style="display: block; padding: 8px 12px; cursor: pointer;"><input type="checkbox" class="column-toggle" data-column="verified" checked style="margin-right: 8px;"> Verified By</label>
						<label style="display: block; padding: 8px 12px; cursor: pointer;"><input type="checkbox" class="column-toggle" data-column="date" checked style="margin-right: 8px;"> Date</label>
						<label style="display: block; padding: 8px 12px; cursor: pointer;"><input type="checkbox" class="column-toggle" data-column="intime" checked style="margin-right: 8px;"> In Time</label>
						<label style="display: block; padding: 8px 12px; cursor: pointer;"><input type="checkbox" class="column-toggle" data-column="outtime" checked style="margin-right: 8px;"> Out Time</label>
						<label style="display: block; padding: 8px 12px; cursor: pointer;"><input type="checkbox" class="column-toggle" data-column="shift" checked style="margin-right: 8px;"> Shift</label>
						<label style="display: block; padding: 8px 12px; cursor: pointer;"><input type="checkbox" class="column-toggle" data-column="frl" checked style="margin-right: 8px;"> FRL Status</label>
						<label style="display: block; padding: 8px 12px; cursor: pointer;"><input type="checkbox" class="column-toggle" data-column="location" checked style="margin-right: 8px;"> Location</label>
						<label style="display: block; padding: 8px 12px; cursor: pointer;"><input type="checkbox" class="column-toggle" data-column="endtime" checked style="margin-right: 8px;"> Shift End Time</label>
					</div>
				</div>
			</div>
			
			<!-- Export PDF -->
			<button type="button" class="modern-export-btn" id="exportPDF" style="padding: 10px 18px !important; border: 2px solid #dc2626 !important; border-radius: 10px !important; background: #ffffff !important; color: #dc2626 !important; font-size: 14px !important; font-weight: 700 !important; cursor: pointer !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; display: inline-flex !important; align-items: center !important; gap: 8px !important; white-space: nowrap !important; font-family: 'Inter', system-ui, -apple-system, sans-serif !important; letter-spacing: 0.025em !important; text-decoration: none !important; box-shadow: 0 1px 3px rgba(220, 38, 38, 0.2) !important;">
				<i class="bi bi-file-pdf"></i> PDF
			</button>
			
			<!-- Export Excel -->
			<button type="button" class="modern-export-btn" id="exportExcel" style="padding: 10px 18px !important; border: 2px solid #16a34a !important; border-radius: 10px !important; background: #ffffff !important; color: #16a34a !important; font-size: 14px !important; font-weight: 700 !important; cursor: pointer !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; display: inline-flex !important; align-items: center !important; gap: 8px !important; white-space: nowrap !important; font-family: 'Inter', system-ui, -apple-system, sans-serif !important; letter-spacing: 0.025em !important; text-decoration: none !important; box-shadow: 0 1px 3px rgba(22, 163, 74, 0.2) !important;">
				<i class="bi bi-file-excel"></i> Excel
			</button>
			
			<!-- Refresh -->
			<button type="button" class="modern-export-btn" id="refreshAttendance" style="padding: 10px 18px !important; border: 2px solid #d1d5db !important; border-radius: 10px !important; background: #ffffff !important; color: #6b7280 !important; font-size: 14px !important; font-weight: 700 !important; cursor: pointer !important; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; display: inline-flex !important; align-items: center !important; gap: 8px !important; white-space: nowrap !important; font-family: 'Inter', system-ui, -apple-system, sans-serif !important; letter-spacing: 0.025em !important; text-decoration: none !important; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;">
				<i class="material-icons" style="font-size: 16px;">refresh</i> Refresh
			</button>
		</div>
	</div>
</div>

<!-- Modern Attendance List -->
<div class="premium-attendance-list" style="background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%) !important; border-radius: 16px !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important; border: 1px solid #e5e7eb !important; overflow: hidden !important; backdrop-filter: blur(10px) !important;">
	
	<!-- Table Header -->
	<div style="display: flex; align-items: center; min-height: 48px; padding: 12px 16px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-bottom: 2px solid #e2e8f0; font-weight: 600; font-size: 13px; color: #475569; text-transform: uppercase; letter-spacing: 0.05em; font-family: 'Inter', system-ui, sans-serif;">
		<div style="width: 52px; margin-right: 12px;"><!-- Avatar space --></div>
		<div style="flex: 1; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 16px; align-items: center;">
			<div style="font-weight: 700; color: #1e293b;">
				<i class="material-icons" style="margin-right: 6px; font-size: 12px;">person</i>Employee
			</div>
			<div style="font-weight: 700; color: #1e293b;">
				<i class="material-icons" style="margin-right: 6px; font-size: 12px;">location_on</i>Site & Type
			</div>
			<div style="font-weight: 700; color: #1e293b;">
				<i class="material-icons" style="margin-right: 6px; font-size: 12px;">access_time</i>Actual Time
			</div>
			<div style="font-weight: 700; color: #1e293b;">
				<i class="material-icons" style="margin-right: 6px; font-size: 12px;">schedule</i>Shift Time
			</div>
			<div style="font-weight: 700; color: #1e293b;">
				<i class="material-icons" style="margin-right: 6px; font-size: 12px;">face</i>Recognition
			</div>
		</div>
		<div style="min-width: 100px; text-align: center; font-weight: 700; color: #1e293b;">
			<i class="material-icons" style="margin-right: 6px; font-size: 12px;">visibility</i>Actions
		</div>
	</div>

	<div id="attendance-loading" class="premium-loading" style="padding: 80px 32px !important; text-align: center !important; color: #6b7280 !important; background: linear-gradient(135deg, #fefefe 0%, #f8fafc 100%) !important;">
		<div class="spinner-border" style="color: #3b82f6 !important; width: 3rem !important; height: 3rem !important; border-width: 0.3em !important;" role="status">
			<span class="visually-hidden">Loading...</span>
		</div>
		<h5 style="color: #374151 !important; font-weight: 600 !important; margin-top: 1.5rem !important; font-family: 'Inter', system-ui, -apple-system, sans-serif !important;">Loading attendance records...</h5>
		<p style="color: #9ca3af !important; font-size: 15px !important; margin-top: 0.5rem !important; font-family: 'Inter', system-ui, -apple-system, sans-serif !important;">Please wait while we fetch the data</p>
	</div>

	<div id="attendance-list">
		<!-- Attendance records will be populated here -->
	</div>
	
	<!-- Hidden DataTable for server-side processing -->
	<table id="hidden-datatable" style="display: none;"></table>

	<div id="attendance-empty" class="premium-empty d-none" style="padding: 80px 32px !important; text-align: center !important; color: #6b7280 !important; background: linear-gradient(135deg, #fefefe 0%, #f8fafc 100%) !important;">
		<i class="material-icons" style="font-size: 4rem; color: #d1d5db; margin-bottom: 1rem;">assignment</i>
		<h5 style="color: #374151 !important; font-weight: 600 !important; margin-top: 1.5rem !important; font-family: 'Inter', system-ui, -apple-system, sans-serif !important;">No attendance records found</h5>
		<p style="color: #9ca3af !important; font-size: 15px !important; margin-top: 0.5rem !important; font-family: 'Inter', system-ui, -apple-system, sans-serif !important;">Try adjusting your search criteria or date range to find records</p>
	</div>
	
	<!-- Pagination Controls -->
	<div id="pagination-controls" class="pagination-container d-none" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: white; border-top: 1px solid #e5e7eb; margin-top: auto;">
		<div class="pagination-info" style="color: #6b7280; font-size: 14px; font-weight: 500;">
			Showing <span id="record-start">1</span> to <span id="record-end">50</span> of <span id="total-records">0</span> entries
		</div>
		
		<div class="pagination-buttons" style="display: flex; gap: 0.5rem;">
			<button id="first-page" class="pagination-btn" onclick="goToPage(1)" style="padding: 6px 12px; border: 1px solid #d1d5db; background: white; border-radius: 6px; color: #374151; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
				<i class="material-icons" style="font-size: 16px;">first_page</i>
			</button>
			<button id="prev-page" class="pagination-btn" onclick="goToPage(currentPage - 1)" style="padding: 6px 12px; border: 1px solid #d1d5db; background: white; border-radius: 6px; color: #374151; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
				<i class="material-icons" style="font-size: 16px;">chevron_left</i>
			</button>
			
			<div id="page-numbers" style="display: flex; gap: 0.25rem;">
				<!-- Page numbers will be dynamically inserted here -->
			</div>
			
			<button id="next-page" class="pagination-btn" onclick="goToPage(currentPage + 1)" style="padding: 6px 12px; border: 1px solid #d1d5db; background: white; border-radius: 6px; color: #374151; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
				<i class="material-icons" style="font-size: 16px;">chevron_right</i>
			</button>
			<button id="last-page" class="pagination-btn" onclick="goToPage(totalPages)" style="padding: 6px 12px; border: 1px solid #d1d5db; background: white; border-radius: 6px; color: #374151; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
				<i class="material-icons" style="font-size: 16px;">last_page</i>
			</button>
		</div>
		
		<div class="page-size-selector" style="display: flex; align-items: center; gap: 0.5rem;">
			<label style="color: #6b7280; font-size: 14px;">Show</label>
			<select id="records-per-page" onchange="changeRecordsPerPage(this.value)" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white; color: #374151; font-size: 14px;">
				<option value="25">25</option>
				<option value="50" selected>50</option>
				<option value="100">100</option>
				<option value="200">200</option>
			</select>
			<label style="color: #6b7280; font-size: 14px;">entries</label>
		</div>
	</div>
</div>

<!-- Face Recognition Status Modal -->
<div class="modal fade face-recognition-modal" id="frStatusModal" tabindex="-1" aria-labelledby="frStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="frStatusModalLabel">
          <i class="material-icons me-2">face</i>
          Face Recognition & Location Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="closeFRModal()"></button>
      </div>
      <div class="modal-body">
        <!-- Warning Message -->
        <div id="frWarningMessage" style="display: none; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px 16px; margin-bottom: 20px; color: #92400e; font-size: 14px; font-weight: 600;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 20px;">⚠️</span>
            <div>
              <div>Reference image appears to be Non-face image</div>
              <div style="font-weight: 500; font-size: 13px; margin-top: 2px;">Kindly update with a proper User face image.</div>
            </div>
          </div>
        </div>
        <!-- Images Section -->
        <div class="fr-images-section">
          <div class="fr-image-column">
            <h6 class="fr-image-title">Check-in Image</h6>
            <div class="fr-image-container">
              <img id="checkinImage" src="" alt="Check-in" style="display: none;">
              <div class="text-muted" id="checkinPlaceholder">No image available</div>
            </div>
          </div>
          
          <div class="fr-image-column">
            <h6 class="fr-image-title">Profile Image</h6>
            <div class="fr-image-container">
              <img id="profileImage" src="" alt="Profile" style="display: none;">
              <div class="text-muted" id="profilePlaceholder">No image available</div>
            </div>
          </div>
          
          <div class="fr-image-column">
            <h6 class="fr-image-title">Check-out Image</h6>
            <div class="fr-image-container">
              <img id="checkoutImage" src="" alt="Check-out" style="display: none;">
              <div class="text-muted" id="checkoutPlaceholder">No image available</div>
            </div>
          </div>
        </div>
        
        <!-- Details Section -->
        <div class="fr-details-section">
          <!-- Check-in Details -->
          <div class="fr-detail-card">
            <div class="fr-detail-header">Check-in Details</div>
            <div class="fr-detail-content">
              <div class="fr-detail-item">
                <span class="fr-detail-label">Face Recognition:</span>
                <span class="fr-detail-value" id="frInAccuracy">-</span>
              </div>
              <div class="fr-detail-item">
                <span class="fr-detail-label">Metric Used:</span>
                <span class="fr-detail-value" id="frInMetric">-</span>
              </div>
              <div class="fr-detail-item">
                <span class="fr-detail-label">Performed By:</span>
                <span class="fr-detail-value" id="frInUser">-</span>
              </div>
              <div class="fr-detail-item">
                <span class="fr-detail-label">Date:</span>
                <span class="fr-detail-value" id="frInDate">-</span>
              </div>
              <div class="fr-detail-item">
                <span class="fr-detail-label">Location:</span>
                <span class="fr-detail-value" id="frInLocation">-</span>
              </div>
            </div>
          </div>
          
          <!-- Profile Details -->
          <div class="fr-detail-card">
            <div class="fr-detail-header">Profile Details</div>
            <div class="fr-detail-content">
              <div class="fr-detail-item">
                <span class="fr-detail-label">Profile Type:</span>
                <span class="fr-detail-value">Default Profile Image</span>
              </div>
              <div class="fr-detail-item">
                <span class="fr-detail-label">Taken On:</span>
                <span class="fr-detail-value" id="profileTakenOn">-</span>
              </div>
              <div class="fr-detail-item">
                <span class="fr-detail-label">Created By:</span>
                <span class="fr-detail-value" id="profileCreatedBy">-</span>
              </div>
              <div class="fr-detail-item">
                <span class="fr-detail-label">Modified On:</span>
                <span class="fr-detail-value" id="profileModifiedOn">-</span>
              </div>
              <div class="fr-detail-item">
                <span class="fr-detail-label">Base Location:</span>
                <span class="fr-detail-value" id="profileBaseLocation">-</span>
              </div>
            </div>
          </div>
          
          <!-- Check-out Details -->
          <div class="fr-detail-card">
            <div class="fr-detail-header">Check-out Details</div>
            <div class="fr-detail-content">
              <div class="fr-detail-item">
                <span class="fr-detail-label">Face Recognition:</span>
                <span class="fr-detail-value" id="frOutAccuracy">-</span>
              </div>
              <div class="fr-detail-item">
                <span class="fr-detail-label">Metric Used:</span>
                <span class="fr-detail-value" id="frOutMetric">-</span>
              </div>
              <div class="fr-detail-item">
                <span class="fr-detail-label">Performed By:</span>
                <span class="fr-detail-value" id="frOutUser">-</span>
              </div>
              <div class="fr-detail-item">
                <span class="fr-detail-label">Date:</span>
                <span class="fr-detail-value" id="frOutDate">-</span>
              </div>
              <div class="fr-detail-item">
                <span class="fr-detail-label">Location:</span>
                <span class="fr-detail-value" id="frOutLocation">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%); border-top: 1px solid #e2e8f0; padding: 1rem 1.5rem;">
        <button type="button" class="btn btn-primary" onclick="closeFRModal()" style="padding: 10px 24px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 8px; color: white; font-weight: 700; font-size: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); transition: all 0.3s ease;">
          OK
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Location Details Modal -->
<div class="modal fade location-modal" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="locationModalLabel">
          <i class="material-icons me-2">place</i>
          Attendance Location Details
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="loading-map" id="mapLoading">
          <div class="text-center">
            <div class="loading-spinner mb-2"></div>
            <div>Fetching location details...</div>
          </div>
        </div>
        
        <div id="locationContent" style="display: none;">
          <div class="location-details">
            <div class="location-detail-card">
              <div class="location-detail-label">Site Name</div>
              <div class="location-detail-value" id="locationSiteName">-</div>
            </div>
            <div class="location-detail-card">
              <div class="location-detail-label">Employee Name</div>
              <div class="location-detail-value" id="locationEmployeeName">-</div>
            </div>
            <div class="location-detail-card">
              <div class="location-detail-label">Employee Phone</div>
              <div class="location-detail-value" id="locationEmployeePhone">-</div>
            </div>
            <div class="location-detail-card">
              <div class="location-detail-label">Site Incharge</div>
              <div class="location-detail-value" id="locationSiteIncharge">-</div>
            </div>
            <div class="location-detail-card">
              <div class="location-detail-label">Incharge Phone</div>
              <div class="location-detail-value" id="locationInchargePhone">-</div>
            </div>
            <div class="location-detail-card">
              <div class="location-detail-label">Incharge Email</div>
              <div class="location-detail-value" id="locationInchargeEmail">-</div>
            </div>
          </div>
          
          <div class="map-container">
            <div id="attendanceMap" style="height: 400px; width: 100%;"></div>
          </div>
        </div>
        
        <div class="alert alert-warning" id="noLocationData" style="display: none;">
          <i class="material-icons me-2">warning</i>
          <strong>No Data Available:</strong> There is no geofence details available for this record.
        </div>
      </div>
    </div>
  </div>
</div>

</div>
{% endblock pagebody_container %}

{% block extra_scripts %}
{{ super() }}
<!-- DataTables JavaScript -->
<script src="{{ static('assets/plugins/custom/DataTables/datatables.min.js') }}"></script>
<script src="{{ static('assets/plugins/custom/Editor-2.0.8/js/dataTables.editor.min.js') }}"></script>

<!-- Google Maps API -->
{% load google_maps_tags %}
{% google_maps_script callback='initGoogleMaps' %}

<!-- Date Range Picker -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

<script>
// Pagination variables
let attendanceData = [];
let currentPage = 1;
let totalPages = 1;
let totalRecords = 0;
let recordsPerPage = 50;  // Show 50 records per page
let isLoading = false;

// Filter variables
let currentSearch = '';
let params = null;
let from_pd = moment().subtract(7, 'days').format('YYYY-MM-DD');
let to_pd = moment().format('YYYY-MM-DD');
params = {from: from_pd, to: to_pd};

// Avatar color classes
const avatarColors = [
  'avatar-blue', 'avatar-green', 'avatar-purple', 'avatar-orange',
  'avatar-pink', 'avatar-indigo', 'avatar-red', 'avatar-teal'
];

// Get avatar color based on name
function getAvatarColor(name) {
  const index = name ? name.length % avatarColors.length : 0;
  return avatarColors[index];
}

// Get avatar initials
function getInitials(name) {
  if (!name || name === 'NONE') return '?';
  return name.split(' ')
    .map(word => word.charAt(0).toUpperCase())
    .filter(char => char)
    .join('')
    .substring(0, 2) || name.substring(0, 2).toUpperCase();
}

// Export functions
function exportToPDF(data, visibleColumns) {
  // Create URL with parameters for server-side PDF generation
  const params = {
    from: from_pd,
    to: to_pd,
    columns: visibleColumns.join(','),
    format: 'pdf'
  };
  
  const url = `/attendance/attendance/?action=export&params=${encodeURIComponent(JSON.stringify(params))}`;
  window.open(url, '_blank');
}

function exportToExcel(data, visibleColumns) {
  // Create CSV content
  const headers = [];
  const columnMap = {
    'type': 'Type',
    'site': 'Site',
    'code': 'Code',
    'employee': 'Employee',
    'verified': 'Verified By',
    'date': 'Date',
    'intime': 'In Time',
    'outtime': 'Out Time',
    'shift': 'Shift',
    'frl': 'FRL Status',
    'location': 'Location',
    'endtime': 'Shift End Time'
  };
  
  // Build headers
  visibleColumns.forEach(col => {
    if (columnMap[col]) headers.push(columnMap[col]);
  });
  
  // Build rows
  const rows = data.map(record => {
    const row = [];
    visibleColumns.forEach(col => {
      switch(col) {
        case 'type': row.push(record.peventtype__taname || ''); break;
        case 'site': row.push(record.bu__buname || ''); break;
        case 'code': row.push(record.people__peoplecode || ''); break;
        case 'employee': row.push(record.people__peoplename || ''); break;
        case 'verified': row.push(record.verified_by || 'Not Verified'); break;
        case 'date': row.push(record.datefor || ''); break;
        case 'intime': row.push(record.punchintime || ''); break;
        case 'outtime': row.push(record.punchouttime || ''); break;
        case 'shift': row.push(record.shift__shiftname || ''); break;
        case 'frl': row.push(record.facerecognitionin ? 'Matched' : 'Not Matched'); break;
        case 'location': row.push(record.checkinlocation || ''); break;
        case 'endtime': row.push(record.shift__endtime || ''); break;
      }
    });
    return row;
  });
  
  // Convert to CSV
  let csv = headers.join(',') + '\n';
  rows.forEach(row => {
    csv += row.map(val => `"${val}"`).join(',') + '\n';
  });
  
  // Download
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `attendance_${from_pd}_to_${to_pd}.csv`;
  link.click();
}

$(document).ready(function() {
  // Move the dropdown menu to body to ensure it's on top
  $('#columnVisibilityMenu').appendTo('body');
  // Initialize date range picker
  initializeDateRangePicker();
  
  // Initialize attendance list
  initializeAttendanceList();
  
  // Setup event handlers
  setupEventHandlers();
  
  // Auto-refresh every 5 minutes
  setInterval(() => {
    if (attendanceTable) {
      // Store current page before refresh
      const currentPageBefore = attendanceTable.page();
      
      // Reload data
      $.get('/attendance/attendance/?action=list&params=' + encodeURIComponent(JSON.stringify(params)))
        .done(function(response) {
          const data = response.data || [];
          
          // Clear and add new data
          attendanceTable.clear();
          attendanceTable.rows.add(data);
          
          // Go back to the same page
          attendanceTable.page(currentPageBefore).draw(false);
        });
    }
  }, 300000);
});

function initializeAttendanceList() {
  initializeAttendanceDataTable();
}

function showLoadingState() {
  // Show loading spinner in the list area
  $('#attendance-list').html(`
    <div class="text-center py-5">
      <div class="spinner-border" style="color: #3b82f6 !important; width: 3rem !important; height: 3rem !important;" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h5 style="color: #374151 !important; font-weight: 600 !important; margin-top: 1.5rem !important;">Applying filter...</h5>
      <p style="color: #9ca3af !important; font-size: 15px !important; margin-top: 0.5rem !important;">Loading attendance records for selected date range</p>
    </div>
  `);
  
  // Add visual feedback to date input
  $('#dateRangeInput').parent().find('.input-group-text').html('<i class="bi bi-hourglass-split"></i>');
}

function hideLoadingState() {
  // Restore calendar icon
  $('#dateRangeInput').parent().find('.input-group-text').html('<i class="bi bi-calendar3"></i>');
}

function initializeDateRangePicker() {
  $('#dateRangeInput').daterangepicker({
    startDate: moment().subtract(7, 'days'),
    endDate: moment(),
    ranges: {
      'Today': [moment(), moment()],
      'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
      'Last 7 Days': [moment().subtract(6, 'days'), moment()],
      'Last 30 Days': [moment().subtract(29, 'days'), moment()],
      'This Month': [moment().startOf('month'), moment().endOf('month')],
      'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
    },
    locale: {
      format: 'YYYY-MM-DD'
    }
  }, function(start, end, label) {
    updateDateRangeDisplay(start, end);
    // Auto-apply filter when date range changes
    from_pd = start.format('YYYY-MM-DD');
    to_pd = end.format('YYYY-MM-DD');
    params = {from: from_pd, to: to_pd};
    
    // Show loading state
    showLoadingState();
    
    // Reinitialize DataTable with new parameters after a short delay to prevent too many requests
    clearTimeout(window.dateFilterTimeout);
    window.dateFilterTimeout = setTimeout(function() {
      initializeAttendanceDataTable();
    }, 300);
  });
  
  // Set initial display
  updateDateRangeDisplay(moment().subtract(7, 'days'), moment());
}

function updateDateRangeDisplay(start, end) {
  const displayText = `${start.format('MMM DD, YYYY')} - ${end.format('MMM DD, YYYY')}`;
  $('#dateRangeDisplay').text(`Showing records from ${displayText}`);
}

// Initialize DataTable for server-side processing (like people list)
let attendanceTable;

function initializeAttendanceDataTable() {
  // Destroy existing table if it exists
  if (attendanceTable && $.fn.DataTable.isDataTable('#hidden-datatable')) {
    attendanceTable.destroy();
    attendanceTable = null;
  }
  
  // Clear the attendance list
  $('#attendance-list').empty();

  // Initialize DataTable with client-side processing but server data
  $.get('/attendance/attendance/?action=list&params=' + encodeURIComponent(JSON.stringify(params)))
    .done(function(response) {
      const data = response.data || [];
      
      attendanceTable = $('#hidden-datatable').DataTable({
        data: data,
        pageLength: recordsPerPage,
        lengthMenu: [25, 50, 100, 200],
        order: [[3, 'desc']], // Order by date
        searching: true,
        columns: [
          {data: 'peventtype__taname', title: 'Type'},
          {data: 'bu__buname', title: 'Site'},
          {data: 'people__peoplename', title: 'Employee'},
          {data: 'datefor', title: 'Date'},
          {data: 'punchintime', title: 'In Time'},
          {data: 'punchouttime', title: 'Out Time'},
          {data: 'shift__shiftname', title: 'Shift'},
          {data: 'facerecognitionin', title: 'FRL Status'},
          {data: 'uuid', title: 'Actions'}
        ],
        drawCallback: function(settings) {
          // After DataTable draws, render our custom list view
          const data = this.api().rows({page: 'current'}).data().toArray();
          renderCustomAttendanceList(data);
          
          // Hide loading state after data is rendered
          hideLoadingState();
          
          // Update our pagination info
          const info = this.api().page.info();
          totalRecords = info.recordsTotal;
          totalPages = info.pages;
          currentPage = info.page + 1;
          recordsPerPage = info.length;
          
          updatePaginationControls();
        },
        dom: 't', // Only show table (hide DataTable's built-in controls)
        language: {
          processing: '<div class="d-flex justify-content-center"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>'
        }
      });
      
      // Handle search from our custom input
      $('#modern-search-input').off('input').on('input', function() {
        clearTimeout(window.searchTimeout);
        const searchValue = $(this).val().trim();
        
        window.searchTimeout = setTimeout(() => {
          attendanceTable.search(searchValue).draw();
        }, 300);
      });
      
      // Handle page size change
      $('#records-per-page').off('change').on('change', function() {
        const newLength = parseInt($(this).val());
        attendanceTable.page.len(newLength).draw();
      });
    })
    .fail(function(xhr, status, error) {
      console.error('Failed to load attendance data:', error);
      $('#attendance-loading').addClass('d-none');
      $('#attendance-empty').removeClass('d-none');
    });
  
}

function loadAttendanceData(page = 1) {
  // Use DataTable's built-in functionality instead
  if (attendanceTable) {
    if (page !== currentPage) {
      attendanceTable.page(page - 1).draw('page');
    } else {
      attendanceTable.ajax.reload();
    }
  } else {
    initializeAttendanceDataTable();
  }
}

function renderAttendanceList() {
  // This function is now handled by renderCustomAttendanceList
  // Keep for backward compatibility
}

function renderCustomAttendanceList(data) {
  $('#attendance-loading').addClass('d-none');
  
  if (!data || data.length === 0) {
    $('#attendance-empty').removeClass('d-none');
    $('#pagination-controls').addClass('d-none');
    return;
  }
  
  $('#attendance-empty').addClass('d-none');
  const html = data.map((record, index) => renderAttendanceRecord(record, index)).join('');
  $('#attendance-list').html(html);
  $('#pagination-controls').removeClass('d-none');
}

function updatePaginationControls() {
  // Update record info
  const start = Math.min((currentPage - 1) * recordsPerPage + 1, totalRecords);
  const end = Math.min(currentPage * recordsPerPage, totalRecords);
  
  $('#record-start').text(start);
  $('#record-end').text(end);
  $('#total-records').text(totalRecords);
  
  // Enable/disable navigation buttons
  $('#first-page, #prev-page').prop('disabled', currentPage === 1);
  $('#next-page, #last-page').prop('disabled', currentPage === totalPages);
  
  // Update button styles for disabled state
  if (currentPage === 1) {
    $('#first-page, #prev-page').css({'opacity': '0.5', 'cursor': 'not-allowed'});
  } else {
    $('#first-page, #prev-page').css({'opacity': '1', 'cursor': 'pointer'});
  }
  
  if (currentPage === totalPages) {
    $('#next-page, #last-page').css({'opacity': '0.5', 'cursor': 'not-allowed'});
  } else {
    $('#next-page, #last-page').css({'opacity': '1', 'cursor': 'pointer'});
  }
  
  // Generate page numbers
  generatePageNumbers();
}

function generatePageNumbers() {
  const pageNumbersContainer = $('#page-numbers');
  pageNumbersContainer.empty();
  
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, currentPage + 2);
  
  // Adjust range if near boundaries
  if (currentPage <= 3) {
    endPage = Math.min(5, totalPages);
  }
  if (currentPage >= totalPages - 2) {
    startPage = Math.max(1, totalPages - 4);
  }
  
  // Add first page and ellipsis if needed
  if (startPage > 1) {
    pageNumbersContainer.append(createPageButton(1));
    if (startPage > 2) {
      pageNumbersContainer.append('<span style="padding: 6px 8px; color: #9ca3af;">...</span>');
    }
  }
  
  // Add page numbers
  for (let i = startPage; i <= endPage; i++) {
    pageNumbersContainer.append(createPageButton(i));
  }
  
  // Add last page and ellipsis if needed
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      pageNumbersContainer.append('<span style="padding: 6px 8px; color: #9ca3af;">...</span>');
    }
    pageNumbersContainer.append(createPageButton(totalPages));
  }
}

function createPageButton(pageNum) {
  const isActive = pageNum === currentPage;
  const style = isActive 
    ? 'padding: 6px 12px; border: 1px solid #3b82f6; background: #3b82f6; color: white; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;'
    : 'padding: 6px 12px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;';
  
  return `<button onclick="goToPage(${pageNum})" style="${style}">${pageNum}</button>`;
}

function goToPage(page) {
  if (page < 1 || page > totalPages || page === currentPage) return;
  if (attendanceTable) {
    attendanceTable.page(page - 1).draw('page');
  }
}

function changeRecordsPerPage(value) {
  recordsPerPage = parseInt(value);
  if (attendanceTable) {
    attendanceTable.page.len(recordsPerPage).draw();
  }
}

function renderAttendanceRecord(record, index) {
  const initials = getInitials(record.people__peoplename);
  const avatarColor = getAvatarColor(record.people__peoplename);
  
  const siteName = record.bu__buname || 'Unknown Site';
  const employeeName = record.people__peoplename || 'Unknown';
  const employeeCode = record.people__peoplecode || '-';
  const eventType = record.peventtype__taname || 'Unknown';
  const date = utc_to_local(record.ctzoffset, record.datefor, 'DD MMM YYYY');
  const inTime = record.punchintime ? convert_to_local('display', record.punchintime, record) : 'Not recorded';
  const outTime = record.punchouttime ? convert_to_local('display', record.punchouttime, record) : 'Not recorded';
  
  // Shift times
  const shiftName = record.shift__shiftname || 'No Shift';
  const shiftStart = record.shift__starttime ? convertToIST(record.shift__starttime) : '-';
  const shiftEnd = record.shift__endtime ? convertToIST(record.shift__endtime) : '-';
  
  // Face recognition badges
  const frInBadge = record.facerecognitionin === false ? 
    '<span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; letter-spacing: 0.025em; text-transform: uppercase; display: inline-flex; align-items: center; gap: 2px; white-space: nowrap; background: #fef2f2; color: #991b1b;">NOT MATCHED</span>' : 
    '<span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; letter-spacing: 0.025em; text-transform: uppercase; display: inline-flex; align-items: center; gap: 2px; white-space: nowrap; background: #dcfdf4; color: #065f46;">MATCHED</span>';
    
  const frOutBadge = record.punchouttime ? (record.facerecognitionout === false ? 
    '<span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; letter-spacing: 0.025em; text-transform: uppercase; display: inline-flex; align-items: center; gap: 2px; white-space: nowrap; background: #fef2f2; color: #991b1b;">NOT MATCHED</span>' : 
    '<span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; letter-spacing: 0.025em; text-transform: uppercase; display: inline-flex; align-items: center; gap: 2px; white-space: nowrap; background: #dcfdf4; color: #065f46;">MATCHED</span>') :
    '<span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; letter-spacing: 0.025em; text-transform: uppercase; display: inline-flex; align-items: center; gap: 2px; white-space: nowrap; background: #fef3c7; color: #92400e;">PENDING</span>';

  const avatarGradients = {
    'avatar-blue': 'linear-gradient(135deg, #3b82f6, #1d4ed8)',
    'avatar-green': 'linear-gradient(135deg, #10b981, #059669)',
    'avatar-purple': 'linear-gradient(135deg, #8b5cf6, #7c3aed)',
    'avatar-orange': 'linear-gradient(135deg, #f59e0b, #d97706)',
    'avatar-pink': 'linear-gradient(135deg, #ec4899, #be185d)',
    'avatar-indigo': 'linear-gradient(135deg, #6366f1, #4f46e5)',
    'avatar-red': 'linear-gradient(135deg, #ef4444, #dc2626)',
    'avatar-teal': 'linear-gradient(135deg, #14b8a6, #0d9488)'
  };

  return `
    <div style="display: flex; align-items: center; min-height: 64px; padding: 12px 16px; border-bottom: 1px solid #f1f5f9; background: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; opacity: 0; animation: fadeInUp 0.5s ease forwards; animation-delay: ${index * 0.03}s;" 
         onmouseover="this.style.background='#f8fafc'; this.style.boxShadow='inset 3px 0 0 #3b82f6';" 
         onmouseout="this.style.background='white'; this.style.boxShadow='none';" 
         data-id="${record.id}">
      
      <div style="width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; color: white; margin-right: 12px; flex-shrink: 0; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.12); background: ${avatarGradients[avatarColor] || avatarGradients['avatar-blue']};">
        ${initials}
      </div>
      
      <div style="flex: 1; min-width: 0; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 16px; align-items: center;">
        <div style="min-width: 0;">
          <h6 style="font-size: 14px; font-weight: 700; color: #0f172a; margin: 0 0 2px 0; line-height: 1.3; font-family: 'Inter', system-ui, sans-serif; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${employeeName}</h6>
          <div style="font-size: 11px; color: #3b82f6; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${employeeCode}</div>
        </div>
        
        <div style="min-width: 0;">
          <div style="font-size: 12px; color: #475569; font-weight: 600; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <i class="material-icons" style="font-size: 10px; opacity: 0.6; margin-right: 4px;">location_on</i>${siteName}
          </div>
          <div style="font-size: 11px; color: #64748b; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <i class="material-icons" style="font-size: 10px; opacity: 0.6; margin-right: 4px;">event</i>${eventType}
          </div>
        </div>
        
        <div style="min-width: 0;">
          <div style="font-size: 12px; color: #475569; font-weight: 600; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <i class="material-icons" style="font-size: 10px; opacity: 0.6; margin-right: 4px;">login</i>${inTime}
          </div>
          <div style="font-size: 11px; color: #64748b; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <i class="material-icons" style="font-size: 10px; opacity: 0.6; margin-right: 4px;">logout</i>${outTime}
          </div>
        </div>
        
        <div style="min-width: 0;">
          <div style="font-size: 12px; color: #475569; font-weight: 600; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <i class="material-icons" style="font-size: 10px; opacity: 0.6; margin-right: 4px;">work</i>${shiftStart} - ${shiftEnd}
          </div>
          <div style="font-size: 11px; color: #64748b; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <i class="material-icons" style="font-size: 10px; opacity: 0.6; margin-right: 4px;">badge</i>${shiftName}
          </div>
        </div>
        
        <div style="min-width: 0;">
          <div style="font-size: 12px; color: #475569; font-weight: 600; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            In: ${frInBadge}
          </div>
          <div style="font-size: 11px; color: #64748b; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            Out: ${frOutBadge}
          </div>
        </div>
      </div>
      
      <div style="display: flex; gap: 4px;">
        ${['SELF', 'MARK'].includes(record.peventtype__tacode) ? `
        <button onclick="showFRStatus('${record.uuid}')" title="View Face Recognition"
                style="width: 28px; height: 28px; border-radius: 5px; border: 1px solid #e2e8f0; background: white; color: #64748b; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; font-size: 12px;"
                onmouseover="this.style.background='#f1f5f9'; this.style.borderColor='#cbd5e1'; this.style.color='#3b82f6';"
                onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0'; this.style.color='#64748b';">
          <i class="material-icons" style="font-size: 14px;">face</i>
        </button>` : ''}
        <button onclick="showLocationDetails('${record.bu__buname}', '${record.people__id}', '${record.people__peoplename}', '${record.people__mobno || ""}', '${record.bu__siteincharge__peoplename || ""}', '${record.bu__siteincharge__mobno || ""}', '${record.bu__siteincharge__email || ""}', '${record.sL || "null"}', '${record.eL || "null"}')" title="View Location"
                style="width: 28px; height: 28px; border-radius: 5px; border: 1px solid #e2e8f0; background: white; color: #64748b; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; font-size: 12px;"
                onmouseover="this.style.background='#f1f5f9'; this.style.borderColor='#cbd5e1'; this.style.color='#10b981';"
                onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0'; this.style.color='#64748b';">
          <i class="material-icons" style="font-size: 14px;">place</i>
        </button>
      </div>
    </div>
  `;
}

// Helper function to get DataTable column index
function getColumnIndex(columnName) {
  const columnMap = {
    'type': 0,      // peventtype__taname
    'site': 1,      // bu__buname
    'employee': 2,  // people__peoplename
    'date': 3,      // datefor
    'intime': 4,    // punchintime
    'outtime': 5,   // punchouttime
    'shift': 6,     // shift__shiftname
    'frl': 7,       // facerecognitionin
    'actions': 8    // uuid
  };
  return columnMap[columnName] !== undefined ? columnMap[columnName] : -1;
}

// Show notification
function showNotification(message) {
  // Remove any existing notification
  $('.column-notification').remove();
  
  // Create and show new notification
  const notification = $(`
    <div class="column-notification" style="position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 999999; font-size: 14px; font-weight: 600;">
      ${message}
    </div>
  `);
  
  $('body').append(notification);
  
  // Auto-hide after 2 seconds
  setTimeout(() => {
    notification.fadeOut(300, function() {
      $(this).remove();
    });
  }, 2000);
}

// Track visible columns
let visibleColumns = {
  type: true,
  site: true,
  code: true,
  employee: true,
  verified: true,
  date: true,
  intime: true,
  outtime: true,
  shift: true,
  frl: true,
  location: true,
  endtime: true
};

function setupEventHandlers() {
  // Custom dropdown toggle for column visibility
  $('#columnToggleBtn').on('click', function(e) {
    e.stopPropagation();
    const menu = $('#columnVisibilityMenu');
    const button = $(this);
    
    if (menu.is(':visible')) {
      menu.hide();
      $('.dropdown-backdrop').remove();
    } else {
      // Add backdrop
      $('<div class="dropdown-backdrop" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 999998; background: rgba(0,0,0,0.1);"></div>').appendTo('body');
      
      // Calculate position for fixed positioning
      const buttonRect = button[0].getBoundingClientRect();
      menu.css({
        'position': 'fixed',
        'top': (buttonRect.bottom + 5) + 'px',
        'left': buttonRect.left + 'px',
        'z-index': '999999',
        'display': 'block'
      });
    }
  });
  
  // Close dropdown when clicking outside or on backdrop
  $(document).on('click', '.dropdown-backdrop', function(e) {
    $('#columnVisibilityMenu').hide();
    $('.dropdown-backdrop').remove();
  });
  
  $(document).on('click', function(e) {
    if (!$(e.target).closest('#columnToggleBtn, #columnVisibilityMenu').length) {
      $('#columnVisibilityMenu').hide();
      $('.dropdown-backdrop').remove();
    }
  });
  
  // Prevent dropdown from closing when clicking inside
  $('#columnVisibilityMenu').on('click', function(e) {
    e.stopPropagation();
  });
  
  // Column visibility toggles - use delegation since menu moves to body
  $(document).on('change', '.column-toggle', function() {
    const column = $(this).data('column');
    const isChecked = $(this).is(':checked');
    
    console.log(`Toggling column: ${column}, checked: ${isChecked}`);
    
    // Update visibility tracking
    visibleColumns[column] = isChecked;
    
    // Save preference to localStorage
    localStorage.setItem(`attendance_column_${column}`, isChecked);
    
    // Show feedback message
    const message = isChecked ? `Showing ${column} column` : `Hiding ${column} column`;
    showNotification(message);
    
    // Re-render the attendance list with updated column visibility
    if (attendanceTable) {
      const currentData = attendanceTable.rows({page: 'current'}).data().toArray();
      renderCustomAttendanceList(currentData);
    }
  });
  
  // Load saved column preferences using delegation
  setTimeout(() => {
    $('.column-toggle').each(function() {
      const column = $(this).data('column');
      const savedState = localStorage.getItem(`attendance_column_${column}`);
      if (savedState !== null) {
        const isChecked = savedState === 'true';
        $(this).prop('checked', isChecked);
        visibleColumns[column] = isChecked;
      }
    });
    
    // Re-render with saved preferences
    if (attendanceTable) {
      const currentData = attendanceTable.rows({page: 'current'}).data().toArray();
      renderCustomAttendanceList(currentData);
    }
  }, 100);
  
  // Export to PDF
  $('#exportPDF').on('click', function() {
    const visibleColumns = [];
    $('.column-toggle:checked').each(function() {
      visibleColumns.push($(this).data('column'));
    });
    
    // Get current data from DataTable
    if (attendanceTable) {
      const data = attendanceTable.rows().data().toArray();
      exportToPDF(data, visibleColumns);
    }
  });
  
  // Export to Excel
  $('#exportExcel').on('click', function() {
    const visibleColumns = [];
    $('.column-toggle:checked').each(function() {
      visibleColumns.push($(this).data('column'));
    });
    
    // Get current data from DataTable
    if (attendanceTable) {
      const data = attendanceTable.rows().data().toArray();
      exportToExcel(data, visibleColumns);
    }
  });
  
  // Search functionality
  $('#modern-search-input').on('input', function() {
    const searchTerm = $(this).val();
    
    if (attendanceTable) {
      // Use DataTable's built-in search
      attendanceTable.search(searchTerm).draw();
    }
  });
  
  // Refresh button
  $('#refreshAttendance').on('click', function() {
    const $btn = $(this);
    const $icon = $btn.find('i');
    
    $icon.addClass('fa-spin');
    $btn.prop('disabled', true);
    
    // Reload data by reinitializing
    initializeAttendanceDataTable();
    
    setTimeout(() => {
      $icon.removeClass('fa-spin');
      $btn.prop('disabled', false);
    }, 1000);
  });
  
  // Add hover effects for modern buttons
  $('.modern-export-btn, .modern-filter-btn').hover(
    function() {
      if (!$(this).hasClass('active')) {
        $(this).css({
          'background': '#f9fafb',
          'border-color': '#d1d5db',
          'color': '#374151',
          'transform': 'translateY(-1px)',
          'box-shadow': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
        });
      }
    },
    function() {
      if (!$(this).hasClass('active')) {
        $(this).css({
          'background': '#ffffff',
          'border-color': '#d1d5db',
          'color': '#6b7280',
          'transform': 'translateY(0)',
          'box-shadow': '0 1px 3px rgba(0, 0, 0, 0.1)'
        });
      }
    }
  );
  
  // Focus effects for search inputs
  $('.modern-search input, .modern-date-range input').focus(function() {
    $(this).css({
      'border-color': '#3b82f6',
      'box-shadow': '0 0 0 4px rgba(59, 130, 246, 0.1), 0 4px 6px -1px rgba(0, 0, 0, 0.1)',
      'transform': 'translateY(-1px)'
    });
  }).blur(function() {
    $(this).css({
      'border-color': '#e5e7eb',
      'box-shadow': '0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06)',
      'transform': 'translateY(0)'
    });
  });
}


// Helper functions from original template
function matchStatus(row, data) {
  if (['SELF', 'MARK'].includes(row['peventtype__tacode'])) {
    if ([null, "", 'NONE'].includes(row['punchouttime'])) {
      return '<span class="status-badge pending"><i class="material-icons">schedule</i>Pending</span>';
    }
    if (![null, "", 'NONE'].includes(row['punchintime'])) {
      return data === false ? 
        '<span class="status-badge not-matched"><i class="material-icons">cancel</i>Not Matched</span>' : 
        '<span class="status-badge matched"><i class="material-icons">check_circle</i>Matched</span>';
    }
  }
  return '<span class="text-muted">-</span>';
}

function convertToIST(time) {
  if (!time) return '-';
  const utcDate = new Date(`1970-01-01T${time}Z`);
  const istOffset = 5 * 60 + 30;
  const istDate = new Date(utcDate.getTime() + istOffset * 60000);
  const hours = String(istDate.getUTCHours()).padStart(2, '0');
  const minutes = String(istDate.getUTCMinutes()).padStart(2, '0');
  const seconds = String(istDate.getUTCSeconds()).padStart(2, '0');
  return `${hours}:${minutes}:${seconds}`;
}

function showFRStatus(uuid) {
  // Get modal element
  const modalElement = document.getElementById('frStatusModal');
  
  if (!modalElement) {
    console.error('FR Status modal element not found');
    return;
  }
  
  // Store modal instance globally for closing
  window.currentFRModal = null;
  
  try {
    // Check if Bootstrap is available and try to use it
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
      // Check if modal instance already exists
      let modal = bootstrap.Modal.getInstance(modalElement);
      if (!modal) {
        // Create new modal instance with proper configuration
        modal = new bootstrap.Modal(modalElement, {
          backdrop: true,
          keyboard: true,
          focus: true
        });
      }
      window.currentFRModal = modal;
      modal.show();
    } else if (typeof $ !== 'undefined' && $.fn.modal) {
      // Fallback to jQuery modal
      $('#frStatusModal').modal('show');
    } else {
      // Manual fallback - show modal with basic styling
      console.log('Using manual modal fallback');
      modalElement.classList.add('show');
      modalElement.style.display = 'block';
      modalElement.setAttribute('aria-modal', 'true');
      modalElement.removeAttribute('aria-hidden');
      
      // Remove any existing backdrop first
      const existingBackdrop = document.getElementById('frModalBackdrop');
      if (existingBackdrop) {
        existingBackdrop.remove();
      }
      
      // Add new backdrop
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop fade show';
      backdrop.id = 'frModalBackdrop';
      backdrop.onclick = closeFRModal; // Allow closing by clicking backdrop
      document.body.appendChild(backdrop);
      document.body.classList.add('modal-open');
    }
  } catch (error) {
    console.error('Error showing modal:', error);
    // Fallback to manual display
    modalElement.classList.add('show');
    modalElement.style.display = 'block';
    modalElement.setAttribute('aria-modal', 'true');
    modalElement.removeAttribute('aria-hidden');
    
    // Add backdrop manually
    const existingBackdrop = document.getElementById('frModalBackdrop');
    if (existingBackdrop) {
      existingBackdrop.remove();
    }
    
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.id = 'frModalBackdrop';
    backdrop.onclick = closeFRModal;
    document.body.appendChild(backdrop);
    document.body.classList.add('modal-open');
  }
  
  // Reset modal content
  resetFRModal();
  
  // Load face recognition data
  fire_ajax_get({
    url: `{{ url('activity:previewImage') }}?action=getFRStatus&uuid=${uuid}`
  })
  .done((data, status, xhr) => {
    populateFRModal(data);
  })
  .fail((xhr, status, error) => {
    console.error('Error loading FR status:', error);
    if (typeof showAlert !== 'undefined') {
      showAlert('error', 'Failed to load face recognition status.');
    }
  });
}

function closeFRModal() {
  const modalElement = document.getElementById('frStatusModal');
  
  if (!modalElement) {
    console.error('FR Status modal element not found');
    return;
  }
  
  try {
    // Try Bootstrap 5 first
    if (window.currentFRModal) {
      window.currentFRModal.hide();
      window.currentFRModal = null;
    } else if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
      // Try to get existing instance
      const modal = bootstrap.Modal.getInstance(modalElement);
      if (modal) {
        modal.hide();
      }
    } else if (typeof $ !== 'undefined' && $.fn.modal) {
      // jQuery fallback
      $('#frStatusModal').modal('hide');
    } else {
      // Manual fallback
      modalElement.classList.remove('show');
      modalElement.style.display = 'none';
      modalElement.setAttribute('aria-hidden', 'true');
      modalElement.removeAttribute('aria-modal');
      
      // Remove backdrop
      const backdrop = document.getElementById('frModalBackdrop');
      if (backdrop) {
        backdrop.remove();
      }
      document.body.classList.remove('modal-open');
    }
  } catch (error) {
    console.error('Error closing modal:', error);
    // Fallback to manual close
    modalElement.classList.remove('show');
    modalElement.style.display = 'none';
    modalElement.setAttribute('aria-hidden', 'true');
    modalElement.removeAttribute('aria-modal');
    
    // Remove backdrop
    const backdrop = document.getElementById('frModalBackdrop');
    if (backdrop) {
      backdrop.remove();
    }
    document.body.classList.remove('modal-open');
  }
}

function resetFRModal() {
  $('#checkinImage, #checkoutImage, #profileImage').hide();
  $('#checkinPlaceholder, #checkoutPlaceholder, #profilePlaceholder').show();
  $('.fr-detail-value').text('-');
  $('#frWarningMessage').hide();
}

function populateFRModal(data) {
  const NA = "Information not available";
  
  // Check if reference image is a non-face image and show warning
  if (data.default_people_data && data.default_people_data.length > 0) {
    const profileData = data.default_people_data[0];
    // Check if the profile image is missing or is a placeholder/non-face image
    if (!profileData.peopleimg || profileData.is_non_face_image) {
      $('#frWarningMessage').show();
    } else {
      $('#frWarningMessage').hide();
    }
  } else {
    // No profile data, show warning
    $('#frWarningMessage').show();
  }
  
  // Configure remote media server URL
  const REMOTE_MEDIA_URL = 'https://sg.youtility.in/youtility4_media/';
  const USE_REMOTE_MEDIA = false;  // Set to true for remote, false for local
  
  // Determine which media URL to use
  const mediaUrl = USE_REMOTE_MEDIA ? REMOTE_MEDIA_URL : '/media/';
  
  // Handle images
  if (data.attachment_in_out && data.attachment_in_out.length > 0) {
    const inImage = data.attachment_in_out[0];
    // Build the URL - the filepath already contains 'youtility4_media' in some cases
    let inImagePath = inImage.filepath.replace('youtility4_media/', '');
    const inImageUrl = `${mediaUrl}${inImagePath}/${inImage.filename}`;
    $('#checkinImage').attr('src', inImageUrl).show();
    $('#checkinPlaceholder').hide();
  }
  
  if (data.attachment_in_out && data.attachment_in_out.length > 1) {
    const outImage = data.attachment_in_out[1];
    // Build the URL - the filepath already contains 'youtility4_media' in some cases
    let outImagePath = outImage.filepath.replace('youtility4_media/', '');
    const outImageUrl = `${mediaUrl}${outImagePath}/${outImage.filename}`;
    $('#checkoutImage').attr('src', outImageUrl).show();
    $('#checkoutPlaceholder').hide();
  }
  
  if (data.default_people_data && data.default_people_data.length > 0) {
    const profileData = data.default_people_data[0];
    if (profileData.peopleimg) {
      // Build the profile image URL
      let profilePath = profileData.peopleimg.replace('youtility4_media/', '');
      const profileImageUrl = `${mediaUrl}${profilePath}`;
      $('#profileImage').attr('src', profileImageUrl).show();
      $('#profilePlaceholder').hide();
    }
    
    // Populate profile details
    $('#profileTakenOn').text(utc_to_local(profileData.ctzoffset, profileData.cdtz));
    $('#profileCreatedBy').text(profileData['cuser__peoplename'] || '-');
    $('#profileModifiedOn').text(utc_to_local(profileData.ctzoffset, profileData.mdtz));
  }
  
  // Populate FR details
  if (data.eventlog_in_out && data.eventlog_in_out.length > 0) {
    const eventData = data.eventlog_in_out[0];
    
    // Check-in details
    const inAccuracy = eventData.peventlogextras?.distance_in ? 
      Math.round((1 - eventData.peventlogextras.distance_in) * 100) + '%' : 'N/A';
    $('#frInAccuracy').text(inAccuracy);
    
    // Check-out details
    const outAccuracy = eventData.peventlogextras?.distance_out ? 
      Math.round((1 - eventData.peventlogextras.distance_out) * 100) + '%' : 'N/A';
    $('#frOutAccuracy').text(outAccuracy);
    
    // Common details
    const metric = eventData.peventlogextras?.similarity_metric?.toUpperCase() || 'N/A';
    $('#frInMetric, #frOutMetric').text(`Metric Used: ${metric}`);
    
    const date = eventData.datefor || 'N/A';
    $('#frInDate, #frOutDate').text(`Captured Date: ${date}`);
    
    const user = eventData.createdby || 'N/A';
    $('#frInUser, #frOutUser').text(`Performed By: ${user}`);
    
    // Locations
    $('#frInLocation').text(`In Location: ${eventData.in_address || 'N/A'}`);
    $('#frOutLocation').text(`Out Location: ${eventData.out_address || 'N/A'}`);
    $('#profileBaseLocation').text(`Base Location: ${eventData.base_address || 'N/A (This people not added in GeoFence)'}`);
  }
}

function showLocationDetails(siteName, peopleId, peopleName, peoplePhone, inchargeName, inchargePhone, inchargeEmail, startLocation, endLocation) {
  $('#locationModal').modal('show');
  
  // Show loading state
  $('#mapLoading').show();
  $('#locationContent, #noLocationData').hide();
  
  // Check if we have required data
  if (!siteName || !peopleId || !startLocation || startLocation === 'null') {
    setTimeout(() => {
      $('#mapLoading').hide();
      $('#noLocationData').show();
    }, 1000);
    return;
  }
  
  // Populate location details
  $('#locationSiteName').text(siteName);
  $('#locationEmployeeName').text(peopleName);
  $('#locationEmployeePhone').text(peoplePhone);
  $('#locationSiteIncharge').text(inchargeName);
  $('#locationInchargePhone').text(inchargePhone);
  $('#locationInchargeEmail').text(inchargeEmail);
  
  // Load geofence data
  $.ajax({
    url: `/attendance/attendance/?action=getLocationStatus&peopleid=${peopleId}`,
    type: 'GET',
    dataType: 'json',
    success: function(response) {
      $('#mapLoading').hide();
      
      if (!response || !response.geofence_coords || response.geofence_coords.length === 0) {
        $('#noLocationData').show();
        return;
      }
      
      $('#locationContent').show();
      initializeMap(siteName, response.geofence_coords, startLocation, endLocation);
    },
    error: function(xhr, status, error) {
      console.error('Error loading location data:', error);
      $('#mapLoading').hide();
      $('#noLocationData').show();
    }
  });
}

function initializeMap(siteName, geofenceCoords, startLocation, endLocation) {
  // Calculate center
  const centerLat = geofenceCoords.reduce((sum, coord) => sum + coord[1], 0) / geofenceCoords.length;
  const centerLng = geofenceCoords.reduce((sum, coord) => sum + coord[0], 0) / geofenceCoords.length;
  const center = { lat: centerLat, lng: centerLng };
  
  // Initialize map
  const map = new google.maps.Map(document.getElementById('attendanceMap'), {
    zoom: 15,
    center: center,
    styles: [
      {
        featureType: "poi",
        elementType: "labels",
        stylers: [{ visibility: "off" }]
      }
    ]
  });
  
  // Draw geofence
  const geofence = new google.maps.Polygon({
    paths: geofenceCoords.map(([lng, lat]) => ({ lat, lng })),
    strokeColor: "#377dff",
    strokeOpacity: 0.8,
    strokeWeight: 2,
    fillColor: "#377dff",
    fillOpacity: 0.2
  });
  geofence.setMap(map);
  
  // Add center marker
  new google.maps.Marker({
    position: center,
    map,
    title: siteName,
    icon: {
      url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="16" cy="16" r="16" fill="#377dff"/>
          <circle cx="16" cy="16" r="6" fill="white"/>
        </svg>
      `),
      scaledSize: new google.maps.Size(32, 32)
    }
  });
  
  // Add start/end location markers if available
  try {
    if (startLocation && startLocation !== 'null') {
      const startCoords = typeof startLocation === 'string' ? JSON.parse(startLocation) : startLocation;
      if (startCoords && startCoords.lat && startCoords.lng) {
        new google.maps.Marker({
          position: startCoords,
          map,
          title: "Check-in Location",
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="12" fill="#00c9a7"/>
                <path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            `),
            scaledSize: new google.maps.Size(24, 24)
          }
        });
      }
    }
    
    if (endLocation && endLocation !== 'null') {
      const endCoords = typeof endLocation === 'string' ? JSON.parse(endLocation) : endLocation;
      if (endCoords && endCoords.lat && endCoords.lng) {
        new google.maps.Marker({
          position: endCoords,
          map,
          title: "Check-out Location",
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="12" fill="#de4437"/>
                <path d="M15 9l-6 6m0-6l6 6" stroke="white" stroke-width="2" stroke-linecap="round"/>
              </svg>
            `),
            scaledSize: new google.maps.Size(24, 24)
          }
        });
      }
    }
  } catch (e) {
    console.warn('Error adding location markers:', e);
  }
  
  // Fit bounds to show all elements
  const bounds = new google.maps.LatLngBounds();
  geofenceCoords.forEach(coord => bounds.extend(new google.maps.LatLng(coord[1], coord[0])));
  map.fitBounds(bounds);
}

function showAlert(type, message) {
  const alertClass = type === 'error' ? 'danger' : type;
  const iconMap = {
    'success': 'check_circle',
    'warning': 'warning',
    'danger': 'error',
    'info': 'info'
  };
  
  const alertHtml = `
    <div class="alert alert-${alertClass} alert-dismissible fade show position-fixed" 
         style="top: 20px; right: 20px; z-index: 1060; min-width: 300px;" role="alert">
      <i class="material-icons me-2">${iconMap[alertClass]}</i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  `;
  
  $('body').append(alertHtml);
  
  setTimeout(() => {
    $('.alert').fadeOut(() => {
      $(this).remove();
    });
  }, 5000);
}

// Initialize tooltips
$(document).on('mouseenter', '[data-bs-toggle="tooltip"]', function() {
  $(this).tooltip();
});

// Keyboard shortcuts
$(document).on('keydown', function(e) {
  if (e.ctrlKey || e.metaKey) {
    switch(e.keyCode) {
      case 70: // Ctrl+F for search
        e.preventDefault();
        $('#attendance_table_filter input').focus();
        break;
      case 82: // Ctrl+R for refresh
        e.preventDefault();
        $('#refreshAttendance').click();
        break;
    }
  }
});
</script>
{% endblock extra_scripts %}