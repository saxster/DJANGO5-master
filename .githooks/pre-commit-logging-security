#!/usr/bin/env bash
#
# Pre-commit hook: Logging Security Validation
#
# Prevents commits that contain insecure logging patterns:
# - Password logging
# - Token/secret logging
# - Email address logging
# - request.POST/GET dictionary logging
# - Sensitive PII in log messages
#
# CRITICAL: Enforces Rule #15 - Logging Data Sanitization

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

echo -e "${YELLOW}ğŸ” Running Logging Security Pre-commit Checks...${NC}"

VIOLATIONS_FOUND=0
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}âœ… No Python files to check${NC}"
    exit 0
fi

check_pattern() {
    local pattern=$1
    local description=$2
    local files=$3

    echo -e "\n  Checking for: $description"

    matches=$(echo "$files" | xargs grep -n -E "$pattern" 2>/dev/null || true)

    if [ -n "$matches" ]; then
        echo -e "${RED}  âŒ VIOLATION FOUND: $description${NC}"
        echo "$matches" | while read -r match; do
            echo -e "${RED}     $match${NC}"
        done
        return 1
    else:
        echo -e "${GREEN}  âœ… Clean${NC}"
        return 0
    fi
}

echo -e "\n${YELLOW}Checking for insecure logging patterns...${NC}"

if ! check_pattern 'logger\.(info|debug|error|warning|critical)\(.*password' "Password in log messages" "$STAGED_FILES"; then
    VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
    echo -e "${YELLOW}  ğŸ’¡ FIX: Remove password from log message or use correlation ID${NC}"
fi

if ! check_pattern 'logger\.(info|debug|error|warning|critical)\(.*f".*\{.*\.email' "Email addresses in f-string logs" "$STAGED_FILES"; then
    VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
    echo -e "${YELLOW}  ğŸ’¡ FIX: Use user_id instead of email, or use get_sanitized_logger()${NC}"
fi

if ! check_pattern 'logger\.(info|debug|error|warning|critical)\(.*token.*=' "Token/API key logging" "$STAGED_FILES"; then
    VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
    echo -e "${YELLOW}  ğŸ’¡ FIX: Never log tokens or API keys${NC}"
fi

if ! check_pattern 'logger\.(info|debug|error|warning|critical)\(.*secret' "Secret logging" "$STAGED_FILES"; then
    VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
    echo -e "${YELLOW}  ğŸ’¡ FIX: Never log secrets or encryption keys${NC}"
fi

if ! check_pattern 'logger\.(info|debug|error|warning|critical)\(.*request\.POST\b' "request.POST dictionary logging" "$STAGED_FILES"; then
    VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
    echo -e "${YELLOW}  ğŸ’¡ FIX: Log specific fields or field count, not entire POST dict${NC}"
fi

if ! check_pattern 'logger\.(info|debug|error|warning|critical)\(.*request\.GET\b' "request.GET dictionary logging" "$STAGED_FILES"; then
    VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
    echo -e "${YELLOW}  ğŸ’¡ FIX: Log specific parameters, not entire GET dict${NC}"
fi

if ! check_pattern 'logger\.(info|debug|error|warning|critical)\(.*credit.*card' "Credit card logging" "$STAGED_FILES"; then
    VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
    echo -e "${YELLOW}  ğŸ’¡ FIX: Never log credit card information${NC}"
fi

if ! check_pattern 'logger\.(info|debug|error|warning|critical)\(.*\bssn\b' "SSN logging" "$STAGED_FILES"; then
    VIOLATIONS_FOUND=$((VIOLATIONS_FOUND + 1))
    echo -e "${YELLOW}  ğŸ’¡ FIX: Never log Social Security Numbers${NC}"
fi

if [ $VIOLATIONS_FOUND -gt 0 ]; then
    echo -e "\n${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âŒ COMMIT REJECTED: $VIOLATIONS_FOUND logging security violation(s) found${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "\n${YELLOW}ğŸ“š REMEDIATION STEPS:${NC}"
    echo -e "  1. Review the violations listed above"
    echo -e "  2. Read: docs/security/LOGGING_SECURITY_MIGRATION_GUIDE.md"
    echo -e "  3. Use: from apps.core.middleware import get_sanitized_logger"
    echo -e "  4. Use structured logging with extra={} parameter"
    echo -e "  5. Run: python manage.py audit_logging_security --path <your_app>"
    echo -e "\n${YELLOW}ğŸ“– Rule Reference: .claude/rules.md - Rule #15${NC}"
    echo -e "${YELLOW}ğŸ”’ Security First: Never log passwords, tokens, or PII${NC}\n"
    exit 1
fi

echo -e "\n${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… Logging Security Checks Passed${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
exit 0