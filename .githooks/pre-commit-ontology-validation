#!/bin/bash
#
# Pre-commit hook for ontology decorator validation
#
# Installation:
#   chmod +x .githooks/pre-commit-ontology-validation
#   ln -sf ../../.githooks/pre-commit-ontology-validation .git/hooks/pre-commit
#
# Purpose:
#   Validates all ontology decorators in staged files before allowing commit.
#   Ensures 100% validation pass rate for quality enforcement.
#
# Author: Ontology Expansion Team
# Date: 2025-11-01
#

# ANSI color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}  Ontology Decorator Validation (Pre-Commit Hook)${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Check if validation script exists
VALIDATION_SCRIPT="scripts/validate_ontology_decorators.py"
if [ ! -f "$VALIDATION_SCRIPT" ]; then
    echo -e "${RED}âœ— Error: Validation script not found at $VALIDATION_SCRIPT${NC}"
    echo -e "${YELLOW}  This hook requires the ontology validation script.${NC}"
    echo ""
    exit 1
fi

# Get list of staged Python files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$')

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}âœ“ No Python files staged for commit. Skipping validation.${NC}"
    echo ""
    exit 0
fi

# Count staged files
FILE_COUNT=$(echo "$STAGED_FILES" | wc -l | tr -d ' ')
echo -e "${BLUE}ğŸ“‹ Found $FILE_COUNT staged Python file(s)${NC}"
echo ""

# Check if any staged files contain @ontology decorators
DECORATED_FILES=""
for file in $STAGED_FILES; do
    if [ -f "$file" ] && grep -q "@ontology" "$file"; then
        DECORATED_FILES="$DECORATED_FILES $file"
    fi
done

if [ -z "$DECORATED_FILES" ]; then
    echo -e "${GREEN}âœ“ No files with @ontology decorators in this commit.${NC}"
    echo -e "${BLUE}  Validation skipped (not required).${NC}"
    echo ""
    exit 0
fi

DECORATED_COUNT=$(echo "$DECORATED_FILES" | wc -w | tr -d ' ')
echo -e "${YELLOW}ğŸ” Found $DECORATED_COUNT file(s) with @ontology decorators${NC}"
echo ""

# Validate each decorated file
VALIDATION_FAILED=0
VALIDATION_WARNINGS=0

for file in $DECORATED_FILES; do
    echo -e "${BLUE}Validating:${NC} $file"

    # Run validation script
    if python "$VALIDATION_SCRIPT" --file "$file" > /tmp/ontology_validation_output.txt 2>&1; then
        # Check for warnings
        if grep -q "âš " /tmp/ontology_validation_output.txt; then
            echo -e "${YELLOW}  âš  Warnings found (commit allowed, but please review)${NC}"
            VALIDATION_WARNINGS=$((VALIDATION_WARNINGS + 1))
            # Show warning details
            grep "âš " /tmp/ontology_validation_output.txt | head -5
        else
            echo -e "${GREEN}  âœ“ Validation passed${NC}"
        fi
    else
        echo -e "${RED}  âœ— Validation failed${NC}"
        VALIDATION_FAILED=$((VALIDATION_FAILED + 1))

        # Show error details
        echo ""
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        cat /tmp/ontology_validation_output.txt
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    fi
    echo ""
done

# Clean up temp file
rm -f /tmp/ontology_validation_output.txt

# Summary
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}  Validation Summary${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "  Files validated: ${BLUE}$DECORATED_COUNT${NC}"
echo -e "  Errors:          ${RED}$VALIDATION_FAILED${NC}"
echo -e "  Warnings:        ${YELLOW}$VALIDATION_WARNINGS${NC}"
echo ""

if [ $VALIDATION_FAILED -gt 0 ]; then
    echo -e "${RED}âŒ COMMIT BLOCKED - Fix validation errors before committing${NC}"
    echo ""
    echo -e "${YELLOW}How to fix:${NC}"
    echo -e "  1. Review error messages above"
    echo -e "  2. Fix missing required fields or PII marking issues"
    echo -e "  3. Run validation manually:"
    echo -e "     ${BLUE}python scripts/validate_ontology_decorators.py --file <file>${NC}"
    echo -e "  4. Try committing again"
    echo ""
    echo -e "${YELLOW}Need help?${NC}"
    echo -e "  - See: ${BLUE}docs/ontology/GOLD_STANDARD_EXAMPLES.md${NC}"
    echo -e "  - See: ${BLUE}apps/ontology/templates/DECORATOR_TEMPLATES.md${NC}"
    echo -e "  - Ask in #ontology-expansion Slack channel"
    echo ""
    exit 1
fi

if [ $VALIDATION_WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}âš ï¸  WARNINGS FOUND - Commit allowed, but please review warnings${NC}"
    echo ""
    echo -e "${YELLOW}Common warnings:${NC}"
    echo -e "  - Tag count < 5 (recommend 7-10 tags)"
    echo -e "  - Example count < 2 (recommend 3-5 examples)"
    echo -e "  - Security notes < 3 sections (recommend 5+)"
    echo ""
    echo -e "${YELLOW}These are quality suggestions, not blockers.${NC}"
    echo -e "Consider improving before final PR submission."
    echo ""
fi

echo -e "${GREEN}âœ… VALIDATION PASSED - Commit allowed${NC}"
echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

exit 0
