# Generated by Django 5.2.7 on 2025-11-11 04:27

import django.contrib.gis.db.models.fields
import django.contrib.postgres.indexes
import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('tenants', '0001_initial'),
        ('work_order_management', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='CollectiveIntelligencePattern',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('pattern_type', models.CharField(choices=[('RESPONSE_EFFECTIVENESS', 'Response Protocol Effectiveness'), ('FALSE_POSITIVE_COMMON', 'Common False Positive Pattern'), ('ESCALATION_TIMELINE', 'Typical Escalation Timeline'), ('GEOGRAPHIC_CORRELATION', 'Geographic Event Correlation'), ('SEASONAL_TREND', 'Seasonal Trend Pattern')], db_index=True, max_length=50)),
                ('threat_category', models.CharField(db_index=True, max_length=50)),
                ('geographic_region', models.CharField(blank=True, help_text="Broad region (e.g., 'US-Northeast', 'Europe-Central')", max_length=200)),
                ('industry_sector', models.CharField(blank=True, help_text="Anonymized industry (e.g., 'retail', 'manufacturing')", max_length=100)),
                ('pattern_description', models.TextField()),
                ('sample_size', models.PositiveIntegerField(help_text='Number of events/tenants contributing to this pattern')),
                ('confidence_score', models.FloatField(help_text='Statistical confidence in pattern (0.0-1.0)')),
                ('recommended_actions', models.JSONField(default=list, help_text='List of recommended responses based on pattern')),
                ('effectiveness_metrics', models.JSONField(default=dict, help_text="Metrics on outcomes: {'action_X': {'success_rate': 0.85}}")),
                ('pattern_data', models.JSONField(default=dict, help_text='Statistical summaries, timelines, correlations')),
                ('valid_from', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('valid_until', models.DateTimeField(blank=True, help_text='Pattern expiration (for time-sensitive trends)', null=True)),
                ('times_applied', models.PositiveIntegerField(default=0)),
                ('times_helpful', models.PositiveIntegerField(default=0)),
                ('times_not_helpful', models.PositiveIntegerField(default=0)),
                ('is_active', models.BooleanField(db_index=True, default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'ordering': ['-confidence_score', '-sample_size'],
                'indexes': [models.Index(fields=['pattern_type', 'threat_category', 'is_active'], name='threat_inte_pattern_bff73d_idx'), models.Index(fields=['geographic_region', 'industry_sector'], name='threat_inte_geograp_4bb1a9_idx'), models.Index(fields=['valid_from', 'valid_until'], name='threat_inte_valid_f_f18b4d_idx'), django.contrib.postgres.indexes.GinIndex(fields=['pattern_data'], name='threat_inte_pattern_5b2d34_gin')],
            },
        ),
        migrations.CreateModel(
            name='IntelligenceAlert',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('severity', models.CharField(db_index=True, max_length=20)),
                ('urgency_level', models.CharField(max_length=20)),
                ('distance_km', models.FloatField(help_text='Distance from nearest monitored facility')),
                ('delivery_status', models.CharField(choices=[('PENDING', 'Pending'), ('SENT', 'Sent'), ('DELIVERED', 'Delivered'), ('FAILED', 'Failed'), ('SUPPRESSED', 'Suppressed (outside hours/digest)')], db_index=True, default='PENDING', max_length=20)),
                ('delivery_channels', models.JSONField(default=list, help_text="Channels used: ['websocket', 'email', 'sms']")),
                ('delivered_at', models.DateTimeField(blank=True, null=True)),
                ('delivery_error', models.TextField(blank=True)),
                ('tenant_response', models.CharField(choices=[('NO_RESPONSE', 'No Response Yet'), ('ACTIONABLE', 'Triggered Response Protocol'), ('NOTED', 'Acknowledged - No Action Needed'), ('FALSE_POSITIVE', 'Not Relevant/False Positive'), ('MISSED', 'Should Have Alerted Sooner'), ('TOO_SENSITIVE', 'Too Many Similar Alerts')], db_index=True, default='NO_RESPONSE', max_length=30)),
                ('response_timestamp', models.DateTimeField(blank=True, null=True)),
                ('response_notes', models.TextField(blank=True)),
                ('work_order_created', models.BooleanField(default=False)),
                ('acknowledged_at', models.DateTimeField(blank=True, null=True)),
                ('escalation_level', models.PositiveSmallIntegerField(default=0)),
                ('escalated_to', models.JSONField(default=list, help_text='List of people/roles escalated to')),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('acknowledged_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='acknowledged_alerts', to=settings.AUTH_USER_MODEL)),
                ('tenant', models.ForeignKey(blank=True, help_text='Tenant that owns this record', null=True, on_delete=django.db.models.deletion.CASCADE, to='tenants.tenant')),
                ('work_order', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='intelligence_alerts', to='work_order_management.wom')),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='IntelligenceAlertView',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('viewed_at', models.DateTimeField(auto_now_add=True)),
                ('view_duration_seconds', models.PositiveIntegerField(blank=True, null=True)),
                ('alert', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='threat_intelligence.intelligencealert')),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.AddField(
            model_name='intelligencealert',
            name='viewed_by',
            field=models.ManyToManyField(related_name='viewed_intelligence_alerts', through='threat_intelligence.IntelligenceAlertView', to=settings.AUTH_USER_MODEL),
        ),
        migrations.CreateModel(
            name='IntelligenceSource',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=200, unique=True)),
                ('source_type', models.CharField(choices=[('NEWS_API', 'News API'), ('RSS_FEED', 'RSS Feed'), ('WEATHER_API', 'Weather Service'), ('GOVERNMENT', 'Government Alert System'), ('SOCIAL_MEDIA', 'Social Media Platform'), ('THREAT_FEED', 'Security Threat Feed'), ('CUSTOM_SCRAPER', 'Custom Web Scraper')], max_length=50)),
                ('endpoint_url', models.URLField(blank=True)),
                ('api_key_name', models.CharField(blank=True, help_text='Name of environment variable containing API key', max_length=100)),
                ('refresh_interval_minutes', models.PositiveIntegerField(default=60)),
                ('last_fetch_at', models.DateTimeField(blank=True, null=True)),
                ('last_fetch_status', models.CharField(choices=[('ACTIVE', 'Active'), ('PAUSED', 'Paused'), ('FAILED', 'Failed'), ('RATE_LIMITED', 'Rate Limited')], default='ACTIVE', max_length=20)),
                ('last_fetch_error', models.TextField(blank=True)),
                ('is_active', models.BooleanField(default=True)),
                ('priority', models.PositiveSmallIntegerField(default=5, help_text='1=highest, 10=lowest')),
                ('config', models.JSONField(default=dict, help_text='Source-specific configuration (query params, filters, etc.)')),
                ('total_fetches', models.PositiveIntegerField(default=0)),
                ('total_events_created', models.PositiveIntegerField(default=0)),
                ('average_fetch_duration_seconds', models.FloatField(default=0.0)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'ordering': ['priority', 'name'],
                'indexes': [models.Index(fields=['is_active', 'last_fetch_at'], name='threat_inte_is_acti_531a95_idx'), models.Index(fields=['source_type', 'is_active'], name='threat_inte_source__d6834a_idx')],
            },
        ),
        migrations.CreateModel(
            name='TenantIntelligenceProfile',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('monitored_locations', django.contrib.gis.db.models.fields.MultiPolygonField(geography=True, help_text='Geofences around tenant facilities requiring monitoring', srid=4326)),
                ('buffer_radius_km', models.FloatField(default=10.0, help_text='Expand monitored area by this radius')),
                ('threat_categories', models.JSONField(default=list, help_text='List of enabled threat categories')),
                ('category_weights', models.JSONField(default=dict, help_text='Per-category importance weights (for ML scoring)')),
                ('minimum_severity', models.CharField(default='MEDIUM', max_length=20)),
                ('minimum_confidence', models.FloatField(default=0.6, help_text='Minimum ML confidence to trigger alert (0.0-1.0)')),
                ('alert_urgency_critical', models.CharField(choices=[('IMMEDIATE', 'Immediate (WebSocket + SMS)'), ('RAPID', '15 minutes (WebSocket + Email)'), ('STANDARD', '1 hour (Email summary)'), ('DIGEST', 'Daily digest only'), ('DISABLED', 'No alerts')], default='IMMEDIATE', max_length=20)),
                ('alert_urgency_high', models.CharField(choices=[('IMMEDIATE', 'Immediate (WebSocket + SMS)'), ('RAPID', '15 minutes (WebSocket + Email)'), ('STANDARD', '1 hour (Email summary)'), ('DIGEST', 'Daily digest only'), ('DISABLED', 'No alerts')], default='RAPID', max_length=20)),
                ('alert_urgency_medium', models.CharField(choices=[('IMMEDIATE', 'Immediate (WebSocket + SMS)'), ('RAPID', '15 minutes (WebSocket + Email)'), ('STANDARD', '1 hour (Email summary)'), ('DIGEST', 'Daily digest only'), ('DISABLED', 'No alerts')], default='STANDARD', max_length=20)),
                ('alert_urgency_low', models.CharField(choices=[('IMMEDIATE', 'Immediate (WebSocket + SMS)'), ('RAPID', '15 minutes (WebSocket + Email)'), ('STANDARD', '1 hour (Email summary)'), ('DIGEST', 'Daily digest only'), ('DISABLED', 'No alerts')], default='DIGEST', max_length=20)),
                ('enable_websocket', models.BooleanField(default=True)),
                ('enable_sms', models.BooleanField(default=False)),
                ('enable_email', models.BooleanField(default=True)),
                ('enable_work_order_creation', models.BooleanField(default=False)),
                ('emergency_contacts', models.JSONField(default=list, help_text='List of {role, name, phone, email} for critical alerts')),
                ('operational_hours', models.JSONField(default=dict, help_text="Per-day operating hours: {'monday': {'start': '08:00', 'end': '18:00'}}")),
                ('enable_auto_tuning', models.BooleanField(default=True, help_text='Allow ML to adjust thresholds based on feedback')),
                ('enable_collective_intelligence', models.BooleanField(default=True, help_text='Participate in anonymized cross-tenant pattern sharing')),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('tenant', models.ForeignKey(blank=True, help_text='Tenant that owns this record', null=True, on_delete=django.db.models.deletion.CASCADE, to='tenants.tenant')),
            ],
        ),
        migrations.AddField(
            model_name='intelligencealert',
            name='intelligence_profile',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='alerts', to='threat_intelligence.tenantintelligenceprofile'),
        ),
        migrations.CreateModel(
            name='TenantLearningProfile',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('category_sensitivity', models.JSONField(default=dict, help_text="Per-category adjusted thresholds: {'POLITICAL': 0.7, 'WEATHER': 0.4}")),
                ('optimal_alert_hours', models.JSONField(default=dict, help_text="Hours when tenant is most responsive: {'weekday': [8, 17], 'weekend': []}")),
                ('source_trust_scores', models.JSONField(default=dict, help_text="Per-source reliability for this tenant: {'source_id': 0.85}")),
                ('total_alerts_received', models.PositiveIntegerField(default=0)),
                ('total_actionable', models.PositiveIntegerField(default=0)),
                ('total_false_positives', models.PositiveIntegerField(default=0)),
                ('total_missed', models.PositiveIntegerField(default=0)),
                ('average_response_time_minutes', models.FloatField(default=0.0, help_text='How quickly tenant typically responds to alerts')),
                ('effective_monitoring_radius_km', models.FloatField(blank=True, help_text='ML-calculated optimal radius based on past responses', null=True)),
                ('feature_importance', models.JSONField(default=dict, help_text="Which features matter most for this tenant's decisions")),
                ('last_retrained_at', models.DateTimeField(blank=True, null=True)),
                ('training_sample_size', models.PositiveIntegerField(default=0)),
                ('model_accuracy_score', models.FloatField(blank=True, help_text='Predictive accuracy of tenant-specific model', null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('intelligence_profile', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='learning_profile', to='threat_intelligence.tenantintelligenceprofile')),
                ('tenant', models.ForeignKey(blank=True, help_text='Tenant that owns this record', null=True, on_delete=django.db.models.deletion.CASCADE, to='tenants.tenant')),
            ],
        ),
        migrations.CreateModel(
            name='ThreatEvent',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('external_id', models.CharField(blank=True, db_index=True, max_length=500)),
                ('title', models.CharField(max_length=500)),
                ('description', models.TextField()),
                ('raw_content', models.TextField(help_text='Original unprocessed content')),
                ('category', models.CharField(choices=[('POLITICAL', 'Political Unrest'), ('WEATHER', 'Weather/Natural Disaster'), ('CYBER', 'Cyber Threat'), ('CIVIL_EMERGENCY', 'Civil Emergency'), ('TERRORISM', 'Terrorism/Violence'), ('CRIME', 'Crime Wave'), ('INFRASTRUCTURE', 'Infrastructure Failure'), ('HEALTH', 'Public Health Emergency'), ('OTHER', 'Other')], db_index=True, max_length=50)),
                ('severity', models.CharField(choices=[('CRITICAL', 'Critical'), ('HIGH', 'High'), ('MEDIUM', 'Medium'), ('LOW', 'Low'), ('INFO', 'Informational')], db_index=True, max_length=20)),
                ('confidence_score', models.FloatField(default=0.5, help_text='ML confidence in classification (0.0-1.0)')),
                ('location', django.contrib.gis.db.models.fields.PointField(blank=True, geography=True, null=True, srid=4326)),
                ('affected_area', django.contrib.gis.db.models.fields.PolygonField(blank=True, geography=True, null=True, srid=4326)),
                ('impact_radius_km', models.FloatField(blank=True, null=True)),
                ('location_name', models.CharField(blank=True, max_length=500)),
                ('country_code', models.CharField(blank=True, db_index=True, max_length=2)),
                ('event_start_time', models.DateTimeField(db_index=True)),
                ('event_end_time', models.DateTimeField(blank=True, null=True)),
                ('forecast_window_hours', models.PositiveIntegerField(blank=True, help_text='How many hours ahead this event is forecasted', null=True)),
                ('entities', models.JSONField(default=dict, help_text='Extracted entities: organizations, people, locations')),
                ('keywords', models.JSONField(default=list, help_text='Extracted keywords/tags')),
                ('source_url', models.URLField(blank=True, max_length=1000)),
                ('source_published_at', models.DateTimeField(blank=True, null=True)),
                ('is_processed', models.BooleanField(db_index=True, default=False)),
                ('processing_error', models.TextField(blank=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('source', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='events', to='threat_intelligence.intelligencesource')),
            ],
            options={
                'ordering': ['-event_start_time', '-severity'],
            },
        ),
        migrations.AddField(
            model_name='intelligencealert',
            name='threat_event',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='alerts', to='threat_intelligence.threatevent'),
        ),
        migrations.CreateModel(
            name='EventEscalationHistory',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('stage', models.CharField(choices=[('EARLY_SIGNAL', 'Early Signal Detected'), ('CHATTER', 'Increased Social Media Chatter'), ('OFFICIAL_WARNING', 'Official Warning Issued'), ('IMMINENT', 'Event Imminent (24hrs)'), ('ACTIVE', 'Event Active'), ('AFTERMATH', 'Aftermath/Recovery Phase'), ('RESOLVED', 'Resolved')], db_index=True, max_length=30)),
                ('confidence_score', models.FloatField(help_text='ML confidence at this stage')),
                ('severity', models.CharField(max_length=20)),
                ('trigger_source', models.CharField(blank=True, max_length=200)),
                ('trigger_description', models.TextField(blank=True)),
                ('predicted_impact_radius_km', models.FloatField(blank=True, null=True)),
                ('predicted_duration_hours', models.FloatField(blank=True, null=True)),
                ('similar_historical_events', models.JSONField(default=list, help_text='IDs of similar past events for pattern matching')),
                ('supporting_signals', models.JSONField(default=list, help_text='List of data points supporting this escalation')),
                ('stage_reached_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('threat_event', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='escalation_history', to='threat_intelligence.threatevent')),
            ],
            options={
                'verbose_name_plural': 'Event escalation histories',
                'ordering': ['threat_event', 'stage_reached_at'],
            },
        ),
        migrations.AddIndex(
            model_name='intelligencealertview',
            index=models.Index(fields=['alert', 'viewed_at'], name='threat_inte_alert_i_64e129_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='intelligencealertview',
            unique_together={('alert', 'user')},
        ),
        migrations.AddIndex(
            model_name='tenantintelligenceprofile',
            index=models.Index(fields=['tenant', 'is_active'], name='threat_inte_tenant__9c39bf_idx'),
        ),
        migrations.AddIndex(
            model_name='tenantintelligenceprofile',
            index=django.contrib.postgres.indexes.GinIndex(fields=['threat_categories'], name='threat_inte_threat__cb77cc_gin'),
        ),
        migrations.AddIndex(
            model_name='tenantlearningprofile',
            index=models.Index(fields=['tenant', 'last_retrained_at'], name='threat_inte_tenant__af4124_idx'),
        ),
        migrations.AddIndex(
            model_name='tenantlearningprofile',
            index=django.contrib.postgres.indexes.GinIndex(fields=['category_sensitivity'], name='threat_inte_categor_7edd8a_gin'),
        ),
        migrations.AddIndex(
            model_name='threatevent',
            index=models.Index(fields=['category', 'severity', 'event_start_time'], name='threat_inte_categor_5e66e4_idx'),
        ),
        migrations.AddIndex(
            model_name='threatevent',
            index=models.Index(fields=['is_processed', 'created_at'], name='threat_inte_is_proc_470472_idx'),
        ),
        migrations.AddIndex(
            model_name='threatevent',
            index=models.Index(fields=['event_start_time', 'event_end_time'], name='threat_inte_event_s_9b2c5e_idx'),
        ),
        migrations.AddIndex(
            model_name='threatevent',
            index=django.contrib.postgres.indexes.GinIndex(fields=['entities'], name='threat_inte_entitie_6d7752_gin'),
        ),
        migrations.AddIndex(
            model_name='threatevent',
            index=django.contrib.postgres.indexes.GinIndex(fields=['keywords'], name='threat_inte_keyword_d545db_gin'),
        ),
        migrations.AddConstraint(
            model_name='threatevent',
            constraint=models.CheckConstraint(condition=models.Q(('confidence_score__gte', 0.0), ('confidence_score__lte', 1.0)), name='valid_confidence_score'),
        ),
        migrations.AddIndex(
            model_name='intelligencealert',
            index=models.Index(fields=['tenant', 'delivery_status', 'created_at'], name='threat_inte_tenant__297529_idx'),
        ),
        migrations.AddIndex(
            model_name='intelligencealert',
            index=models.Index(fields=['severity', 'tenant_response'], name='threat_inte_severit_3cf219_idx'),
        ),
        migrations.AddIndex(
            model_name='intelligencealert',
            index=models.Index(fields=['tenant', 'tenant_response', 'created_at'], name='threat_inte_tenant__b25627_idx'),
        ),
        migrations.AddIndex(
            model_name='eventescalationhistory',
            index=models.Index(fields=['threat_event', 'stage', 'stage_reached_at'], name='threat_inte_threat__8e137c_idx'),
        ),
        migrations.AddIndex(
            model_name='eventescalationhistory',
            index=models.Index(fields=['stage', 'stage_reached_at'], name='threat_inte_stage_f921a8_idx'),
        ),
        migrations.AddIndex(
            model_name='eventescalationhistory',
            index=django.contrib.postgres.indexes.GinIndex(fields=['supporting_signals'], name='threat_inte_support_8a3783_gin'),
        ),
    ]
