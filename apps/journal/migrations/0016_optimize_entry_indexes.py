# Generated by Claude Code on 2025-11-04
# Performance optimization: Phase 1 - Performance Engineer

from django.db import migrations, models


class Migration(migrations.Migration):
    """
    Optimize JournalEntry indexes for descending timestamp queries.

    These index changes significantly improve performance for:
    - User timeline queries (user + -timestamp): Most recent entries first
    - Type-filtered timelines (entry_type + -timestamp): Filter by type with chronological ordering
    - Privacy-aware queries (privacy_scope + user): Already optimized, no changes

    Changes:
    - user + timestamp → user + -timestamp (descending order matches query pattern)
    - entry_type + user → entry_type + -timestamp (temporal ordering for type filters)

    Related: Phase 1 Performance Remediation - Critical Performance Issues
    """

    dependencies = [
        ('journal', '0015_migrate_to_encrypted_fields'),
    ]

    operations = [
        # Remove old ascending indexes
        migrations.RemoveIndex(
            model_name='journalentry',
            name='journal_ent_user_id_8e7a9b_idx',  # user + timestamp (ascending)
        ),
        migrations.RemoveIndex(
            model_name='journalentry',
            name='journal_ent_entry_t_2c5e8d_idx',  # entry_type + user
        ),

        # Add optimized descending indexes
        migrations.AddIndex(
            model_name='journalentry',
            index=models.Index(
                fields=['user', '-timestamp'],
                name='journal_user_time_desc_idx'
            ),
        ),
        migrations.AddIndex(
            model_name='journalentry',
            index=models.Index(
                fields=['entry_type', '-timestamp'],
                name='journal_type_time_desc_idx'
            ),
        ),
    ]
