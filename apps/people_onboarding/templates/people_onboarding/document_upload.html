{% extends "people_onboarding/base_onboarding.html" %}
{% load static %}

{% block page_title %}Document Upload - {{ request_obj.request_number }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css">
<style>
    .dropzone {
        border: 2px dashed #3699FF;
        background-color: #F3F6F9;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .dropzone:hover {
        border-color: #187DE4;
        background-color: #E1F0FF;
    }
    .dropzone.dz-drag-hover {
        border-color: #1BC5BD;
        background-color: #C9F7F5;
    }
    .dz-preview {
        display: inline-block;
        margin: 10px;
        position: relative;
    }
    .pdf-preview-container {
        width: 100%;
        height: 600px;
        border: 1px solid #E4E6EF;
        border-radius: 8px;
        overflow: hidden;
    }
    #pdfCanvas {
        width: 100%;
        height: auto;
    }
    .doc-type-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'people_onboarding:dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'people_onboarding:request_detail' request_obj.uuid %}">{{ request_obj.request_number }}</a></li>
<li class="breadcrumb-item text-muted">Documents</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="card card-flush mb-5">
        <div class="card-body py-5">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2 fw-bold">Document Upload</h1>
                    <p class="text-muted mb-0">
                        Request #{{ request_obj.request_number }} -
                        {{ request_obj.candidate_profile.full_name }}
                        {% include "people_onboarding/partials/_status_badge.html" with state=request_obj.current_state %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'people_onboarding:request_detail' request_obj.uuid %}"
                       class="btn btn-light">
                        <i class="bi bi-arrow-left me-2"></i>
                        Back to Request
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-5">
        <!-- Upload Section -->
        <div class="col-xl-8">
            <!-- Document Requirements -->
            <div class="card card-flush mb-5">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-list-check text-primary me-2"></i>
                        Required Documents
                    </h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-row-bordered gy-4">
                            <thead>
                                <tr class="fw-bold text-muted bg-light">
                                    <th>Document Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc_type in required_documents %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-file-earmark-text fs-3 me-3 text-primary"></i>
                                            <div>
                                                <div class="fw-bold">{{ doc_type.name }}</div>
                                                <div class="text-muted fs-7">{{ doc_type.description }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if doc_type.uploaded %}
                                        <span class="badge badge-success">
                                            <i class="bi bi-check-circle me-1"></i>
                                            Uploaded
                                        </span>
                                        {% else %}
                                        <span class="badge badge-warning">
                                            <i class="bi bi-exclamation-circle me-1"></i>
                                            Pending
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button"
                                                class="btn btn-sm btn-light-primary"
                                                onclick="DocumentUploadApp.openUploadModal('{{ doc_type.code }}')">
                                            <i class="bi bi-upload me-2"></i>
                                            Upload
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Dropzone Upload -->
            <div class="card card-flush">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-cloud-upload text-primary me-2"></i>
                        Upload Documents
                    </h3>
                    {% if not document_parser_available %}
                    <span class="badge badge-warning text-dark ms-3">
                        AI parsing offline
                    </span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="alert alert-info d-flex align-items-center mb-5">
                        <i class="bi bi-info-circle-fill fs-2 me-3"></i>
                        <div>
                            <h5 class="mb-1">Upload Guidelines</h5>
                            <ul class="mb-0 ps-3">
                                <li>Maximum file size: <strong>10MB</strong></li>
                                <li>Supported formats: <strong>PDF, JPG, PNG, DOC, DOCX</strong></li>
                                <li>Ensure documents are clear and legible</li>
                                {% if document_parser_available %}
                                <li>Files are automatically scanned using OCR technology</li>
                                {% else %}
                                <li class="text-muted">AI document parsing is temporarily unavailable; documents will be reviewed manually.</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>

                    <!-- Dropzone -->
                    <form action="{% url 'people_onboarding:api_document_upload' %}"
                          class="dropzone"
                          id="documentDropzone">
                        {% csrf_token %}
                        <input type="hidden" name="onboarding_request" value="{{ request_obj.uuid }}">
                        <div class="dz-message needsclick">
                            <i class="bi bi-cloud-arrow-up-fill text-primary" style="font-size: 4rem;"></i>
                            <h3 class="mt-4 mb-2">Drop files here or click to upload</h3>
                            <p class="text-muted">
                                You can upload multiple files at once
                            </p>
                        </div>
                    </form>

                    <!-- Upload Progress -->
                    <div id="uploadProgressContainer" class="mt-5 d-none">
                        <h5 class="mb-3">Upload Progress</h5>
                        <div id="uploadProgressList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Uploaded Documents Sidebar -->
        <div class="col-xl-4">
            <!-- Summary Card -->
            <div class="card card-flush mb-5 bg-light-primary">
                <div class="card-body text-center py-8">
                    <i class="bi bi-files text-primary mb-3" style="font-size: 3rem;"></i>
                    <h2 class="fw-bold mb-2">{{ documents|length }}</h2>
                    <p class="text-muted mb-0">Documents Uploaded</p>
                </div>
            </div>

            <!-- Uploaded Documents List -->
            <div class="card card-flush">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-folder-fill text-warning me-2"></i>
                        Uploaded Documents
                    </h3>
                </div>
                <div class="card-body" id="uploadedDocumentsContainer">
                    {% if documents %}
                    <div class="timeline">
                        {% for doc in documents %}
                        <div class="timeline-item mb-4" data-doc-uuid="{{ doc.uuid }}">
                            <div class="timeline-icon">
                                {% if doc.document_file.url|slice:"-4:" == ".pdf" %}
                                <i class="bi bi-file-pdf-fill text-danger"></i>
                                {% elif doc.document_file.url|slice:"-4:" == ".jpg" or doc.document_file.url|slice:"-5:" == ".jpeg" or doc.document_file.url|slice:"-4:" == ".png" %}
                                <i class="bi bi-file-image-fill text-info"></i>
                                {% else %}
                                <i class="bi bi-file-earmark-fill text-primary"></i>
                                {% endif %}
                            </div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="mb-1">{{ doc.get_document_type_display }}</h6>
                                        <small class="text-muted">
                                            {{ doc.cdtz|timesince }} ago
                                        </small>
                                    </div>
                                    {% include "people_onboarding/partials/_status_badge.html" with state=doc.verification_status %}
                                </div>

                                <!-- Document Actions -->
                                <div class="btn-group btn-group-sm mt-2">
                                    <button type="button"
                                            class="btn btn-light-primary"
                                            onclick="DocumentUploadApp.previewDocument('{{ doc.uuid }}')">
                                        <i class="bi bi-eye me-1"></i>
                                        Preview
                                    </button>
                                    <a href="{{ doc.document_file.url }}"
                                       download
                                       class="btn btn-light-info">
                                        <i class="bi bi-download me-1"></i>
                                        Download
                                    </a>
                                    {% if doc.verification_status != 'VERIFIED' %}
                                    <button type="button"
                                            class="btn btn-light-danger"
                                            onclick="DocumentUploadApp.deleteDocument('{{ doc.uuid }}')">
                                        <i class="bi bi-trash me-1"></i>
                                        Delete
                                    </button>
                                    {% endif %}
                                </div>

                                <!-- OCR Data Preview -->
                                {% if doc.ocr_data %}
                                <div class="mt-3 p-3 bg-light rounded">
                                    <small class="text-muted d-block mb-1">
                                        <i class="bi bi-robot me-1"></i>
                                        Extracted Data (OCR):
                                    </small>
                                    <pre class="mb-0 text-dark" style="font-size: 11px; white-space: pre-wrap;">{{ doc.ocr_data|truncatewords:30 }}</pre>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <i class="bi bi-folder2-open text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3 mb-0">No documents uploaded yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Preview Modal -->
<div class="modal fade" id="documentPreviewModal" tabindex="-1" aria-labelledby="documentPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentPreviewModalLabel">
                    <i class="bi bi-eye me-2"></i>
                    Document Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="documentPreviewContainer">
                    <!-- PDF Preview -->
                    <div id="pdfPreviewSection" class="d-none">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <button type="button" class="btn btn-sm btn-light" id="pdfPrevPage">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <span class="mx-3">
                                    Page <span id="pdfCurrentPage">1</span> of <span id="pdfTotalPages">1</span>
                                </span>
                                <button type="button" class="btn btn-sm btn-light" id="pdfNextPage">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-sm btn-light" id="pdfZoomOut">
                                    <i class="bi bi-zoom-out"></i>
                                </button>
                                <span class="mx-2" id="pdfZoomLevel">100%</span>
                                <button type="button" class="btn btn-sm btn-light" id="pdfZoomIn">
                                    <i class="bi bi-zoom-in"></i>
                                </button>
                            </div>
                        </div>
                        <div class="pdf-preview-container">
                            <canvas id="pdfCanvas"></canvas>
                        </div>
                    </div>

                    <!-- Image Preview -->
                    <div id="imagePreviewSection" class="d-none text-center">
                        <img id="imagePreview" src="" alt="Document Preview" class="img-fluid rounded" style="max-height: 600px;">
                    </div>

                    <!-- Loading Spinner -->
                    {% include "people_onboarding/partials/_loading_spinner.html" with id="previewLoadingSpinner" %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                <a href="#" id="downloadDocumentBtn" class="btn btn-primary" download>
                    <i class="bi bi-download me-2"></i>
                    Download
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Document Upload Modal (for specific document types) -->
<div class="modal fade" id="documentUploadModal" tabindex="-1" aria-labelledby="documentUploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentUploadModalLabel">
                    <i class="bi bi-upload me-2"></i>
                    Upload Document
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="singleDocumentUploadForm">
                    {% csrf_token %}
                    <input type="hidden" name="onboarding_request" value="{{ request_obj.uuid }}">
                    <input type="hidden" name="document_type" id="modalDocumentType">

                    <div class="mb-4">
                        <label for="modalDocumentFile" class="form-label fw-bold required">
                            Select Document File
                        </label>
                        <input type="file"
                               class="form-control"
                               id="modalDocumentFile"
                               name="document_file"
                               accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                               required>
                        <small class="text-muted">Max 10MB, PDF/JPG/PNG/DOC/DOCX</small>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="modalIssueDate" class="form-label fw-bold">
                                Issue Date
                            </label>
                            <input type="date"
                                   class="form-control"
                                   id="modalIssueDate"
                                   name="issue_date">
                        </div>
                        <div class="col-md-6">
                            <label for="modalExpiryDate" class="form-label fw-bold">
                                Expiry Date
                            </label>
                            <input type="date"
                                   class="form-control"
                                   id="modalExpiryDate"
                                   name="expiry_date">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button"
                        class="btn btn-primary"
                        onclick="DocumentUploadApp.uploadSingleDocument()">
                    <i class="bi bi-upload me-2"></i>
                    Upload
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
// Initialize PDF.js
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

window.DocumentUploadApp = {
    config: {
        documentParserEnabled: {{ document_parser_available|yesno:"true,false" }}
    },
    dropzone: null,
    currentPdf: null,
    currentPage: 1,
    totalPages: 0,
    zoomLevel: 1.0,
    requestUuid: '{{ request_obj.uuid }}',

    init: function() {
        this.initDropzone();
        this.initPdfControls();
    },

    initDropzone: function() {
        Dropzone.autoDiscover = false;
        const self = this;

        this.dropzone = new Dropzone('#documentDropzone', {
            url: '{% url "people_onboarding:api_document_upload" %}',
            paramName: 'document_file',
            maxFilesize: 10, // MB
            acceptedFiles: '.pdf,.jpg,.jpeg,.png,.doc,.docx',
            addRemoveLinks: true,
            headers: {
                'X-CSRFToken': OnboardingApp.config.csrfToken
            },
            init: function() {
                this.on('sending', function(file, xhr, formData) {
                    formData.append('onboarding_request', self.requestUuid);
                    $('#uploadProgressContainer').removeClass('d-none');
                });

                this.on('success', function(file, response) {
                    OnboardingApp.toast.success('Document uploaded successfully');
                    self.addDocumentToSidebar(response.document);

                    // Trigger OCR extraction
                    if (DocumentUploadApp.config.documentParserEnabled && response.document.uuid) {
                        self.triggerOCR(response.document.uuid);
                    }
                });

                this.on('error', function(file, errorMessage) {
                    OnboardingApp.toast.error('Upload failed: ' + errorMessage);
                });

                this.on('complete', function(file) {
                    setTimeout(() => {
                        this.removeFile(file);
                    }, 2000);
                });
            }
        });
    },

    triggerOCR: function(documentUuid) {
        if (!this.config.documentParserEnabled) {
            return;
        }
        OnboardingApp.ajax.post(
            OnboardingApp.config.apiBaseUrl + 'documents/' + documentUuid + '/extract-ocr/',
            {},
            function(response) {
                OnboardingApp.toast.success('OCR extraction completed');
                // Update document card with OCR data
                location.reload();
            },
            function(error) {
                console.error('OCR extraction failed', error);
            }
        );
    },

    addDocumentToSidebar: function(document) {
        const container = $('#uploadedDocumentsContainer');
        const emptyState = container.find('.text-center.py-8');

        if (emptyState.length) {
            emptyState.remove();
            container.html('<div class="timeline"></div>');
        }

        const timeline = container.find('.timeline');
        const docHtml = `
            <div class="timeline-item mb-4" data-doc-uuid="${document.uuid}">
                <div class="timeline-icon">
                    <i class="bi bi-file-earmark-fill text-primary"></i>
                </div>
                <div class="timeline-content">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="mb-1">${document.document_type_display}</h6>
                            <small class="text-muted">Just now</small>
                        </div>
                        <span class="badge badge-warning">PENDING</span>
                    </div>
                    <div class="btn-group btn-group-sm mt-2">
                        <button type="button" class="btn btn-light-primary" onclick="DocumentUploadApp.previewDocument('${document.uuid}')">
                            <i class="bi bi-eye me-1"></i> Preview
                        </button>
                        <a href="${document.file_url}" download class="btn btn-light-info">
                            <i class="bi bi-download me-1"></i> Download
                        </a>
                        <button type="button" class="btn btn-light-danger" onclick="DocumentUploadApp.deleteDocument('${document.uuid}')">
                            <i class="bi bi-trash me-1"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        `;

        timeline.prepend(docHtml);

        // Update document count
        const currentCount = parseInt($('.card.bg-light-primary h2').text());
        $('.card.bg-light-primary h2').text(currentCount + 1);
    },

    previewDocument: function(documentUuid) {
        $('#documentPreviewModal').modal('show');
        $('#previewLoadingSpinner').removeClass('d-none');
        $('#pdfPreviewSection, #imagePreviewSection').addClass('d-none');

        // Fetch document details
        OnboardingApp.ajax.get(
            OnboardingApp.config.apiBaseUrl + 'documents/' + documentUuid + '/',
            function(response) {
                $('#previewLoadingSpinner').addClass('d-none');
                const fileUrl = response.file_url;
                const fileName = fileUrl.split('/').pop().toLowerCase();

                $('#downloadDocumentBtn').attr('href', fileUrl);

                if (fileName.endsWith('.pdf')) {
                    DocumentUploadApp.loadPdf(fileUrl);
                } else if (fileName.match(/\.(jpg|jpeg|png)$/)) {
                    $('#imagePreview').attr('src', fileUrl);
                    $('#imagePreviewSection').removeClass('d-none');
                }
            },
            function(error) {
                OnboardingApp.toast.error('Failed to load document preview');
                $('#documentPreviewModal').modal('hide');
            }
        );
    },

    loadPdf: function(url) {
        const self = this;

        pdfjsLib.getDocument(url).promise.then(function(pdf) {
            self.currentPdf = pdf;
            self.totalPages = pdf.numPages;
            self.currentPage = 1;

            $('#pdfTotalPages').text(self.totalPages);
            $('#pdfPreviewSection').removeClass('d-none');

            self.renderPdfPage(self.currentPage);
        }).catch(function(error) {
            OnboardingApp.toast.error('Failed to load PDF');
            console.error(error);
        });
    },

    renderPdfPage: function(pageNum) {
        const self = this;

        this.currentPdf.getPage(pageNum).then(function(page) {
            const canvas = document.getElementById('pdfCanvas');
            const context = canvas.getContext('2d');

            const viewport = page.getViewport({ scale: self.zoomLevel });
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };

            page.render(renderContext);
            $('#pdfCurrentPage').text(pageNum);
        });
    },

    initPdfControls: function() {
        const self = this;

        $('#pdfPrevPage').on('click', function() {
            if (self.currentPage > 1) {
                self.currentPage--;
                self.renderPdfPage(self.currentPage);
            }
        });

        $('#pdfNextPage').on('click', function() {
            if (self.currentPage < self.totalPages) {
                self.currentPage++;
                self.renderPdfPage(self.currentPage);
            }
        });

        $('#pdfZoomIn').on('click', function() {
            self.zoomLevel += 0.25;
            self.renderPdfPage(self.currentPage);
            $('#pdfZoomLevel').text(Math.round(self.zoomLevel * 100) + '%');
        });

        $('#pdfZoomOut').on('click', function() {
            if (self.zoomLevel > 0.5) {
                self.zoomLevel -= 0.25;
                self.renderPdfPage(self.currentPage);
                $('#pdfZoomLevel').text(Math.round(self.zoomLevel * 100) + '%');
            }
        });
    },

    openUploadModal: function(documentType) {
        $('#modalDocumentType').val(documentType);
        $('#documentUploadModal').modal('show');
    },

    uploadSingleDocument: function() {
        const form = $('#singleDocumentUploadForm')[0];
        const formData = new FormData(form);

        $.ajax({
            url: '{% url "people_onboarding:api_document_upload" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': OnboardingApp.config.csrfToken
            },
            success: function(response) {
                OnboardingApp.toast.success('Document uploaded successfully');
                $('#documentUploadModal').modal('hide');
                DocumentUploadApp.addDocumentToSidebar(response.document);
                form.reset();
            },
            error: function(error) {
                OnboardingApp.toast.error('Upload failed');
            }
        });
    },

    deleteDocument: function(documentUuid) {
        if (!confirm('Are you sure you want to delete this document?')) {
            return;
        }

        OnboardingApp.ajax.delete(
            OnboardingApp.config.apiBaseUrl + 'documents/' + documentUuid + '/',
            function(response) {
                OnboardingApp.toast.success('Document deleted successfully');
                $(`.timeline-item[data-doc-uuid="${documentUuid}"]`).fadeOut(300, function() {
                    $(this).remove();

                    // Update count
                    const currentCount = parseInt($('.card.bg-light-primary h2').text());
                    $('.card.bg-light-primary h2').text(currentCount - 1);

                    // Show empty state if no documents
                    if (currentCount - 1 === 0) {
                        $('#uploadedDocumentsContainer').html(`
                            <div class="text-center py-8">
                                <i class="bi bi-folder2-open text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-3 mb-0">No documents uploaded yet</p>
                            </div>
                        `);
                    }
                });
            },
            function(error) {
                OnboardingApp.toast.error('Failed to delete document');
            }
        );
    }
};

$(document).ready(function() {
    DocumentUploadApp.init();
});
</script>
{% endblock %}
