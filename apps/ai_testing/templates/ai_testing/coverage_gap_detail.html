{% extends "base.html" %}
{% load static %}

{% block title %}Coverage Gap: {{ gap.title }}{% endblock %}

{% block extra_css %}
<style>
    .priority-critical { border-color: #dc3545; }
    .priority-high { border-color: #fd7e14; }
    .priority-medium { border-color: #ffc107; }
    .priority-low { border-color: #6c757d; }

    .gap-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px 15px 0 0;
        margin-bottom: 0;
    }

    .score-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
        color: white;
        text-align: center;
    }

    .confidence-circle { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
    .impact-circle { background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%); }

    .timeline {
        position: relative;
        padding: 20px 0;
    }

    .timeline-item {
        position: relative;
        padding: 15px 0 15px 40px;
        border-left: 2px solid #e9ecef;
    }

    .timeline-item:last-child {
        border-left: 2px solid transparent;
    }

    .timeline-marker {
        position: absolute;
        left: -8px;
        top: 20px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #6c757d;
    }

    .timeline-marker.completed { background: #28a745; }
    .timeline-marker.current { background: #ffc107; }

    .code-preview {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        max-height: 400px;
        overflow-y: auto;
    }

    .similar-gap-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }

    .similar-gap-card:hover {
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0,123,255,0.15);
    }

    .similarity-bar {
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
    }

    .similarity-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        transition: width 0.3s ease;
    }

    .platform-badge {
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 12px;
        background: #e9ecef;
        color: #495057;
        margin: 2px;
    }

    .endpoint-tag {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 0.8rem;
        margin: 2px;
        font-family: monospace;
    }

    .pattern-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 0.75rem;
        padding: 4px 12px;
        border-radius: 15px;
        margin: 2px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Back Navigation -->
    <div class="row mb-3">
        <div class="col-12">
            <a href="{% url 'ai_testing:coverage_gaps_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Coverage Gaps
            </a>
        </div>
    </div>

    <!-- Gap Header -->
    <div class="gap-header priority-{{ gap.priority }}">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h3 mb-2">{{ gap.title }}</h1>
                <div class="d-flex align-items-center gap-3 mb-3">
                    <span class="badge bg-light text-dark">{{ gap.get_coverage_type_display }}</span>
                    <span class="badge bg-{{ gap.priority }}">{{ gap.get_priority_display }} Priority</span>
                    <span class="badge bg-{% if gap.status == 'identified' %}warning{% elif gap.status == 'test_generated' %}info{% elif gap.status == 'test_implemented' %}success{% else %}secondary{% endif %}">
                        {{ gap.get_status_display }}
                    </span>
                </div>
                <p class="mb-0">{{ gap.description }}</p>
                <small class="opacity-75">
                    Identified {{ gap.identified_at|timesince }} ago •
                    Estimated implementation: {{ estimated_time }} hours
                </small>
            </div>
            <div class="col-md-4 text-center">
                <div class="row">
                    <div class="col-6">
                        <div class="score-circle confidence-circle">
                            {{ gap.confidence_score|floatformat:0 }}%
                        </div>
                        <div class="mt-2 small">Confidence</div>
                    </div>
                    <div class="col-6">
                        <div class="score-circle impact-circle">
                            {{ gap.impact_score|floatformat:1 }}/10
                        </div>
                        <div class="mt-2 small">Impact</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-top-0" style="border-radius: 0 0 15px 15px;">
        <div class="card-body">
            <div class="row">
                <!-- Left Column: Gap Details -->
                <div class="col-lg-8">
                    <!-- Affected Components -->
                    <div class="mb-4">
                        <h5><i class="fas fa-network-wired"></i> Affected Components</h5>

                        {% if gap.affected_endpoints %}
                            <div class="mb-3">
                                <h6 class="text-muted">Endpoints/Components</h6>
                                <div class="d-flex flex-wrap">
                                    {% for endpoint in gap.affected_endpoints %}
                                        <span class="endpoint-tag">{{ endpoint }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        {% if gap.affected_platforms %}
                            <div class="mb-3">
                                <h6 class="text-muted">Platforms</h6>
                                <div class="d-flex flex-wrap">
                                    {% for platform in gap.affected_platforms %}
                                        <span class="platform-badge">
                                            <i class="fab fa-{{ platform }}"></i> {{ platform|capfirst }}
                                        </span>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Related Anomaly -->
                    <div class="mb-4">
                        <h5><i class="fas fa-exclamation-triangle"></i> Source Anomaly</h5>
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ gap.anomaly_signature.anomaly_type|title }}</h6>
                                        <p class="text-muted small mb-2">{{ gap.anomaly_signature.description|truncatechars:150 }}</p>
                                        <div class="small text-muted">
                                            <strong>Occurrences:</strong> {{ gap.anomaly_signature.occurrence_count }} •
                                            <strong>Last seen:</strong> {{ gap.anomaly_signature.last_seen|timesince }} ago
                                        </div>
                                    </div>
                                    <span class="badge bg-{{ gap.anomaly_signature.severity }}">
                                        {{ gap.anomaly_signature.get_severity_display }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Generation -->
                    <div class="mb-4">
                        <h5><i class="fas fa-code"></i> Test Generation</h5>

                        {% if gap.auto_generated_test_code %}
                            <!-- Existing Generated Code -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Generated Test Code</h6>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('generated-code')">
                                            <i class="fas fa-copy"></i> Copy
                                        </button>
                                        <a href="{% url 'ai_testing:download_generated_test' %}?gap_id={{ gap.id }}&framework={{ gap.recommended_framework }}"
                                           class="btn btn-sm btn-success">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>
                                </div>

                                <div class="code-preview">
                                    <pre id="generated-code"><code class="language-{% if gap.recommended_framework == 'xctest' or gap.recommended_framework == 'ui_testing' %}swift{% else %}kotlin{% endif %}">{{ gap.auto_generated_test_code }}</code></pre>
                                </div>

                                <div class="mt-2 small text-muted">
                                    <strong>Framework:</strong> {{ gap.get_recommended_framework_display }} •
                                    <strong>Generated:</strong> {{ gap.updated_at|timesince }} ago
                                </div>
                            </div>
                        {% else %}
                            <!-- Generate New Test -->
                            <div class="mb-3">
                                <p class="text-muted">No test code has been generated yet for this coverage gap.</p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Test Framework</label>
                                        <select id="frameworkSelect" class="form-select">
                                            {% for value, label in framework_choices %}
                                                <option value="{{ value }}" {% if value == gap.recommended_framework %}selected{% endif %}>
                                                    {{ label }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button class="btn btn-primary" onclick="generateTest()">
                                            <i class="fas fa-magic"></i> Generate Test Code
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Test Preview Area -->
                            <div id="test-preview-area" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Preview</h6>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('preview-code')">
                                            <i class="fas fa-copy"></i> Copy
                                        </button>
                                        <button class="btn btn-sm btn-success" onclick="saveGeneratedTest()">
                                            <i class="fas fa-save"></i> Save & Download
                                        </button>
                                    </div>
                                </div>

                                <div class="code-preview">
                                    <pre id="preview-code"><code id="preview-code-content"></code></pre>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Implementation Timeline -->
                    <div class="mb-4">
                        <h5><i class="fas fa-history"></i> Implementation Timeline</h5>
                        <div class="timeline">
                            {% for item in timeline %}
                                <div class="timeline-item">
                                    <div class="timeline-marker {% if item.timestamp %}completed{% else %}current{% endif %}"></div>
                                    <div>
                                        <h6 class="mb-1">{{ item.event }}</h6>
                                        {% if item.timestamp %}
                                            <small class="text-muted">{{ item.timestamp|timesince }} ago</small>
                                        {% else %}
                                            <small class="text-muted">Pending</small>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- Status Update Actions -->
                        <div class="mt-3">
                            <div class="btn-group">
                                {% if gap.status == 'identified' %}
                                    <button class="btn btn-outline-info" onclick="updateStatus('test_generated')">
                                        Mark Test Generated
                                    </button>
                                {% elif gap.status == 'test_generated' %}
                                    <button class="btn btn-outline-success" onclick="updateStatus('test_implemented')">
                                        Mark Implemented
                                    </button>
                                {% elif gap.status == 'test_implemented' %}
                                    <button class="btn btn-outline-success" onclick="updateStatus('test_verified')">
                                        Mark Verified
                                    </button>
                                {% endif %}

                                {% if gap.status != 'dismissed' %}
                                    <button class="btn btn-outline-warning" onclick="updateStatus('dismissed')">
                                        Dismiss Gap
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Related Information -->
                <div class="col-lg-4">
                    <!-- Gap Metadata -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-info-circle"></i> Gap Metadata</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <strong>Effectiveness Score:</strong>
                                <span class="float-end">{{ gap.effectiveness_score|floatformat:2 }}</span>
                            </div>
                            <div class="mb-2">
                                <strong>Urgency Level:</strong>
                                <span class="float-end badge bg-{{ gap.urgency_level }}">{{ gap.urgency_level|title }}</span>
                            </div>
                            {% if gap.assigned_to %}
                                <div class="mb-2">
                                    <strong>Assigned to:</strong>
                                    <span class="float-end">{{ gap.assigned_to.get_full_name|default:gap.assigned_to.username }}</span>
                                </div>
                            {% endif %}
                            {% if gap.similar_gaps_count %}
                                <div class="mb-2">
                                    <strong>Similar Gaps:</strong>
                                    <span class="float-end">{{ gap.similar_gaps_count }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Related Patterns -->
                    {% if patterns %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-chart-line"></i> Related Patterns</h6>
                            </div>
                            <div class="card-body">
                                {% for pattern in patterns %}
                                    <div class="mb-3">
                                        <span class="pattern-badge">{{ pattern.get_pattern_type_display }}</span>
                                        <div class="mt-1 small text-muted">{{ pattern.title }}</div>
                                        <div class="small text-muted">
                                            {{ pattern.occurrence_count }} occurrences •
                                            {{ pattern.confidence_score|floatformat:0 }}% confidence
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Similar Gaps -->
                    {% if similar_gaps %}
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-clone"></i> Similar Coverage Gaps</h6>
                            </div>
                            <div class="card-body">
                                {% for similar in similar_gaps %}
                                    <div class="similar-gap-card">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="mb-1">
                                                <a href="{% url 'ai_testing:coverage_gap_detail' similar.gap.id %}" class="text-decoration-none">
                                                    {{ similar.gap.title|truncatechars:40 }}
                                                </a>
                                            </h6>
                                            <span class="badge bg-{{ similar.gap.priority }}">{{ similar.gap.get_priority_display }}</span>
                                        </div>
                                        <div class="mb-2">
                                            <div class="small text-muted mb-1">
                                                Similarity: {{ similar.similarity_score|floatformat:0 }}%
                                            </div>
                                            <div class="similarity-bar">
                                                <div class="similarity-fill" style="width: {{ similar.similarity_score|floatformat:0 }}%"></div>
                                            </div>
                                        </div>
                                        <div class="small text-muted">
                                            {{ similar.gap.get_coverage_type_display }} •
                                            {{ similar.gap.get_status_display }}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Gap Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusForm">
                    <input type="hidden" id="newStatus" name="status">

                    <div class="mb-3" id="notesField">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>

                    <div class="mb-3" id="implementationFields" style="display: none;">
                        <label for="testFilePath" class="form-label">Test File Path</label>
                        <input type="text" class="form-control" id="testFilePath" name="test_file_path"
                               placeholder="/path/to/test/file.kt">

                        <label for="commitSha" class="form-label mt-2">Commit SHA (optional)</label>
                        <input type="text" class="form-control" id="commitSha" name="commit_sha"
                               placeholder="abc123...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitStatusUpdate()">Update Status</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentGapId = '{{ gap.id }}';
let generatedTestCode = null;

function generateTest() {
    const framework = document.getElementById('frameworkSelect').value;
    const button = event.target;
    const originalText = button.innerHTML;

    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

    fetch(`/streamlab/ai/coverage-gaps/${currentGapId}/generate-test/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCsrfToken()
        },
        body: `framework=${framework}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            generatedTestCode = data.test_code;
            document.getElementById('preview-code-content').textContent = data.test_code;
            document.getElementById('test-preview-area').style.display = 'block';

            // Trigger syntax highlighting
            Prism.highlightElement(document.getElementById('preview-code-content'));

            showToast('Test code generated successfully!', 'success');
        } else {
            showToast(data.error || 'Failed to generate test code', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred while generating test code', 'danger');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

function saveGeneratedTest() {
    if (!generatedTestCode) {
        showToast('No test code to save', 'warning');
        return;
    }

    // This would save the generated test and trigger a download
    const framework = document.getElementById('frameworkSelect').value;
    window.location.href = `/streamlab/ai/coverage-gaps/${currentGapId}/download-generated-test/?framework=${framework}`;

    showToast('Test code saved and downloaded!', 'success');
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent;

    navigator.clipboard.writeText(text).then(() => {
        showToast('Code copied to clipboard!', 'success');
    }).catch(() => {
        showToast('Failed to copy to clipboard', 'danger');
    });
}

function updateStatus(newStatus) {
    document.getElementById('newStatus').value = newStatus;

    // Show appropriate fields based on status
    const notesField = document.getElementById('notesField');
    const implementationFields = document.getElementById('implementationFields');

    notesField.style.display = 'block';
    implementationFields.style.display = 'none';

    if (newStatus === 'dismissed') {
        document.querySelector('#notesField label').textContent = 'Reason for dismissal';
    } else if (newStatus === 'test_implemented') {
        implementationFields.style.display = 'block';
        document.querySelector('#notesField label').textContent = 'Implementation notes (optional)';
    } else {
        document.querySelector('#notesField label').textContent = 'Notes (optional)';
    }

    const modal = new bootstrap.Modal(document.getElementById('statusModal'));
    modal.show();
}

function submitStatusUpdate() {
    const formData = new FormData(document.getElementById('statusForm'));

    fetch(`/streamlab/ai/coverage-gaps/${currentGapId}/update-status/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();

            // Show success message
            showToast(data.message, 'success');

            // Refresh the page to show updated status
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showToast(data.error || 'Failed to update status', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred while updating status', 'danger');
    });
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

// Initialize syntax highlighting on page load
document.addEventListener('DOMContentLoaded', function() {
    Prism.highlightAll();
});
</script>
{% endblock %}