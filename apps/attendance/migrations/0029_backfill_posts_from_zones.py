# Generated by Claude Code on 2025-11-03
# Phase 2: Data Migration - Backfill Posts from OnboardingZone

from django.db import migrations
from django.contrib.gis.geos import Point


def backfill_posts_from_zones(apps, schema_editor):
    """
    Backfill Post records from OnboardingZone records.

    Creates one Post per (Zone, Shift, Site) combination where coverage is required.

    Logic:
    1. Find all OnboardingZone records with coverage_required=True
    2. For each zone, find all shifts for the zone's site
    3. Create Post for each (Zone, Shift) pair
    4. Copy zone attributes to post
    5. Generate post_code as "POST-{site_code}-{zone_type}-{shift_code}-{counter}"
    """
    OnboardingZone = apps.get_model('onboarding', 'OnboardingZone')
    Shift = apps.get_model('onboarding', 'Shift')
    Post = apps.get_model('attendance', 'Post')
    Geofence = apps.get_model('attendance', 'Geofence')

    posts_created = 0
    errors = []

    try:
        # Get all zones requiring coverage
        zones = OnboardingZone.objects.filter(
            coverage_required=True
        ).select_related('site')

        print(f"Found {zones.count()} zones requiring coverage")

        for zone in zones:
            try:
                # Get all active shifts for this zone's site
                shifts = Shift.objects.filter(
                    bu=zone.site,
                    enable=True
                )

                if not shifts.exists():
                    print(f"Warning: No shifts found for site {zone.site.buname}, skipping zone {zone.zone_name}")
                    continue

                # Create post for each (zone, shift) combination
                for shift_counter, shift in enumerate(shifts, 1):
                    # Generate post_code
                    site_code = zone.site.bucode[:8] if zone.site.bucode else f"SITE{zone.site.id}"
                    zone_type_short = zone.zone_type[:4].upper() if zone.zone_type else "POST"
                    shift_code = shift.shiftname[:4].upper().replace(' ', '') if shift.shiftname else f"SH{shift.id}"
                    post_code = f"{site_code}-{zone_type_short}-{shift_code}"

                    # Check if post already exists
                    existing_post = Post.objects.filter(
                        site=zone.site,
                        post_code=post_code,
                        tenant=zone.site.tenant
                    ).first()

                    if existing_post:
                        print(f"Post {post_code} already exists, skipping")
                        continue

                    # Create post_name
                    post_name = f"{zone.zone_name} - {shift.shiftname}"

                    # Map zone_type to post_type
                    zone_to_post_type_mapping = {
                        'GATE': 'GATE',
                        'PERIMETER': 'PERIMETER',
                        'ENTRY_EXIT': 'ENTRY_EXIT',
                        'VAULT': 'VAULT',
                        'ATM': 'ATM',
                        'CONTROL_ROOM': 'CONTROL_ROOM',
                        'PARKING': 'PARKING',
                        'LOADING_DOCK': 'LOADING_DOCK',
                        'EMERGENCY_EXIT': 'EMERGENCY_EXIT',
                        'ASSET_STORAGE': 'ASSET_STORAGE',
                        'CASH_COUNTER': 'CASH_COUNTER',
                        'SERVER_ROOM': 'SERVER_ROOM',
                        'RECEPTION': 'RECEPTION',
                        'LOBBY': 'LOBBY',
                        'ROOFTOP': 'ROOFTOP',
                    }
                    post_type = zone_to_post_type_mapping.get(zone.zone_type, 'OTHER')

                    # Map importance_level to risk_level
                    importance_to_risk_mapping = {
                        'critical': 'CRITICAL',
                        'high': 'HIGH',
                        'medium': 'MEDIUM',
                        'low': 'LOW',
                    }
                    risk_level = importance_to_risk_mapping.get(zone.importance_level, 'MEDIUM')

                    # Try to find matching geofence
                    matching_geofence = None
                    if zone.gps_coordinates:
                        # Look for geofence near this zone
                        matching_geofence = Geofence.objects.filter(
                            bu=zone.site,
                            is_active=True
                        ).first()

                    # Create post
                    post = Post.objects.create(
                        # Core identification
                        post_code=post_code,
                        post_name=post_name,
                        post_type=post_type,

                        # Relationships
                        site=zone.site,
                        zone=zone,
                        shift=shift,
                        geofence=matching_geofence,

                        # Location
                        gps_coordinates=zone.gps_coordinates,
                        geofence_radius=50,  # Default 50m

                        # Staffing (defaults)
                        required_guard_count=1,
                        armed_required=False,

                        # Post orders (to be filled by supervisors)
                        post_orders=f"Post Orders for {zone.zone_name}\n\nTo be completed by site supervisor.",
                        post_orders_version=1,
                        duties_summary=f"Duties at {zone.zone_name}",
                        emergency_procedures="Follow site emergency procedures.",
                        reporting_instructions="Report incidents to supervisor immediately.",

                        # Risk
                        risk_level=risk_level,
                        high_value_assets=zone.zone_type in ['VAULT', 'ATM', 'CASH_COUNTER', 'SERVER_ROOM'],
                        public_access=zone.zone_type in ['RECEPTION', 'LOBBY', 'ENTRY_EXIT'],

                        # Status
                        active=True,
                        coverage_required=zone.coverage_required,
                        temporary=False,

                        # Metadata
                        post_metadata={
                            'migrated_from_zone_id': str(zone.zone_id) if hasattr(zone, 'zone_id') else None,
                            'original_zone_type': zone.zone_type,
                            'migration_date': '2025-11-03',
                            'migration_source': 'onboarding_zone',
                        },

                        # Tenant
                        tenant=zone.site.tenant,
                        client=zone.site,
                    )

                    posts_created += 1
                    print(f"Created post: {post_code} - {post_name}")

            except Exception as e:
                error_msg = f"Error processing zone {zone.zone_name}: {str(e)}"
                print(error_msg)
                errors.append(error_msg)
                continue

        print(f"\nBackfill complete: {posts_created} posts created")
        if errors:
            print(f"\nErrors encountered: {len(errors)}")
            for error in errors[:10]:  # Show first 10 errors
                print(f"  - {error}")

    except Exception as e:
        print(f"Critical error during backfill: {str(e)}")
        raise


def reverse_backfill(apps, schema_editor):
    """
    Reverse migration - delete posts created from zones

    Only deletes posts with migration_source='onboarding_zone' in metadata
    to avoid deleting manually created posts.
    """
    Post = apps.get_model('attendance', 'Post')

    deleted_count = Post.objects.filter(
        post_metadata__migration_source='onboarding_zone'
    ).delete()[0]

    print(f"Deleted {deleted_count} backfilled posts")


class Migration(migrations.Migration):

    dependencies = [
        ('attendance', '0028_add_post_models'),
        ('onboarding', '0001_initial'),  # Adjust to actual latest
    ]

    operations = [
        migrations.RunPython(
            backfill_posts_from_zones,
            reverse_code=reverse_backfill,
        ),
    ]
