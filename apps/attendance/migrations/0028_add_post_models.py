# Generated by Claude Code on 2025-11-03
# Phase 2: Post Assignment Models

from django.conf import settings
import django.contrib.gis.db.models.fields
from django.db import migrations, models
import django.db.models.deletion
import django.utils.timezone
import django_fsm


class Migration(migrations.Migration):
    """
    Phase 2: Add Post Assignment Models

    Creates three new models:
    1. Post - Explicit duty stations within sites
    2. PostAssignment - Explicit worker-to-post roster
    3. PostOrderAcknowledgement - Digital post orders compliance

    Also extends PeopleEventlog with post tracking fields.
    """

    dependencies = [
        ('attendance', '0027_add_shift_validation_indexes'),
        ('onboarding', '0001_initial'),  # Adjust to actual latest onboarding migration
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        # ==================== CREATE POST MODEL ====================
        migrations.CreateModel(
            name='Post',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('tenant', models.CharField(db_index=True, default='default', max_length=100)),
                ('cdtz', models.DateTimeField(auto_now_add=True)),
                ('client', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='onboarding.bt')),

                # Core identification
                ('post_code', models.CharField(db_index=True, help_text='Unique post code (e.g., POST-001, GATE-A)', max_length=20)),
                ('post_name', models.CharField(help_text='Descriptive post name (e.g., Main Gate - Morning Shift)', max_length=100)),
                ('post_type', models.CharField(
                    choices=[
                        ('GATE', 'Gate'),
                        ('PERIMETER', 'Perimeter'),
                        ('ENTRY_EXIT', 'Entry/Exit Point'),
                        ('VAULT', 'Vault'),
                        ('ATM', 'ATM'),
                        ('CONTROL_ROOM', 'Control Room'),
                        ('PARKING', 'Parking Area'),
                        ('LOADING_DOCK', 'Loading Dock'),
                        ('EMERGENCY_EXIT', 'Emergency Exit'),
                        ('ASSET_STORAGE', 'Asset Storage'),
                        ('CASH_COUNTER', 'Cash Counter'),
                        ('SERVER_ROOM', 'Server Room'),
                        ('RECEPTION', 'Reception'),
                        ('LOBBY', 'Lobby'),
                        ('ROOFTOP', 'Rooftop'),
                        ('OTHER', 'Other'),
                    ],
                    db_index=True,
                    default='OTHER',
                    help_text='Type of duty station',
                    max_length=20
                )),

                # Relationships
                ('site', models.ForeignKey(
                    help_text='Site where this post is located',
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='posts',
                    to='onboarding.bt'
                )),
                ('zone', models.ForeignKey(
                    blank=True,
                    help_text='Optional link to site zone definition',
                    null=True,
                    on_delete=django.db.models.deletion.SET_NULL,
                    related_name='posts',
                    to='onboarding.onboardingzone'
                )),
                ('shift', models.ForeignKey(
                    help_text='Shift that operates this post',
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='posts',
                    to='onboarding.shift'
                )),
                ('geofence', models.ForeignKey(
                    blank=True,
                    help_text='Geographic boundary for GPS validation at this post',
                    null=True,
                    on_delete=django.db.models.deletion.SET_NULL,
                    related_name='posts',
                    to='attendance.geofence'
                )),

                # Staffing requirements
                ('required_guard_count', models.IntegerField(
                    default=1,
                    help_text='Number of guards required at this post simultaneously',
                    validators=[django.core.validators.MinValueValidator(0), django.core.validators.MaxValueValidator(10)]
                )),
                ('armed_required', models.BooleanField(default=False, help_text='Whether guards at this post must be armed')),

                # Location
                ('gps_coordinates', django.contrib.gis.db.models.fields.PointField(
                    blank=True,
                    geography=True,
                    help_text='GPS coordinates of post location (center point)',
                    null=True,
                    srid=4326
                )),
                ('geofence_radius', models.IntegerField(
                    default=50,
                    help_text='Radius in meters for circular geofence (if no explicit geofence)',
                    validators=[django.core.validators.MinValueValidator(10), django.core.validators.MaxValueValidator(500)]
                )),
                ('floor_level', models.CharField(blank=True, help_text='Floor level (e.g., Ground Floor, Level 2)', max_length=20)),
                ('building_section', models.CharField(blank=True, help_text='Building section (e.g., Tower A, North Wing)', max_length=50)),

                # Post orders
                ('post_orders', models.TextField(blank=True, help_text='Digital post orders - detailed instructions for guards')),
                ('post_orders_version', models.IntegerField(default=1, help_text='Version number for post orders tracking')),
                ('post_orders_last_updated', models.DateTimeField(auto_now=True, help_text='When post orders were last modified')),
                ('duties_summary', models.TextField(blank=True, help_text='Brief summary of duties (bullet points)')),
                ('emergency_procedures', models.TextField(blank=True, help_text='Emergency procedures for this post')),
                ('reporting_instructions', models.TextField(blank=True, help_text='How and when to report from this post')),

                # Risk & security
                ('risk_level', models.CharField(
                    choices=[
                        ('CRITICAL', 'Critical'),
                        ('HIGH', 'High'),
                        ('MEDIUM', 'Medium'),
                        ('LOW', 'Low'),
                        ('MINIMAL', 'Minimal'),
                    ],
                    db_index=True,
                    default='MEDIUM',
                    help_text='Security risk level for this post',
                    max_length=20
                )),
                ('high_value_assets', models.BooleanField(default=False, help_text='Whether this post protects high-value assets')),
                ('public_access', models.BooleanField(default=False, help_text='Whether this post has public access')),

                # Operational status
                ('active', models.BooleanField(db_index=True, default=True, help_text='Whether this post is currently active')),
                ('coverage_required', models.BooleanField(default=True, help_text='Whether this post must be covered at all times')),
                ('temporary', models.BooleanField(default=False, help_text='Whether this is a temporary post (event-based)')),
                ('temporary_start_date', models.DateField(blank=True, help_text='Start date for temporary posts', null=True)),
                ('temporary_end_date', models.DateField(blank=True, help_text='End date for temporary posts', null=True)),

                # Metadata
                ('post_metadata', models.JSONField(blank=True, default=dict, help_text='Extensible metadata')),
                ('notes', models.TextField(blank=True, help_text='Additional notes about this post')),

                # Audit
                ('created_by', models.ForeignKey(
                    blank=True,
                    help_text='User who created this post',
                    null=True,
                    on_delete=django.db.models.deletion.SET_NULL,
                    related_name='posts_created',
                    to=settings.AUTH_USER_MODEL
                )),
                ('modified_by', models.ForeignKey(
                    blank=True,
                    help_text='User who last modified this post',
                    null=True,
                    on_delete=django.db.models.deletion.SET_NULL,
                    related_name='posts_modified',
                    to=settings.AUTH_USER_MODEL
                )),
            ],
            options={
                'verbose_name': 'Post',
                'verbose_name_plural': 'Posts',
                'db_table': 'attendance_post',
                'ordering': ['site', 'shift', 'post_code'],
            },
        ),

        # ==================== CREATE POST ASSIGNMENT MODEL ====================
        migrations.CreateModel(
            name='PostAssignment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('tenant', models.CharField(db_index=True, default='default', max_length=100)),
                ('cdtz', models.DateTimeField(auto_now_add=True)),
                ('client', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='onboarding.bt')),

                # Core assignment
                ('worker', models.ForeignKey(
                    help_text='Worker assigned to this post',
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='post_assignments',
                    to=settings.AUTH_USER_MODEL
                )),
                ('post', models.ForeignKey(
                    help_text='Duty station where worker will be posted',
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='assignments',
                    to='attendance.post'
                )),
                ('shift', models.ForeignKey(
                    help_text='Shift for this assignment',
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='post_assignments',
                    to='onboarding.shift'
                )),
                ('site', models.ForeignKey(
                    help_text='Site (denormalized from post for query performance)',
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='post_assignments',
                    to='onboarding.bt'
                )),

                # Schedule
                ('assignment_date', models.DateField(db_index=True, help_text='Date of assignment')),
                ('start_time', models.TimeField(help_text='Shift start time')),
                ('end_time', models.TimeField(help_text='Shift end time')),

                # Status tracking
                ('status', models.CharField(
                    choices=[
                        ('SCHEDULED', 'Scheduled'),
                        ('CONFIRMED', 'Worker Confirmed'),
                        ('IN_PROGRESS', 'On Duty'),
                        ('COMPLETED', 'Shift Completed'),
                        ('NO_SHOW', 'No Show'),
                        ('CANCELLED', 'Cancelled'),
                        ('REPLACED', 'Replaced by Another Worker'),
                    ],
                    db_index=True,
                    default='SCHEDULED',
                    help_text='Current status of assignment',
                    max_length=20
                )),
                ('status_updated_at', models.DateTimeField(auto_now=True, help_text='When status was last updated')),

                # Confirmation & check-in
                ('confirmed_at', models.DateTimeField(blank=True, help_text='When worker confirmed they will attend', null=True)),
                ('checked_in_at', models.DateTimeField(blank=True, help_text='When worker checked in at post', null=True)),
                ('checked_out_at', models.DateTimeField(blank=True, help_text='When worker checked out from post', null=True)),

                # Approval workflow
                ('assigned_by', models.ForeignKey(
                    blank=True,
                    help_text='Supervisor who created this assignment',
                    null=True,
                    on_delete=django.db.models.deletion.SET_NULL,
                    related_name='assignments_created',
                    to=settings.AUTH_USER_MODEL
                )),
                ('approval_required', models.BooleanField(default=False, help_text='Whether this assignment requires manager approval')),
                ('approved_by', models.ForeignKey(
                    blank=True,
                    help_text='Manager who approved this assignment',
                    null=True,
                    on_delete=django.db.models.deletion.SET_NULL,
                    related_name='assignments_approved',
                    to=settings.AUTH_USER_MODEL
                )),
                ('approved_at', models.DateTimeField(blank=True, help_text='When assignment was approved', null=True)),
                ('approval_notes', models.TextField(blank=True, help_text='Notes from approver')),

                # Override tracking
                ('is_override', models.BooleanField(db_index=True, default=False, help_text='Whether this is an override assignment')),
                ('override_reason', models.TextField(blank=True, help_text='Reason for override')),
                ('override_type', models.CharField(
                    blank=True,
                    choices=[
                        ('EMERGENCY', 'Emergency'),
                        ('REPLACEMENT', 'Worker Replacement'),
                        ('VALIDATION_BYPASS', 'Validation Check-in Bypass'),
                        ('SCHEDULE_CHANGE', 'Last-Minute Schedule Change'),
                        ('COVERAGE_GAP', 'Coverage Gap Fill'),
                        ('OTHER', 'Other'),
                    ],
                    help_text='Type of override',
                    max_length=50
                )),
                ('replaced_assignment', models.ForeignKey(
                    blank=True,
                    help_text='If this replaces another assignment, link to original',
                    null=True,
                    on_delete=django.db.models.deletion.SET_NULL,
                    related_name='replacement_assignments',
                    to='attendance.postassignment'
                )),

                # Attendance link
                ('attendance_record', models.ForeignKey(
                    blank=True,
                    help_text='Link to actual attendance check-in/out record',
                    null=True,
                    on_delete=django.db.models.deletion.SET_NULL,
                    related_name='post_assignment',
                    to='attendance.peopleeventlog'
                )),

                # Post orders acknowledgement
                ('post_orders_acknowledged', models.BooleanField(default=False, help_text='Whether worker has acknowledged post orders')),
                ('post_orders_version_acknowledged', models.IntegerField(blank=True, help_text='Version of post orders acknowledged', null=True)),
                ('post_orders_acknowledged_at', models.DateTimeField(blank=True, help_text='When post orders were acknowledged', null=True)),

                # Performance & compliance
                ('on_time_checkin', models.BooleanField(default=False, help_text='Whether worker checked in on time')),
                ('late_minutes', models.IntegerField(blank=True, help_text='Minutes late for check-in', null=True)),
                ('hours_worked', models.DecimalField(blank=True, decimal_places=2, help_text='Actual hours worked', max_digits=5, null=True)),

                # Metadata
                ('assignment_metadata', models.JSONField(blank=True, default=dict, help_text='Extensible metadata')),
                ('notes', models.TextField(blank=True, help_text='Additional notes')),

                # Notification tracking
                ('worker_notified', models.BooleanField(default=False, help_text='Whether worker was notified')),
                ('worker_notified_at', models.DateTimeField(blank=True, help_text='When worker was notified', null=True)),
                ('reminder_sent', models.BooleanField(default=False, help_text='Whether reminder was sent')),
                ('reminder_sent_at', models.DateTimeField(blank=True, help_text='When reminder was sent', null=True)),
            ],
            options={
                'verbose_name': 'Post Assignment',
                'verbose_name_plural': 'Post Assignments',
                'db_table': 'attendance_post_assignment',
                'ordering': ['assignment_date', 'start_time', 'site', 'post'],
            },
        ),

        # ==================== CREATE POST ORDER ACKNOWLEDGEMENT MODEL ====================
        migrations.CreateModel(
            name='PostOrderAcknowledgement',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('tenant', models.CharField(db_index=True, default='default', max_length=100)),
                ('cdtz', models.DateTimeField(auto_now_add=True)),
                ('client', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='onboarding.bt')),

                # Core acknowledgement
                ('worker', models.ForeignKey(
                    help_text='Worker who acknowledged post orders',
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='post_order_acknowledgements',
                    to=settings.AUTH_USER_MODEL
                )),
                ('post', models.ForeignKey(
                    help_text='Post whose orders were acknowledged',
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='acknowledgements',
                    to='attendance.post'
                )),
                ('post_assignment', models.ForeignKey(
                    blank=True,
                    help_text='Assignment this acknowledgement is for (optional)',
                    null=True,
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='post_order_acknowledgements',
                    to='attendance.postassignment'
                )),

                # Post orders version
                ('post_orders_version', models.IntegerField(help_text='Version of post orders that was acknowledged')),
                ('post_orders_content_hash', models.CharField(blank=True, help_text='SHA-256 hash for integrity verification', max_length=64)),

                # Acknowledgement details
                ('acknowledged_at', models.DateTimeField(db_index=True, default=django.utils.timezone.now, help_text='When post orders were acknowledged')),
                ('acknowledgement_date', models.DateField(auto_now_add=True, db_index=True, help_text='Date of acknowledgement')),

                # Device & location tracking
                ('device_id', models.CharField(blank=True, help_text='Device ID where acknowledgement occurred', max_length=100)),
                ('ip_address', models.GenericIPAddressField(blank=True, help_text='IP address', null=True)),
                ('user_agent', models.CharField(blank=True, help_text='Browser/app user agent', max_length=255)),
                ('gps_location', models.JSONField(blank=True, help_text='GPS location where acknowledgement occurred', null=True)),

                # Acknowledgement method
                ('acknowledgement_method', models.CharField(
                    choices=[
                        ('mobile_app', 'Mobile App'),
                        ('web_portal', 'Web Portal'),
                        ('paper_signed', 'Paper Form (Digitized)'),
                        ('verbal_confirmed', 'Verbal Confirmation (Documented)'),
                        ('auto_assigned', 'Auto-assigned (System)'),
                    ],
                    default='mobile_app',
                    help_text='How acknowledgement was obtained',
                    max_length=50
                )),

                # Read time tracking
                ('time_to_acknowledge_seconds', models.IntegerField(blank=True, help_text='Seconds spent reading before acknowledging', null=True)),
                ('minimum_read_time_met', models.BooleanField(default=True, help_text='Whether minimum required reading time was met')),

                # Quiz/comprehension
                ('quiz_taken', models.BooleanField(default=False, help_text='Whether comprehension quiz was taken')),
                ('quiz_score', models.IntegerField(blank=True, help_text='Quiz score (0-100)', null=True)),
                ('quiz_passed', models.BooleanField(default=False, help_text='Whether quiz was passed')),
                ('quiz_results', models.JSONField(blank=True, help_text='Detailed quiz results', null=True)),

                # Signature
                ('digital_signature', models.TextField(blank=True, help_text='Digital signature data')),
                ('signature_verified', models.BooleanField(default=False, help_text='Whether signature was verified')),

                # Acknowledgement text
                ('acknowledgement_statement', models.TextField(
                    default='I have read and understood the post orders for this duty station.',
                    help_text='Statement that worker acknowledged'
                )),
                ('worker_comments', models.TextField(blank=True, help_text='Optional comments from worker')),

                # Validity & expiration
                ('valid_from', models.DateTimeField(default=django.utils.timezone.now, help_text='When this acknowledgement becomes valid')),
                ('valid_until', models.DateTimeField(blank=True, help_text='When this acknowledgement expires', null=True)),
                ('is_valid', models.BooleanField(db_index=True, default=True, help_text='Whether this acknowledgement is currently valid')),

                # Supervisor verification
                ('supervisor_verified', models.BooleanField(default=False, help_text='Whether supervisor verified this acknowledgement')),
                ('verified_by', models.ForeignKey(
                    blank=True,
                    help_text='Supervisor who verified acknowledgement',
                    null=True,
                    on_delete=django.db.models.deletion.SET_NULL,
                    related_name='verified_acknowledgements',
                    to=settings.AUTH_USER_MODEL
                )),
                ('verified_at', models.DateTimeField(blank=True, help_text='When acknowledgement was verified', null=True)),

                # Metadata
                ('acknowledgement_metadata', models.JSONField(blank=True, default=dict, help_text='Extensible metadata')),
            ],
            options={
                'verbose_name': 'Post Order Acknowledgement',
                'verbose_name_plural': 'Post Order Acknowledgements',
                'db_table': 'attendance_post_order_acknowledgement',
                'ordering': ['-acknowledged_at'],
            },
        ),

        # ==================== ADD MANY-TO-MANY FOR CERTIFICATIONS ====================
        migrations.AddField(
            model_name='post',
            name='required_certifications',
            field=models.ManyToManyField(
                blank=True,
                help_text='Certifications required to work this post',
                limit_choices_to={'tatype__tacode': 'CERTIFICATION'},
                related_name='required_for_posts',
                to='onboarding.typeassist'
            ),
        ),

        # ==================== ADD UNIQUE CONSTRAINTS ====================
        migrations.AddConstraint(
            model_name='post',
            constraint=models.UniqueConstraint(
                fields=['site', 'post_code', 'tenant'],
                name='unique_post_code_per_site'
            ),
        ),
        migrations.AddConstraint(
            model_name='post',
            constraint=models.UniqueConstraint(
                fields=['site', 'shift', 'post_name', 'tenant'],
                name='unique_post_name_per_site_shift'
            ),
        ),
        migrations.AddConstraint(
            model_name='postassignment',
            constraint=models.UniqueConstraint(
                fields=['worker', 'post', 'assignment_date', 'shift', 'tenant'],
                name='unique_worker_post_date_shift'
            ),
        ),
        migrations.AddConstraint(
            model_name='postorderacknowledgement',
            constraint=models.UniqueConstraint(
                fields=['worker', 'post', 'post_orders_version', 'acknowledgement_date', 'tenant'],
                name='unique_worker_post_version_date'
            ),
        ),

        # ==================== ADD INDEXES ====================
        migrations.AddIndex(
            model_name='post',
            index=models.Index(fields=['tenant', 'site', 'shift', 'active'], name='post_active_lookup_idx'),
        ),
        migrations.AddIndex(
            model_name='post',
            index=models.Index(fields=['tenant', 'site', 'post_type'], name='post_type_idx'),
        ),
        migrations.AddIndex(
            model_name='post',
            index=models.Index(fields=['tenant', 'active', 'coverage_required'], name='post_coverage_idx'),
        ),
        migrations.AddIndex(
            model_name='post',
            index=models.Index(fields=['tenant', 'risk_level'], name='post_risk_idx'),
        ),
        migrations.AddIndex(
            model_name='postassignment',
            index=models.Index(fields=['tenant', 'assignment_date', 'site', 'status'], name='pa_daily_site_status_idx'),
        ),
        migrations.AddIndex(
            model_name='postassignment',
            index=models.Index(fields=['tenant', 'worker', 'assignment_date'], name='pa_worker_date_idx'),
        ),
        migrations.AddIndex(
            model_name='postassignment',
            index=models.Index(fields=['tenant', 'post', 'assignment_date'], name='pa_post_date_idx'),
        ),
        migrations.AddIndex(
            model_name='postassignment',
            index=models.Index(fields=['tenant', 'status', 'assignment_date'], name='pa_status_date_idx'),
        ),
        migrations.AddIndex(
            model_name='postassignment',
            index=models.Index(fields=['tenant', 'is_override', 'assignment_date'], name='pa_override_idx'),
        ),
        migrations.AddIndex(
            model_name='postorderacknowledgement',
            index=models.Index(fields=['tenant', 'worker', 'acknowledged_at'], name='poa_worker_time_idx'),
        ),
        migrations.AddIndex(
            model_name='postorderacknowledgement',
            index=models.Index(fields=['tenant', 'post', 'post_orders_version'], name='poa_post_version_idx'),
        ),
        migrations.AddIndex(
            model_name='postorderacknowledgement',
            index=models.Index(fields=['tenant', 'acknowledgement_date', 'is_valid'], name='poa_date_valid_idx'),
        ),
        migrations.AddIndex(
            model_name='postorderacknowledgement',
            index=models.Index(fields=['tenant', 'is_valid', 'valid_until'], name='poa_validity_idx'),
        ),

        # ==================== ADD POST FIELDS TO PEOPLEEVENTLOG ====================
        migrations.AddField(
            model_name='peopleeventlog',
            name='post',
            field=models.ForeignKey(
                blank=True,
                help_text='Specific duty station worker checked into (Phase 2)',
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name='attendance_records',
                to='attendance.post'
            ),
        ),
        migrations.AddField(
            model_name='peopleeventlog',
            name='post_assignment',
            field=models.ForeignKey(
                blank=True,
                help_text='Reference to scheduled post assignment (Phase 2)',
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name='attendance_records',
                to='attendance.postassignment'
            ),
        ),
    ]
