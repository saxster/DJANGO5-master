"""
Guard coverage and shift assignment plan.

Generated from zone requirements and risk windows - no cost calculations.
"""

import uuid
from django.conf import settings
from django.db import models
from django.utils.translation import gettext_lazy as _

from apps.core.models import BaseModel
from apps.tenants.models import TenantAwareModel


class CoveragePlan(BaseModel, TenantAwareModel):
    """
    Guard coverage and shift assignment plan.

    Generated from zone requirements and risk windows - no cost calculations.
    """

    plan_id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    site = models.OneToOneField(
        "site_onboarding.OnboardingSite",
        on_delete=models.CASCADE,
        related_name="coverage_plan",
        verbose_name=_("Site")
    )
    guard_posts = models.JSONField(
        _("Guard Posts"),
        default=list,
        help_text="Posts: [{post_id, zone, position, duties, risk_level}]"
    )
    shift_assignments = models.JSONField(
        _("Shift Assignments"),
        default=list,
        help_text="Shifts: [{shift_name, start_time, end_time, posts_covered, staffing}]"
    )
    patrol_routes = models.JSONField(
        _("Patrol Routes"),
        default=list,
        blank=True,
        help_text="Routes: [{route_id, zones, frequency, checkpoints}]"
    )
    risk_windows = models.JSONField(
        _("Risk Windows"),
        default=list,
        blank=True,
        help_text="High-risk time periods: [{start, end, zones, mitigation}]"
    )
    compliance_notes = models.TextField(
        _("Compliance Notes"),
        blank=True,
        help_text="Regulatory compliance considerations"
    )
    generated_by = models.CharField(
        _("Generated By"),
        max_length=50,
        default="ai",
        help_text="ai/manual/hybrid"
    )
    approved_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name="approved_coverage_plans",
        verbose_name=_("Approved By")
    )
    approved_at = models.DateTimeField(
        _("Approved At"),
        null=True,
        blank=True
    )

    class Meta(BaseModel.Meta):
        db_table = "site_onboarding_coverage_plan"
        verbose_name = "Coverage Plan"
        verbose_name_plural = "Coverage Plans"
        indexes = [
            models.Index(fields=['site', 'approved_at'], name='coverage_site_approved_idx'),
        ]

    def __str__(self):
        return f"Coverage Plan for {self.site.business_unit.buname}"
