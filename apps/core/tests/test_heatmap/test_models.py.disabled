"""
Unit tests for heatmap tracking models
"""
import pytest
from django.utils import timezone
from django.core.exceptions import ValidationError
from django.db import IntegrityError
from datetime import timedelta
import uuid

from apps.core.models.heatmap import (
    HeatmapSession, ClickHeatmap, ScrollHeatmap,
    AttentionHeatmap, ElementInteraction, HeatmapAggregation
)
from tests.factories.heatmap_factories import (
    HeatmapSessionFactory, ClickHeatmapFactory, ScrollHeatmapFactory,
    AttentionHeatmapFactory, ElementInteractionFactory, HeatmapAggregationFactory,
    UserFactory, create_complete_session_with_data
)

pytestmark = pytest.mark.django_db


class TestHeatmapSession:
    """Test HeatmapSession model"""
    
    def test_session_creation(self):
        """Test creating a heatmap session with valid data"""
        session = HeatmapSessionFactory()
        assert session.session_id
        assert session.page_url
        assert session.device_type in ['desktop', 'tablet', 'mobile']
        assert session.viewport_width > 0
        assert session.viewport_height > 0
    
    def test_session_duration_calculation(self):
        """Test that session duration is calculated correctly"""
        session = HeatmapSessionFactory(is_active=True)
        assert session.duration_seconds is None
        
        # End the session
        session.end_session()
        assert session.is_active is False
        assert session.end_time is not None
        assert session.duration_seconds > 0
    
    def test_end_session_method(self):
        """Test the end_session method"""
        session = HeatmapSessionFactory(is_active=True)
        initial_time = session.start_time
        
        # Wait a moment and end session
        session.end_session()
        
        assert session.is_active is False
        assert session.end_time > initial_time
        assert session.duration_seconds == (session.end_time - session.start_time).total_seconds()
    
    def test_unique_session_id_constraint(self):
        """Test that session_id must be unique"""
        session1 = HeatmapSessionFactory()
        
        # Try to create another session with same ID
        with pytest.raises(IntegrityError):
            HeatmapSession.objects.create(
                session_id=session1.session_id,
                page_url='/test/',
                viewport_width=1920,
                viewport_height=1080,
                screen_width=1920,
                screen_height=1080,
                device_type='desktop'
            )
    
    def test_device_type_detection(self):
        """Test device type validation"""
        valid_types = ['desktop', 'tablet', 'mobile']
        for device_type in valid_types:
            session = HeatmapSessionFactory(device_type=device_type)
            assert session.device_type == device_type
    
    def test_session_with_user(self):
        """Test session creation with authenticated user"""
        user = UserFactory()
        session = HeatmapSessionFactory(user=user)
        assert session.user == user
    
    def test_session_without_user(self):
        """Test session creation for anonymous user"""
        session = HeatmapSessionFactory(user=None)
        assert session.user is None
    
    def test_data_points_tracking(self):
        """Test tracking of data points collected"""
        session = HeatmapSessionFactory()
        assert session.data_points_collected == 0
        
        # Add some data points
        ClickHeatmapFactory(session=session)
        session.data_points_collected = 1
        session.save()
        
        assert session.data_points_collected == 1


class TestClickHeatmap:
    """Test ClickHeatmap model"""
    
    def test_click_creation(self):
        """Test creating click heatmap data"""
        click = ClickHeatmapFactory()
        assert click.session
        assert 0 <= click.x_position <= 1
        assert 0 <= click.y_position <= 1
        assert click.element_type
        assert click.timestamp
    
    def test_position_normalization(self):
        """Test that positions are normalized to 0-1 range"""
        click = ClickHeatmapFactory(
            x_position=0.5,
            y_position=0.75
        )
        assert click.x_position == 0.5
        assert click.y_position == 0.75
    
    def test_navigation_click_identification(self):
        """Test identification of navigation clicks"""
        nav_click = ClickHeatmapFactory(is_navigation=True)
        regular_click = ClickHeatmapFactory(is_navigation=False)
        
        assert nav_click.is_navigation is True
        assert regular_click.is_navigation is False
    
    def test_click_types(self):
        """Test different click types"""
        for click_type in ['left', 'right', 'middle']:
            click = ClickHeatmapFactory(click_type=click_type)
            assert click.click_type == click_type
    
    def test_element_tracking(self):
        """Test element information tracking"""
        click = ClickHeatmapFactory(
            element_type='button',
            element_id='submit-btn',
            element_class='btn-primary',
            element_text='Submit Form'
        )
        assert click.element_type == 'button'
        assert click.element_id == 'submit-btn'
        assert click.element_class == 'btn-primary'
        assert click.element_text == 'Submit Form'
    
    def test_foreign_key_cascade(self):
        """Test that clicks are deleted when session is deleted"""
        session = HeatmapSessionFactory()
        click = ClickHeatmapFactory(session=session)
        
        assert ClickHeatmap.objects.filter(pk=click.pk).exists()
        
        session.delete()
        assert not ClickHeatmap.objects.filter(pk=click.pk).exists()


class TestScrollHeatmap:
    """Test ScrollHeatmap model"""
    
    def test_scroll_creation(self):
        """Test creating scroll heatmap data"""
        scroll = ScrollHeatmapFactory()
        assert scroll.session
        assert 0 <= scroll.scroll_depth_percentage <= 100
        assert scroll.scroll_depth_pixels >= 0
    
    def test_scroll_depth_validation(self):
        """Test scroll depth percentage is within valid range"""
        scroll = ScrollHeatmapFactory(scroll_depth_percentage=50.5)
        assert scroll.scroll_depth_percentage == 50.5
        
        # Test boundary values
        scroll_min = ScrollHeatmapFactory(scroll_depth_percentage=0)
        scroll_max = ScrollHeatmapFactory(scroll_depth_percentage=100)
        
        assert scroll_min.scroll_depth_percentage == 0
        assert scroll_max.scroll_depth_percentage == 100
    
    def test_max_scroll_depth_tracking(self):
        """Test tracking of maximum scroll depth"""
        session = HeatmapSessionFactory()
        
        # Create multiple scroll events
        ScrollHeatmapFactory(session=session, scroll_depth_percentage=25)
        ScrollHeatmapFactory(session=session, scroll_depth_percentage=50)
        ScrollHeatmapFactory(session=session, scroll_depth_percentage=75)
        ScrollHeatmapFactory(session=session, max_scroll_depth=75)
        
        # Check max depth
        max_scroll = ScrollHeatmap.objects.filter(
            session=session
        ).order_by('-max_scroll_depth').first()
        
        assert max_scroll.max_scroll_depth == 75
    
    def test_scroll_velocity_calculation(self):
        """Test scroll velocity tracking"""
        scroll = ScrollHeatmapFactory(scroll_velocity=250.5)
        assert scroll.scroll_velocity == 250.5
    
    def test_time_at_position(self):
        """Test time spent at scroll position"""
        scroll = ScrollHeatmapFactory(time_at_position=5.5)
        assert scroll.time_at_position == 5.5


class TestAttentionHeatmap:
    """Test AttentionHeatmap model"""
    
    def test_attention_zone_creation(self):
        """Test creating attention zone data"""
        attention = AttentionHeatmapFactory()
        assert attention.session
        assert 0 <= attention.x_start <= 1
        assert 0 <= attention.y_start <= 1
        assert attention.x_start <= attention.x_end
        assert attention.y_start <= attention.y_end
    
    def test_attention_score_calculation(self):
        """Test attention score is normalized to 0-1"""
        attention = AttentionHeatmapFactory(attention_score=0.75)
        assert 0 <= attention.attention_score <= 1
    
    def test_zone_boundary_validation(self):
        """Test that zone boundaries are valid"""
        attention = AttentionHeatmapFactory(
            x_start=0.2,
            y_start=0.3,
            x_end=0.5,
            y_end=0.6
        )
        
        assert attention.x_end > attention.x_start
        assert attention.y_end > attention.y_start
        assert attention.x_end <= 1
        assert attention.y_end <= 1
    
    def test_content_type_classification(self):
        """Test content type classification"""
        content_types = ['text', 'image', 'video', 'form', 'navigation']
        
        for content_type in content_types:
            attention = AttentionHeatmapFactory(content_type=content_type)
            assert attention.content_type == content_type
    
    def test_interaction_tracking(self):
        """Test tracking of interactions within attention zone"""
        attention = AttentionHeatmapFactory(
            has_interaction=True,
            interaction_count=5
        )
        assert attention.has_interaction is True
        assert attention.interaction_count == 5
    
    def test_attention_duration(self):
        """Test attention duration tracking"""
        attention = AttentionHeatmapFactory(attention_duration=10.5)
        assert attention.attention_duration == 10.5


class TestElementInteraction:
    """Test ElementInteraction model"""
    
    def test_interaction_creation(self):
        """Test creating element interaction data"""
        interaction = ElementInteractionFactory()
        assert interaction.session
        assert interaction.element_selector
        assert interaction.interaction_type
    
    def test_interaction_types(self):
        """Test different interaction types"""
        interaction_types = ['click', 'focus', 'blur', 'change', 'hover', 'submit']
        
        for int_type in interaction_types:
            interaction = ElementInteractionFactory(interaction_type=int_type)
            assert interaction.interaction_type == int_type
    
    def test_duration_tracking(self):
        """Test interaction duration tracking"""
        interaction = ElementInteractionFactory(duration=3.5)
        assert interaction.duration == 3.5
    
    def test_element_selector_validation(self):
        """Test element selector storage"""
        selectors = [
            '#submit-button',
            '.btn-primary',
            'form > input[type="text"]',
            '[data-test="component"]'
        ]
        
        for selector in selectors:
            interaction = ElementInteractionFactory(element_selector=selector)
            assert interaction.element_selector == selector
    
    def test_element_metadata(self):
        """Test element metadata storage"""
        interaction = ElementInteractionFactory(
            element_type='input',
            element_id='email-field',
            element_class='form-control',
            element_text='Enter email'
        )
        
        assert interaction.element_type == 'input'
        assert interaction.element_id == 'email-field'
        assert interaction.element_class == 'form-control'
        assert interaction.element_text == 'Enter email'


class TestHeatmapAggregation:
    """Test HeatmapAggregation model"""
    
    def test_aggregation_creation(self):
        """Test creating aggregation data"""
        aggregation = HeatmapAggregationFactory()
        assert aggregation.page_url
        assert aggregation.time_period
        assert aggregation.period_start
        assert aggregation.period_end
        assert aggregation.session_count >= 0
    
    def test_unique_constraint(self):
        """Test unique constraint on page_url, time_period, device_type"""
        aggregation1 = HeatmapAggregationFactory(
            page_url='/test-page/',
            time_period='hour',
            device_type='desktop'
        )
        
        # Try to create duplicate
        with pytest.raises(IntegrityError):
            HeatmapAggregation.objects.create(
                page_url='/test-page/',
                time_period='hour',
                period_start=aggregation1.period_start,
                period_end=aggregation1.period_end,
                device_type='desktop',
                session_count=100
            )
    
    def test_aggregation_data_generation(self):
        """Test aggregation data structure"""
        aggregation = HeatmapAggregationFactory()
        
        # Check click heatmap data
        assert 'grid_size' in aggregation.click_heatmap_data
        assert 'matrix' in aggregation.click_heatmap_data
        assert 'hotspots' in aggregation.click_heatmap_data
        
        # Check scroll distribution
        assert isinstance(aggregation.scroll_depth_distribution, dict)
        
        # Check interaction summary
        assert 'top_elements' in aggregation.interaction_summary
        assert 'interaction_types' in aggregation.interaction_summary
    
    def test_time_period_options(self):
        """Test different time period options"""
        periods = ['hour', 'day', 'week', 'month']
        
        for period in periods:
            aggregation = HeatmapAggregationFactory(time_period=period)
            assert aggregation.time_period == period
    
    def test_device_type_aggregation(self):
        """Test aggregation by device type"""
        device_types = ['all', 'desktop', 'tablet', 'mobile']
        
        for device_type in device_types:
            aggregation = HeatmapAggregationFactory(device_type=device_type)
            assert aggregation.device_type == device_type
    
    def test_statistics_calculation(self):
        """Test statistical calculations in aggregation"""
        aggregation = HeatmapAggregationFactory(
            session_count=100,
            total_clicks=500,
            total_scrolls=300,
            total_interactions=200,
            avg_session_duration=180.5,
            avg_scroll_depth=65.5
        )
        
        assert aggregation.session_count == 100
        assert aggregation.total_clicks == 500
        assert aggregation.total_scrolls == 300
        assert aggregation.total_interactions == 200
        assert aggregation.avg_session_duration == 180.5
        assert aggregation.avg_scroll_depth == 65.5
    
    @pytest.mark.slow
    def test_generate_aggregation_classmethod(self):
        """Test the generate_aggregation class method"""
        # Create sample sessions with data
        page_url = '/test-aggregation/'
        for _ in range(5):
            create_complete_session_with_data(page_url=page_url)
        
        # Generate aggregation
        end_date = timezone.now()
        start_date = end_date - timedelta(hours=1)
        
        aggregation = HeatmapAggregation.generate_aggregation(
            page_url=page_url,
            start_date=start_date,
            end_date=end_date
        )
        
        assert aggregation.page_url == page_url
        assert aggregation.session_count == 5
        assert aggregation.total_clicks > 0
        assert aggregation.total_scrolls > 0


class TestCompleteSessionFlow:
    """Test complete session workflow"""
    
    @pytest.mark.integration
    def test_complete_session_creation(self):
        """Test creating a complete session with all data types"""
        user = UserFactory()
        session = create_complete_session_with_data(
            user=user,
            page_url='/test-complete/',
            num_clicks=5,
            num_scrolls=3,
            num_interactions=4
        )
        
        assert session.user == user
        assert session.page_url == '/test-complete/'
        assert session.clicks.count() == 5
        assert session.scrolls.count() == 3
        assert session.element_interactions.count() == 4
        assert session.attention_zones.count() == 3
        assert session.data_points_collected == 15  # 5+3+4+3
    
    @pytest.mark.integration
    def test_session_deletion_cascade(self):
        """Test that all related data is deleted when session is deleted"""
        session = create_complete_session_with_data()
        session_id = session.pk
        
        # Get counts before deletion
        click_count = session.clicks.count()
        scroll_count = session.scrolls.count()
        
        assert click_count > 0
        assert scroll_count > 0
        
        # Delete session
        session.delete()
        
        # Verify all related data is deleted
        assert not HeatmapSession.objects.filter(pk=session_id).exists()
        assert not ClickHeatmap.objects.filter(session_id=session_id).exists()
        assert not ScrollHeatmap.objects.filter(session_id=session_id).exists()
        assert not ElementInteraction.objects.filter(session_id=session_id).exists()
        assert not AttentionHeatmap.objects.filter(session_id=session_id).exists()