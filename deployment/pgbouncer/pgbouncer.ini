;;;
;;; PgBouncer Configuration for Django 5 Enterprise Application
;;;
;;; Optimized for high-performance connection pooling with PostgreSQL 14+
;;; Supports both development and production environments
;;;
;;; Installation:
;;; 1. Install pgbouncer: apt-get install pgbouncer (Ubuntu/Debian)
;;; 2. Copy this file to /etc/pgbouncer/pgbouncer.ini
;;; 3. Update userlist.txt with database credentials
;;; 4. Start service: systemctl start pgbouncer
;;;
;;; Monitoring:
;;; - Admin interface: psql -p 6432 -U pgbouncer pgbouncer
;;; - Stats: SHOW STATS; SHOW POOLS; SHOW DATABASES;
;;;

[databases]

;;; Production Database Configuration
;;; Replace with actual production database details
youtility_prod = host=localhost port=5432 dbname=youtility_prod user=youtility_user password=secure_password pool_size=25 reserve_pool_size=5

;;; Development Database Configuration
;;; For local development and testing
youtility_dev = host=localhost port=5432 dbname=youtility_dev user=youtility_dev password=dev_password pool_size=10 reserve_pool_size=2

;;; Staging Database Configuration
;;; For staging environment testing
youtility_staging = host=localhost port=5432 dbname=youtility_staging user=youtility_staging password=staging_password pool_size=15 reserve_pool_size=3

;;; Read Replica Configuration (for read scaling)
;;; Uncomment and configure when using read replicas
; youtility_replica = host=replica.example.com port=5432 dbname=youtility_prod user=readonly_user password=readonly_password pool_size=20

[pgbouncer]

;;; Connection Settings
;;;
;;; listen_addr: Interface to bind to (* = all interfaces)
;;; listen_port: Port to listen on (6432 is pgbouncer default)
;;; unix_socket_dir: Directory for unix socket (leave empty to disable)
listen_addr = 127.0.0.1
listen_port = 6432
unix_socket_dir = /var/run/pgbouncer

;;; Authentication
;;;
;;; auth_type: Authentication method (md5, scram-sha-256, trust, etc.)
;;; auth_file: File containing username/password pairs
;;; auth_query: Query to fetch authentication info (alternative to auth_file)
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;;; Connection Pooling Configuration
;;;
;;; pool_mode: Pooling mode
;;;   - session: One server connection per client connection (safest)
;;;   - transaction: Server connection returned after each transaction (recommended)
;;;   - statement: Server connection returned after each statement (experimental)
;;;
;;; max_client_conn: Maximum number of client connections
;;; default_pool_size: Default pool size per database
;;; min_pool_size: Minimum pool size to maintain
;;; reserve_pool_size: Additional connections for emergency use
;;; max_db_connections: Global limit on database connections
pool_mode = transaction
max_client_conn = 200
default_pool_size = 20
min_pool_size = 5
reserve_pool_size = 5
max_db_connections = 100

;;; Connection Timeouts (in seconds)
;;;
;;; server_lifetime: Maximum age of server connection (0 = unlimited)
;;; server_idle_timeout: Close server connection after being idle
;;; client_idle_timeout: Close client connection after being idle
;;; query_timeout: Cancel queries running longer than this
;;; query_wait_timeout: Time to wait for connection from pool
;;; client_login_timeout: Time to wait for client login
;;; autodb_idle_timeout: Close database when idle for this long
server_lifetime = 3600
server_idle_timeout = 600
client_idle_timeout = 0
query_timeout = 300
query_wait_timeout = 120
client_login_timeout = 60
autodb_idle_timeout = 3600

;;; Connection Limits per User
;;;
;;; max_user_connections: Max connections per user
;;; max_prepared_statements: Max prepared statements per connection
max_user_connections = 50
max_prepared_statements = 100

;;; Performance Tuning
;;;
;;; server_connect_timeout: Timeout for connecting to PostgreSQL
;;; server_login_retry: Retries for server login
;;; server_round_robin: Use round-robin for server selection
;;; ignore_startup_parameters: Ignore these parameters from client
server_connect_timeout = 15
server_login_retry = 5
server_round_robin = 1
ignore_startup_parameters = extra_float_digits

;;; SSL Configuration
;;;
;;; server_tls_sslmode: SSL mode for server connections
;;; server_tls_ca_file: CA certificate file
;;; server_tls_key_file: Private key file
;;; server_tls_cert_file: Certificate file
;;; client_tls_sslmode: SSL mode for client connections
server_tls_sslmode = require
; server_tls_ca_file = /path/to/ca-cert.pem
; server_tls_key_file = /path/to/server-key.pem
; server_tls_cert_file = /path/to/server-cert.pem
client_tls_sslmode = disable

;;; Logging Configuration
;;;
;;; log_connections: Log successful connections
;;; log_disconnections: Log disconnections
;;; log_pooler_errors: Log pooler errors
;;; syslog: Use syslog for logging
;;; syslog_facility: Syslog facility to use
;;; syslog_ident: Syslog program identifier
;;; logfile: Log file path (use syslog if not set)
;;; pidfile: PID file location
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
syslog = 0
syslog_facility = daemon
syslog_ident = pgbouncer
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

;;; Admin Configuration
;;;
;;; admin_users: Comma-separated list of admin users
;;; stats_users: Users allowed to see stats
;;; stats_period: Period for updating stats (seconds)
admin_users = postgres,pgbouncer_admin
stats_users = postgres,pgbouncer_admin,monitoring_user
stats_period = 60

;;; Advanced Options
;;;
;;; application_name_add_host: Add hostname to application_name
;;; conffile: Include additional config file
;;; tcp_keepalive: Enable TCP keepalive
;;; tcp_keepcnt: TCP keepalive probe count
;;; tcp_keepidle: TCP keepalive idle time
;;; tcp_keepintvl: TCP keepalive probe interval
application_name_add_host = 1
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 600
tcp_keepintvl = 30

;;; DNS Configuration
;;;
;;; dns_max_ttl: Maximum DNS cache TTL
;;; dns_zone_check_period: How often to check DNS zone
dns_max_ttl = 15
dns_zone_check_period = 0

;;; Security
;;;
;;; disable_pqexec: Disable simple query protocol
;;; server_check_delay: Delay before checking server state
disable_pqexec = 0
server_check_delay = 30