{% extends "admin/base.html" %}
{% load static %}
{% load i18n %}

{#
  YOUTILITY Industrial Minimal Design System
  Django Admin Theme Override

  This template applies the industrial minimal design to Django admin.
  It integrates:
    - Design tokens (colors, typography, spacing)
    - Self-hosted fonts (Inter + JetBrains Mono)
    - Dark mode toggle with system preference detection
    - Accessibility enhancements (ARIA, focus states)
#}

{% block title %}{% if subtitle %}{{ subtitle }} | {% endif %}{{ title }} | {{ site_title|default:_('YOUTILITY Admin') }}{% endblock %}

{% block extrastyle %}
  {{ block.super }}

  {# Preload critical fonts for optimal performance #}
  <link rel="preload" href="{% static 'fonts/inter-v12-latin-regular.woff2' %}" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="{% static 'fonts/inter-v12-latin-600.woff2' %}" as="font" type="font/woff2" crossorigin>

  {# Industrial Minimal Design System #}
  <link rel="stylesheet" href="{% static 'theme/fonts.css' %}">
  <link rel="stylesheet" href="{% static 'theme/tokens.css' %}">
  <link rel="stylesheet" href="{% static 'theme/admin.css' %}">

  {# Theme-specific metadata #}
  <meta name="color-scheme" content="light dark">
  <meta name="theme-color" content="#155EEF" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#3B82F6" media="(prefers-color-scheme: dark)">
{% endblock %}

{% block extrahead %}
  {{ block.super }}

  {# Dark mode manager - must load early to prevent flash #}
  <script src="{% static 'theme/theme-toggle.js' %}"></script>

  {# Admin-specific enhancements #}
  <script>
    // Listen for theme changes and update admin-specific elements
    document.addEventListener('themechange', function(e) {
      // Update charts, syntax highlighting, etc. when theme changes
      console.log('Admin theme changed to:', e.detail.theme);

      // Dispatch custom event for admin widgets
      const adminThemeEvent = new CustomEvent('adminthemechange', {
        detail: { theme: e.detail.theme },
        bubbles: true
      });
      document.dispatchEvent(adminThemeEvent);
    });
  </script>
{% endblock %}

{% block branding %}
  <div id="site-name">
    <a href="{% url 'admin:index' %}" class="admin-brand">
      {# Logo/Icon (optional - can add SVG logo here) #}
      <svg class="admin-logo-icon" width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect width="32" height="32" rx="6" fill="currentColor" opacity="0.1"/>
        <path d="M16 8L24 12V20L16 24L8 20V12L16 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M16 16L24 12M16 16L8 12M16 16V24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>

      {# Brand text #}
      <span class="admin-brand-text">
        <span class="admin-brand-name">{{ site_header|default:_('YOUTILITY') }}</span>
        <span class="admin-brand-subtitle">{% trans "Facility Management" %}</span>
      </span>
    </a>
  </div>
{% endblock %}

{% block usertools %}
  {# User tools with dark mode toggle #}
  <div id="user-tools">
    {{ block.super }}

    {# Dark mode toggle button #}
    <button
      type="button"
      class="theme-toggle-button"
      data-theme-toggle
      aria-label="{% trans 'Toggle dark mode' %}"
      title="{% trans 'Toggle dark mode' %}">

      {# Sun icon (light mode) #}
      <svg class="theme-icon theme-icon-light" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill="currentColor"/>
      </svg>

      {# Moon icon (dark mode) #}
      <svg class="theme-icon theme-icon-dark" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" fill="currentColor"/>
      </svg>

      {# Screen reader text #}
      <span class="sr-only" data-theme-text>{% trans "Dark" %}</span>
      <span class="sr-only">{% trans "Mode" %}</span>
    </button>
  </div>
{% endblock %}

{% block nav-global %}
  {# Global navigation - can be customized here #}
  {{ block.super }}
{% endblock %}

{% block footer %}
  <div id="footer">
    <div class="footer-content">
      <div class="footer-left">
        <span id="copyright-year">{{ current_year|default:"2025" }}</span>
        <span class="footer-separator">•</span>
        <a href="https://youtility.work/" target="_blank" rel="noopener noreferrer" class="footer-link">
          {% trans "Powered by YOUTILITY" %}
        </a>
      </div>

      <div class="footer-right">
        {# Version info (optional) #}
        {% if version %}
          <span class="footer-version" title="{% trans 'Application version' %}">
            v{{ version }}
          </span>
          <span class="footer-separator">•</span>
        {% endif %}

        {# Environment indicator #}
        {% if DEBUG %}
          <span class="footer-env footer-env-dev" title="{% trans 'Development environment' %}">
            <span class="footer-env-indicator"></span>
            {% trans "DEV" %}
          </span>
        {% elif staging %}
          <span class="footer-env footer-env-staging" title="{% trans 'Staging environment' %}">
            <span class="footer-env-indicator"></span>
            {% trans "STAGING" %}
          </span>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}

{% block extrajs %}
  {{ block.super }}

  {# Admin-specific JavaScript enhancements #}
  <script>
    (function() {
      'use strict';

      /**
       * Initialize admin enhancements
       */
      function initAdminEnhancements() {
        // Update copyright year
        const yearElement = document.getElementById('copyright-year');
        if (yearElement) {
          yearElement.textContent = new Date().getFullYear();
        }

        // Add keyboard shortcut for theme toggle (Ctrl/Cmd + Shift + D)
        document.addEventListener('keydown', function(e) {
          if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
            e.preventDefault();
            if (window.themeManager) {
              window.themeManager.toggle();

              // Announce to screen readers
              announceToScreenReader('Theme toggled');
            }
          }
        });

        // Enhance form accessibility
        enhanceFormAccessibility();

        // Add loading states to submit buttons
        enhanceSubmitButtons();
      }

      /**
       * Enhance form accessibility
       */
      function enhanceFormAccessibility() {
        // Add aria-required to required fields that don't have it
        const requiredFields = document.querySelectorAll('.required input, .required select, .required textarea');
        requiredFields.forEach(function(field) {
          if (!field.hasAttribute('aria-required')) {
            field.setAttribute('aria-required', 'true');
          }
        });

        // Associate error messages with form fields
        const errors = document.querySelectorAll('.errorlist');
        errors.forEach(function(errorList) {
          const fieldWrapper = errorList.closest('.form-row');
          if (fieldWrapper) {
            const input = fieldWrapper.querySelector('input, select, textarea');
            if (input) {
              const errorId = 'error_' + input.id;
              errorList.id = errorId;
              input.setAttribute('aria-describedby', errorId);
              input.setAttribute('aria-invalid', 'true');
            }
          }
        });
      }

      /**
       * Enhance submit buttons with loading states
       */
      function enhanceSubmitButtons() {
        const forms = document.querySelectorAll('form');
        forms.forEach(function(form) {
          form.addEventListener('submit', function(e) {
            const submitButton = form.querySelector('[type="submit"]');
            if (submitButton && !submitButton.disabled) {
              // Store original text
              submitButton.dataset.originalText = submitButton.textContent;

              // Show loading state
              submitButton.textContent = '{% trans "Saving..." %}';
              submitButton.disabled = true;
              submitButton.classList.add('loading');

              // Re-enable after timeout (in case form doesn't navigate away)
              setTimeout(function() {
                if (submitButton.dataset.originalText) {
                  submitButton.textContent = submitButton.dataset.originalText;
                  submitButton.disabled = false;
                  submitButton.classList.remove('loading');
                }
              }, 5000);
            }
          });
        });
      }

      /**
       * Announce message to screen readers
       * @param {string} message
       */
      function announceToScreenReader(message) {
        const announcement = document.createElement('div');
        announcement.setAttribute('role', 'status');
        announcement.setAttribute('aria-live', 'polite');
        announcement.className = 'sr-only';
        announcement.textContent = message;

        document.body.appendChild(announcement);

        setTimeout(function() {
          document.body.removeChild(announcement);
        }, 1000);
      }

      /**
       * Initialize when DOM is ready
       */
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAdminEnhancements);
      } else {
        initAdminEnhancements();
      }
    })();
  </script>
{% endblock %}

{#
  ACCESSIBILITY FEATURES:
  - ARIA labels on all interactive elements
  - Keyboard shortcut for theme toggle (Ctrl/Cmd + Shift + D)
  - Screen reader announcements
  - Focus management
  - Error message associations
  - Required field indicators

  PERFORMANCE FEATURES:
  - Font preloading
  - Minimal CSS/JS (tokens + admin styles only)
  - Dark mode preference cached in localStorage
  - No flash of unstyled content (FOUC)

  CUSTOMIZATION:
  - Override site_header in settings: ADMIN_SITE_HEADER = "Your Company"
  - Override site_title in settings: ADMIN_SITE_TITLE = "Your Admin"
  - Add version number: Pass 'version' in context
  - Add staging flag: Pass 'staging' in context
#}
