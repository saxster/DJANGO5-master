name: ğŸ›¡ï¸ Django Code Quality & Security Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.10'
  DJANGO_SETTINGS_MODULE: 'intelliwiz_config.settings_test'

jobs:
  # =============================================================================
  # ğŸ”’ CRITICAL SECURITY SCANNING
  # =============================================================================
  security-scan:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Security Tools
      run: |
        pip install bandit[toml] safety semgrep
        pip install -r requirements/base.txt

    - name: ğŸ” Bandit Security Scan
      run: |
        echo "ğŸ” Running Bandit security analysis..."
        bandit -r apps/ intelliwiz_config/ -f json -o bandit-report.json || true
        bandit -r apps/ intelliwiz_config/ -f txt
      continue-on-error: true

    - name: ğŸ›¡ï¸ Safety Check (Dependencies)
      run: |
        echo "ğŸ›¡ï¸ Checking for vulnerable dependencies..."
        safety check --json > safety-report.json || true
        safety check
      continue-on-error: true

    - name: ğŸ” Semgrep Security Rules
      run: |
        echo "ğŸ” Running Semgrep security analysis..."
        semgrep --config=auto --json --output=semgrep-report.json . || true
        semgrep --config=auto .
      continue-on-error: true

    - name: ğŸ“Š Upload Security Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          semgrep-report.json

  # =============================================================================
  # ğŸ“ ARCHITECTURE & CODE QUALITY
  # =============================================================================
  architecture-validation:
    name: ğŸ“ Architecture Rules
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ“ Check Settings File Size Limits
      run: |
        echo "ğŸ“ Validating settings file sizes..."
        violations=0
        for settings_file in $(find . -name "*settings*.py" -not -path "./venv/*" -not -path "./.env/*"); do
          lines=$(wc -l < "$settings_file")
          if [ "$lines" -gt 200 ]; then
            echo "âŒ VIOLATION: $settings_file has $lines lines (limit: 200)"
            violations=$((violations + 1))
          else
            echo "âœ… PASS: $settings_file has $lines lines"
          fi
        done
        if [ $violations -gt 0 ]; then
          echo "ğŸ’¥ Architecture Rule #6 violated: Split large settings files"
          echo "ğŸ“– See .claude/rules.md Rule #6 for guidance"
          exit 1
        fi

    - name: ğŸ“Š Check Model Complexity
      run: |
        echo "ğŸ“Š Validating model file complexity..."
        violations=0
        for model_file in $(find apps/ -name "models.py" -o -name "*models*.py"); do
          if grep -q "class.*Model\|models\.Model" "$model_file" 2>/dev/null; then
            lines=$(wc -l < "$model_file")
            if [ "$lines" -gt 150 ]; then
              echo "âŒ VIOLATION: $model_file has $lines lines (limit: 150)"
              violations=$((violations + 1))
            else
              echo "âœ… PASS: $model_file has $lines lines"
            fi
          fi
        done
        if [ $violations -gt 0 ]; then
          echo "ğŸ’¥ Architecture Rule #7 violated: Apply single responsibility to models"
          echo "ğŸ“– See .claude/rules.md Rule #7 for guidance"
          exit 1
        fi

  # =============================================================================
  # ğŸš« FORBIDDEN PATTERN DETECTION
  # =============================================================================
  pattern-enforcement:
    name: ğŸš« Pattern Enforcement
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Critical Pattern Violations
      run: |
        echo "ğŸ” Scanning for forbidden patterns..."
        violations=0

        echo "ğŸ”’ Checking for GraphQL security bypass..."
        if grep -r "def _is_graphql_request.*return True" apps/ intelliwiz_config/ 2>/dev/null; then
          echo "âŒ CRITICAL: GraphQL security bypass detected!"
          echo "ğŸ“– See .claude/rules.md Rule #1"
          violations=$((violations + 1))
        fi

        echo "ğŸš¨ Checking for generic exception handling..."
        if grep -r "except Exception" apps/ 2>/dev/null; then
          echo "âŒ VIOLATION: Generic exception handling found!"
          echo "ğŸ“– Use specific exception types - see .claude/rules.md Rule #11"
          violations=$((violations + 1))
        fi

        echo "ğŸ” Checking for CSRF exemptions on GraphQL..."
        if grep -B5 -A5 "@csrf_exempt" apps/ 2>/dev/null | grep -i "graphql" >/dev/null; then
          echo "âŒ CRITICAL: CSRF exempt GraphQL endpoints detected!"
          echo "ğŸ“– See .claude/rules.md Rule #3"
          violations=$((violations + 1))
        fi

        echo "ğŸ“ Checking for sensitive data in logs..."
        if grep -r "log.*password\|logger.*password\|log.*token\|logger.*token" apps/ 2>/dev/null; then
          echo "âŒ VIOLATION: Sensitive data in logs detected!"
          echo "ğŸ“– See .claude/rules.md Rule #15"
          violations=$((violations + 1))
        fi

        if [ $violations -gt 0 ]; then
          echo ""
          echo "ğŸ’¥ CRITICAL VIOLATIONS FOUND: $violations"
          echo "ğŸš¨ These patterns WILL cause security vulnerabilities!"
          echo "ğŸ“– Review .claude/rules.md for required fixes"
          exit 1
        else
          echo "âœ… No critical pattern violations found!"
        fi

  # =============================================================================
  # ğŸ“‹ QUALITY REPORT GENERATION
  # =============================================================================
  quality-report:
    name: ğŸ“‹ Quality Report
    runs-on: ubuntu-latest
    needs: [security-scan, architecture-validation, pattern-enforcement]
    if: always()

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ“Š Download Artifacts
      uses: actions/download-artifact@v3
      with:
        name: security-reports
        path: reports/
      continue-on-error: true

    - name: ğŸ“ˆ Generate Quality Summary
      run: |
        echo "# ğŸ“Š Code Quality Report" > quality-report.md
        echo "" >> quality-report.md
        echo "## ğŸ† Pipeline Results" >> quality-report.md
        echo "" >> quality-report.md

        # Job status summary
        echo "| Check | Status | Description |" >> quality-report.md
        echo "|-------|--------|-------------|" >> quality-report.md
        echo "| ğŸ”’ Security Scan | ${{ needs.security-scan.result }} | Bandit, Safety, Semgrep analysis |" >> quality-report.md
        echo "| ğŸ“ Architecture | ${{ needs.architecture-validation.result }} | File size & complexity limits |" >> quality-report.md
        echo "| ğŸš« Pattern Enforcement | ${{ needs.pattern-enforcement.result }} | Forbidden pattern detection |" >> quality-report.md
        echo "" >> quality-report.md

        echo "## ğŸ“– Rule Reference" >> quality-report.md
        echo "All checks enforce rules defined in \`.claude/rules.md\`" >> quality-report.md

    - name: ğŸ“¤ Upload Quality Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: quality-report
        path: quality-report.md

    - name: ğŸ’¬ Comment PR with Quality Report
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request' && always()
      with:
        script: |
          const fs = require('fs');
          try {
            const report = fs.readFileSync('quality-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
          } catch (error) {
            console.log('Could not read quality report:', error.message);
          }

  # =============================================================================
  # ğŸ¯ OVERALL PIPELINE STATUS
  # =============================================================================
  pipeline-status:
    name: ğŸ¯ Pipeline Status
    runs-on: ubuntu-latest
    needs: [security-scan, architecture-validation, pattern-enforcement]
    if: always()

    steps:
    - name: ğŸ“Š Pipeline Summary
      run: |
        echo "ğŸ¯ Django Code Quality Pipeline Results:"
        echo "========================================"
        echo "ğŸ”’ Security Scan: ${{ needs.security-scan.result }}"
        echo "ğŸ“ Architecture: ${{ needs.architecture-validation.result }}"
        echo "ğŸš« Pattern Enforcement: ${{ needs.pattern-enforcement.result }}"
        echo ""

        # Determine overall status
        if [[ "${{ needs.pattern-enforcement.result }}" == "failure" ]]; then
          echo "ğŸ’¥ PIPELINE FAILED: Critical security patterns detected!"
          echo "ğŸš¨ Code contains patterns that WILL cause vulnerabilities"
          echo "ğŸ“– Review .claude/rules.md for required fixes"
          exit 1
        elif [[ "${{ needs.architecture-validation.result }}" == "failure" ]]; then
          echo "âš ï¸ PIPELINE FAILED: Architecture rules violated!"
          echo "ğŸ“ Code violates size/complexity limits"
          echo "ğŸ“– Review .claude/rules.md for guidance"
          exit 1
        else
          echo "âœ… PIPELINE PASSED: All quality checks successful!"
          echo "ğŸ‰ Code meets all quality and security standards"
        fi