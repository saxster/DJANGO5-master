name: ğŸ›¡ï¸ Django Code Quality & Security Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.10'
  DJANGO_SETTINGS_MODULE: 'intelliwiz_config.settings_test'

jobs:
  # =============================================================================
  # ğŸ”’ CRITICAL SECURITY SCANNING
  # =============================================================================
  security-scan:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Security Tools
      run: |
        pip install bandit[toml] safety semgrep pip-audit
        pip install -r requirements/base.txt

    - name: ğŸ” Bandit Security Scan
      run: |
        echo "ğŸ” Running Bandit security analysis..."
        bandit -r apps/ intelliwiz_config/ -f json -o bandit-report.json || true
        bandit -r apps/ intelliwiz_config/ -f txt
      continue-on-error: true

    - name: ğŸ›¡ï¸ Safety Check (Dependencies)
      run: |
        echo "ğŸ›¡ï¸ Checking for vulnerable dependencies..."
        safety check --json > safety-report.json || true
        safety check
      continue-on-error: true

    - name: ğŸ“¦ Pip-Audit (Supply Chain Security)
      run: |
        echo "ğŸ“¦ Running pip-audit for supply chain vulnerabilities..."
        pip-audit --desc --output json > pip-audit-report.json || true
        pip-audit --desc
      continue-on-error: true

    - name: ğŸ” Semgrep Security Rules
      run: |
        echo "ğŸ” Running Semgrep security analysis..."
        semgrep --config=auto --json --output=semgrep-report.json . || true
        semgrep --config=auto .
      continue-on-error: true

    - name: ğŸ“Š Upload Security Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          pip-audit-report.json
          semgrep-report.json

  # =============================================================================
  # ğŸ“ ARCHITECTURE & CODE QUALITY
  # =============================================================================
  architecture-validation:
    name: ğŸ“ Architecture Rules
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Quality Tools
      run: |
        pip install radon xenon pydeps

    - name: ğŸ“ Check Comprehensive File Size Limits
      run: |
        echo "ğŸ“ Running comprehensive file size validation..."
        python scripts/check_file_sizes.py --ci
      continue-on-error: false

    - name: ğŸ”„ Check Cyclomatic Complexity (Radon)
      run: |
        echo "ğŸ”„ Running cyclomatic complexity analysis..."
        radon cc apps/ -a -s -n C --total-average || true
        echo ""
        echo "ğŸ“Š Detailed complexity report..."
        radon cc apps/ -n C -s -j > radon-complexity.json || true
        echo ""
        echo "ğŸ¯ Methods exceeding complexity 10:"
        radon cc apps/ -n C | head -100
      continue-on-error: true

    - name: ğŸ“‰ Check Code Maintainability (Radon MI)
      run: |
        echo "ğŸ“‰ Running maintainability index analysis..."
        radon mi apps/ -s -n B || true
        echo ""
        echo "âš ï¸ Files with low maintainability (<65):"
        radon mi apps/ -n B -j > radon-maintainability.json || true
      continue-on-error: true

    - name: ğŸ” Check Complexity Threshold (Xenon)
      run: |
        echo "ğŸ” Running Xenon complexity threshold check..."
        xenon --max-absolute C --max-modules B --max-average A apps/ || true
      continue-on-error: true

    - name: ğŸŒ Network Timeout Validation
      run: |
        echo "ğŸŒ Validating network timeout parameters..."
        python scripts/check_network_timeouts.py --ci
      continue-on-error: false

    - name: ğŸ”— Circular Dependency Detection
      run: |
        echo "ğŸ”— Checking for circular dependencies..."
        python scripts/check_circular_deps.py --ci
      continue-on-error: true

    - name: ğŸ“Š Upload Quality Metrics
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: quality-metrics
        path: |
          radon-complexity.json
          radon-maintainability.json

  # =============================================================================
  # ğŸ§ª TEST COVERAGE VALIDATION
  # =============================================================================
  test-coverage:
    name: ğŸ§ª Test Coverage
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install -r requirements/base.txt
        pip install pytest pytest-cov pytest-django coverage

    - name: ğŸ§ª Run Tests with Coverage
      run: |
        echo "ğŸ§ª Running test suite with coverage analysis..."
        pytest --cov=apps --cov-report=term --cov-report=html:coverage_reports/html --cov-report=json:coverage.json --tb=short -v || true
      continue-on-error: true

    - name: ğŸ“Š Check Coverage Threshold
      run: |
        echo "ğŸ“Š Checking test coverage threshold (75% minimum)..."
        python -c "
import json
import sys
try:
    with open('coverage.json', 'r') as f:
        data = json.load(f)
    coverage = data['totals']['percent_covered']
    print(f'Current coverage: {coverage:.2f}%')
    if coverage < 75:
        print(f'âŒ Coverage {coverage:.2f}% is below 75% threshold')
        sys.exit(1)
    else:
        print(f'âœ… Coverage {coverage:.2f}% meets threshold')
except FileNotFoundError:
    print('âš ï¸ Coverage report not found, skipping check')
except Exception as e:
    print(f'âš ï¸ Error checking coverage: {e}')
"
      continue-on-error: true

    - name: ğŸ“¤ Upload Coverage Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: coverage-reports
        path: |
          coverage_reports/
          coverage.json

  # =============================================================================
  # ğŸš« FORBIDDEN PATTERN DETECTION
  # =============================================================================
  pattern-enforcement:
    name: ğŸš« Pattern Enforcement
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Critical Pattern Violations
      run: |
        echo "ğŸ” Scanning for forbidden patterns..."
        violations=0

        echo "ğŸ”’ Checking for GraphQL security bypass..."
        if grep -r "def _is_graphql_request.*return True" apps/ intelliwiz_config/ 2>/dev/null; then
          echo "âŒ CRITICAL: GraphQL security bypass detected!"
          echo "ğŸ“– See .claude/rules.md Rule #1"
          violations=$((violations + 1))
        fi

        echo "ğŸš¨ Checking for generic exception handling..."
        if grep -r "except Exception" apps/ 2>/dev/null; then
          echo "âŒ VIOLATION: Generic exception handling found!"
          echo "ğŸ“– Use specific exception types - see .claude/rules.md Rule #11"
          violations=$((violations + 1))
        fi

        echo "ğŸ” Checking for CSRF exemptions on GraphQL..."
        if grep -B5 -A5 "@csrf_exempt" apps/ 2>/dev/null | grep -i "graphql" >/dev/null; then
          echo "âŒ CRITICAL: CSRF exempt GraphQL endpoints detected!"
          echo "ğŸ“– See .claude/rules.md Rule #3"
          violations=$((violations + 1))
        fi

        echo "ğŸ“ Checking for sensitive data in logs..."
        if grep -r "log.*password\|logger.*password\|log.*token\|logger.*token" apps/ 2>/dev/null; then
          echo "âŒ VIOLATION: Sensitive data in logs detected!"
          echo "ğŸ“– See .claude/rules.md Rule #15"
          violations=$((violations + 1))
        fi

        if [ $violations -gt 0 ]; then
          echo ""
          echo "ğŸ’¥ CRITICAL VIOLATIONS FOUND: $violations"
          echo "ğŸš¨ These patterns WILL cause security vulnerabilities!"
          echo "ğŸ“– Review .claude/rules.md for required fixes"
          exit 1
        else
          echo "âœ… No critical pattern violations found!"
        fi

  # =============================================================================
  # ğŸ“‹ QUALITY REPORT GENERATION
  # =============================================================================
  quality-report:
    name: ğŸ“‹ Quality Report
    runs-on: ubuntu-latest
    needs: [security-scan, architecture-validation, pattern-enforcement]
    if: always()

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ“Š Download Artifacts
      uses: actions/download-artifact@v3
      with:
        name: security-reports
        path: reports/
      continue-on-error: true

    - name: ğŸ“ˆ Generate Quality Summary
      run: |
        echo "# ğŸ“Š Code Quality Report" > quality-report.md
        echo "" >> quality-report.md
        echo "## ğŸ† Pipeline Results" >> quality-report.md
        echo "" >> quality-report.md

        # Job status summary
        echo "| Check | Status | Description |" >> quality-report.md
        echo "|-------|--------|-------------|" >> quality-report.md
        echo "| ğŸ”’ Security Scan | ${{ needs.security-scan.result }} | Bandit, Safety, Semgrep analysis |" >> quality-report.md
        echo "| ğŸ“ Architecture | ${{ needs.architecture-validation.result }} | File size & complexity limits |" >> quality-report.md
        echo "| ğŸš« Pattern Enforcement | ${{ needs.pattern-enforcement.result }} | Forbidden pattern detection |" >> quality-report.md
        echo "" >> quality-report.md

        echo "## ğŸ“– Rule Reference" >> quality-report.md
        echo "All checks enforce rules defined in \`.claude/rules.md\`" >> quality-report.md

    - name: ğŸ“¤ Upload Quality Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: quality-report
        path: quality-report.md

    - name: ğŸ’¬ Comment PR with Quality Report
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request' && always()
      with:
        script: |
          const fs = require('fs');
          try {
            const report = fs.readFileSync('quality-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
          } catch (error) {
            console.log('Could not read quality report:', error.message);
          }

  # =============================================================================
  # ğŸ¯ OVERALL PIPELINE STATUS
  # =============================================================================
  pipeline-status:
    name: ğŸ¯ Pipeline Status
    runs-on: ubuntu-latest
    needs: [security-scan, architecture-validation, test-coverage, pattern-enforcement]
    if: always()

    steps:
    - name: ğŸ“Š Pipeline Summary
      run: |
        echo "ğŸ¯ Django Code Quality Pipeline Results:"
        echo "========================================"
        echo "ğŸ”’ Security Scan: ${{ needs.security-scan.result }}"
        echo "ğŸ“ Architecture: ${{ needs.architecture-validation.result }}"
        echo "ğŸ§ª Test Coverage: ${{ needs.test-coverage.result }}"
        echo "ğŸš« Pattern Enforcement: ${{ needs.pattern-enforcement.result }}"
        echo ""

        # Determine overall status
        if [[ "${{ needs.pattern-enforcement.result }}" == "failure" ]]; then
          echo "ğŸ’¥ PIPELINE FAILED: Critical security patterns detected!"
          echo "ğŸš¨ Code contains patterns that WILL cause vulnerabilities"
          echo "ğŸ“– Review .claude/rules.md for required fixes"
          exit 1
        elif [[ "${{ needs.architecture-validation.result }}" == "failure" ]]; then
          echo "âš ï¸ PIPELINE FAILED: Architecture rules violated!"
          echo "ğŸ“ Code violates size/complexity limits"
          echo "ğŸ“– Review .claude/rules.md for guidance"
          exit 1
        else
          echo "âœ… PIPELINE PASSED: All quality checks successful!"
          echo "ğŸ‰ Code meets all quality and security standards"
        fi